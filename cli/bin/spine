#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
RUNS="${ROOT}/runs"
RECEIPTS="${ROOT}/receipts/sessions"
SPINE_STATE="${ROOT}/.spine"

usage() {
  cat <<USAGE
spine: detachable front door

Commands:
  spine doctor
  spine start
  spine run --task <path>
  spine receipt --run-id <RUN_ID> --status <0|1> --note "<text>"
  spine closeout --run-id <RUN_ID>

USAGE
}

doctor() {
  echo "SPINE DOCTOR"
  echo "root: ${ROOT}"
  [[ -d "${ROOT}/cli/bin" ]] && echo "ok: cli/bin" || echo "FAIL: cli/bin"
  [[ -d "${ROOT}/engine" ]] && echo "ok: engine" || echo "FAIL: engine"
  [[ -f "${ROOT}/docs/RECEIPTS_CONTRACT.md" ]] && echo "ok: receipts contract" || echo "FAIL: receipts contract"
  command -v git >/dev/null 2>&1 && echo "ok: git" || echo "WARN: git missing"
  echo "done"
}

start() {
  local run_id="R$(date -u +%Y%m%d-%H%M%S)"
  mkdir -p "${RUNS}/${run_id}" "${RECEIPTS}/${run_id}" "${SPINE_STATE}"
  echo "${run_id}" > "${SPINE_STATE}/latest_run_id"
  cat > "${RUNS}/${run_id}/run.md" <<EOF2
# Run
RUN_ID: ${run_id}
UTC: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
EOF2
  echo "${run_id}"
}

run_task() {
  local task=""
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --task) shift; task="${1:-}";;
      *) echo "Unknown arg: $1"; exit 1;;
    esac
    shift
  done

  [[ -n "${task}" ]] || { echo "FAIL: --task required"; exit 1; }
  [[ -f "${task}" ]] || { echo "FAIL: task file not found: ${task}"; exit 1; }

  # Always mint a fresh run for each task run (Ronny-proof MOU)
  local run_id
  run_id="$(start)"

  mkdir -p "${RUNS}/${run_id}"
  cp "${task}" "${RUNS}/${run_id}/task.txt"

  # Extract the ## REQUEST section (deterministic) into runs/<RUN_ID>/request.txt
  perl -0777 -ne 'if (s/^.*?^## REQUEST\s*\n//ms) { s/\n\s*\z//; print } else { die "FAIL: task missing ## REQUEST\n" }' \
    "${RUNS}/${run_id}/task.txt" > "${RUNS}/${run_id}/request.txt"

  local runner="${ROOT}/engine/run.sh"
  [[ -x "${runner}" ]] || { echo "FAIL: missing engine adapter: ${runner}"; exit 1; }
  local result_path
  result_path="$("${runner}" "${run_id}")"

  # Write receipt (auto) listing request/result artifacts
  local out="${RECEIPTS}/${run_id}/receipt.md"
  mkdir -p "${RECEIPTS}/${run_id}"
  cat > "${out}" <<EOF2
# Receipt
RUN_ID: ${run_id}
UTC timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
Command invoked: spine run --task ${task}
Inputs (file paths):
- runs/${run_id}/task.txt
Outputs (file paths):
- runs/${run_id}/request.txt
- runs/${run_id}/result.txt
- receipts/sessions/${run_id}/receipt.md
Exit status: 0
Notes: v0.1 MOU (extract REQUEST + write result)
EOF2

  echo "RUN_ID=${run_id}"
  echo "TASK=${task}"
  echo "RESULT=${result_path}"
  echo "${out}"
}

receipt() {
  local run_id="" status="" note=""
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --run-id) shift; run_id="${1:-}";;
      --status) shift; status="${1:-}";;
      --note) shift; note="${1:-}";;
      *) echo "Unknown arg: $1"; exit 1;;
    esac
    shift
  done

  [[ -n "${run_id}" ]] || { echo "FAIL: --run-id required"; exit 1; }
  [[ -n "${status}" ]] || { echo "FAIL: --status required"; exit 1; }

  local out="${RECEIPTS}/${run_id}/receipt.md"
  cat > "${out}" <<EOF2
# Receipt
RUN_ID: ${run_id}
UTC timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
Command invoked: spine run
Inputs (file paths):
- runs/${run_id}/task.txt
Outputs (file paths):
- receipts/sessions/${run_id}/receipt.md
Exit status: ${status}
Notes: ${note:-â€”}
EOF2
  echo "${out}"
}

closeout() {
  local run_id=""
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --run-id) shift; run_id="${1:-}";;
      *) echo "Unknown arg: $1"; exit 1;;
    esac
    shift
  done

  [[ -n "${run_id}" ]] || { echo "FAIL: --run-id required"; exit 1; }
  echo "Closed: ${run_id}"
  echo "Receipt: receipts/sessions/${run_id}/receipt.md"
}

cmd="${1:-}"
shift || true
case "${cmd}" in
  doctor) doctor ;;
  start) start ;;
  run) run_task "$@" ;;
  receipt) receipt "$@" ;;
  closeout) closeout "$@" ;;
  ""|help|-h|--help) usage ;;
  *) echo "Unknown command: ${cmd}"; usage; exit 1 ;;
esac
