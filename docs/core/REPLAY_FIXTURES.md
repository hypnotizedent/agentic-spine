---
status: authoritative
owner: "@ronny"
last_verified: 2026-02-05
scope: replay-fixtures
---

# Replay Fixtures

> **Purpose:** Explain how `surfaces/verify/replay-test.sh` uses `fixtures/events/v1` plus `fixtures/baseline` to prove deterministic outputs.

## Layout

| Path | Role |
|------|------|
| `fixtures/events/v1/` | Inbound prompts (session header + event description). Each file is one deterministic scenario. |
| `fixtures/baseline/` | Normalized SHA256 hashes of the canonical results. Generated by `replay-test.sh` when it runs without `--compare`. |
| `mailroom/inbox/queued/` | Where `ops run --fixture` or `replay-test` copies fixtures so the watcher can run them. |
| `mailroom/outbox/` | Receives `*__RESULT.md` files after the spine finishes each fixture. |
| `receipts/sessions/` | Stores receipts for each fixture run (auto-written by `ops cap` or the watcher). |

## Running the replay surface

1. **Capture a baseline (first time or whenever fixtures change)**

   ```bash
   ./surfaces/verify/replay-test.sh
   ```

   - Enqueues every fixture under `fixtures/events/v1` except the nondeterministic `__unknown_event__` file.
   - Waits for `mailroom/outbox/${run_key}__RESULT.md` and writes a normalized hash into `fixtures/baseline/${run_key}.hash`.
   - Run the script from the spine repo root; it already knows `SPINE_ROOT=$HOME/Code/agentic-spine`.

2. **Verify against the baseline (the capability `spine.replay` does this)**

   ```bash
   ./bin/ops cap run spine.replay
   # or run directly:
   ./surfaces/verify/replay-test.sh --compare
   ```

   - Replays every deterministic fixture and compares the normalized hash to the captured baseline.
   - If any hash differs or the baseline is missing, the script exits non-zero and the capability emits a failed receipt.

3. **Clean test artifacts (if you need to regenerate everything)**

   ```bash
   ./surfaces/verify/replay-test.sh --clean
   ```

## Adding or updating a fixture

1. Copy an existing fixture (e.g., `S20260201-180000__email_received__R0001.md`) and adjust the header/body to match the new scenario.
2. Name the file `S<YYYYMMDD-HHMMSS>__<brief_description>__R000X.md`. Keep `AUDIENCE`, `MODE`, `SESSION TYPE`, `PIPELINE STAGE`, and `OUTCOME` headers consistent.
3. Drop the file into `fixtures/events/v1/`.
4. Re-run `./surfaces/verify/replay-test.sh` (no args) to capture the new baseline hash. Commit both the fixture and the new `.hash` file.
5. Use `./bin/ops cap run spine.replay` to prove that the baseline still matches; receipts go to `receipts/sessions/RCAP-...`.

> **Tip:** If the fixture should never be compared (e.g., unpredictable vendor data), suffix it with `__unknown_event__` and it will be skipped during comparison but still enqueued during baseline capture.

## Unknown event fixture

- The `*_unknown_event__R0005.md` fixture demonstrates how the spine behaves when the outcome cannot be predicted.
- It is **enqueued** every time, but the script explicitly **skips** it during `--compare` to avoid false negatives.
- Only rely on it for exploratory runs that should not block deterministic checks.

## Troubleshooting

- If the watcher never drains `mailroom/inbox/queued`, inspect `mailroom/logs/` and ensure the watcher is running (see `surfaces/verify/agent-status.sh`).
- When hashes mismatch, compare `mailroom/outbox/${run_key}__RESULT.md` manually, normalize timestamps via `./surfaces/verify/replay-test.sh --compare` output, and inspect receipts under `receipts/sessions/`.
- Always commit the fixture, the new baseline hash, and the receipt proving the comparison passed.
