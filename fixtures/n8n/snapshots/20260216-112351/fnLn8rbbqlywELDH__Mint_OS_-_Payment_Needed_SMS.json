{
  "id": "fnLn8rbbqlywELDH",
  "name": "Mint OS - Payment Needed SMS",
  "active": true,
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "mint-payment-needed-sms",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        250,
        300
      ],
      "webhookId": "mint-payment-needed-sms-webhook"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ received: true, order: $json.data?.visual_id, sms_sent: $json.sms_sent || false }) }}",
        "options": {}
      },
      "id": "respond-ok",
      "name": "Respond OK",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        1100,
        400
      ]
    },
    {
      "parameters": {
        "conditions": {
          "conditions": [
            {
              "id": "check-phone",
              "leftValue": "={{ $json.data?.customer?.phone }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            },
            {
              "id": "check-balance",
              "leftValue": "={{ $json.data?.order_summary?.balance_due }}",
              "rightValue": "0",
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-conditions",
      "name": "Has Phone & Balance Due?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        450,
        300
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "customer-phone",
              "name": "customer_phone",
              "type": "string",
              "value": "={{ $json.data.customer.phone.replace(/[^0-9+]/g, '') }}"
            },
            {
              "id": "customer-name",
              "name": "customer_name",
              "type": "string",
              "value": "={{ $json.data.customer.first_name || 'there' }}"
            },
            {
              "id": "order-number",
              "name": "order_number",
              "type": "string",
              "value": "={{ $json.data.visual_id }}"
            },
            {
              "id": "balance-due",
              "name": "balance_due",
              "type": "string",
              "value": "={{ '$' + Number($json.data.order_summary.balance_due).toFixed(2) }}"
            },
            {
              "id": "payment-link",
              "name": "payment_link",
              "type": "string",
              "value": "={{ 'https://mintprints.ronny.works/pay/' + $json.data.id }}"
            }
          ]
        },
        "options": {}
      },
      "id": "set-variables",
      "name": "Set SMS Variables",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        650,
        200
      ]
    },
    {
      "parameters": {
        "from": "+15619335513",
        "to": "={{ $json.customer_phone }}",
        "message": "=Hi {{ $json.customer_name }}! Your Mint Prints order #{{ $json.order_number }} has a balance due of {{ $json.balance_due }}. Pay online: {{ $json.payment_link }} or call (561) 502-6030. Reply STOP to opt out."
      },
      "id": "send-sms",
      "name": "Send Payment SMS",
      "type": "n8n-nodes-base.twilio",
      "typeVersion": 1,
      "position": [
        850,
        200
      ],
      "credentials": {
        "twilioApi": {
          "id": "M31BGs4LTs73juOs",
          "name": "Twilio Mint Prints"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "sms-sent",
              "name": "sms_sent",
              "type": "boolean",
              "value": true
            }
          ]
        },
        "options": {}
      },
      "id": "mark-sent",
      "name": "Mark SMS Sent",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1050,
        200
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "sms-sent",
              "name": "sms_sent",
              "type": "boolean",
              "value": false
            }
          ]
        },
        "options": {}
      },
      "id": "log-skip",
      "name": "No Phone/Balance - Skip",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        650,
        400
      ]
    }
  ],
  "connections": {
    "Webhook Trigger": {
      "main": [
        [
          {
            "node": "Has Phone & Balance Due?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Phone & Balance Due?": {
      "main": [
        [
          {
            "node": "Set SMS Variables",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Phone/Balance - Skip",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set SMS Variables": {
      "main": [
        [
          {
            "node": "Send Payment SMS",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Payment SMS": {
      "main": [
        [
          {
            "node": "Mark SMS Sent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mark SMS Sent": {
      "main": [
        [
          {
            "node": "Respond OK",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "No Phone/Balance - Skip": {
      "main": [
        [
          {
            "node": "Respond OK",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  }
}
