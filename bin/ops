#!/usr/bin/env bash
# Main dispatcher for ops governance helpers
set -eo pipefail

# Resolve symlinks to get actual script directory
SCRIPT_SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SCRIPT_SOURCE" ]; do
  SCRIPT_SOURCE="$(readlink "$SCRIPT_SOURCE")"
done
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_SOURCE")" && pwd)"

COMMAND="${1:-help}"
shift || true

case "$COMMAND" in
  agent)     source "$SCRIPT_DIR/../ops/commands/agent.sh" "$@" ;;
  start)
    source "$SCRIPT_DIR/../ops/commands/start.sh" "$@"
    ;;
  preflight)
    source "$SCRIPT_DIR/../ops/commands/preflight.sh" "$@"
    ;;
  lane)
    source "$SCRIPT_DIR/../ops/commands/lane.sh" "$@"
    ;;
  verify)
    source "$SCRIPT_DIR/../ops/commands/verify.sh" "$@"
    ;;
  pr)
    source "$SCRIPT_DIR/../ops/commands/pr.sh" "$@"
    ;;
  close)
    source "$SCRIPT_DIR/../ops/commands/close.sh" "$@"
    ;;
  ai)
    source "$SCRIPT_DIR/../ops/commands/ai.sh" "$@"
    ;;
  run)
    source "$SCRIPT_DIR/../ops/commands/run.sh" "$@"
    ;;
  cap)
    source "$SCRIPT_DIR/../ops/commands/cap.sh" "$@"
    ;;
  loops)
    source "$SCRIPT_DIR/../ops/commands/loops.sh" "$@"
    ;;
  *)
    echo "ops - governance-aware operations helper"
    echo
    echo "Usage:"
    echo "  ops run [opts]       Enqueue work into mailroom (--file, --fixture, --inline)"
    echo "  ops cap <cmd>        Execute governed capabilities (list, run, show)"
    echo "  ops loops <cmd>      Open Loop Engine (list, collect, close, summary)"
    echo "  ops start <issue>    Create per-issue worktree + session docs"
    echo "  ops preflight        Print governance banner + service registry hints"
    echo "  ops lane <name>      Show lane header (builder|runner|clerk)"
    echo "  ops verify           Health-check services declared in SERVICE_REGISTRY.yaml"
    echo "  ops pr [...args]     Stage/commit/push changes and open a PR for issue"
    echo "  ops close [issue]    Run verify, confirm PR merged, update state, close issue"
    echo "  ops ai [--bundle X]  Bundle governance docs for AI agents"
    echo
    echo "Current directory resolved to: $SCRIPT_DIR"
    exit 1
    ;;
esac
