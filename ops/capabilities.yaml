# ═══════════════════════════════════════════════════════════════════════════
# Capability Registry - Governed actions the spine can execute
# ═══════════════════════════════════════════════════════════════════════════
#
# Each capability is an allowed action with:
#   - name: unique identifier
#   - command: what to run
#   - safety: read-only | mutating | destructive
#   - approval: auto | manual
#   - description: what it does
#
# Rule: Only capabilities listed here can be executed via `ops cap run`
# ═══════════════════════════════════════════════════════════════════════════

version: "1.0"
updated: "2026-02-07"

capabilities:

  # ─────────────────────────────────────────────────────────────────────────
  # SPINE HEALTH (always safe)
  # ─────────────────────────────────────────────────────────────────────────

  spine.verify:
    description: "Run drift gates to verify spine health"
    command: "./surfaces/verify/drift-gate.sh"
    cwd: "$SPINE_REPO"
    safety: read-only
    approval: auto
    outputs: ["stdout"]

  spine.replay:
    description: "Run replay test to verify determinism"
    command: "./surfaces/verify/replay-test.sh --compare"
    cwd: "$SPINE_REPO"
    safety: read-only
    approval: auto
    outputs: ["stdout"]

  spine.status:
    description: "Show watcher and queue status"
    command: "./ops/runtime/inbox/agent-status.sh"
    cwd: "$SPINE_REPO"
    safety: read-only
    approval: auto
    outputs: ["stdout"]

  spine.watcher.status:
    description: "Canonical watcher status (launchd + PID + lock + queue counts)"
    command: "./ops/runtime/inbox/agent-status.sh"
    cwd: "$SPINE_REPO"
    safety: read-only
    approval: auto
    outputs: ["stdout"]

  spine.watcher.restart:
    description: "Restart the canonical launchd watcher (bootout + bootstrap)"
    command: "./ops/runtime/inbox/agent-restart.sh"
    cwd: "$SPINE_REPO"
    safety: mutating
    approval: manual
    outputs: ["stdout"]

  loops.status:
    description: "Open loop ledger summary (open/closed counts)."
    command: "./ops/plugins/loops/bin/loops-status"
    cwd: "$SPINE_REPO"
    safety: read-only
    approval: auto
    outputs: ["stdout"]

  loops.reconcile:
    description: "Reconcile stale run-failure loops with superseding pass receipts (conservative auto-close)."
    command: "./ops/plugins/loops/bin/loops-reconcile --execute"
    cwd: "$SPINE_REPO"
    safety: mutating
    approval: manual
    requires:
      - loops.status
    outputs: ["stdout"]

  # ─────────────────────────────────────────────────────────────────────────
  # MONOLITH READ (safe exploration)
  # ─────────────────────────────────────────────────────────────────────────

  monolith.tree:
    description: "List directory structure of allowed paths"
    command: "ls -la"
    cwd: "$HOME/Code"
    safety: read-only
    approval: auto
    args:
      - name: path
        required: false
        default: "."
        validate: "^[a-zA-Z0-9_./-]+$"
    outputs: ["stdout"]

  monolith.search:
    description: "Search code with ripgrep"
    command: "rg"
    cwd: "$HOME/Code"
    safety: read-only
    approval: auto
    args:
      - name: pattern
        required: true
      - name: path
        required: false
        default: "."
    outputs: ["stdout"]

  monolith.git_status:
    description: "Show git status of a repo"
    command: "git status"
    cwd: "$HOME/Code"
    safety: read-only
    approval: auto
    args:
      - name: repo
        required: false
        default: "agentic-spine"
    outputs: ["stdout"]

  # ─────────────────────────────────────────────────────────────────────────
  # INFRASTRUCTURE (read-only checks)
  # ─────────────────────────────────────────────────────────────────────────

  infra.docker_ps:
    description: "List running Docker containers"
    command: "docker ps --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}'"
    safety: read-only
    approval: auto
    outputs: ["stdout"]


  secrets.status:
    description: "Check secrets configuration presence (no values, no network). Fails if not configured."
    command: "./ops/plugins/secrets/bin/secrets-status"
    cwd: "$SPINE_REPO"
    safety: read-only
    approval: auto
    outputs: ["stdout"]
  infra.gh_issue:
    description: "Get GitHub issue details"
    command: "gh issue view"
    safety: read-only
    approval: auto
    args:
      - name: issue_number
        required: true
        validate: "^[0-9]+$"
    outputs: ["stdout"]


  secrets.binding:
    description: "Print non-secret secrets provider binding (SSOT). STOP if incomplete."
    command: "./ops/plugins/secrets/bin/secrets-binding"
    cwd: "$SPINE_REPO"
    safety: read-only
    approval: auto
    outputs: ["stdout"]

  secrets.auth.status:
    description: "Check secrets auth presence for Infisical (NO values). STOP if missing."
    command: "./ops/plugins/secrets/bin/secrets-auth-status"
    cwd: "$SPINE_REPO"
    safety: read-only
    approval: auto
    outputs: ["stdout"]

  secrets.auth.load:
    description: "Validate Infisical Universal Auth creds file exists + perms; print one-liner to source it. Does NOT store secrets."
    command: "./ops/plugins/secrets/bin/secrets-auth-load"
    cwd: "$SPINE_REPO"
    safety: read-only
    approval: auto
    outputs: ["stdout"]

  secrets.projects.status:
    description: "Compare SSOT inventory vs live Infisical projects. Reports parity deltas (names only, no secrets)."
    command: "./ops/plugins/secrets/bin/secrets-projects-status"
    cwd: "$SPINE_REPO"
    safety: read-only
    approval: auto
    requires:
      - secrets.binding
      - secrets.auth.status
    outputs: ["stdout"]

  secrets.inventory.status:
    description: "Read-only SSOT inventory (project names + counts). No network, no secrets values."
    command: "./ops/plugins/secrets/bin/secrets-inventory-status"
    cwd: "$SPINE_REPO"
    safety: read-only
    approval: auto
    outputs: ["stdout"]

  secrets.cli.status:
    description: "Hash parity check: canonical (spine) vs vendored (workbench) infisical-agent.sh."
    command: "./ops/plugins/secrets/bin/secrets-cli-status"
    cwd: "$SPINE_REPO"
    safety: read-only
    approval: auto
    outputs: ["stdout"]

  # ─────────────────────────────────────────────────────────────────────────
  # FUTURE: MUTATING (require manual approval)
  # ─────────────────────────────────────────────────────────────────────────


  secrets.exec:
    description: "Run a command with secrets injected (Infisical). Requires secrets.binding + secrets.auth.status OK."
    command: "./ops/plugins/secrets/bin/secrets-exec"
    cwd: "$SPINE_REPO"
    safety: mutating
    approval: operator
    outputs: ["stdout", "stderr"]
  # git.commit:
  #   description: "Create a git commit"
  #   command: "git commit -m"
  #   safety: mutating
  #   approval: manual
  #   args:
  #     - name: message
  #       required: true
  #   outputs: ["stdout"]

  # ─────────────────────────────────────────────────────────────────────────
  # CLOUDFLARE (read-only status checks)
  # ─────────────────────────────────────────────────────────────────────────

  cloudflare.status:
    description: "Read-only Cloudflare status (zones + DNS record counts; no values)."
    command: "./ops/plugins/cloudflare/bin/cloudflare-status"
    cwd: "$SPINE_REPO"
    safety: read-only
    approval: auto
    requires:
      - secrets.binding
      - secrets.auth.status
      - secrets.projects.status
    outputs: ["stdout"]

  cloudflare.dns.status:
    description: "DNS record counts per bound zone (read-only)."
    command: "./ops/plugins/cloudflare/bin/cloudflare-dns-status"
    cwd: "$SPINE_REPO"
    safety: read-only
    approval: auto
    requires:
      - secrets.binding
      - secrets.auth.status
      - secrets.projects.status
    outputs: ["stdout"]

  cloudflare.tunnel.status:
    description: "Tunnel inventory + creation timestamps for bound tunnels."
    command: "./ops/plugins/cloudflare/bin/cloudflare-tunnel-status"
    cwd: "$SPINE_REPO"
    safety: read-only
    approval: auto
    requires:
      - secrets.binding
      - secrets.auth.status
      - secrets.projects.status
    outputs: ["stdout"]

  cloudflare.inventory.sync:
    description: "Verify cloudflare.inventory metadata matches live zones/tunnels."
    command: "./ops/plugins/cloudflare/bin/cloudflare-inventory-sync"
    cwd: "$SPINE_REPO"
    safety: read-only
    approval: auto
    requires:
      - secrets.binding
      - secrets.auth.status
      - secrets.projects.status
    outputs: ["stdout"]

  # ─────────────────────────────────────────────────────────────────────────
  # GITHUB (read-only repo health)
  # ─────────────────────────────────────────────────────────────────────────

  github.status:
    description: "Read-only GitHub repo health (branch, HEAD, clean, tags)."
    command: "./ops/plugins/github/bin/github-status"
    cwd: "$SPINE_REPO"
    safety: read-only
    approval: auto
    requires:
      - secrets.binding
      - secrets.auth.status
      - secrets.projects.status
    outputs: ["stdout"]

  github.queue.status:
    description: "GitHub queue counts (open PRs + open issues). Read-only, counts only."
    command: "./ops/plugins/github/bin/github-queue-status"
    cwd: "$SPINE_REPO"
    safety: read-only
    approval: auto
    requires:
      - secrets.binding
      - secrets.auth.status
      - secrets.projects.status
    outputs: ["stdout"]

  github.actions.status:
    description: "GitHub Actions workflow run counts + latest conclusion. Read-only, no names/URLs."
    command: "./ops/plugins/github/bin/github-actions-status"
    cwd: "$SPINE_REPO"
    safety: read-only
    approval: auto
    requires:
      - secrets.binding
      - secrets.auth.status
      - secrets.projects.status
    outputs: ["stdout"]

  github.labels.status:
    description: "GitHub label parity (declared vs live). Read-only, counts + delta."
    command: "./ops/plugins/github/bin/github-labels-status"
    cwd: "$SPINE_REPO"
    safety: read-only
    approval: auto
    outputs: ["stdout"]

  # ─────────────────────────────────────────────────────────────────────────
  # SSH (read-only connectivity checks)
  # ─────────────────────────────────────────────────────────────────────────

  ssh.target.status:
    description: "Connectivity status for declared SSH targets (read-only, no prompts, no known_hosts writes)."
    command: "./ops/plugins/ssh/bin/ssh-target-status"
    cwd: "$SPINE_REPO"
    safety: read-only
    approval: auto
    outputs: ["stdout"]

  nodes.status:
    description: "Node/VM reachability across Tier 1-3 estate (alias for ssh.target.status)."
    command: "./ops/plugins/ssh/bin/ssh-target-status"
    cwd: "$SPINE_REPO"
    safety: read-only
    approval: auto
    outputs: ["stdout"]

  # ─────────────────────────────────────────────────────────────────────────
  # DOCKER (read-only compose status)
  # ─────────────────────────────────────────────────────────────────────────

  docker.compose.status:
    description: "Read-only docker compose status per stack (no restarts, no deploys)."
    command: "./ops/plugins/docker/bin/docker-compose-status"
    cwd: "$SPINE_REPO"
    safety: read-only
    approval: auto
    outputs: ["stdout"]

  # ─────────────────────────────────────────────────────────────────────────
  # BACKUP (read-only inventory status)
  # ─────────────────────────────────────────────────────────────────────────

  # ─────────────────────────────────────────────────────────────────────────
  # SERVICES (read-only HTTP health probes)
  # ─────────────────────────────────────────────────────────────────────────

  services.health.status:
    description: "Read-only HTTP health probe for declared service endpoints (no auth, no verbose)."
    command: "./ops/plugins/services/bin/services-health-status"
    cwd: "$SPINE_REPO"
    safety: read-only
    approval: auto
    outputs: ["stdout"]

  backup.status:
    description: "Read-only backup inventory status (file_glob only, freshness + reason codes)."
    command: "./ops/plugins/backup/bin/backup-status"
    cwd: "$SPINE_REPO"
    safety: read-only
    approval: auto
    # NOTE: No requires - script handles SSH errors per-target with reason codes.
    # Run ssh.target.status separately if you need pre-flight SSH connectivity check.
    outputs: ["stdout"]

  # ─────────────────────────────────────────────────────────────────────────
  # HOST (read-only home/config/entrypoint drift audit)
  # ─────────────────────────────────────────────────────────────────────────

  host.drift.audit:
    description: "Audit host-level drift across active configs, launchd entrypoints, and home output sinks."
    command: "./ops/plugins/host/bin/host-drift-audit"
    cwd: "$SPINE_REPO"
    safety: read-only
    approval: auto
    outputs: ["stdout"]

  # ─────────────────────────────────────────────────────────────────────────
  # DOCS (workbench infrastructure extraction tracking)
  # ─────────────────────────────────────────────────────────────────────────

  docs.status:
    description: "Verify workbench infrastructure docs extraction integrity (file counts per dir)."
    command: "./ops/plugins/docs/bin/docs-status"
    cwd: "$SPINE_REPO"
    safety: read-only
    approval: auto
    outputs: ["stdout"]

  infra.extraction.status:
    description: "Track infrastructure extraction coverage into workbench (23 asset groups, % complete)."
    command: "./ops/plugins/docs/bin/infra-extraction-status"
    cwd: "$SPINE_REPO"
    safety: read-only
    approval: auto
    outputs: ["stdout"]

  docs.lint:
    description: "Lint spine docs hierarchy: folder placement, metadata headers, README registration, legacy isolation."
    command: "./ops/plugins/docs/bin/docs-lint"
    cwd: "$SPINE_REPO"
    safety: read-only
    approval: auto
    outputs: ["stdout"]

  mcp.inventory.status:
    description: "Validate workbench MCP inventory vs MCPJungle configs (read-only)."
    command: "./ops/plugins/mcp/bin/mcp-inventory-status"
    cwd: "$SPINE_REPO"
    safety: read-only
    approval: auto
    outputs: ["stdout"]

  # ─────────────────────────────────────────────────────────────────────────
  # INFRA RELOCATION (read-only VM/service move governance)
  # ─────────────────────────────────────────────────────────────────────────

  infra.placement.policy:
    description: "Canonical placement policy check (site/hypervisor/vmid/service target enforcement)."
    command: "./ops/plugins/infra/bin/infra-placement-policy-check --check all"
    cwd: "$SPINE_REPO"
    safety: read-only
    approval: auto
    outputs: ["stdout"]

  infra.hypervisor.identity:
    description: "Verify proxmox host identity uniqueness (id/hostname/machine-id) to prevent wrong-host execution."
    command: "./ops/plugins/infra/bin/infra-hypervisor-identity-status"
    cwd: "$SPINE_REPO"
    safety: read-only
    approval: auto
    outputs: ["stdout"]

  infra.hypervisor.hostname.set:
    description: "Set canonical hostname for a proxmox host-id (dry-run by default, --execute to mutate)."
    command: "./ops/plugins/infra/bin/infra-hypervisor-hostname-set"
    cwd: "$SPINE_REPO"
    safety: mutating
    approval: manual
    requires:
      - infra.placement.policy
    outputs: ["stdout"]

  infra.relocation.preflight:
    description: "Pre-flight check: host reachability + health baseline for relocation manifest."
    command: "./ops/plugins/infra/bin/infra-relocation-preflight"
    cwd: "$SPINE_REPO"
    safety: read-only
    approval: auto
    outputs: ["stdout"]

  infra.relocation.parity:
    description: "Verify cross-SSOT parity + canonical placement policy for relocation manifest."
    command: "./ops/plugins/infra/bin/infra-relocation-parity"
    cwd: "$SPINE_REPO"
    safety: read-only
    approval: auto
    outputs: ["stdout"]

  infra.relocation.impact:
    description: "Print required docs/bindings/gates delta matrix for current relocation."
    command: "./ops/plugins/infra/bin/infra-relocation-impact"
    cwd: "$SPINE_REPO"
    safety: read-only
    approval: auto
    outputs: ["stdout"]

  infra.relocation.rollback.plan:
    description: "Generate deterministic rollback checklist and commands for current relocation."
    command: "./ops/plugins/infra/bin/infra-relocation-rollback"
    cwd: "$SPINE_REPO"
    safety: read-only
    approval: auto
    outputs: ["stdout"]

  infra.vm.provision:
    description: "Provision Proxmox VM from relocation target/profile (dry-run by default, --execute to mutate)."
    command: "./ops/plugins/infra/bin/infra-vm-provision"
    cwd: "$SPINE_REPO"
    safety: mutating
    approval: manual
    requires:
      - infra.placement.policy
      - infra.hypervisor.identity
      - infra.relocation.preflight
      - infra.relocation.parity
    outputs: ["stdout"]

  infra.vm.bootstrap:
    description: "Bootstrap a provisioned VM to spine-ready profile baseline (dry-run by default, --execute to mutate)."
    command: "./ops/plugins/infra/bin/infra-vm-bootstrap"
    cwd: "$SPINE_REPO"
    safety: mutating
    approval: manual
    requires:
      - infra.placement.policy
      - infra.hypervisor.identity
      - infra.relocation.preflight
    outputs: ["stdout"]

  infra.relocation.state.transition:
    description: "Controlled relocation state transition + vm_targets status/IP update (dry-run by default, --execute to mutate)."
    command: "./ops/plugins/infra/bin/infra-relocation-state-transition"
    cwd: "$SPINE_REPO"
    safety: mutating
    approval: manual
    requires:
      - infra.placement.policy
      - infra.hypervisor.identity
      - infra.relocation.parity
    outputs: ["stdout"]

  infra.relocation.service.transition:
    description: "Controlled service status update within relocation manifest (dry-run by default, --execute to mutate)."
    command: "./ops/plugins/infra/bin/infra-relocation-service-transition"
    cwd: "$SPINE_REPO"
    safety: mutating
    approval: manual
    requires:
      - infra.placement.policy
      - infra.hypervisor.identity
      - infra.relocation.parity
    outputs: ["stdout"]

  infra.relocation.promote:
    description: "Promotion gate runner: validates soak health checks, then promotes service from cutover to migrated with full gate verification (dry-run by default, --execute to mutate)."
    command: "./ops/plugins/infra/bin/infra-relocation-promote"
    cwd: "$SPINE_REPO"
    safety: mutating
    approval: manual
    requires:
      - infra.placement.policy
      - infra.hypervisor.identity
      - infra.relocation.parity
    outputs: ["stdout"]

  infra.vm.ready.status:
    description: "Read-only readiness report for relocation VM target (running + ssh + tailscale + profile checks)."
    command: "./ops/plugins/infra/bin/infra-vm-ready-status"
    cwd: "$SPINE_REPO"
    safety: read-only
    approval: auto
    outputs: ["stdout"]

  # ─────────────────────────────────────────────────────────────
  # BUDGET (read-only token budget diagnostics)
  # ─────────────────────────────────────────────────────────────

  budget.check:
    description: "Check token budget against a receipt (read-only diagnostic)."
    command: "./ops/plugins/budget/bin/budget"
    cwd: "$SPINE_REPO"
    safety: read-only
    approval: auto
    outputs: ["stdout"]

  # ─────────────────────────────────────────────────────────────────────────
  # MAKER (digital-to-physical toolkit)
  # ─────────────────────────────────────────────────────────────────────────

  maker.tools.status:
    description: "Read-only maker tools inventory probe (installed/missing/hardware status)."
    command: "./ops/plugins/maker/bin/maker-tools-status"
    cwd: "$SPINE_REPO"
    safety: read-only
    approval: auto
    outputs: ["stdout"]

  maker.qr.generate:
    description: "Generate QR code (PNG/SVG/terminal) to mailroom/outbox/maker/."
    command: "./ops/plugins/maker/bin/maker-qr-generate"
    cwd: "$SPINE_REPO"
    safety: mutating
    approval: manual
    requires:
      - maker.tools.status
    outputs: ["stdout"]

  maker.label.print:
    description: "Print label to Brother QL thermal printer (requires hardware)."
    command: "./ops/plugins/maker/bin/maker-label-print"
    cwd: "$SPINE_REPO"
    safety: mutating
    approval: manual
    requires:
      - maker.tools.status
    outputs: ["stdout"]

# ═══════════════════════════════════════════════════════════════════════════
# Safety Levels
# ═══════════════════════════════════════════════════════════════════════════
#
# read-only:   Cannot modify state. Safe to run autonomously.
# mutating:    Modifies state but is recoverable. Requires receipt.
# destructive: Cannot be undone. Requires manual approval + confirmation.
#
# ═══════════════════════════════════════════════════════════════════════════
