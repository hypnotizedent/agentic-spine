#!/usr/bin/env bash
# RAG Remote Dependency Probe
# Validates dependency reachability and timing from the runner host (VM207) perspective.
set -euo pipefail

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
git_root="$(git -C "$script_dir" rev-parse --show-toplevel 2>/dev/null || true)"
if [[ -n "${git_root:-}" && "${git_root:-}" != "null" ]]; then
  SP="${SPINE_ROOT:-$git_root}"
else
  SP="${SPINE_ROOT:-$(cd "$script_dir/../../../.." && pwd)}"
fi

RUNNER_BINDING="$SP/ops/bindings/rag.remote.runner.yaml"
QUALITY_BINDING="$SP/ops/bindings/rag.reindex.quality.yaml"

fail() { echo "FAIL: $*" >&2; exit 1; }
warn() { echo "WARN: $*"; }
pass() { echo "PASS: $*"; }

for t in yq ssh; do
  command -v "$t" >/dev/null 2>&1 || fail "missing required tool: $t"
done

[[ -f "$RUNNER_BINDING" ]] || fail "runner binding not found: $RUNNER_BINDING"
[[ -f "$QUALITY_BINDING" ]] || fail "quality binding not found: $QUALITY_BINDING"

# Read runner binding
REMOTE_HOST="$(yq -r '.remote.host // ""' "$RUNNER_BINDING")"
REMOTE_USER="$(yq -r '.remote.user // ""' "$RUNNER_BINDING")"
REMOTE_PORT="$(yq -r '.remote.port // 22' "$RUNNER_BINDING")"
ANYTHINGLLM_URL="$(yq -r '.sync.anythingllm_url // "http://localhost:3002"' "$RUNNER_BINDING")"
QDRANT_URL="$(yq -r '.sync.qdrant_url // "http://localhost:6333"' "$RUNNER_BINDING")"
OLLAMA_URL="$(yq -r '.sync.ollama_url // "http://192.168.1.110:11434"' "$RUNNER_BINDING")"

# Read quality SLOs
ANYTHINGLLM_SLO="$(yq -r '.dependency_slos.anythingllm_ping_ms // 500' "$QUALITY_BINDING")"
QDRANT_SLO="$(yq -r '.dependency_slos.qdrant_healthz_ms // 100' "$QUALITY_BINDING")"
OLLAMA_SLO="$(yq -r '.dependency_slos.ollama_tags_ms // 1000' "$QUALITY_BINDING")"

[[ -n "$REMOTE_HOST" ]] || fail ".remote.host missing"
[[ -n "$REMOTE_USER" ]] || fail ".remote.user missing"

TARGET="${REMOTE_USER}@${REMOTE_HOST}"
SSH_ARGS=(-o BatchMode=yes -o ConnectTimeout=10 -p "$REMOTE_PORT")

echo "=== RAG Remote Dependency Probe ==="
echo "target:       $TARGET"
echo "perspective:  VM207 (runner host)"
echo

ERRORS=0
SLO_VIOLATIONS=0

probe_endpoint() {
  local name="$1"
  local url="$2"
  local slo_ms="$3"
  
  echo -n "  $name ($url)... "
  
  result="$(ssh "${SSH_ARGS[@]}" "$TARGET" "
    start=\$(date +%s%3N)
    code=\$(curl -sS -o /dev/null -w '%{http_code}' --max-time 10 '$url' 2>/dev/null || echo '000')
    end=\$(date +%s%3N)
    elapsed=\$((end - start))
    echo \"\$code \$elapsed\"
  " 2>/dev/null || echo "000 99999")"
  
  code="$(echo "$result" | awk '{print $1}')"
  elapsed="$(echo "$result" | awk '{print $2}')"
  
  if [[ "$code" != "200" ]]; then
    echo "FAIL (HTTP $code, ${elapsed}ms)"
    ERRORS=$((ERRORS + 1))
    return 1
  fi
  
  if [[ "$elapsed" -gt "$slo_ms" ]]; then
    echo "SLOW (HTTP $code, ${elapsed}ms > ${slo_ms}ms SLO)"
    SLO_VIOLATIONS=$((SLO_VIOLATIONS + 1))
    return 1
  fi
  
  echo "OK (HTTP $code, ${elapsed}ms <= ${slo_ms}ms SLO)"
  return 0
}

echo "Dependency Probes:"
echo "------------------"

# Probe AnythingLLM
anythingllm_ping_url="${ANYTHINGLLM_URL}/api/ping"
probe_endpoint "AnythingLLM" "$anythingllm_ping_url" "$ANYTHINGLLM_SLO" || true

# Probe Qdrant
qdrant_healthz_url="${QDRANT_URL}/healthz"
probe_endpoint "Qdrant" "$qdrant_healthz_url" "$QDRANT_SLO" || true

# Probe Ollama
ollama_tags_url="${OLLAMA_URL}/api/tags"
probe_endpoint "Ollama" "$ollama_tags_url" "$OLLAMA_SLO" || true

echo
echo "=== Probe Summary ==="
echo "  SLO thresholds: AnythingLLM=${ANYTHINGLLM_SLO}ms, Qdrant=${QDRANT_SLO}ms, Ollama=${OLLAMA_SLO}ms"
echo

if [[ "$ERRORS" -gt 0 ]]; then
  fail "$ERRORS dependency probe(s) failed (unreachable)"
elif [[ "$SLO_VIOLATIONS" -gt 0 ]]; then
  warn "$SLO_VIOLATIONS dependency probe(s) exceeded SLO threshold"
  exit 0  # SLO violations are warnings, not failures
else
  pass "All dependency probes within SLO"
fi
