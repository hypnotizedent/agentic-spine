#!/usr/bin/env bash
# Stop detached/server-side RAG reindex runner.
# Default is dry-run. Use --execute to stop the remote tmux session.
set -euo pipefail

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
git_root="$(git -C "$script_dir" rev-parse --show-toplevel 2>/dev/null || true)"
if [[ -n "${git_root:-}" && "${git_root:-}" != "null" ]]; then
  SP="${SPINE_ROOT:-$git_root}"
else
  SP="${SPINE_ROOT:-$(cd "$script_dir/../../../.." && pwd)}"
fi

BINDING="$SP/ops/bindings/rag.remote.runner.yaml"
fail() { echo "FAIL: $*" >&2; exit 1; }

EXECUTE=0
CLEAR_CHECKPOINT=0
while [[ $# -gt 0 ]]; do
  case "$1" in
    --execute)
      EXECUTE=1
      shift
      ;;
    --clear-checkpoint)
      CLEAR_CHECKPOINT=1
      shift
      ;;
    -h|--help)
      cat <<'EOF'
Usage:
  rag-reindex-remote-stop [--execute] [--clear-checkpoint]

Default:
  dry-run only (no remote mutation)
EOF
      exit 0
      ;;
    *)
      fail "Unknown arg: $1"
      ;;
  esac
done

for t in yq ssh; do
  command -v "$t" >/dev/null 2>&1 || fail "missing required tool: $t"
done
[[ -f "$BINDING" ]] || fail "binding not found: $BINDING"

read_binding() { yq -r "$1 // \"\"" "$BINDING"; }
REMOTE_HOST="$(read_binding '.remote.host')"
REMOTE_USER="$(read_binding '.remote.user')"
REMOTE_PORT="$(read_binding '.remote.port')"
TMUX_SESSION="$(read_binding '.remote.tmux_session')"
REMOTE_CHECKPOINT="$(read_binding '.remote.checkpoint_path')"

[[ -n "$REMOTE_HOST" ]] || fail ".remote.host missing in binding"
[[ -n "$REMOTE_USER" ]] || fail ".remote.user missing in binding"
[[ -n "$TMUX_SESSION" ]] || fail ".remote.tmux_session missing in binding"
[[ -n "$REMOTE_CHECKPOINT" ]] || fail ".remote.checkpoint_path missing in binding"

if [[ -z "$REMOTE_PORT" || "$REMOTE_PORT" == "null" ]]; then
  REMOTE_PORT="22"
fi
if ! [[ "$REMOTE_PORT" =~ ^[0-9]+$ ]]; then
  fail ".remote.port must be an integer (got: $REMOTE_PORT)"
fi

TARGET="${REMOTE_USER}@${REMOTE_HOST}"
SSH_ARGS=(-o BatchMode=yes -o ConnectTimeout=10 -p "$REMOTE_PORT")

if ! ssh "${SSH_ARGS[@]}" "$TARGET" "echo remote-ok >/dev/null"; then
  fail "cannot reach remote target $TARGET via ssh"
fi

running=0
if ssh "${SSH_ARGS[@]}" "$TARGET" "tmux has-session -t '$TMUX_SESSION' 2>/dev/null"; then
  running=1
fi

if [[ "$EXECUTE" -ne 1 ]]; then
  echo "DRY-RUN: remote reindex stop plan"
  echo "  target:       $TARGET"
  echo "  tmux_session: $TMUX_SESSION"
  if [[ "$running" -eq 1 ]]; then
    echo "  session:      RUNNING (would stop)"
  else
    echo "  session:      STOPPED (nothing to stop)"
  fi
  if [[ "$CLEAR_CHECKPOINT" -eq 1 ]]; then
    echo "  checkpoint:   would delete $REMOTE_CHECKPOINT"
  fi
  echo
  echo "To execute:"
  echo "  ./bin/ops cap run rag.reindex.remote.stop --execute"
  exit 0
fi

if [[ "$running" -eq 1 ]]; then
  ssh "${SSH_ARGS[@]}" "$TARGET" "tmux kill-session -t '$TMUX_SESSION'"
  echo "STOPPED: tmux session '$TMUX_SESSION' on $TARGET"
else
  echo "NOOP: tmux session '$TMUX_SESSION' not running on $TARGET"
fi

if [[ "$CLEAR_CHECKPOINT" -eq 1 ]]; then
  ssh "${SSH_ARGS[@]}" "$TARGET" "rm -f '$REMOTE_CHECKPOINT'"
  echo "CLEARED: checkpoint $REMOTE_CHECKPOINT"
fi

