#!/usr/bin/env bash
# anythingllm-tune - Tune AnythingLLM runtime settings on ai-consolidation (VM 207)
#
# Current use: ensure chat LLM model is fast/stable by pinning Ollama model to phi3:mini.
# This is a remote mutation (edits compose + recreates container) and must be receipted.
#
# Usage:
#   anythingllm-tune [--target ai-consolidation] [--stack ai-consolidation] [--model phi3:mini]
#
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SPINE_ROOT="${SPINE_ROOT:-$(cd "$SCRIPT_DIR/../../../.." && pwd)}"
BINDING="$SPINE_ROOT/ops/bindings/docker.compose.targets.yaml"
SSH_BINDING="$SPINE_ROOT/ops/bindings/ssh.targets.yaml"

stop(){ echo "STOP (2): $*" >&2; exit 2; }

command -v yq >/dev/null 2>&1 || stop "missing dependency: yq"
command -v ssh >/dev/null 2>&1 || stop "missing dependency: ssh"

[[ -f "$BINDING" ]] || stop "missing binding: $BINDING"
[[ -f "$SSH_BINDING" ]] || stop "missing binding: $SSH_BINDING"

TARGET="ai-consolidation"
STACK="ai-consolidation"
MODEL="phi3:mini"

while [[ $# -gt 0 ]]; do
  case "$1" in
    --target) TARGET="${2:-}"; shift 2;;
    --stack) STACK="${2:-}"; shift 2;;
    --model) MODEL="${2:-}"; shift 2;;
    -h|--help)
      cat <<'EOF'
anythingllm-tune

Usage:
  anythingllm-tune [--target ai-consolidation] [--stack ai-consolidation] [--model phi3:mini]
EOF
      exit 0
      ;;
    *) stop "unknown arg: $1";;
  esac
done

ssh_target_id="$(yq -r ".targets.\"$TARGET\".ssh_target // \"\"" "$BINDING")"
[[ -n "$ssh_target_id" && "$ssh_target_id" != "null" ]] || stop "unknown target (or missing ssh_target): $TARGET"

stack_path="$(yq -r ".targets.\"$TARGET\".stacks[] | select(.name == \"$STACK\") | .path" "$BINDING" 2>/dev/null | head -n1 || true)"
[[ -n "${stack_path:-}" && "${stack_path:-}" != "null" ]] || stop "unknown stack '$STACK' for target '$TARGET' (see $BINDING)"

# Resolve ssh target via binding (no ~/.ssh/config dependency)
DEF_USER="$(yq -r '.ssh.defaults.user // "root"' "$SSH_BINDING")"
DEF_PORT="$(yq -r '.ssh.defaults.port // 22' "$SSH_BINDING")"
DEF_TO="$(yq -r '.ssh.defaults.connect_timeout_sec // 5' "$SSH_BINDING")"
DEF_BATCH="$(yq -r '.ssh.defaults.batch_mode // true' "$SSH_BINDING")"
DEF_STRICT="$(yq -r '.ssh.defaults.strict_host_key_checking // "no"' "$SSH_BINDING")"
DEF_KNOWN_HOSTS="$(yq -r '.ssh.defaults.user_known_hosts_file // "/dev/null"' "$SSH_BINDING")"

ssh_host="$(yq -r ".ssh.targets[] | select(.id == \"$ssh_target_id\") | .host // \"\"" "$SSH_BINDING" 2>/dev/null | head -n1 || true)"
ssh_user="$(yq -r ".ssh.targets[] | select(.id == \"$ssh_target_id\") | .user // \"\"" "$SSH_BINDING" 2>/dev/null | head -n1 || true)"
ssh_port="$(yq -r ".ssh.targets[] | select(.id == \"$ssh_target_id\") | .port // ${DEF_PORT}" "$SSH_BINDING" 2>/dev/null | head -n1 || true)"
ssh_to="$(yq -r ".ssh.targets[] | select(.id == \"$ssh_target_id\") | .connect_timeout_sec // ${DEF_TO}" "$SSH_BINDING" 2>/dev/null | head -n1 || true)"

[[ -n "$ssh_host" && "$ssh_host" != "null" ]] || stop "ssh target '$ssh_target_id' missing in $SSH_BINDING (or host unset)"
[[ -n "$ssh_user" && "$ssh_user" != "null" ]] || ssh_user="$DEF_USER"
[[ -n "$ssh_port" && "$ssh_port" != "null" ]] || ssh_port="$DEF_PORT"
[[ -n "$ssh_to" && "$ssh_to" != "null" ]] || ssh_to="$DEF_TO"

ssh_opts=(
  -o "ConnectTimeout=$ssh_to"
  -o "StrictHostKeyChecking=$DEF_STRICT"
  -o "UserKnownHostsFile=$DEF_KNOWN_HOSTS"
  -o "NumberOfPasswordPrompts=0"
  -o "LogLevel=ERROR"
)
if [[ "$DEF_BATCH" == "true" ]]; then
  ssh_opts+=(-o "BatchMode=yes")
fi

echo "rag.anythingllm.tune"
echo "target: $TARGET (ssh_target=$ssh_target_id ${ssh_user}@${ssh_host}:${ssh_port})"
echo "stack:  $STACK"
echo "path:   $stack_path"
echo "model:  $MODEL"
echo

REMOTE_SCRIPT="$(cat <<'EOS'
set -euo pipefail
PATHX="$1"; shift
MODEL="$1"; shift

case "$PATHX" in
  "~/"*) PATHX="$HOME/${PATHX:2}" ;;
  "~") PATHX="$HOME" ;;
esac

cd "$PATHX"
[[ -f docker-compose.yml ]] || { echo "FAIL: docker-compose.yml missing in $PATHX" >&2; exit 2; }

ts="$(date -u +%Y%m%dT%H%M%SZ)"
cp -a docker-compose.yml "docker-compose.yml.bak.${ts}"

# Remove any prior LLM overrides to keep the patch idempotent.
tmp="$(mktemp)"
grep -vE '^[[:space:]]+LLM_PROVIDER:|^[[:space:]]+LLM_MODEL_PREF:|^[[:space:]]+OLLAMA_MODEL_PREF:' docker-compose.yml > "$tmp"

# Inject LLM model preferences under the anythingllm service's environment block.
# We insert right after EMBEDDING_MODEL_PREF for readability.
out="$(mktemp)"
awk -v model="$MODEL" '
  {print}
  $0 ~ /^[[:space:]]+EMBEDDING_MODEL_PREF:/ {
    print "      LLM_PROVIDER: ollama"
    print "      LLM_MODEL_PREF: " model
    print "      OLLAMA_MODEL_PREF: " model
  }
' "$tmp" > "$out"
mv "$out" docker-compose.yml
rm -f "$tmp"

if ! command -v docker >/dev/null 2>&1; then
  echo "FAIL: docker command missing on host" >&2
  exit 1
fi

DOCKER_CMD=(docker)
if ! docker info >/dev/null 2>&1; then
  if command -v sudo >/dev/null 2>&1 && sudo -n docker info >/dev/null 2>&1; then
    DOCKER_CMD=(sudo -n docker)
  else
    echo "FAIL: docker daemon unreachable (no docker group + no sudo -n)" >&2
    exit 1
  fi
fi

# Recreate AnythingLLM so env changes take effect.
"${DOCKER_CMD[@]}" compose up -d --force-recreate anythingllm

echo "OK: compose patched + anythingllm recreated"
EOS
)"

ssh "${ssh_opts[@]}" -p "$ssh_port" "${ssh_user}@${ssh_host}" \
  "bash -lc $(printf "%q" "$REMOTE_SCRIPT") -- $(printf "%q" "$stack_path") $(printf "%q" "$MODEL")"

