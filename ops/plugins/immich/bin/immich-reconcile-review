#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SPINE_ROOT="${SPINE_ROOT:-$(cd "$SCRIPT_DIR/../../../.." && pwd)}"
SCRIPT_NAME="$(basename "$0")"
PROJECT_ROOT="${IMMICH_PLUGIN_PROJECT_ROOT:-/Users/ronnyworks/code/workbench/agents/immich/spine-plugin-immich/bin}"
PROJECT_SCRIPT="$PROJECT_ROOT/$SCRIPT_NAME"
LEGACY_SCRIPT="$SCRIPT_DIR/${SCRIPT_NAME}.legacy"

if [[ -x "$PROJECT_SCRIPT" ]]; then
  exec env SPINE_ROOT="$SPINE_ROOT" "$PROJECT_SCRIPT" "$@"
fi

echo "WARN: immich plugin fallback active; delegated project command missing at $PROJECT_SCRIPT" >&2
exec "$LEGACY_SCRIPT" "$@"
