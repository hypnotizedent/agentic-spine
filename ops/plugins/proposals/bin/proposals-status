#!/usr/bin/env bash
# proposals-status: Summary of proposal queue health + SLA breaches
set -euo pipefail

SP="${SPINE_CODE:-.}"
PROPOSALS_DIR="$SP/mailroom/outbox/proposals"
LIFECYCLE="$SP/ops/bindings/proposals.lifecycle.yaml"

NOW=$(date +%s)

# Read SLA thresholds from lifecycle binding
if command -v yq >/dev/null 2>&1 && [[ -f "$LIFECYCLE" ]]; then
  PENDING_MAX=$(yq '.sla.pending_max_age_days // 7' "$LIFECYCLE")
  DRAFT_MAX=$(yq '.sla.draft_max_age_days // 14' "$LIFECYCLE")
  HOLD_REVIEW_MAX=$(yq '.sla.draft_hold_review_max_days // 30' "$LIFECYCLE")
  STALE_PATH_THRESHOLD=$(yq '.staleness.path_drift_threshold_days // 3' "$LIFECYCLE")
else
  PENDING_MAX=7
  DRAFT_MAX=14
  HOLD_REVIEW_MAX=30
  STALE_PATH_THRESHOLD=3
fi

# Counters
total=0
pending=0; applied=0; superseded=0; draft_hold=0; draft=0; readonly=0; invalid=0; other=0
sla_breaches=0
malformed=0
stale_pending=0
link_valid_pending=0
link_missing=0
link_scope_missing=0
link_scope_closed=0
link_scope_unknown=0
pending_loop_ids=""
mismatch_lines=""
mismatch_total=0
mismatch_printed=0
stale_pending_lines=""
other_statuses=""

append_mismatch() {
  local line="$1"
  mismatch_total=$((mismatch_total + 1))
  if [[ "$mismatch_printed" -lt 20 ]]; then
    mismatch_lines="${mismatch_lines}  - ${line}\n"
    mismatch_printed=$((mismatch_printed + 1))
  fi
}

parse_epoch() {
  local ds="${1:-}"
  [[ -n "$ds" ]] || { echo 0; return; }
  if command -v python3 >/dev/null 2>&1; then
    python3 -c "
import sys
from datetime import datetime, timezone
ds = sys.argv[1].strip()
try:
    dt = datetime.fromisoformat(ds)
    if dt.tzinfo is None: dt = dt.replace(tzinfo=timezone.utc)
    print(int(dt.timestamp()))
except: print(0)
" "$ds"
    return
  fi
  date -j -f "%Y-%m-%dT%H:%M:%SZ" "$ds" +%s 2>/dev/null || echo 0
}

echo "═══════════════════════════════════════════════════════════════════════════"
echo "Proposal Queue Health"
echo "═══════════════════════════════════════════════════════════════════════════"
echo ""

SLA_LINES=""

for dir in "$PROPOSALS_DIR"/CP-*; do
  [[ -d "$dir" ]] || continue
  bname=$(basename "$dir")
  manifest="$dir/manifest.yaml"
  total=$((total + 1))

  # Determine status - executed is treated as alias for applied
  if [[ -f "$dir/.applied" ]]; then
    status="applied"
    applied=$((applied + 1))
  elif [[ ! -f "$manifest" ]]; then
    status="invalid"
    invalid=$((invalid + 1))
    malformed=$((malformed + 1))
    continue
  else
    status=$(grep -m1 '^status:' "$manifest" 2>/dev/null | sed 's/^status: *//' | tr -d '"' | tr -d "'" || echo "")
    [[ -z "$status" ]] && status="pending"
    # Treat executed as applied (alias normalization)
    if [[ "$status" == "executed" ]]; then
      status="applied"
    fi
    # Detect read_only proposals without explicit status field
    if [[ "$status" == "pending" ]]; then
      if grep -q '^read_only: *true' "$manifest" || grep -q '^mode: *read-only' "$manifest"; then
        status="read-only"
      fi
    fi
  fi

  case "$status" in
    pending) pending=$((pending + 1)) ;;
    superseded) superseded=$((superseded + 1)) ;;
    draft_hold) draft_hold=$((draft_hold + 1)) ;;
    draft) draft=$((draft + 1)) ;;
    read-only|readonly) readonly=$((readonly + 1)) ;;
    invalid) invalid=$((invalid + 1)) ;;
    applied) ;; # already counted
    *)
      other=$((other + 1))
      other_statuses="${other_statuses}${status}"$'\n'
      ;;
  esac

  # SLA check for pending
  if [[ "$status" == "pending" ]]; then
    cp_loop_id=$(grep -m1 '^loop_id:' "$manifest" 2>/dev/null | sed 's/^loop_id: *//' | tr -d '"' | tr -d "'" || echo "")
    [[ "$cp_loop_id" == "null" ]] && cp_loop_id=""

    if [[ -z "$cp_loop_id" ]]; then
      link_missing=$((link_missing + 1))
      append_mismatch "$bname has pending status with missing loop_id"
    else
      scope_file="$SP/mailroom/state/loop-scopes/${cp_loop_id}.scope.md"
      if [[ ! -f "$scope_file" ]]; then
        link_scope_missing=$((link_scope_missing + 1))
        append_mismatch "$bname targets loop_id=$cp_loop_id but scope file is missing"
      else
        scope_status=$(awk -F': *' '/^status:/{print $2; exit}' "$scope_file" 2>/dev/null | tr -d '"' | tr -d "'" || echo "")
        case "$scope_status" in
          active|draft|open|planned)
            link_valid_pending=$((link_valid_pending + 1))
            pending_loop_ids="${pending_loop_ids}${cp_loop_id}"$'\n'
            ;;
          closed)
            link_scope_closed=$((link_scope_closed + 1))
            append_mismatch "$bname targets closed loop_id=$cp_loop_id"
            ;;
          *)
            link_scope_unknown=$((link_scope_unknown + 1))
            append_mismatch "$bname targets loop_id=$cp_loop_id with unknown scope status '${scope_status:-unknown}'"
            ;;
        esac
      fi
    fi

    created=$(grep -m1 '^created:' "$manifest" 2>/dev/null | sed 's/^created: *//' | tr -d '"' | tr -d "'" || echo "")
    if [[ -n "$created" ]]; then
      epoch=$(parse_epoch "$created")
      if [[ "$epoch" -gt 0 ]]; then
        age_days=$(( (NOW - epoch) / 86400 ))
        if [[ "$age_days" -gt "$PENDING_MAX" ]]; then
          SLA_LINES="${SLA_LINES}  SLA BREACH: $bname (pending ${age_days}d, max ${PENDING_MAX}d)\n"
          sla_breaches=$((sla_breaches + 1))
        fi
        # Staleness check: pending older than threshold may have path drift
        if [[ "$age_days" -gt "$STALE_PATH_THRESHOLD" ]]; then
          stale_pending=$((stale_pending + 1))
          if [[ "$stale_pending" -le 20 ]]; then
            stale_pending_lines="${stale_pending_lines}  - $bname (pending ${age_days}d, may have path drift)\n"
          fi
        fi
      fi
    fi
  fi

  # SLA check for draft_hold review dates
  if [[ "$status" == "draft_hold" ]]; then
    review_date=$(grep -m1 '^review_date:' "$manifest" 2>/dev/null | sed 's/^review_date: *//' | tr -d '"' | tr -d "'" || echo "")
    if [[ -n "$review_date" ]]; then
      review_epoch=$(parse_epoch "${review_date}T00:00:00Z")
      if [[ "$review_epoch" -gt 0 ]]; then
        days_until=$(( (review_epoch - NOW) / 86400 ))
        if [[ "$days_until" -lt 0 ]]; then
          SLA_LINES="${SLA_LINES}  SLA BREACH: $bname (review overdue by $(( -days_until ))d)\n"
          sla_breaches=$((sla_breaches + 1))
        fi
      fi
    fi
  fi

  # Check for missing required fields
  if [[ -f "$manifest" ]]; then
    if ! grep -q '^proposal:' "$manifest" && ! grep -q '^proposal_id:' "$manifest"; then
      malformed=$((malformed + 1))
    fi
    if ! grep -q '^agent:' "$manifest" && ! grep -q '^author:' "$manifest"; then
      malformed=$((malformed + 1))
    fi
  fi
done

open_loop_count=0
open_loop_without_pending=0
open_loop_without_pending_lines=""
if [[ -d "$SP/mailroom/state/loop-scopes" ]]; then
  for scope_file in "$SP"/mailroom/state/loop-scopes/*.scope.md; do
    [[ -f "$scope_file" ]] || continue
    loop_id=$(awk -F': *' '/^loop_id:/{print $2; exit}' "$scope_file" | tr -d '"' | tr -d "'" || true)
    scope_status=$(awk -F': *' '/^status:/{print $2; exit}' "$scope_file" | tr -d '"' | tr -d "'" || true)
    [[ -z "$loop_id" ]] && continue
    case "$scope_status" in
      active|draft|open)
        open_loop_count=$((open_loop_count + 1))
        if ! printf '%s' "$pending_loop_ids" | grep -Fxq "$loop_id"; then
          open_loop_without_pending=$((open_loop_without_pending + 1))
          if [[ "$open_loop_without_pending" -le 20 ]]; then
            open_loop_without_pending_lines="${open_loop_without_pending_lines}  - ${loop_id}\n"
          fi
        fi
        ;;
    esac
  done
fi

echo "Summary:"
echo "  Total:       $total"
echo "  Pending:     $pending"
echo "  Applied:     $applied"
echo "  Superseded:  $superseded"
echo "  Draft Hold:  $draft_hold"
echo "  Draft:       $draft"
echo "  Read-only:   $readonly"
echo "  Invalid:     $invalid"
if [[ "$other" -gt 0 ]]; then
  echo "  Other:       $other"
  echo "    Breakdown:"
  echo "$other_statuses" | sort | uniq -c | sort -rn | while read -r count status; do
    [[ -n "$status" ]] && echo "      - $status: $count"
  done
fi
echo ""
echo "Health:"
echo "  SLA breaches:    $sla_breaches"
echo "  Malformed:       $malformed"

echo ""
echo "Loop-Proposal Linkage:"
echo "  Pending linked to active loops: $link_valid_pending"
echo "  Pending missing loop_id:        $link_missing"
echo "  Pending with missing scope:     $link_scope_missing"
echo "  Pending targeting closed loop:  $link_scope_closed"
echo "  Pending targeting unknown loop: $link_scope_unknown"
echo "  Open loops without pending CP:  $open_loop_without_pending/$open_loop_count"

if [[ -n "$SLA_LINES" ]]; then
  echo ""
  echo "SLA Details:"
  printf "$SLA_LINES"
fi

if [[ "$mismatch_total" -gt 0 ]]; then
  echo ""
  echo "Linkage Mismatch Details:"
  printf "$mismatch_lines"
  if [[ "$mismatch_total" -gt "$mismatch_printed" ]]; then
    echo "  ... plus $((mismatch_total - mismatch_printed)) more"
  fi
fi

if [[ "$open_loop_without_pending" -gt 0 ]]; then
  echo ""
  echo "Open Loops Without Pending Proposal:"
  printf "$open_loop_without_pending_lines"
  if [[ "$open_loop_without_pending" -gt 20 ]]; then
    echo "  ... plus $((open_loop_without_pending - 20)) more"
  fi
fi

if [[ "$stale_pending" -gt 0 ]]; then
  echo ""
  echo "Stale Pending Proposals (may have path drift):"
  printf "$stale_pending_lines"
  if [[ "$stale_pending" -gt 20 ]]; then
    echo "  ... plus $((stale_pending - 20)) more"
  fi
  echo "  Recommendation: supersede + create successor if paths have drifted"
fi

echo ""
echo "Thresholds (from proposals.lifecycle.yaml):"
echo "  Pending max age:       ${PENDING_MAX}d"
echo "  Draft max age:         ${DRAFT_MAX}d"
echo "  Draft hold review max: ${HOLD_REVIEW_MAX}d"

# Exit non-zero if there are SLA breaches or malformed proposals
if [[ "$sla_breaches" -gt 0 || "$malformed" -gt 0 || "$mismatch_total" -gt 0 ]]; then
  echo ""
  echo "WARN: $sla_breaches SLA breaches, $malformed malformed, $mismatch_total linkage mismatches"
fi

exit 0
