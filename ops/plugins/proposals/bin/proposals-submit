#!/bin/bash
set -euo pipefail

# proposals-submit: Create a new change proposal in mailroom/outbox/proposals/

usage() {
  cat <<'EOF'
Usage: proposals-submit "description" [--loop-id LOOP_ID]

Create a change proposal in mailroom/outbox/proposals/.

Loop binding is mandatory:
  - pass --loop-id LOOP_ID, or
  - set SPINE_LOOP_ID in the environment.
EOF
}

DESCRIPTION=""
LOOP_ID_ARG=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help)
      usage
      exit 0
      ;;
    --loop-id)
      [[ $# -lt 2 ]] && { echo "ERROR: --loop-id requires a value" >&2; exit 2; }
      LOOP_ID_ARG="$2"
      shift 2
      ;;
    --loop-id=*)
      LOOP_ID_ARG="${1#*=}"
      shift
      ;;
    -*)
      echo "ERROR: unknown option: $1" >&2
      usage >&2
      exit 2
      ;;
    *)
      if [[ -z "$DESCRIPTION" ]]; then
        DESCRIPTION="$1"
      else
        DESCRIPTION="$DESCRIPTION $1"
      fi
      shift
      ;;
  esac
done

if [[ -z "$DESCRIPTION" ]]; then
  usage >&2
  exit 2
fi

SPINE_CODE="${SPINE_CODE:-.}"

PROPOSALS_DIR="$SPINE_CODE/mailroom/outbox/proposals"
AGENT_ID="${SPINE_AGENT_ID:-${USER:-unknown}@$(hostname -s 2>/dev/null || hostname 2>/dev/null || echo unknown-host)}"
LOOP_ID="${LOOP_ID_ARG:-${SPINE_LOOP_ID:-}}"
LOOP_SCOPE_FILE="$SPINE_CODE/mailroom/state/loop-scopes/${LOOP_ID}.scope.md"

if [[ -z "${LOOP_ID:-}" || "${LOOP_ID}" == "null" ]]; then
  echo "ERROR: loop binding required. Set SPINE_LOOP_ID or pass --loop-id LOOP_ID." >&2
  exit 1
fi

if [[ ! -f "$LOOP_SCOPE_FILE" ]]; then
  echo "ERROR: loop scope not found for loop_id=$LOOP_ID at $LOOP_SCOPE_FILE" >&2
  exit 1
fi

LOOP_STATUS="$(awk -F': *' '/^status:/{print $2; exit}' "$LOOP_SCOPE_FILE" | tr -d '"' | tr -d "'" || true)"
case "$LOOP_STATUS" in
  active|draft|open|planned) ;;
  closed)
    echo "ERROR: cannot create proposal for closed loop_id=$LOOP_ID" >&2
    exit 1
    ;;
  *)
    echo "ERROR: loop_id=$LOOP_ID has unsupported scope status '${LOOP_STATUS:-unknown}'" >&2
    exit 1
    ;;
esac

# Create timestamp in format YYYYMMDD-HHMMSS
TIMESTAMP=$(date +%Y%m%d-%H%M%S)

# Sanitize description: lowercase, replace spaces with hyphens
SANITIZED_DESC=$(echo "$DESCRIPTION" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g' | sed 's/-+/-/g')

# Create proposal directory
PROPOSAL_NAME="CP-${TIMESTAMP}__${SANITIZED_DESC}"
PROPOSAL_DIR="$PROPOSALS_DIR/$PROPOSAL_NAME"

mkdir -p "$PROPOSAL_DIR/files"

# Create empty manifest.yaml template
cat > "$PROPOSAL_DIR/manifest.yaml" << MANIFEST
proposal: $PROPOSAL_NAME
agent: "$AGENT_ID"
created: $(date -u +%Y-%m-%dT%H:%M:%SZ)
loop_id: $LOOP_ID
changes: []
MANIFEST

# Create empty receipt.md template
cat > "$PROPOSAL_DIR/receipt.md" << RECEIPT
# Proposal Receipt: $PROPOSAL_NAME

## What was done
(describe the changes here)

## Why
(explain the motivation)

## Constraints
(any limitations or dependencies)

## Expected outcomes
(what should happen when applied)
RECEIPT

echo "Proposal created: $PROPOSAL_DIR"
echo "Next steps:"
echo "  Loop binding: $LOOP_ID"
echo "  1. Edit manifest.yaml to list your changes"
echo "  2. Add files to files/ directory (preserving path structure)"
echo "  3. Update receipt.md with details"
