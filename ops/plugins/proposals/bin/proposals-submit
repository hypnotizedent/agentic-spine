#!/bin/bash
set -euo pipefail

# proposals-submit: Create a new change proposal in mailroom/outbox/proposals/

usage() {
  cat <<'EOF'
Usage: proposals-submit "description" [--loop-id LOOP_ID]

Create a change proposal in mailroom/outbox/proposals/.

Loop binding is mandatory:
  - pass --loop-id LOOP_ID, or
  - set SPINE_LOOP_ID in the environment.
EOF
}

DESCRIPTION=""
LOOP_ID_ARG=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help)
      usage
      exit 0
      ;;
    --loop-id)
      [[ $# -lt 2 ]] && { echo "ERROR: --loop-id requires a value" >&2; exit 2; }
      LOOP_ID_ARG="$2"
      shift 2
      ;;
    --loop-id=*)
      LOOP_ID_ARG="${1#*=}"
      shift
      ;;
    -*)
      echo "ERROR: unknown option: $1" >&2
      usage >&2
      exit 2
      ;;
    *)
      if [[ -z "$DESCRIPTION" ]]; then
        DESCRIPTION="$1"
      else
        DESCRIPTION="$DESCRIPTION $1"
      fi
      shift
      ;;
  esac
done

if [[ -z "$DESCRIPTION" ]]; then
  usage >&2
  exit 2
fi

SPINE_CODE="${SPINE_CODE:-.}"
ROLE_RUNTIME_CONTRACT="$SPINE_CODE/ops/bindings/role.runtime.control.contract.yaml"
TERMINAL_ROLE_CONTRACT="$SPINE_CODE/ops/bindings/terminal.role.contract.yaml"
PROPOSALS_LIFECYCLE_CONTRACT="$SPINE_CODE/ops/bindings/proposals.lifecycle.yaml"

PROPOSALS_DIR="$SPINE_CODE/mailroom/outbox/proposals"
AGENT_ID="${SPINE_AGENT_ID:-${USER:-unknown}@$(hostname -s 2>/dev/null || hostname 2>/dev/null || echo unknown-host)}"
LOOP_ID="${LOOP_ID_ARG:-${SPINE_LOOP_ID:-}}"
LOOP_SCOPE_FILE="$SPINE_CODE/mailroom/state/loop-scopes/${LOOP_ID}.scope.md"

if [[ -z "${LOOP_ID:-}" || "${LOOP_ID}" == "null" ]]; then
  echo "ERROR: loop binding required. Set SPINE_LOOP_ID or pass --loop-id LOOP_ID." >&2
  exit 1
fi

if [[ ! -f "$LOOP_SCOPE_FILE" ]]; then
  echo "ERROR: loop scope not found for loop_id=$LOOP_ID at $LOOP_SCOPE_FILE" >&2
  exit 1
fi

LOOP_STATUS="$(awk -F': *' '/^status:/{print $2; exit}' "$LOOP_SCOPE_FILE" | tr -d '"' | tr -d "'" || true)"
LOOP_HORIZON="$(awk -F': *' '/^horizon:/{print $2; exit}' "$LOOP_SCOPE_FILE" | tr -d '"' | tr -d "'" || true)"
LOOP_READINESS="$(awk -F': *' '/^execution_readiness:/{print $2; exit}' "$LOOP_SCOPE_FILE" | tr -d '"' | tr -d "'" || true)"
LOOP_OWNER="$(awk -F': *' '/^owner:/{print $2; exit}' "$LOOP_SCOPE_FILE" | tr -d '"' | tr -d "'" || true)"
case "$LOOP_STATUS" in
  active|draft|open|planned) ;;
  closed)
    echo "ERROR: cannot create proposal for closed loop_id=$LOOP_ID" >&2
    exit 1
    ;;
  *)
    echo "ERROR: loop_id=$LOOP_ID has unsupported scope status '${LOOP_STATUS:-unknown}'" >&2
    exit 1
    ;;
esac

[[ -n "$LOOP_HORIZON" ]] || LOOP_HORIZON="now"
[[ -n "$LOOP_READINESS" ]] || LOOP_READINESS="runnable"
[[ -n "$LOOP_OWNER" ]] || LOOP_OWNER="@ronny"

PENDING_REQUIRED_HORIZON="now"
PENDING_REQUIRED_READINESS="runnable"
DEFERRED_HORIZONS="later future"
DRAFT_HOLD_REVIEW_MAX_DAYS=30
if [[ -f "$PROPOSALS_LIFECYCLE_CONTRACT" ]] && command -v yq >/dev/null 2>&1; then
  PENDING_REQUIRED_HORIZON="$(yq e -r '.horizon_rules.pending_requires.parent_loop_horizon // "now"' "$PROPOSALS_LIFECYCLE_CONTRACT" 2>/dev/null || echo now)"
  PENDING_REQUIRED_READINESS="$(yq e -r '.horizon_rules.pending_requires.parent_loop_readiness // "runnable"' "$PROPOSALS_LIFECYCLE_CONTRACT" 2>/dev/null || echo runnable)"
  DEFERRED_HORIZONS="$(yq e -r '.horizon_rules.draft_hold_for_deferred.applies_when_horizon[]?' "$PROPOSALS_LIFECYCLE_CONTRACT" 2>/dev/null | tr '\n' ' ')"
  [[ -n "$DEFERRED_HORIZONS" ]] || DEFERRED_HORIZONS="later future"
  DRAFT_HOLD_REVIEW_MAX_DAYS="$(yq e -r '.sla.draft_hold_review_max_days // 30' "$PROPOSALS_LIFECYCLE_CONTRACT" 2>/dev/null || echo 30)"
fi

MANIFEST_STATUS="pending"
MANIFEST_OWNER_BLOCK=""
MANIFEST_REVIEW_BLOCK=""
MANIFEST_HOLD_BLOCK=""

is_deferred=false
for hz in $DEFERRED_HORIZONS; do
  if [[ "$LOOP_HORIZON" == "$hz" ]]; then
    is_deferred=true
    break
  fi
done

if [[ "$is_deferred" == "true" ]]; then
  review_date="$(python3 - "$DRAFT_HOLD_REVIEW_MAX_DAYS" <<'PY'
import sys
from datetime import datetime, timedelta, timezone

days = int(sys.argv[1]) if len(sys.argv) > 1 else 30
print((datetime.now(timezone.utc) + timedelta(days=days)).strftime("%Y-%m-%d"))
PY
)"
  MANIFEST_STATUS="draft_hold"
  MANIFEST_OWNER_BLOCK="owner: \"$LOOP_OWNER\""
  MANIFEST_REVIEW_BLOCK="review_date: \"$review_date\""
  MANIFEST_HOLD_BLOCK="hold_reason: \"Parent loop is deferred (horizon=$LOOP_HORIZON); promote loop to horizon=$PENDING_REQUIRED_HORIZON and readiness=$PENDING_REQUIRED_READINESS before pending/apply.\""
elif [[ "$LOOP_HORIZON" == "$PENDING_REQUIRED_HORIZON" && "$LOOP_READINESS" == "$PENDING_REQUIRED_READINESS" ]]; then
  MANIFEST_STATUS="pending"
else
  echo "ERROR: proposals-submit blocked by horizon_rules for loop_id=$LOOP_ID." >&2
  echo "ERROR: pending requires parent loop horizon=$PENDING_REQUIRED_HORIZON and execution_readiness=$PENDING_REQUIRED_READINESS." >&2
  echo "ERROR: observed horizon=$LOOP_HORIZON readiness=$LOOP_READINESS." >&2
  echo "Remediation:" >&2
  echo "  ./bin/ops cap run planning.horizon.set -- --loop $LOOP_ID --horizon $PENDING_REQUIRED_HORIZON --readiness $PENDING_REQUIRED_READINESS" >&2
  exit 1
fi

RUNTIME_ROLE="${SPINE_RUNTIME_ROLE:-}"
if [[ -z "$RUNTIME_ROLE" && -n "${OPS_TERMINAL_ROLE:-}" ]] && command -v yq >/dev/null 2>&1 && [[ -f "$TERMINAL_ROLE_CONTRACT" ]]; then
  RUNTIME_ROLE="$(yq -r ".runtime_role_defaults.by_terminal_id.\"${OPS_TERMINAL_ROLE}\" // \"\"" "$TERMINAL_ROLE_CONTRACT" 2>/dev/null || true)"
  if [[ -z "$RUNTIME_ROLE" || "$RUNTIME_ROLE" == "null" ]]; then
    role_type="$(yq -r ".roles[]? | select(.id == \"${OPS_TERMINAL_ROLE}\") | .type" "$TERMINAL_ROLE_CONTRACT" 2>/dev/null | head -n1 || true)"
    if [[ -n "$role_type" && "$role_type" != "null" ]]; then
      RUNTIME_ROLE="$(yq -r ".runtime_role_defaults.by_terminal_type.\"$role_type\" // \"\"" "$TERMINAL_ROLE_CONTRACT" 2>/dev/null || true)"
    fi
  fi
fi
[[ -n "$RUNTIME_ROLE" ]] || RUNTIME_ROLE="researcher"

if [[ -f "$ROLE_RUNTIME_CONTRACT" ]] && command -v yq >/dev/null 2>&1; then
  role_enforcement="$(yq -r '.promotion_gates.enforce // true' "$ROLE_RUNTIME_CONTRACT" 2>/dev/null || echo true)"
  if [[ "$role_enforcement" == "true" && "$RUNTIME_ROLE" != "worker" ]]; then
    override_ref="${SPINE_ROLE_POLICY_OVERRIDE_REF:-}"
    if [[ -z "$override_ref" ]]; then
      echo "ERROR: proposals-submit admission blocked for runtime role '$RUNTIME_ROLE' (worker required)." >&2
      echo "ERROR: promotion gate required (researcher->worker or explicit override via SPINE_ROLE_POLICY_OVERRIDE_REF)." >&2
      exit 1
    fi
  fi
fi

# Create timestamp in format YYYYMMDD-HHMMSS
TIMESTAMP=$(date +%Y%m%d-%H%M%S)

# Sanitize description: lowercase, replace spaces with hyphens
SANITIZED_DESC=$(echo "$DESCRIPTION" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g' | sed 's/-+/-/g')

# Create proposal directory
PROPOSAL_NAME="CP-${TIMESTAMP}__${SANITIZED_DESC}"
PROPOSAL_DIR="$PROPOSALS_DIR/$PROPOSAL_NAME"

mkdir -p "$PROPOSAL_DIR/files"

# Create empty manifest.yaml template
cat > "$PROPOSAL_DIR/manifest.yaml" << MANIFEST
proposal: $PROPOSAL_NAME
agent: "$AGENT_ID"
created: $(date -u +%Y-%m-%dT%H:%M:%SZ)
status: $MANIFEST_STATUS
loop_id: $LOOP_ID
${MANIFEST_OWNER_BLOCK}
${MANIFEST_REVIEW_BLOCK}
${MANIFEST_HOLD_BLOCK}
changes: []
MANIFEST

# Create empty receipt.md template
cat > "$PROPOSAL_DIR/receipt.md" << RECEIPT
# Proposal Receipt: $PROPOSAL_NAME

## What was done
(describe the changes here)

## Why
(explain the motivation)

## Constraints
(any limitations or dependencies)

## Expected outcomes
(what should happen when applied)
RECEIPT

echo "Proposal created: $PROPOSAL_DIR"
echo "Next steps:"
echo "  Loop binding: $LOOP_ID"
echo "  1. Edit manifest.yaml to list your changes"
echo "  2. Add files to files/ directory (preserving path structure)"
echo "  3. Update receipt.md with details"
