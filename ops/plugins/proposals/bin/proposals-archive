#!/usr/bin/env bash
# proposals-archive: Move applied/superseded proposals to .archived/ and purge aged archives.
# Usage: proposals-archive [--applied-days N] [--superseded-days N] [--dry-run]
#                         [--purge-archived] [--purge-days N] [--no-purge]
set -euo pipefail

SP="${SPINE_CODE:-.}"
PROPOSALS_DIR="$SP/mailroom/outbox/proposals"
ARCHIVE_DIR="$PROPOSALS_DIR/.archived"
LIFECYCLE="$SP/ops/bindings/proposals.lifecycle.yaml"
RETENTION_POLICY="$SP/ops/bindings/evidence.retention.policy.yaml"

NOW=$(date +%s)

# Read defaults from lifecycle binding
if command -v yq >/dev/null 2>&1 && [[ -f "$LIFECYCLE" ]]; then
  APPLIED_DAYS=$(yq '.sla.archive_applied_after_days // 3' "$LIFECYCLE")
  SUPERSEDED_DAYS=$(yq '.sla.archive_superseded_after_days // 3' "$LIFECYCLE")
else
  APPLIED_DAYS=3
  SUPERSEDED_DAYS=3
fi

DRY_RUN=false
PURGE_ARCHIVED=false
PURGE_DAYS=30

if command -v yq >/dev/null 2>&1 && [[ -f "$RETENTION_POLICY" ]]; then
  retention_days=$(yq -r '.retention_classes.proposals.retention_days // 30' "$RETENTION_POLICY")
  purge_requires=$(yq -r '.retention_classes.proposals.purge_requires // "manual_approval"' "$RETENTION_POLICY")
  if [[ "$retention_days" =~ ^[0-9]+$ ]]; then
    PURGE_DAYS="$retention_days"
  fi
  if [[ "$purge_requires" == "auto" ]]; then
    PURGE_ARCHIVED=true
  fi
fi

while [[ $# -gt 0 ]]; do
  case "$1" in
    --applied-days) APPLIED_DAYS="$2"; shift 2 ;;
    --superseded-days) SUPERSEDED_DAYS="$2"; shift 2 ;;
    --dry-run) DRY_RUN=true; shift ;;
    --purge-archived) PURGE_ARCHIVED=true; shift ;;
    --purge-days) PURGE_DAYS="$2"; PURGE_ARCHIVED=true; shift 2 ;;
    --no-purge) PURGE_ARCHIVED=false; shift ;;
    *) echo "Unknown option: $1"; exit 1 ;;
  esac
done

mkdir -p "$ARCHIVE_DIR"

parse_epoch() {
  local ds="${1:-}"
  [[ -n "$ds" ]] || { echo 0; return; }
  if command -v python3 >/dev/null 2>&1; then
    python3 -c "
import sys
from datetime import datetime, timezone
ds = sys.argv[1].strip()
try:
    dt = datetime.fromisoformat(ds)
    if dt.tzinfo is None: dt = dt.replace(tzinfo=timezone.utc)
    print(int(dt.timestamp()))
except: print(0)
" "$ds"
    return
  fi
  date -j -f "%Y-%m-%dT%H:%M:%SZ" "$ds" +%s 2>/dev/null || echo 0
}

archived=0
skipped=0

echo "═══════════════════════════════════════════════════════════════════════════"
echo "Proposal Archive"
echo "═══════════════════════════════════════════════════════════════════════════"
echo ""
echo "Thresholds: applied > ${APPLIED_DAYS}d, superseded > ${SUPERSEDED_DAYS}d"
if [[ "$DRY_RUN" == "true" ]]; then
  echo "MODE: dry-run (no moves)"
fi
echo "Purge archived: ${PURGE_ARCHIVED} (>${PURGE_DAYS}d)"
echo ""

for dir in "$PROPOSALS_DIR"/CP-*; do
  [[ -d "$dir" ]] || continue
  bname=$(basename "$dir")
  manifest="$dir/manifest.yaml"

  status=""
  age_days=0
  detail=""

  if [[ -f "$dir/.applied" ]]; then
    status="applied"
    # Get applied timestamp
    applied_ts=$(grep -m1 '^Applied:' "$dir/.applied" 2>/dev/null | sed 's/^Applied: *//' || true)
    commit_short=$(grep -m1 '^Commit:' "$dir/.applied" 2>/dev/null | awk '{print substr($2,1,7)}' || true)
    if [[ -n "$applied_ts" ]]; then
      epoch=$(parse_epoch "$applied_ts")
      [[ "$epoch" -gt 0 ]] && age_days=$(( (NOW - epoch) / 86400 ))
    fi
    detail="$commit_short"
    threshold=$APPLIED_DAYS
  elif [[ -f "$manifest" ]] && grep -q '^status: superseded' "$manifest"; then
    status="superseded"
    superseded_at=$(grep -m1 '^superseded_at:' "$manifest" 2>/dev/null | sed 's/^superseded_at: *//' | tr -d '"' || echo "")
    if [[ -n "$superseded_at" ]]; then
      epoch=$(parse_epoch "${superseded_at}T00:00:00Z")
      [[ "$epoch" -gt 0 ]] && age_days=$(( (NOW - epoch) / 86400 ))
    fi
    threshold=$SUPERSEDED_DAYS
  else
    continue
  fi

  if [[ "$age_days" -lt "$threshold" ]]; then
    skipped=$((skipped + 1))
    continue
  fi

  # Build archive name
  status_upper=$(echo "$status" | tr '[:lower:]' '[:upper:]')
  if [[ -n "$detail" ]]; then
    archive_name="${status_upper}__${bname}__${detail}"
  else
    archive_name="${status_upper}__${bname}"
  fi

  if [[ "$DRY_RUN" == "true" ]]; then
    echo "  WOULD ARCHIVE: $bname (${age_days}d old)"
  else
    mv "$dir" "$ARCHIVE_DIR/$archive_name"
    echo "  ARCHIVED: $bname (${age_days}d old)"
  fi
  archived=$((archived + 1))
done

purged=0
purge_skipped=0
if [[ "$PURGE_ARCHIVED" == "true" ]]; then
  while IFS= read -r -d '' dir; do
    mtime=0
    if stat_mtime=$(stat -f "%m" "$dir" 2>/dev/null); then
      mtime="$stat_mtime"
    elif stat_mtime=$(stat -c "%Y" "$dir" 2>/dev/null); then
      mtime="$stat_mtime"
    fi
    [[ "$mtime" -gt 0 ]] || continue

    age_days=$(( (NOW - mtime) / 86400 ))
    if [[ "$age_days" -lt "$PURGE_DAYS" ]]; then
      purge_skipped=$((purge_skipped + 1))
      continue
    fi

    if [[ "$DRY_RUN" == "true" ]]; then
      echo "  WOULD PURGE: $(basename "$dir") (${age_days}d old)"
    else
      rm -rf "$dir"
      echo "  PURGED: $(basename "$dir") (${age_days}d old)"
    fi
    purged=$((purged + 1))
  done < <(find "$ARCHIVE_DIR" -mindepth 1 -maxdepth 1 -type d -print0)
fi

echo ""
echo "Results: $archived archived, $skipped below threshold, $purged purged, $purge_skipped purge-below-threshold"
