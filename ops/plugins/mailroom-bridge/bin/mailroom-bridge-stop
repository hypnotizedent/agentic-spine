#!/usr/bin/env bash
set -euo pipefail

SPINE_REPO="${SPINE_REPO:-$HOME/code/agentic-spine}"
STATE_DIR="${SPINE_STATE:-$SPINE_REPO/mailroom/state}"

PID_FILE="${STATE_DIR}/mailroom-bridge.pid"
LABEL="com.ronny.mailroom-bridge"
PLIST="$HOME/Library/LaunchAgents/${LABEL}.plist"

mkdir -p "$STATE_DIR"

if ! command -v launchctl >/dev/null 2>&1; then
  echo "STOP (2): launchctl required (macOS launchd)"
  exit 2
fi

svc="$(launchctl list "$LABEL" 2>/dev/null || true)"
if [[ -z "$svc" ]]; then
  echo "NOT_RUNNING: not loaded (${LABEL})"
  rm -f "$PID_FILE" 2>/dev/null || true
  exit 0
fi

if [[ ! -f "$PLIST" ]]; then
  echo "STOP: plist not found at $PLIST"
  exit 2
fi

echo "STOPPING: ${LABEL}"
launchctl bootout "gui/$(id -u)" "$PLIST" 2>&1 || true

rm -f "$PID_FILE" 2>/dev/null || true

echo "STOPPED"
