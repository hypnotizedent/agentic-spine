#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../../../.." && pwd)"
RECEIPTS_DIR="$ROOT/receipts/sessions"
ARCHIVE_DIR="$ROOT/receipts/archive/sessions"
RETENTION_DAYS=""
EXECUTE=0
JSON_MODE=0

usage() {
  cat <<'USAGE'
receipts-rotate

Usage:
  receipts-rotate [--days <n>] [--execute] [--json]

Archives receipt session directories older than retention window.
Default mode is dry-run.
USAGE
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --days)
      RETENTION_DAYS="${2:-}"
      shift 2
      ;;
    --execute)
      EXECUTE=1
      shift
      ;;
    --json)
      JSON_MODE=1
      shift
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      echo "FAIL: unknown argument: $1" >&2
      exit 2
      ;;
  esac
done

if [[ -z "$RETENTION_DAYS" ]]; then
  RETENTION_DAYS="$(yq -r '.retention_classes.session_receipts.retention_days // 30' "$ROOT/ops/bindings/evidence.retention.policy.yaml" 2>/dev/null || echo 30)"
fi

[[ "$RETENTION_DAYS" =~ ^[0-9]+$ ]] || { echo "FAIL: retention days must be numeric" >&2; exit 2; }
mkdir -p "$ARCHIVE_DIR"

mapfile -t targets < <(find "$RECEIPTS_DIR" -maxdepth 1 -mindepth 1 -type d -mtime +"$RETENTION_DAYS" 2>/dev/null | sort)
count="${#targets[@]}"

if [[ "$EXECUTE" -eq 1 ]]; then
  moved=0
  for dir in "${targets[@]}"; do
    base="$(basename "$dir")"
    dest="$ARCHIVE_DIR/$base"
    if [[ -e "$dest" ]]; then
      dest="$ARCHIVE_DIR/${base}-$(date +%s)"
    fi
    mv "$dir" "$dest"
    moved=$((moved + 1))
  done
else
  moved=0
fi

if [[ "$JSON_MODE" -eq 1 ]]; then
  jq -n \
    --arg capability "receipts.rotate" \
    --argjson execute "$EXECUTE" \
    --argjson retention_days "$RETENTION_DAYS" \
    --argjson candidates "$count" \
    --argjson moved "$moved" \
    --arg archive_dir "$ARCHIVE_DIR" \
    '{capability:$capability,execute:($execute==1),retention_days:$retention_days,candidates:$candidates,moved:$moved,archive_dir:$archive_dir}'
  exit 0
fi

echo "receipts.rotate"
echo "execute: $EXECUTE"
echo "retention_days: $RETENTION_DAYS"
echo "candidates: $count"
echo "moved: $moved"
echo "archive_dir: $ARCHIVE_DIR"

if [[ "$EXECUTE" -eq 0 && "$count" -gt 0 ]]; then
  echo "sample_candidates:"
  printf '%s\n' "${targets[@]:0:10}"
fi
