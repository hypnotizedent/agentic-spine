#!/usr/bin/env python3
"""calendar-operator-surface - derive operator-facing calendar JSON surfaces."""

from __future__ import annotations

import argparse
import json
import os
import subprocess
import time
from datetime import UTC, date, datetime, timedelta
from pathlib import Path
from typing import Any


DEFAULT_OUT_ROOT = "mailroom/outbox/calendar"
DEFAULT_TODAY_FILE = "calendar-today.json"
DEFAULT_OPERATOR_FILE = "calendar-operator.index.json"
DEFAULT_FRESHNESS_MINUTES = 720
WEEKDAY_CODES = ["MO", "TU", "WE", "TH", "FR", "SA", "SU"]


def stop(msg: str, code: int = 2) -> None:
    print(f"STOP ({code}): {msg}", file=os.sys.stderr)
    raise SystemExit(code)


def run_yq_json(path: Path) -> dict[str, Any]:
    try:
        proc = subprocess.run(
            ["yq", "-o=json", ".", str(path)],
            capture_output=True,
            text=True,
            check=False,
        )
    except FileNotFoundError:
        stop("missing dependency: yq")

    if proc.returncode != 0:
        stop(f"invalid YAML: {path}")

    try:
        data = json.loads(proc.stdout)
    except json.JSONDecodeError as exc:
        stop(f"failed to parse YAML JSON output: {exc}")

    if not isinstance(data, dict):
        stop("binding root must be a map")
    return data


def parse_dtstart_date(raw: Any) -> date:
    text = str(raw or "").strip()
    if len(text) < 8:
        return date(2026, 1, 1)
    try:
        return datetime.strptime(text[:8], "%Y%m%d").date()
    except ValueError:
        return date(2026, 1, 1)


def occurs_today(event: dict[str, Any], today_local: date) -> bool:
    freq = str(event.get("freq", "")).strip().upper()
    if freq == "DAILY":
        return True

    base_day = parse_dtstart_date(event.get("dtstart_local"))

    if freq == "WEEKLY":
        byday = event.get("byday")
        if isinstance(byday, list) and byday:
            allowed = {str(token).strip().upper() for token in byday}
            return WEEKDAY_CODES[today_local.weekday()] in allowed
        return base_day.weekday() == today_local.weekday()

    if freq == "MONTHLY":
        return today_local.day == base_day.day

    if freq == "YEARLY":
        return (today_local.month, today_local.day) == (base_day.month, base_day.day)

    return False


def local_timezone(tz_name: str):
    if not tz_name:
        return UTC
    try:
        from zoneinfo import ZoneInfo

        return ZoneInfo(tz_name)
    except Exception:
        return UTC


def artifact_meta(path: Path, now_epoch: int) -> dict[str, Any]:
    if not path.exists():
        return {
            "path": str(path),
            "exists": False,
            "size_bytes": 0,
            "modified_at_utc": "",
            "age_minutes": None,
        }

    stat = path.stat()
    mtime = int(stat.st_mtime)
    age_minutes = int((now_epoch - mtime) / 60)
    return {
        "path": str(path),
        "exists": True,
        "size_bytes": int(stat.st_size),
        "modified_at_utc": time.strftime("%Y-%m-%dT%H:%M:%SZ", time.gmtime(mtime)),
        "age_minutes": age_minutes,
    }


def main() -> None:
    script_dir = Path(__file__).resolve().parent
    code_root = script_dir.parents[3]
    env_code = os.environ.get("SPINE_CODE") or os.environ.get("SPINE_ROOT")
    if env_code:
        code_root = Path(env_code).expanduser().resolve()

    runtime_root = Path(os.environ.get("SPINE_REPO", str(code_root))).expanduser().resolve()
    parser = argparse.ArgumentParser(description="Build operator-facing calendar JSON surfaces")
    parser.add_argument(
        "--binding",
        default=str(code_root / "ops/bindings/calendar.global.yaml"),
        help="Path to calendar.global binding",
    )
    parser.add_argument(
        "--smoothness-contract",
        default=str(code_root / "ops/bindings/operator.smoothness.contract.yaml"),
        help="Path to operator smoothness contract",
    )
    parser.add_argument("--out-dir", default="", help="Override output directory")
    parser.add_argument("--json", action="store_true", help="Emit JSON summary")
    args = parser.parse_args()

    binding_path = Path(args.binding).expanduser().resolve()
    if not binding_path.is_file():
        stop(f"missing binding: {binding_path}")
    binding = run_yq_json(binding_path)

    out_dir = ""
    feeds = binding.get("feeds")
    if isinstance(feeds, dict):
        out_dir = str(feeds.get("output_root", "")).strip()
    if not out_dir:
        out_dir = DEFAULT_OUT_ROOT
    target_dir = Path(args.out_dir).expanduser().resolve() if args.out_dir else (runtime_root / out_dir).resolve()

    index_name = "calendar-index.json"
    merged_name = "calendar-global.ics"
    if isinstance(feeds, dict):
        status_cfg = feeds.get("status_index")
        if isinstance(status_cfg, dict):
            index_name = str(status_cfg.get("filename", index_name)).strip() or index_name
        merged_cfg = feeds.get("merged_global_ics")
        if isinstance(merged_cfg, dict):
            merged_name = str(merged_cfg.get("filename", merged_name)).strip() or merged_name

    calendar_index_path = target_dir / index_name
    merged_path = target_dir / merged_name
    if not calendar_index_path.is_file():
        stop(f"missing input artifact: {calendar_index_path}")
    if not merged_path.is_file():
        stop(f"missing input artifact: {merged_path}")

    try:
        index_obj = json.loads(calendar_index_path.read_text(encoding="utf-8"))
    except json.JSONDecodeError as exc:
        stop(f"invalid JSON in {calendar_index_path}: {exc}")
    if not isinstance(index_obj, dict):
        stop(f"invalid calendar index root in {calendar_index_path}")

    tz_name = str(index_obj.get("timezone", "UTC")).strip() or "UTC"
    tzinfo = local_timezone(tz_name)
    now_local = datetime.now(tzinfo)
    today_local = now_local.date()

    raw_events = index_obj.get("events")
    if not isinstance(raw_events, list):
        stop("calendar-index events must be a list")

    today_events: list[dict[str, Any]] = []
    for row in raw_events:
        if not isinstance(row, dict):
            continue
        if not occurs_today(row, today_local):
            continue

        byhour = int(row.get("byhour", 0))
        byminute = int(row.get("byminute", 0))
        duration = int(row.get("duration_minutes", 60))
        start_local = datetime(
            year=today_local.year,
            month=today_local.month,
            day=today_local.day,
            hour=max(0, min(23, byhour)),
            minute=max(0, min(59, byminute)),
            second=0,
            tzinfo=tzinfo,
        )
        end_local = start_local + timedelta(minutes=max(duration, 1))

        if now_local < start_local:
            status = "upcoming"
        elif now_local <= end_local:
            status = "in_progress"
        else:
            status = "completed"

        today_events.append(
            {
                "layer": str(row.get("layer", "")),
                "authority": str(row.get("authority", "")),
                "id": str(row.get("id", "")),
                "summary": str(row.get("summary", "")),
                "source_ref": str(row.get("source_ref", "")),
                "status": status,
                "start_local": start_local.isoformat(),
                "end_local": end_local.isoformat(),
                "duration_minutes": max(duration, 1),
            }
        )

    today_events.sort(key=lambda row: row.get("start_local", ""))

    now_epoch = int(time.time())
    today_artifact_path = target_dir / DEFAULT_TODAY_FILE
    operator_artifact_path = target_dir / DEFAULT_OPERATOR_FILE

    today_obj = {
        "schema_version": "1.0",
        "generated_at": datetime.now(UTC).strftime("%Y-%m-%dT%H:%M:%SZ"),
        "calendar_id": index_obj.get("calendar_id", ""),
        "calendar_name": index_obj.get("calendar_name", ""),
        "timezone": tz_name,
        "date": today_local.isoformat(),
        "source_index": str(calendar_index_path),
        "events_total": len(today_events),
        "events": today_events,
        "artifacts": {
            "calendar_global_ics": artifact_meta(merged_path, now_epoch),
            "calendar_index": artifact_meta(calendar_index_path, now_epoch),
        },
    }

    target_dir.mkdir(parents=True, exist_ok=True)
    today_artifact_path.write_text(json.dumps(today_obj, indent=2, sort_keys=True) + "\n", encoding="utf-8")

    required_outputs = [
        "mailroom/outbox/calendar/calendar-global.ics",
        "mailroom/outbox/calendar/calendar-index.json",
        "mailroom/outbox/calendar/calendar-today.json",
        "mailroom/outbox/calendar/calendar-operator.index.json",
    ]
    freshness_window = DEFAULT_FRESHNESS_MINUTES

    contract_path = Path(args.smoothness_contract).expanduser().resolve()
    if contract_path.is_file():
        contract_obj = run_yq_json(contract_path)
        cal_surface = contract_obj.get("calendar_operator_surface")
        if isinstance(cal_surface, dict):
            cfg_required = cal_surface.get("required_outputs")
            if isinstance(cfg_required, list) and cfg_required:
                required_outputs = [str(row).strip() for row in cfg_required if str(row).strip()]
            cfg_freshness = cal_surface.get("freshness_window_minutes")
            if isinstance(cfg_freshness, int) and cfg_freshness >= 0:
                freshness_window = cfg_freshness

    required_meta: list[dict[str, Any]] = []
    stale_count = 0
    missing_count = 0
    for rel in required_outputs:
        path = (runtime_root / rel).resolve()
        meta = artifact_meta(path, now_epoch)
        age = meta.get("age_minutes")
        stale = bool(meta.get("exists")) and isinstance(age, int) and age > freshness_window
        meta["stale"] = stale
        required_meta.append(meta)
        if not meta["exists"]:
            missing_count += 1
        if stale:
            stale_count += 1

    by_layer: dict[str, int] = {}
    by_status: dict[str, int] = {"upcoming": 0, "in_progress": 0, "completed": 0}
    for row in today_events:
        layer = str(row.get("layer", "")).strip() or "unknown"
        by_layer[layer] = by_layer.get(layer, 0) + 1
        status = str(row.get("status", "")).strip() or "unknown"
        by_status[status] = by_status.get(status, 0) + 1

    operator_obj = {
        "schema_version": "1.0",
        "generated_at": datetime.now(UTC).strftime("%Y-%m-%dT%H:%M:%SZ"),
        "source": "calendar.operator.surface",
        "timezone": tz_name,
        "date": today_local.isoformat(),
        "freshness_window_minutes": freshness_window,
        "required_outputs": required_outputs,
        "artifacts": required_meta,
        "summary": {
            "missing_outputs": missing_count,
            "stale_outputs": stale_count,
            "today_events_total": len(today_events),
            "today_events_by_layer": by_layer,
            "today_events_by_status": by_status,
        },
        "status": "ok" if missing_count == 0 and stale_count == 0 else "warn",
    }
    operator_artifact_path.write_text(json.dumps(operator_obj, indent=2, sort_keys=True) + "\n", encoding="utf-8")

    summary = {
        "capability": "calendar.operator.surface",
        "schema_version": "1.0",
        "status": "ok",
        "generated_at": datetime.now(UTC).strftime("%Y-%m-%dT%H:%M:%SZ"),
        "data": {
            "output_dir": str(target_dir),
            "source_index": str(calendar_index_path),
            "today_output": str(today_artifact_path),
            "operator_index_output": str(operator_artifact_path),
            "today_events_total": len(today_events),
        },
    }
    if args.json:
        print(json.dumps(summary, indent=2, sort_keys=True))
        return

    print("calendar.operator.surface")
    print(f"output_dir: {target_dir}")
    print(f"source_index: {calendar_index_path}")
    print(f"today_output: {today_artifact_path}")
    print(f"operator_index_output: {operator_artifact_path}")
    print(f"today_events_total: {len(today_events)}")
    print()
    print("status: OK")


if __name__ == "__main__":
    main()
