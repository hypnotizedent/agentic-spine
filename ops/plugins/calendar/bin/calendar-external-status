#!/usr/bin/env python3
"""calendar-external-status - report external provider ingest status (read-only)."""

from __future__ import annotations

import argparse
import json
import os
import time
from datetime import datetime, timezone
from pathlib import Path
from typing import Any

import yaml


def fail(msg: str, code: int = 1) -> None:
    print(f"ERROR: {msg}")
    raise SystemExit(code)


def load_yaml(path: Path) -> dict[str, Any]:
    if not path.is_file():
        fail(f"missing contract: {path}")
    try:
        payload = yaml.safe_load(path.read_text(encoding="utf-8")) or {}
    except Exception as exc:
        fail(f"unable to parse YAML {path}: {exc}")
    if not isinstance(payload, dict):
        fail(f"YAML root must be mapping: {path}")
    return payload


def load_json(path: Path) -> dict[str, Any] | None:
    if not path.is_file():
        return None
    try:
        payload = json.loads(path.read_text(encoding="utf-8"))
    except Exception:
        return None
    return payload if isinstance(payload, dict) else None


def parse_generated_age_hours(raw: str) -> float | None:
    value = raw.strip()
    if not value:
        return None
    if value.endswith("Z"):
        value = value[:-1] + "+00:00"
    try:
        dt = datetime.fromisoformat(value)
    except ValueError:
        return None
    if dt.tzinfo is None:
        dt = dt.replace(tzinfo=timezone.utc)
    now = datetime.now(timezone.utc)
    return (now - dt.astimezone(timezone.utc)).total_seconds() / 3600.0


def main() -> None:
    parser = argparse.ArgumentParser(description="Show external calendar provider ingest status")
    parser.add_argument(
        "--provider",
        choices=["icloud", "google", "all"],
        default="all",
        help="Provider scope",
    )
    parser.add_argument("--json", action="store_true", help="Emit JSON output")
    args = parser.parse_args()

    script_dir = Path(__file__).resolve().parent
    root = Path(os.environ.get("SPINE_ROOT", str(script_dir.parents[3]))).expanduser().resolve()
    contract_path = root / "ops/bindings/calendar.external.providers.contract.yaml"
    contract = load_yaml(contract_path)

    providers = contract.get("providers") if isinstance(contract.get("providers"), dict) else {}
    if not providers:
        fail("providers mapping missing in calendar.external.providers.contract.yaml")

    ingest = contract.get("ingest") if isinstance(contract.get("ingest"), dict) else {}
    index_rel = str(ingest.get("external_index_path", "mailroom/outbox/calendar/external/external-calendar-index.json")).strip()
    index_path = (root / index_rel).resolve()
    index_payload = load_json(index_path)

    selected = ["icloud", "google"] if args.provider == "all" else [args.provider]
    status_data: dict[str, Any] = {}
    errors: list[str] = []

    for provider in selected:
        block = providers.get(provider) if isinstance(providers.get(provider), dict) else {}
        if not block:
            errors.append(f"providers.{provider} missing")
            continue
        snapshot = block.get("snapshot") if isinstance(block.get("snapshot"), dict) else {}
        snapshot_rel = str(snapshot.get("output_path", "")).strip()
        snapshot_path = (root / snapshot_rel).resolve() if snapshot_rel else None
        snapshot_payload = load_json(snapshot_path) if snapshot_path else None

        generated_at = ""
        event_count = 0
        snapshot_status = "missing"
        if snapshot_payload:
            generated_at = str(snapshot_payload.get("generated_at", "")).strip()
            data = snapshot_payload.get("data") if isinstance(snapshot_payload.get("data"), dict) else {}
            event_count = int(data.get("event_count", 0) or 0)
            snapshot_status = str(snapshot_payload.get("status", "unknown")).strip() or "unknown"

        age_hours = parse_generated_age_hours(generated_at)

        status_data[provider] = {
            "enabled": bool(block.get("enabled", False)),
            "mode": str(block.get("mode", "")).strip(),
            "snapshot_path": str(snapshot_path) if snapshot_path else "",
            "snapshot_exists": bool(snapshot_payload),
            "snapshot_status": snapshot_status,
            "snapshot_generated_at": generated_at,
            "snapshot_age_hours": age_hours,
            "event_count": event_count,
        }

    payload = {
        "capability": "calendar.external.status",
        "status": "ok" if not errors else "fail",
        "generated_at": time.strftime("%Y-%m-%dT%H:%M:%SZ", time.gmtime()),
        "data": {
            "contract_path": str(contract_path),
            "provider_scope": args.provider,
            "providers": status_data,
            "external_index_path": str(index_path),
            "external_index_exists": bool(index_payload),
            "errors": errors,
        },
    }

    if args.json:
        print(json.dumps(payload, indent=2, sort_keys=True))
    else:
        print("calendar.external.status")
        print(f"provider_scope: {args.provider}")
        print(f"contract: {contract_path}")
        print(f"external_index: {index_path} (exists={str(bool(index_payload)).lower()})")
        for provider in selected:
            data = status_data.get(provider, {})
            if not data:
                continue
            print(f"{provider}_enabled: {str(bool(data.get('enabled', False))).lower()}")
            print(f"{provider}_mode: {data.get('mode', '')}")
            print(f"{provider}_snapshot_exists: {str(bool(data.get('snapshot_exists', False))).lower()}")
            print(f"{provider}_event_count: {int(data.get('event_count', 0) or 0)}")
        if errors:
            print(f"errors: {len(errors)}")
            for item in errors:
                print(f"- {item}")
            raise SystemExit(1)
        print("status: OK")


if __name__ == "__main__":
    main()
