#!/usr/bin/env python3
"""calendar-home-event-delete - delete an event from governed local calendar home (Radicale)."""

from __future__ import annotations

import argparse
import json
import os
import shlex
import subprocess
import sys
import time
from pathlib import Path
from typing import Any

import yaml


def fail(msg: str, code: int = 1) -> None:
    print(f"ERROR: {msg}", file=sys.stderr)
    raise SystemExit(code)


def load_yaml(path: Path) -> dict[str, Any]:
    if not path.is_file():
        fail(f"missing contract: {path}")
    try:
        payload = yaml.safe_load(path.read_text(encoding="utf-8")) or {}
    except Exception as exc:  # pragma: no cover - runtime guard
        fail(f"unable to parse YAML {path}: {exc}")
    if not isinstance(payload, dict):
        fail(f"YAML root must be mapping: {path}")
    return payload


def read_secret_var(name: str) -> str:
    val = os.environ.get(name, "").strip()
    if val:
        return val
    file_var = os.environ.get(f"{name}_FILE", "").strip()
    if file_var:
        try:
            return Path(file_var).expanduser().read_text(encoding="utf-8").strip()
        except Exception as exc:  # pragma: no cover - runtime guard
            fail(f"unable to read secret file for {name}: {exc}")
    return ""


def ssh_curl_delete(
    host: str,
    url: str,
    username: str,
    password: str,
    remote_stack_path: str,
) -> dict[str, Any]:
    """DELETE a single ICS resource from Radicale via SSH + curl."""
    result: dict[str, Any] = {
        "url": url,
        "attempted": True,
        "ok": False,
        "output": "",
        "auth_source": "none",
    }

    if username and password:
        result["auth_source"] = "env"
        remote_cmd = (
            "curl -fsS -u "
            + shlex.quote(f"{username}:{password}")
            + " -X DELETE "
            + shlex.quote(url)
            + " >/dev/null"
        )
    else:
        if not remote_stack_path:
            fail(
                "missing calendar home credentials and home.remote_stack_path unavailable for host auth fallback"
            )
        result["auth_source"] = "host_env"
        remote_cmd = (
            "set -a; source "
            + shlex.quote(f"{remote_stack_path}/.env")
            + "; set +a; "
            + "curl -fsS -u \"$RADICALE_ADMIN_USERNAME:$RADICALE_ADMIN_PASSWORD\" "
            + "-X DELETE "
            + shlex.quote(url)
            + " >/dev/null"
        )

    ssh_cmd = [
        "ssh", "-o", "BatchMode=yes", "-o", "ConnectTimeout=10",
        host, remote_cmd,
    ]
    proc = subprocess.run(ssh_cmd, capture_output=True, text=True, check=False)
    result["output"] = (proc.stdout or proc.stderr or "").strip()
    result["ok"] = proc.returncode == 0
    return result


def main() -> None:
    script_dir = Path(__file__).resolve().parent
    root = Path(os.environ.get("SPINE_ROOT", str(script_dir.parents[3]))).expanduser().resolve()

    parser = argparse.ArgumentParser(description="Delete an event from governed local calendar home")
    parser.add_argument("--uid", required=True, help="Event UID to delete")
    parser.add_argument("--calendar-id", default="spine", help="Local calendar collection id")
    parser.add_argument("--json", action="store_true", help="Emit JSON summary")
    args = parser.parse_args()

    home_contract_path = root / "ops/bindings/calendar.home.contract.yaml"
    sync_contract_path = root / "ops/bindings/calendar.sync.contract.yaml"

    home = load_yaml(home_contract_path)
    sync = load_yaml(sync_contract_path)

    home_section = home.get("home") if isinstance(home.get("home"), dict) else {}
    endpoint = home_section.get("endpoint") if isinstance(home_section.get("endpoint"), dict) else {}

    provider = str(home_section.get("provider", "")).strip()
    host = str(home_section.get("host", "")).strip()
    remote_stack_path = str(home_section.get("remote_stack_path", "")).strip()

    if provider != "communications-calendar":
        fail(f"calendar home provider must be communications-calendar (actual={provider!r})")
    if host != "communications-stack":
        fail(f"calendar home host must be communications-stack (actual={host!r})")

    sync_push_caps = (
        sync.get("sync_contracts", {}).get("push_write_capabilities", [])
        if isinstance(sync.get("sync_contracts"), dict)
        else []
    )
    if not isinstance(sync_push_caps, list) or sync_push_caps:
        fail(f"calendar sync push_write_capabilities must remain empty (actual={sync_push_caps!r})")

    base_url = str(endpoint.get("base_url", "")).strip().rstrip("/")
    collection = str(endpoint.get("calendar_collection", "/spine/")).strip()
    if not collection.startswith("/"):
        collection = "/" + collection
    if not collection.endswith("/"):
        collection = collection + "/"

    if not base_url:
        fail("calendar.home.contract endpoint.base_url is required")

    username = read_secret_var("CALENDAR_HOME_USERNAME") or read_secret_var("RADICALE_ADMIN_USERNAME")
    password = read_secret_var("CALENDAR_HOME_PASSWORD") or read_secret_var("RADICALE_ADMIN_PASSWORD")

    event_url = f"{base_url}{collection}{args.uid}.ics"

    delete_result = ssh_curl_delete(
        host=host,
        url=event_url,
        username=username,
        password=password,
        remote_stack_path=remote_stack_path,
    )

    if not delete_result["ok"]:
        fail(f"remote calendar delete failed: {delete_result['output'] or 'curl returned non-zero'}")

    # Remove local store copy if exists
    local_store_rel = str(
        sync.get("local_calendar_store", {}).get("path", "mailroom/state/calendar-sync/writable")
    ).strip()
    local_store_root = (root / local_store_rel).resolve()
    local_events_dir = local_store_root / "events"
    local_removed = False
    if local_events_dir.is_dir():
        for ics_file in local_events_dir.glob(f"*{args.uid}*.ics"):
            ics_file.unlink()
            local_removed = True

    payload = {
        "capability": "calendar.home.event.delete",
        "status": "ok",
        "generated_at": time.strftime("%Y-%m-%dT%H:%M:%SZ", time.gmtime()),
        "data": {
            "uid": args.uid,
            "calendar_id": args.calendar_id,
            "provider": provider,
            "host": host,
            "remote_delete": delete_result,
            "local_store_removed": local_removed,
        },
    }

    if args.json:
        print(json.dumps(payload, indent=2, sort_keys=True))
    else:
        print("calendar.home.event.delete")
        print(f"provider: {provider}")
        print(f"uid: {args.uid}")
        print(f"remote_delete_ok: {str(delete_result['ok']).lower()}")
        print(f"remote_auth_source: {delete_result['auth_source']}")
        print(f"local_store_removed: {str(local_removed).lower()}")
        print("status: OK")


if __name__ == "__main__":
    main()
