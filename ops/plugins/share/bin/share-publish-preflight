#!/usr/bin/env bash
# share-publish-preflight: Read-only pre-flight checks for share publish
#
# Validates:
# 1. Git tree is clean
# 2. spine.verify passes (runs drift-gate.sh and fails on non-zero)
# 3. Share governance bindings exist (allowlist, denylist, remote, protocol)
# 4. Share remote is configured in git
# 5. Capabilities registered
set -euo pipefail

SP="${SPINE_ROOT:-$HOME/code/agentic-spine}"
cd "$SP"

FAIL=0
err() { echo "  FAIL: $1" >&2; FAIL=1; }
ok()  { echo "  OK: $1"; }

echo "=== Share Publish Pre-flight ==="

# 1. Clean tree
echo "--- Git state ---"
if [[ -z "$(git status --porcelain)" ]]; then
  ok "git tree is clean"
else
  err "git tree is dirty — commit or stash changes first"
fi

# 2. Spine verify (actual enforcement — runs drift-gate.sh)
echo "--- Spine verify ---"
GATE="$SP/surfaces/verify/drift-gate.sh"
if [[ -x "$GATE" ]]; then
  if bash "$GATE" >/dev/null 2>&1; then
    ok "spine.verify passes (all drift gates green)"
  else
    err "spine.verify FAILED — fix drift gate failures before publishing"
  fi
else
  err "drift-gate.sh not found or not executable"
fi

# 3. Required bindings exist
echo "--- Governance bindings ---"
for f in \
  "ops/bindings/share.publish.allowlist.yaml" \
  "ops/bindings/share.publish.denylist.yaml" \
  "ops/bindings/share.publish.remote.yaml" \
  "docs/governance/WORKBENCH_SHARE_PROTOCOL.md"; do
  if [[ -f "$SP/$f" ]]; then
    ok "$f exists"
  else
    err "$f missing"
  fi
done

# 4. Share remote configured (read remote name from binding)
echo "--- Remote configuration ---"
REMOTE_BINDING="$SP/ops/bindings/share.publish.remote.yaml"
REMOTE_NAME="share"
if [[ -f "$REMOTE_BINDING" ]] && command -v yq >/dev/null 2>&1; then
  REMOTE_NAME=$(yq -r '.remote.name' "$REMOTE_BINDING" 2>/dev/null || echo "share")
fi
if git remote get-url "$REMOTE_NAME" >/dev/null 2>&1; then
  SHARE_URL="$(git remote get-url "$REMOTE_NAME")"
  ok "remote '$REMOTE_NAME' configured: $SHARE_URL"
else
  err "git remote '$REMOTE_NAME' not configured (run: git remote add $REMOTE_NAME <url>)"
fi

# 5. Capabilities registered
echo "--- Capability registration ---"
CAP_FILE="$SP/ops/capabilities.yaml"
for cap in share.publish.preflight share.publish.preview share.publish.apply; do
  if grep -q "^  $cap:" "$CAP_FILE" 2>/dev/null; then
    ok "capability $cap registered"
  else
    err "capability $cap not in capabilities.yaml"
  fi
done

echo
if [[ "$FAIL" -eq 0 ]]; then
  echo "PRE-FLIGHT: PASS"
else
  echo "PRE-FLIGHT: FAIL ($FAIL issue(s))"
fi
exit "$FAIL"
