#!/usr/bin/env bash
# share-publish-preview: Read-only preview of what would be published
#
# Builds candidate file list from allowlist, checks against denylist,
# reports blocked hits. Does NOT push anything.
set -euo pipefail

SP="${SPINE_ROOT:-$HOME/code/agentic-spine}"
cd "$SP"

ALLOWLIST="$SP/ops/bindings/share.publish.allowlist.yaml"
DENYLIST="$SP/ops/bindings/share.publish.denylist.yaml"

command -v yq >/dev/null 2>&1 || { echo "FAIL: yq not found" >&2; exit 1; }
[[ -f "$ALLOWLIST" ]] || { echo "FAIL: allowlist not found" >&2; exit 1; }
[[ -f "$DENYLIST" ]] || { echo "FAIL: denylist not found" >&2; exit 1; }

echo "=== Share Publish Preview ==="

# Step 1: Collect candidate files from allowlist patterns
echo "--- Allowlist scan ---"
CANDIDATES=$(mktemp)
trap 'rm -f "$CANDIDATES"' EXIT

pattern_count=$(yq '.allowed_paths | length' "$ALLOWLIST")
for ((i=0; i<pattern_count; i++)); do
  pat=$(yq -r ".allowed_paths[$i].pattern" "$ALLOWLIST")
  # Use git ls-files to only consider tracked files
  git ls-files -- "$pat" 2>/dev/null >> "$CANDIDATES" || true
done

TOTAL=$(sort -u "$CANDIDATES" | wc -l | tr -d ' ')
echo "  Candidate files from allowlist: $TOTAL"

# Step 2: Filter out explicitly excluded paths
echo "--- Exclusion filter ---"
FILTERED=$(mktemp)
trap 'rm -f "$CANDIDATES" "$FILTERED"' EXIT

excl_count=$(yq '.excluded | length' "$ALLOWLIST" 2>/dev/null || echo 0)
cp "$CANDIDATES" "$FILTERED"
for ((i=0; i<excl_count; i++)); do
  excl_pat=$(yq -r ".excluded[$i].pattern" "$ALLOWLIST")
  # Remove matching lines
  grep -v "^${excl_pat}$" "$FILTERED" > "$FILTERED.tmp" 2>/dev/null || true
  mv "$FILTERED.tmp" "$FILTERED"
done

# Also filter excluded directories
excl_dir_count=$(yq '.excluded_directories | length' "$DENYLIST" 2>/dev/null || echo 0)
for ((i=0; i<excl_dir_count; i++)); do
  excl_dir=$(yq -r ".excluded_directories[$i].path" "$DENYLIST")
  grep -v "^${excl_dir}" "$FILTERED" > "$FILTERED.tmp" 2>/dev/null || true
  mv "$FILTERED.tmp" "$FILTERED"
done

# Also filter excluded extensions
excl_ext_count=$(yq '.excluded_extensions | length' "$DENYLIST" 2>/dev/null || echo 0)
for ((i=0; i<excl_ext_count; i++)); do
  excl_ext=$(yq -r ".excluded_extensions[$i].extension" "$DENYLIST")
  grep -v "\\${excl_ext}$" "$FILTERED" > "$FILTERED.tmp" 2>/dev/null || true
  mv "$FILTERED.tmp" "$FILTERED"
done

AFTER_EXCL=$(sort -u "$FILTERED" | wc -l | tr -d ' ')
EXCLUDED=$((TOTAL - AFTER_EXCL))
echo "  Excluded by path/dir/ext filters: $EXCLUDED"
echo "  Remaining candidates: $AFTER_EXCL"

# Step 3: Scan remaining files against denylist secret patterns
echo "--- Denylist content scan ---"
BLOCKED=0
BLOCKED_FILES=""

# Collect all secret + credential patterns
all_patterns=$(mktemp)
for section in secret_patterns credential_patterns; do
  cnt=$(yq ".$section | length" "$DENYLIST" 2>/dev/null || echo 0)
  for ((i=0; i<cnt; i++)); do
    yq -r ".$section[$i].pattern" "$DENYLIST" >> "$all_patterns"
  done
done

while IFS= read -r candidate; do
  [[ -z "$candidate" ]] && continue
  [[ -f "$SP/$candidate" ]] || continue
  while IFS= read -r pat; do
    [[ -z "$pat" ]] && continue
    if grep -qP "$pat" "$SP/$candidate" 2>/dev/null; then
      BLOCKED=$((BLOCKED + 1))
      BLOCKED_FILES="${BLOCKED_FILES}\n  BLOCKED: $candidate (pattern: $pat)"
      break
    fi
  done < "$all_patterns"
done < <(sort -u "$FILTERED")

rm -f "$all_patterns"

if [[ "$BLOCKED" -gt 0 ]]; then
  echo "  Blocked by denylist patterns: $BLOCKED"
  echo -e "$BLOCKED_FILES"
else
  echo "  Blocked by denylist patterns: 0"
fi

# Step 4: Summary
PUBLISHABLE=$((AFTER_EXCL - BLOCKED))
echo
echo "--- Summary ---"
echo "  Allowlist candidates: $TOTAL"
echo "  Excluded (path/dir/ext): $EXCLUDED"
echo "  Blocked (content scan): $BLOCKED"
echo "  Publishable files: $PUBLISHABLE"

if [[ "$BLOCKED" -gt 0 ]]; then
  echo
  echo "WARNING: $BLOCKED file(s) contain denylist patterns. Review before publishing."
  exit 1
fi

echo
echo "PREVIEW: PASS ($PUBLISHABLE files ready)"
exit 0
