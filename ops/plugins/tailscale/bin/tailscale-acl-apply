#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "$0")/../../../../" && pwd)"
SECRETS_EXEC="$ROOT/ops/plugins/secrets/bin/secrets-exec"

if [[ -z "${SPINE_SECRETS_INJECTED:-}" ]]; then
  export SPINE_SECRETS_INJECTED=1
  exec "$SECRETS_EXEC" -- "$0" "$@"
fi

TAILNET="${TAILSCALE_TAILNET:-taile9480.ts.net}"
API_BASE="https://api.tailscale.com/api/v2"
ACL_POLICY="$ROOT/ops/bindings/tailscale.acl.policy.hujson"

# OAuth required for ACL writes (API keys are read-only for policy)
if [[ -z "${TAILSCALE_OAUTH_CLIENT_ID:-}" ]] || [[ -z "${TAILSCALE_OAUTH_CLIENT_SECRET:-}" ]]; then
  echo "STOP: TAILSCALE_OAUTH_CLIENT_ID and TAILSCALE_OAUTH_CLIENT_SECRET required for ACL apply" >&2
  exit 2
fi

if [[ ! -f "$ACL_POLICY" ]]; then
  echo "STOP: local policy file missing: $ACL_POLICY" >&2
  exit 1
fi

# Parse arguments
DRY_RUN=false
while [[ $# -gt 0 ]]; do
  case "$1" in
    --dry-run) DRY_RUN=true; shift ;;
    --) shift ;;
    *) shift ;;
  esac
done

echo "tailscale.acl.apply"
echo "tailnet: $TAILNET"
echo "policy_file: $ACL_POLICY"
echo "dry_run: $DRY_RUN"

# Obtain OAuth bearer token
token_response=$(curl -fsS \
  -X POST \
  -u "${TAILSCALE_OAUTH_CLIENT_ID}:${TAILSCALE_OAUTH_CLIENT_SECRET}" \
  -d "grant_type=client_credentials" \
  "https://api.tailscale.com/api/v2/oauth/token" 2>&1) || {
  echo "oauth: FAIL"
  echo "error: $token_response"
  exit 1
}

BEARER=$(echo "$token_response" | python3 -c "import json,sys; print(json.load(sys.stdin)['access_token'])" 2>/dev/null) || {
  echo "oauth: FAIL (no access_token in response)"
  exit 1
}
echo "oauth: OK"

# Validate first
policy_content=$(cat "$ACL_POLICY")
val_response=$(curl -fsS \
  -X POST \
  -H "Authorization: Bearer $BEARER" \
  -H "Content-Type: application/hujson" \
  -d "$policy_content" \
  "${API_BASE}/tailnet/${TAILNET}/acl/validate" 2>&1) || {
  echo "validate: FAIL"
  echo "error: $val_response"
  exit 1
}

# Check validation errors
val_tmp=$(mktemp)
echo "$val_response" > "$val_tmp"
python3 -c "
import json, sys
text = open('$val_tmp').read().strip()
if not text:
    print('validate: OK (empty response = no errors)')
    sys.exit(0)
try:
    data = json.loads(text)
    errors = data if isinstance(data, list) else data.get('errors', data.get('message', []))
    if errors and errors != []:
        print('validate: FAIL')
        if isinstance(errors, list):
            for e in errors:
                print(f'  - {e}')
        else:
            print(f'  - {errors}')
        sys.exit(1)
except Exception as e:
    print('validate: FAIL')
    print(f'  - non-JSON response: {e}')
    sys.exit(1)
print('validate: OK')
" || { rm -f "$val_tmp"; exit 1; }
rm -f "$val_tmp"

if [[ "$DRY_RUN" == "true" ]]; then
  echo "mode: dry-run (validation only, no apply)"
  echo "status: PASS"
  exit 0
fi

# Fetch current ETag for optimistic concurrency
etag_header_file=$(mktemp)
curl -fsS \
  -H "Authorization: Bearer $BEARER" \
  -H "Accept: application/hujson" \
  -D "$etag_header_file" \
  -o /dev/null \
  "${API_BASE}/tailnet/${TAILNET}/acl" 2>/dev/null || true

ETAG=$(grep -i '^etag:' "$etag_header_file" 2>/dev/null | sed 's/^[Ee][Tt][Aa][Gg]: *//;s/\r$//' || true)
rm -f "$etag_header_file"

if [[ -n "$ETAG" ]]; then
  echo "etag: $ETAG"
else
  echo "etag: none (first apply or read failed)"
fi

# Apply the policy — use ETag if available for concurrency safety
apply_http_code_file=$(mktemp)
apply_response_file=$(mktemp)

if [[ -n "$ETAG" ]]; then
  http_code=$(curl -sS -w '%{http_code}' \
    -X POST \
    -H "Authorization: Bearer $BEARER" \
    -H "Content-Type: application/hujson" \
    -H "If-Match: $ETAG" \
    -d "$policy_content" \
    -o "$apply_response_file" \
    "${API_BASE}/tailnet/${TAILNET}/acl" 2>&1) || true
else
  http_code=$(curl -sS -w '%{http_code}' \
    -X POST \
    -H "Authorization: Bearer $BEARER" \
    -H "Content-Type: application/hujson" \
    -d "$policy_content" \
    -o "$apply_response_file" \
    "${API_BASE}/tailnet/${TAILNET}/acl" 2>&1) || true
fi

apply_body=$(cat "$apply_response_file" 2>/dev/null || echo "")
rm -f "$apply_response_file"

echo "http_code: $http_code"

if [[ "$http_code" -ge 200 && "$http_code" -lt 300 ]]; then
  echo "apply: OK"
  echo "status: PASS"
  echo "note: ACL policy applied to $TAILNET — verify via tailscale.acl.status"
else
  echo "apply: FAIL"
  echo "error_body: $apply_body"
  exit 1
fi
