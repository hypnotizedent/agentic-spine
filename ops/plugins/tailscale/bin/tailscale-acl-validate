#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "$0")/../../../../" && pwd)"
SECRETS_EXEC="$ROOT/ops/plugins/secrets/bin/secrets-exec"

if [[ -z "${SPINE_SECRETS_INJECTED:-}" ]]; then
  export SPINE_SECRETS_INJECTED=1
  exec "$SECRETS_EXEC" -- "$0" "$@"
fi

TAILNET="${TAILSCALE_TAILNET:-taile9480.ts.net}"
API_BASE="https://api.tailscale.com/api/v2"
ACL_POLICY="$ROOT/ops/bindings/tailscale.acl.policy.hujson"

if [[ -z "${TAILSCALE_API_KEY:-}" ]]; then
  echo "STOP: TAILSCALE_API_KEY missing" >&2
  exit 2
fi

if [[ ! -f "$ACL_POLICY" ]]; then
  echo "tailscale.acl.validate"
  echo "status: FAIL"
  echo "error: local policy file missing: $ACL_POLICY"
  exit 1
fi

echo "tailscale.acl.validate"
echo "tailnet: $TAILNET"
echo "policy_file: $ACL_POLICY"

# Local syntax check: ensure HuJSON parses
python3 -c "
import json, re, sys

text = open('$ACL_POLICY').read()
# Strip HuJSON comments
text = re.sub(r'//[^\n]*', '', text)
# Strip trailing commas
text = re.sub(r',(\s*[}\]])', r'\1', text)
try:
    data = json.loads(text)
    print('local_parse: OK')
except json.JSONDecodeError as e:
    print(f'local_parse: FAIL ({e})')
    sys.exit(1)
" || exit 1

# Remote validation via Tailscale API
policy_content=$(cat "$ACL_POLICY")
response=$(curl -fsS \
  -X POST \
  -u "${TAILSCALE_API_KEY}:" \
  -H "Content-Type: application/hujson" \
  -d "$policy_content" \
  "${API_BASE}/tailnet/${TAILNET}/acl/validate" 2>&1) || {
  echo "api_validate: FAIL"
  echo "error: $response"
  exit 1
}

# Parse validation response without swallowing JSON/parser errors
resp_tmp=$(mktemp)
printf '%s' "$response" > "$resp_tmp"
python3 - "$resp_tmp" <<'PY'
import json
import sys
from pathlib import Path

text = Path(sys.argv[1]).read_text(encoding="utf-8").strip()
if not text:
    print("api_validate: OK (empty response = no errors)")
    raise SystemExit(0)

try:
    data = json.loads(text)
except json.JSONDecodeError as exc:
    print("api_validate: FAIL")
    print(f"  - non-JSON response: {exc}")
    raise SystemExit(1)

if isinstance(data, list):
    errors = data
elif isinstance(data, dict):
    errors = data.get("errors")
    if errors is None:
        message = data.get("message")
        errors = [message] if message else []
else:
    errors = [str(data)]

if errors:
    print("api_validate: FAIL")
    if isinstance(errors, list):
        for err in errors:
            print(f"  - {err}")
    else:
        print(f"  - {errors}")
    raise SystemExit(1)

print("api_validate: OK")
PY
rm -f "$resp_tmp"

echo "status: PASS"
