#!/usr/bin/env bash
set -euo pipefail

# communications-alerts-dispatcher-status â€” read-only runtime status for
# autonomous alerts dispatcher.
#
# Safety: read-only
# Approval: auto

ROOT="${SPINE_ROOT:-$(cd "$(dirname "${BASH_SOURCE[0]}")/../../../.." && pwd)}"
QUEUE_CONTRACT="${COMMUNICATIONS_ALERTS_QUEUE_CONTRACT:-$ROOT/ops/bindings/communications.alerts.queue.contract.yaml}"
source "$ROOT/ops/lib/runtime-paths.sh"
spine_runtime_resolve_paths

JSON=0

usage() {
  cat <<'USAGE'
Usage: communications-alerts-dispatcher-status [--json]

Read-only status view of communications alerts dispatcher worker.
USAGE
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --json)
      JSON=1
      shift
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      echo "ERROR: unknown argument: $1" >&2
      exit 2
      ;;
  esac
done

command -v yq >/dev/null 2>&1 || { echo "ERROR: missing dependency: yq" >&2; exit 1; }
command -v jq >/dev/null 2>&1 || { echo "ERROR: missing dependency: jq" >&2; exit 1; }
command -v python3 >/dev/null 2>&1 || { echo "ERROR: missing dependency: python3" >&2; exit 1; }
[[ -f "$QUEUE_CONTRACT" ]] || { echo "ERROR: missing queue contract: $QUEUE_CONTRACT" >&2; exit 1; }

expand_path() {
  local p="$1"
  p="${p//\$SPINE_OUTBOX/$SPINE_OUTBOX}"
  echo "$p"
}

pid_running() {
  local pid="$1"
  [[ -n "$pid" && "$pid" =~ ^[1-9][0-9]*$ ]] || return 1
  kill -0 "$pid" >/dev/null 2>&1
}

find_worker_pid() {
  command -v pgrep >/dev/null 2>&1 || { echo 0; return; }
  while IFS= read -r candidate; do
    [[ "$candidate" =~ ^[1-9][0-9]*$ ]] || continue
    if pid_running "$candidate"; then
      echo "$candidate"
      return
    fi
  done < <(pgrep -f 'communications-alerts-dispatcher-worker --foreground' 2>/dev/null || true)
  echo 0
}

iso_age_seconds() {
  local iso="$1"
  python3 - "$iso" <<'PY'
from datetime import datetime, timezone
import sys

raw = (sys.argv[1] or "").strip()
if not raw:
    print(-1)
    raise SystemExit(0)

try:
    ts = datetime.fromisoformat(raw.replace("Z", "+00:00"))
except Exception:
    print(-1)
    raise SystemExit(0)

if ts.tzinfo is None:
    ts = ts.replace(tzinfo=timezone.utc)

age = int((datetime.now(timezone.utc) - ts).total_seconds())
print(max(age, 0))
PY
}

dispatcher_enabled="$(yq -r '.dispatcher.enabled // true' "$QUEUE_CONTRACT")"
poll_seconds="$(yq -r '.dispatcher.poll_interval_seconds // 60' "$QUEUE_CONTRACT")"
batch_limit="$(yq -r '.dispatcher.batch_limit // 10' "$QUEUE_CONTRACT")"
pid_file_raw="$(yq -r '.dispatcher.pid_file // "$SPINE_OUTBOX/communications/.alerts-dispatcher.pid"' "$QUEUE_CONTRACT")"
heartbeat_file_raw="$(yq -r '.dispatcher.heartbeat_file // "$SPINE_OUTBOX/communications/alerts-dispatcher-heartbeat.json"' "$QUEUE_CONTRACT")"
log_file_raw="$(yq -r '.dispatcher.log_file // "$SPINE_OUTBOX/communications/alerts-dispatcher.log"' "$QUEUE_CONTRACT")"
start_command="$(yq -r '.recommended_actions.dispatcher_start_command // "echo \"yes\" | ./bin/ops cap run communications.alerts.dispatcher.start"' "$QUEUE_CONTRACT")"

PID_FILE="$(expand_path "$pid_file_raw")"
HEARTBEAT_FILE="$(expand_path "$heartbeat_file_raw")"
LOG_FILE="$(expand_path "$log_file_raw")"
LAUNCH_LABEL="${COMMUNICATIONS_ALERTS_DISPATCHER_LAUNCH_LABEL:-com.ronny.communications-alerts-dispatcher}"
LAUNCH_PLIST="${COMMUNICATIONS_ALERTS_DISPATCHER_LAUNCH_PLIST:-$HOME/Library/LaunchAgents/${LAUNCH_LABEL}.plist}"

pid=0
if [[ -f "$PID_FILE" ]]; then
  from_pid_file="$(cat "$PID_FILE" 2>/dev/null || true)"
  if [[ "$from_pid_file" =~ ^[1-9][0-9]*$ ]]; then
    pid="$from_pid_file"
  fi
fi

launchd_loaded="false"
launchd_pid=0
if command -v launchctl >/dev/null 2>&1; then
  svc="$(launchctl list "$LAUNCH_LABEL" 2>/dev/null || true)"
  if [[ -n "$svc" ]]; then
    launchd_loaded="true"
    svc_pid="$(printf '%s\n' "$svc" | awk -F' = ' '/"PID"/ {gsub(/[^0-9]/,"",$2); print $2; exit}')"
    if [[ "$svc_pid" =~ ^[1-9][0-9]*$ ]]; then
      launchd_pid="$svc_pid"
      pid="$svc_pid"
    fi
  fi
fi

if ! pid_running "$pid"; then
  pid="$(find_worker_pid)"
fi

running="false"
if pid_running "$pid"; then
  running="true"
fi

heartbeat_present="false"
heartbeat_generated_at=""
heartbeat_age_seconds=-1
last_tick_json='{}'
heartbeat_status="unknown"
if [[ -f "$HEARTBEAT_FILE" ]]; then
  hb_json="$(jq -c '.' "$HEARTBEAT_FILE" 2>/dev/null || echo '{}')"
  if echo "$hb_json" | jq -e '.' >/dev/null 2>&1; then
    heartbeat_present="true"
    heartbeat_generated_at="$(echo "$hb_json" | jq -r '.generated_at // ""')"
    heartbeat_status="$(echo "$hb_json" | jq -r '.status // "unknown"')"
    last_tick_json="$(echo "$hb_json" | jq -c '.last_tick // {}')"
    heartbeat_age_seconds="$(iso_age_seconds "$heartbeat_generated_at")"
  fi
fi

stale_threshold_seconds=$(( poll_seconds * 3 + 30 ))
status="stopped"
if [[ "$dispatcher_enabled" != "true" ]]; then
  status="disabled"
elif [[ "$running" == "true" ]]; then
  status="running"
  if [[ "$heartbeat_age_seconds" =~ ^[0-9]+$ ]] && (( heartbeat_age_seconds > stale_threshold_seconds )); then
    status="stale"
  fi
elif [[ "$launchd_loaded" == "true" ]]; then
  status="loaded"
fi

if [[ "$JSON" -eq 1 ]]; then
  jq -n \
    --arg capability "communications.alerts.dispatcher.status" \
    --arg status "$status" \
    --arg generated_at "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
    --arg dispatcher_enabled "$dispatcher_enabled" \
    --arg running "$running" \
    --argjson pid "$pid" \
    --arg pid_file "$PID_FILE" \
    --arg heartbeat_file "$HEARTBEAT_FILE" \
    --arg heartbeat_present "$heartbeat_present" \
    --arg heartbeat_generated_at "$heartbeat_generated_at" \
    --argjson heartbeat_age_seconds "$heartbeat_age_seconds" \
    --arg heartbeat_status "$heartbeat_status" \
    --argjson stale_threshold_seconds "$stale_threshold_seconds" \
    --argjson poll_seconds "$poll_seconds" \
    --argjson batch_limit "$batch_limit" \
    --arg log_file "$LOG_FILE" \
    --arg launchd_loaded "$launchd_loaded" \
    --arg launchd_label "$LAUNCH_LABEL" \
    --arg launchd_plist "$LAUNCH_PLIST" \
    --argjson launchd_pid "$launchd_pid" \
    --arg recommended_action "$start_command" \
    --argjson last_tick "$last_tick_json" \
    '{
      capability: $capability,
      status: $status,
      generated_at: $generated_at,
      data: {
        dispatcher_enabled: ($dispatcher_enabled == "true"),
        running: ($running == "true"),
        pid: (if $pid > 0 then $pid else null end),
        pid_file: $pid_file,
        heartbeat_file: $heartbeat_file,
        heartbeat_present: ($heartbeat_present == "true"),
        heartbeat_generated_at: $heartbeat_generated_at,
        heartbeat_age_seconds: $heartbeat_age_seconds,
        heartbeat_status: $heartbeat_status,
        stale_threshold_seconds: $stale_threshold_seconds,
        poll_seconds: $poll_seconds,
        batch_limit: $batch_limit,
        log_file: $log_file,
        launchd: {
          loaded: ($launchd_loaded == "true"),
          label: $launchd_label,
          plist: $launchd_plist,
          pid: (if $launchd_pid > 0 then $launchd_pid else null end)
        },
        last_tick: $last_tick,
        recommended_action: (if ($running == "true") then "" else $recommended_action end)
      }
    }'
  exit 0
fi

echo "communications.alerts.dispatcher.status"
echo "status: $status"
echo "dispatcher_enabled: $dispatcher_enabled"
echo "running: $running"
if [[ "$pid" -gt 0 ]]; then
  echo "pid: $pid"
fi
echo "poll_seconds: $poll_seconds"
echo "batch_limit: $batch_limit"
echo "pid_file: $PID_FILE"
echo "heartbeat_file: $HEARTBEAT_FILE"
echo "log_file: $LOG_FILE"
echo "launchd_loaded: $launchd_loaded"
echo "launchd_label: $LAUNCH_LABEL"
echo "heartbeat_present: $heartbeat_present"
if [[ "$heartbeat_present" == "true" ]]; then
  echo "heartbeat_generated_at: $heartbeat_generated_at"
  echo "heartbeat_age_seconds: $heartbeat_age_seconds"
  echo "heartbeat_status: $heartbeat_status"
fi
if [[ "$running" != "true" ]]; then
  echo "recommended_action: $start_command"
fi
