#!/usr/bin/env bash
set -euo pipefail

ROOT="${SPINE_ROOT:-$(cd "$(dirname "${BASH_SOURCE[0]}")/../../../.." && pwd)}"
CONTRACT="$ROOT/ops/bindings/communications.stack.contract.yaml"

need() { command -v "$1" >/dev/null 2>&1 || { echo "ERROR: missing dependency: $1" >&2; exit 1; }; }
need yq
[[ -f "$CONTRACT" ]] || { echo "ERROR: missing contract: $CONTRACT" >&2; exit 1; }

if [[ "${1:-}" == "--json" ]]; then
  yq e -o=json '.pilot.mailboxes' "$CONTRACT"
  exit 0
fi

echo "communications.mailboxes.list"
printf "%-12s %-34s %-14s %-10s\n" "id" "address" "role" "status"
printf "%-12s %-34s %-14s %-10s\n" "------------" "----------------------------------" "--------------" "----------"
yq e -r '.pilot.mailboxes[] | [.id, .address, .role, .status] | @tsv' "$CONTRACT" | \
while IFS=$'\t' read -r id address role status; do
  printf "%-12s %-34s %-14s %-10s\n" "$id" "$address" "$role" "$status"
done
