#!/usr/bin/env bash
set -euo pipefail

ROOT="${SPINE_ROOT:-$(cd "$(dirname "${BASH_SOURCE[0]}")/../../../.." && pwd)}"
PROVIDERS_CONTRACT="${COMMUNICATIONS_PROVIDERS_CONTRACT:-$ROOT/ops/bindings/communications.providers.contract.yaml}"
DELIVERY_CONTRACT="${COMMUNICATIONS_DELIVERY_CONTRACT:-$ROOT/ops/bindings/communications.delivery.contract.yaml}"
PREVIEW_BIN="${COMMUNICATIONS_PREVIEW_BIN:-$ROOT/ops/plugins/communications/bin/communications-send-preview}"
MICROSOFT_EXEC="${COMMUNICATIONS_MICROSOFT_EXEC:-${COMMUNICATIONS_MICROSOFT_EXEC_LEGACY:-$ROOT/ops/plugins/microsoft/bin/microsoft-cap-exec}}"
source "$ROOT/ops/lib/runtime-paths.sh"
spine_runtime_resolve_paths

CHANNEL=""
MESSAGE_TYPE=""
RECIPIENT=""
SUBJECT=""
BODY=""
VARS_JSON="{}"
CONSENT_STATE="unknown"
TIMEZONE=""
PREVIEW_ID=""
PREVIEW_RECEIPT=""
EXECUTE=0
JSON=0

usage() {
  cat <<'USAGE'
Usage: communications-send-execute --channel <email|sms> --message-type <type> --to <recipient> [options]

Options:
  --subject <text>              Optional subject (custom email).
  --body <text>                 Optional body override.
  --vars-json <json object>     Template variables object.
  --consent-state <state>       opted-in | opted-out | unknown.
  --timezone <IANA TZ>          Override quiet-hours timezone.
  --preview-id <id>             Required for --execute (links to preview receipt).
  --preview-receipt <path>      Optional explicit receipt path (overrides preview-id lookup).
  --execute                     Perform mutation (without this, dry-run only).
  --json                        Emit JSON envelope.
USAGE
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --channel) CHANNEL="${2:-}"; shift 2 ;;
    --message-type) MESSAGE_TYPE="${2:-}"; shift 2 ;;
    --to) RECIPIENT="${2:-}"; shift 2 ;;
    --subject) SUBJECT="${2:-}"; shift 2 ;;
    --body) BODY="${2:-}"; shift 2 ;;
    --vars-json) VARS_JSON="${2:-}"; shift 2 ;;
    --consent-state) CONSENT_STATE="${2:-}"; shift 2 ;;
    --timezone) TIMEZONE="${2:-}"; shift 2 ;;
    --preview-id) PREVIEW_ID="${2:-}"; shift 2 ;;
    --preview-receipt) PREVIEW_RECEIPT="${2:-}"; shift 2 ;;
    --execute) EXECUTE=1; shift ;;
    --json) JSON=1; shift ;;
    -h|--help) usage; exit 0 ;;
    *)
      echo "ERROR: unknown argument: $1" >&2
      exit 2
      ;;
  esac
done

command -v yq >/dev/null 2>&1 || { echo "ERROR: missing dependency: yq" >&2; exit 1; }
command -v jq >/dev/null 2>&1 || { echo "ERROR: missing dependency: jq" >&2; exit 1; }
command -v curl >/dev/null 2>&1 || { echo "ERROR: missing dependency: curl" >&2; exit 1; }
command -v python3 >/dev/null 2>&1 || { echo "ERROR: missing dependency: python3" >&2; exit 1; }
[[ -f "$PROVIDERS_CONTRACT" ]] || { echo "ERROR: missing contract: $PROVIDERS_CONTRACT" >&2; exit 1; }
[[ -f "$DELIVERY_CONTRACT" ]] || { echo "ERROR: missing contract: $DELIVERY_CONTRACT" >&2; exit 1; }
[[ -x "$PREVIEW_BIN" ]] || { echo "ERROR: missing preview script: $PREVIEW_BIN" >&2; exit 1; }

require_preview="$(yq e -r '.execution_policy.require_preview_receipt_for_execute // true' "$DELIVERY_CONTRACT")"
preview_max_age_minutes="$(yq e -r '.execution_policy.preview_max_age_minutes // 30' "$DELIVERY_CONTRACT")"
revalidate_on_execute="$(yq e -r '.execution_policy.revalidate_on_execute // true' "$DELIVERY_CONTRACT")"

preview_dir_raw="$(yq e -r '.artifacts.preview_receipts_dir // "$SPINE_OUTBOX/communications/previews"' "$DELIVERY_CONTRACT")"
preview_dir="${preview_dir_raw//\$SPINE_OUTBOX/$SPINE_OUTBOX}"
mkdir -p "$preview_dir"

if [[ -z "$PREVIEW_RECEIPT" && -n "$PREVIEW_ID" ]]; then
  PREVIEW_RECEIPT="$preview_dir/${PREVIEW_ID}.json"
fi

if [[ "$EXECUTE" -eq 1 && "$require_preview" == "true" && -z "$PREVIEW_RECEIPT" ]]; then
  echo "ERROR: --execute requires preview linkage. Run communications.send.preview first and pass --preview-id or --preview-receipt." >&2
  exit 2
fi

preview_doc_json=""
if [[ -n "$PREVIEW_RECEIPT" ]]; then
  [[ -f "$PREVIEW_RECEIPT" ]] || { echo "ERROR: preview receipt not found: $PREVIEW_RECEIPT" >&2; exit 1; }
  preview_doc_json="$(jq -c '.' "$PREVIEW_RECEIPT")"

  if [[ -z "$PREVIEW_ID" ]]; then
    PREVIEW_ID="$(echo "$preview_doc_json" | jq -r '.preview_id // ""')"
  fi

  if [[ -n "$CHANNEL" ]]; then
    expected="$(echo "$preview_doc_json" | jq -r '.request.channel // ""')"
    [[ "$CHANNEL" == "$expected" ]] || { echo "ERROR: --channel does not match preview receipt" >&2; exit 2; }
  fi
  if [[ -n "$MESSAGE_TYPE" ]]; then
    expected="$(echo "$preview_doc_json" | jq -r '.request.message_type // ""')"
    [[ "$MESSAGE_TYPE" == "$expected" ]] || { echo "ERROR: --message-type does not match preview receipt" >&2; exit 2; }
  fi
  if [[ -n "$RECIPIENT" ]]; then
    expected="$(echo "$preview_doc_json" | jq -r '.request.recipient // ""')"
    [[ "$RECIPIENT" == "$expected" ]] || { echo "ERROR: --to does not match preview receipt" >&2; exit 2; }
  fi

  CHANNEL="$(echo "$preview_doc_json" | jq -r '.request.channel // ""')"
  MESSAGE_TYPE="$(echo "$preview_doc_json" | jq -r '.request.message_type // ""')"
  RECIPIENT="$(echo "$preview_doc_json" | jq -r '.request.recipient // ""')"
  SUBJECT="$(echo "$preview_doc_json" | jq -r '.request.subject // ""')"
  BODY="$(echo "$preview_doc_json" | jq -r '.request.body // ""')"
  VARS_JSON="$(echo "$preview_doc_json" | jq -c '.request.vars_json // {}')"
  CONSENT_STATE="$(echo "$preview_doc_json" | jq -r '.request.consent_state // "unknown"')"
  TIMEZONE="$(echo "$preview_doc_json" | jq -r '.request.timezone // ""')"

  if [[ "$EXECUTE" -eq 1 ]]; then
    preview_generated_at="$(echo "$preview_doc_json" | jq -r '.generated_at // ""')"
    python3 - "$preview_generated_at" "$preview_max_age_minutes" <<'PY'
from datetime import datetime, timezone
import sys

raw_ts = (sys.argv[1] or "").strip()
max_age_minutes = int(sys.argv[2])
if not raw_ts:
    print("ERROR: preview receipt missing generated_at", file=sys.stderr)
    raise SystemExit(1)

try:
    ts = datetime.fromisoformat(raw_ts.replace("Z", "+00:00"))
except Exception:
    print("ERROR: preview generated_at invalid", file=sys.stderr)
    raise SystemExit(1)

if ts.tzinfo is None:
    ts = ts.replace(tzinfo=timezone.utc)

age_seconds = (datetime.now(timezone.utc) - ts).total_seconds()
if age_seconds > (max_age_minutes * 60):
    print("ERROR: preview receipt expired; rerun communications.send.preview", file=sys.stderr)
    raise SystemExit(1)
PY
  fi
fi

[[ "$CHANNEL" == "email" || "$CHANNEL" == "sms" ]] || { echo "ERROR: --channel must be email or sms" >&2; exit 2; }
[[ -n "$MESSAGE_TYPE" ]] || { echo "ERROR: --message-type is required" >&2; exit 2; }
[[ -n "$RECIPIENT" ]] || { echo "ERROR: --to is required" >&2; exit 2; }
[[ "$CONSENT_STATE" == "opted-in" || "$CONSENT_STATE" == "opted-out" || "$CONSENT_STATE" == "unknown" ]] || {
  echo "ERROR: --consent-state must be opted-in, opted-out, or unknown" >&2
  exit 2
}

echo "$VARS_JSON" | jq -e 'type == "object"' >/dev/null 2>&1 || {
  echo "ERROR: --vars-json must be a JSON object" >&2
  exit 2
}

preview_cmd=(
  "$PREVIEW_BIN"
  --channel "$CHANNEL"
  --message-type "$MESSAGE_TYPE"
  --to "$RECIPIENT"
  --vars-json "$VARS_JSON"
  --consent-state "$CONSENT_STATE"
  --json
  --no-receipt-write
)
if [[ -n "$SUBJECT" ]]; then
  preview_cmd+=(--subject "$SUBJECT")
fi
if [[ -n "$BODY" ]]; then
  preview_cmd+=(--body "$BODY")
fi
if [[ -n "$TIMEZONE" ]]; then
  preview_cmd+=(--timezone "$TIMEZONE")
fi

current_preview_json="$("${preview_cmd[@]}")"
payload="$(echo "$current_preview_json" | jq -c '.data')"

if [[ -n "$preview_doc_json" && "$EXECUTE" -eq 1 && "$revalidate_on_execute" == "true" ]]; then
  expected_signature="$(echo "$preview_doc_json" | jq -c '.data | {channel,message_type,recipient,provider,transactional_mode,cutover_phase,provider_execution_mode,consent_state,quiet_timezone,template_id,subject,body,variables,send_allowed,policy_block_reasons}')"
  current_signature="$(echo "$payload" | jq -c '{channel,message_type,recipient,provider,transactional_mode,cutover_phase,provider_execution_mode,consent_state,quiet_timezone,template_id,subject,body,variables,send_allowed,policy_block_reasons}')"
  if [[ "$expected_signature" != "$current_signature" ]]; then
    echo "ERROR: preview drift detected; rerun communications.send.preview for current policy/routing state" >&2
    exit 1
  fi
fi

provider="$(echo "$payload" | jq -r '.provider')"
channel="$(echo "$payload" | jq -r '.channel')"
message_type="$(echo "$payload" | jq -r '.message_type')"
recipient="$(echo "$payload" | jq -r '.recipient')"
rendered_subject="$(echo "$payload" | jq -r '.subject // ""')"
rendered_body="$(echo "$payload" | jq -r '.body // ""')"
transactional_mode="$(echo "$payload" | jq -r '.transactional_mode')"
cutover_phase="$(echo "$payload" | jq -r '.cutover_phase // "phase0-simulation"')"
provider_execution_mode="$(echo "$payload" | jq -r '.provider_execution_mode')"
send_allowed="$(echo "$payload" | jq -r '.send_allowed // false')"
policy_block_reasons="$(echo "$payload" | jq -r '.policy_block_reasons | join(",")')"

expand_path() {
  local p="$1"
  p="${p//\$SPINE_OUTBOX/$SPINE_OUTBOX}"
  echo "$p"
}

latest_record_path="$(expand_path "$(yq e -r '.artifacts.latest_record_file // "$SPINE_OUTBOX/communications/communications-transaction-last.yaml"' "$DELIVERY_CONTRACT")")"
append_log_path="$(expand_path "$(yq e -r '.artifacts.append_log_file // "$SPINE_OUTBOX/communications/communications-delivery-log.jsonl"' "$DELIVERY_CONTRACT")")"
mkdir -p "$(dirname "$latest_record_path")"
mkdir -p "$(dirname "$append_log_path")"

generated_at="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
event_id="comm-$(date -u +%Y%m%dT%H%M%SZ)-$RANDOM"

emit_json() {
  local status="$1"
  local provider_message_id="${2:-}"
  local error_text="${3:-}"
  jq -n \
    --arg capability "communications.send.execute" \
    --arg schema_version "1.0" \
    --arg status "$status" \
    --arg generated_at "$generated_at" \
    --arg event_id "$event_id" \
    --arg preview_id "$PREVIEW_ID" \
    --arg preview_receipt "$PREVIEW_RECEIPT" \
    --arg channel "$channel" \
    --arg message_type "$message_type" \
    --arg provider "$provider" \
    --arg recipient "$recipient" \
    --arg subject "$rendered_subject" \
    --arg body "$rendered_body" \
    --arg transactional_mode "$transactional_mode" \
    --arg cutover_phase "$cutover_phase" \
    --arg provider_execution_mode "$provider_execution_mode" \
    --arg provider_message_id "$provider_message_id" \
    --arg record "$latest_record_path" \
    --arg log "$append_log_path" \
    --arg error "$error_text" \
    '{
      capability: $capability,
      schema_version: $schema_version,
      status: $status,
      generated_at: $generated_at,
      data: {
        event_id: $event_id,
        preview_id: $preview_id,
        preview_receipt: $preview_receipt,
        channel: $channel,
        message_type: $message_type,
        provider: $provider,
        recipient: $recipient,
        subject: $subject,
        body: $body,
        transactional_mode: $transactional_mode,
        cutover_phase: $cutover_phase,
        provider_execution_mode: $provider_execution_mode,
        provider_message_id: $provider_message_id,
        record: $record,
        log: $log
      }
    } + (if ($error | length) > 0 then {error:{message:$error}} else {} end)'
}

if [[ "$EXECUTE" -ne 1 ]]; then
  dry_status="dry-run"
  if [[ "$send_allowed" != "true" ]]; then
    dry_status="blocked"
  fi
  if [[ "$JSON" -eq 1 ]]; then
    emit_json "$dry_status" "" "$policy_block_reasons"
  else
    echo "communications.send.execute"
    echo "status: $dry_status"
    [[ -n "$PREVIEW_ID" ]] && echo "preview_id: $PREVIEW_ID"
    [[ -n "$PREVIEW_RECEIPT" ]] && echo "preview_receipt: $PREVIEW_RECEIPT"
    echo "provider: $provider"
    echo "channel: $channel"
    echo "message_type: $message_type"
    echo "to: $recipient"
    [[ -n "$policy_block_reasons" ]] && echo "policy_block_reasons: $policy_block_reasons"
    [[ "$channel" == "email" ]] && echo "subject: $rendered_subject"
    echo "body: $rendered_body"
  fi
  exit 0
fi

status="pending"
provider_message_id=""
error_text=""

if [[ "$send_allowed" != "true" ]]; then
  status="failed"
  error_text="policy_blocked:${policy_block_reasons:-unknown}"
elif [[ "$transactional_mode" != "live" || "$provider_execution_mode" != "live" ]]; then
  status="simulated"
else
  if [[ "$provider" == "resend" && "$channel" == "email" ]]; then
    [[ -n "${RESEND_API_KEY:-}" ]] || { echo "ERROR: RESEND_API_KEY is required for live resend sends" >&2; exit 1; }
    from_email="${FROM_EMAIL:-$(yq e -r '.transactional.default_sender_email // ""' "$PROVIDERS_CONTRACT")}"
    from_name="$(yq e -r '.transactional.default_sender_name // "Mint Prints"' "$PROVIDERS_CONTRACT")"
    [[ -n "$from_email" ]] || { echo "ERROR: FROM_EMAIL or transactional.default_sender_email is required" >&2; exit 1; }
    response_file="$(mktemp)"
    http_code="$(
      jq -n \
        --arg from "${from_name} <${from_email}>" \
        --arg to "$recipient" \
        --arg subject "$rendered_subject" \
        --arg text "$rendered_body" \
        '{from:$from,to:[$to],subject:$subject,text:$text}' \
      | curl -sS -o "$response_file" -w "%{http_code}" \
          -X POST "https://api.resend.com/emails" \
          -H "Authorization: Bearer ${RESEND_API_KEY}" \
          -H "Content-Type: application/json" \
          --data-binary @-
    )"
    if [[ "$http_code" == "200" || "$http_code" == "201" ]]; then
      provider_message_id="$(jq -r '.id // ""' "$response_file")"
      status="sent"
    else
      status="failed"
      error_text="resend http_code=$http_code"
    fi
    rm -f "$response_file"
  elif [[ "$provider" == "twilio" && "$channel" == "sms" ]]; then
    [[ -n "${TWILIO_ACCOUNT_SID:-}" ]] || { echo "ERROR: TWILIO_ACCOUNT_SID is required for live twilio sends" >&2; exit 1; }
    [[ -n "${TWILIO_AUTH_TOKEN:-}" ]] || { echo "ERROR: TWILIO_AUTH_TOKEN is required for live twilio sends" >&2; exit 1; }
    from_phone="${TWILIO_PHONE_NUMBER:-$(yq e -r '.transactional.default_sms_from // ""' "$PROVIDERS_CONTRACT")}"
    [[ -n "$from_phone" ]] || { echo "ERROR: TWILIO_PHONE_NUMBER or transactional.default_sms_from is required" >&2; exit 1; }
    response_file="$(mktemp)"
    twilio_url="https://api.twilio.com/2010-04-01/Accounts/${TWILIO_ACCOUNT_SID}/Messages.json"
    http_code="$(
      curl -sS -o "$response_file" -w "%{http_code}" \
        -u "${TWILIO_ACCOUNT_SID}:${TWILIO_AUTH_TOKEN}" \
        --data-urlencode "To=${recipient}" \
        --data-urlencode "From=${from_phone}" \
        --data-urlencode "Body=${rendered_body}" \
        "$twilio_url"
    )"
    if [[ "$http_code" == "200" || "$http_code" == "201" ]]; then
      provider_message_id="$(jq -r '.sid // ""' "$response_file")"
      status="sent"
    else
      status="failed"
      error_text="twilio http_code=$http_code"
    fi
    rm -f "$response_file"
  elif [[ "$provider" == "microsoft" && "$channel" == "email" ]]; then
    [[ -x "$MICROSOFT_EXEC" ]] || { echo "ERROR: missing Microsoft executor: $MICROSOFT_EXEC" >&2; exit 1; }
    if "$MICROSOFT_EXEC" mail_send --to "$recipient" --subject "$rendered_subject" --body "$rendered_body" >/dev/null 2>&1; then
      status="sent"
    else
      status="failed"
      error_text="microsoft mail_send failed"
    fi
  else
    status="failed"
    error_text="unsupported live route provider=$provider channel=$channel"
  fi
fi

cat > "$latest_record_path" <<YAML
event_id: "$event_id"
preview_id: "$PREVIEW_ID"
preview_receipt: "$PREVIEW_RECEIPT"
created_at: "$generated_at"
channel: "$channel"
message_type: "$message_type"
provider: "$provider"
recipient: "$recipient"
subject: "$rendered_subject"
body: "$rendered_body"
transactional_mode: "$transactional_mode"
cutover_phase: "$cutover_phase"
provider_execution_mode: "$provider_execution_mode"
status: "$status"
provider_message_id: "$provider_message_id"
error: "$error_text"
YAML

jq -nc \
  --arg event_id "$event_id" \
  --arg preview_id "$PREVIEW_ID" \
  --arg preview_receipt "$PREVIEW_RECEIPT" \
  --arg created_at "$generated_at" \
  --arg channel "$channel" \
  --arg message_type "$message_type" \
  --arg provider "$provider" \
  --arg recipient "$recipient" \
  --arg subject "$rendered_subject" \
  --arg transactional_mode "$transactional_mode" \
  --arg cutover_phase "$cutover_phase" \
  --arg provider_execution_mode "$provider_execution_mode" \
  --arg status "$status" \
  --arg provider_message_id "$provider_message_id" \
  --arg error "$error_text" \
  '{
    event_id: $event_id,
    preview_id: $preview_id,
    preview_receipt: $preview_receipt,
    created_at: $created_at,
    channel: $channel,
    message_type: $message_type,
    provider: $provider,
    recipient: $recipient,
    subject: $subject,
    transactional_mode: $transactional_mode,
    cutover_phase: $cutover_phase,
    provider_execution_mode: $provider_execution_mode,
    status: $status,
    provider_message_id: $provider_message_id,
    error: $error
  }' >> "$append_log_path"

if [[ "$JSON" -eq 1 ]]; then
  emit_json "$status" "$provider_message_id" "$error_text"
else
  echo "communications.send.execute"
  echo "status: $status"
  echo "event_id: $event_id"
  [[ -n "$PREVIEW_ID" ]] && echo "preview_id: $PREVIEW_ID"
  [[ -n "$PREVIEW_RECEIPT" ]] && echo "preview_receipt: $PREVIEW_RECEIPT"
  echo "provider: $provider"
  echo "channel: $channel"
  echo "message_type: $message_type"
  echo "to: $recipient"
  [[ "$channel" == "email" ]] && echo "subject: $rendered_subject"
  echo "record: $latest_record_path"
  echo "log: $append_log_path"
  [[ -n "$provider_message_id" ]] && echo "provider_message_id: $provider_message_id"
  [[ -n "$error_text" ]] && echo "error: $error_text"
fi

if [[ "$status" == "failed" ]]; then
  exit 1
fi
