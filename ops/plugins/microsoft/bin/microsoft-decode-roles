#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SPINE_ROOT="${SPINE_ROOT:-$(cd "$SCRIPT_DIR/../../../.." && pwd)}"
SCRIPT_NAME="$(basename "$0")"
PROJECT_ROOT="${MICROSOFT_PLUGIN_PROJECT_ROOT:-/Users/ronnyworks/code/workbench/agents/microsoft/tools/spine-plugin-microsoft/bin}"
PROJECT_SCRIPT="$PROJECT_ROOT/$SCRIPT_NAME"
LEGACY_SCRIPT="$SCRIPT_DIR/${SCRIPT_NAME}.legacy"

if [[ -x "$PROJECT_SCRIPT" && "${MICROSOFT_PLUGIN_DELEGATED:-0}" != "1" ]]; then
  exec env SPINE_ROOT="$SPINE_ROOT" MICROSOFT_PLUGIN_DELEGATED=1 "$PROJECT_SCRIPT" "$@"
fi

if [[ "${MICROSOFT_PLUGIN_DELEGATED:-0}" == "1" ]]; then
  echo "WARN: microsoft plugin fallback active; delegation loop guard engaged for $PROJECT_SCRIPT" >&2
else
  echo "WARN: microsoft plugin fallback active; delegated project command missing at $PROJECT_SCRIPT" >&2
fi
exec "$LEGACY_SCRIPT" "$@"
