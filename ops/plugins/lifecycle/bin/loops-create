#!/usr/bin/env bash
set -euo pipefail

# loops.create â€” Create a new loop scope file from template
#
# Usage: loops-create --name NAME --objective "desc" [--priority high|medium|low] \
#                   [--phase "Step 1:desc"]... [--success "criterion"]... [--dod "item"]...
#
# Normalizes name to uppercase, computes LOOP-{NAME}-{YYYYMMDD},
# checks uniqueness, renders template.

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../../../.." && pwd)"
SCOPES_DIR="$ROOT/mailroom/state/loop-scopes"
TEMPLATE="$ROOT/ops/plugins/lifecycle/templates/loop-scope.template.md"

NAME="" OBJECTIVE="" PRIORITY="medium" HORIZON="now" READINESS="runnable"
declare -a PHASES=()
declare -a SUCCESS_CRITERIA=()
declare -a DOD_ITEMS=()

while [[ $# -gt 0 ]]; do
  case "$1" in
    --) shift ;;
    --name)      NAME="${2:?--name requires a value}"; shift 2 ;;
    --objective) OBJECTIVE="${2:?--objective requires a value}"; shift 2 ;;
    --priority)  PRIORITY="${2:?--priority requires a value}"; shift 2 ;;
    --horizon)   HORIZON="${2:?--horizon requires a value}"; shift 2 ;;
    --readiness) READINESS="${2:?--readiness requires a value}"; shift 2 ;;
    --phase)     PHASES+=("${2:?--phase requires a value}"); shift 2 ;;
    --success)   SUCCESS_CRITERIA+=("${2:?--success requires a value}"); shift 2 ;;
    --dod)       DOD_ITEMS+=("${2:?--dod requires a value}"); shift 2 ;;
    -h|--help)
      echo "Usage: loops-create --name NAME --objective \"desc\" [--priority high|medium|low]"
      echo "       [--horizon now|later|future] [--readiness runnable|blocked]"
      echo "       [--phase \"Step 1:desc\"]... [--success \"criterion\"]... [--dod \"item\"]..."
      echo ""
      echo "Creates a new loop scope file from template with optional scaffold sections."
      exit 0 ;;
    *) echo "Unknown arg: $1" >&2; exit 2 ;;
  esac
done

[[ -n "$NAME" ]]      || { echo "FAIL: --name required" >&2; exit 2; }
[[ -n "$OBJECTIVE" ]]  || { echo "FAIL: --objective required" >&2; exit 2; }

case "$PRIORITY" in
  high|medium|low) ;;
  *) echo "FAIL: --priority must be high, medium, or low (got '$PRIORITY')" >&2; exit 2 ;;
esac

case "$HORIZON" in
  now|later|future) ;;
  *) echo "FAIL: --horizon must be now, later, or future (got '$HORIZON')" >&2; exit 2 ;;
esac

case "$READINESS" in
  runnable|blocked) ;;
  *) echo "FAIL: --readiness must be runnable or blocked (got '$READINESS')" >&2; exit 2 ;;
esac

# Normalize name:
# - uppercase
# - collapse separators
# - strip leading LOOP- prefixes if caller already provided them
# - keep only [A-Z0-9-]
NORM_NAME="$(echo "$NAME" \
  | tr '[:lower:]' '[:upper:]' \
  | sed -E 's/[[:space:]_]+/-/g; s/[^A-Z0-9-]//g; s/-+/-/g; s/^-+//; s/-+$//')"
while [[ "$NORM_NAME" == LOOP-* ]]; do
  NORM_NAME="${NORM_NAME#LOOP-}"
done
[[ -n "$NORM_NAME" ]] || { echo "FAIL: --name resolves to empty loop name after normalization" >&2; exit 2; }
TODAY="$(date -u +%Y%m%d)"
LOOP_ID="LOOP-${NORM_NAME}-${TODAY}"

# Check uniqueness
SCOPE_FILE="$SCOPES_DIR/${LOOP_ID}.scope.md"
if [[ -f "$SCOPE_FILE" ]]; then
  echo "FAIL: Loop already exists: $SCOPE_FILE" >&2
  exit 1
fi

# Derive scope from name (lowercase, first word)
SCOPE="$(echo "$NORM_NAME" | tr '[:upper:]' '[:lower:]' | cut -d'-' -f1)"

# Ensure scopes directory exists
mkdir -p "$SCOPES_DIR"

# Render template via sed substitution
# Note: horizon/readiness have literal defaults in template, override if non-default
sed \
  -e "s|{{LOOP_ID}}|${LOOP_ID}|g" \
  -e "s|{{DATE}}|$(date -u +%Y-%m-%d)|g" \
  -e "s|{{PRIORITY}}|${PRIORITY}|g" \
  -e "s|{{OBJECTIVE}}|${OBJECTIVE}|g" \
  -e "s|{{SCOPE}}|${SCOPE}|g" \
  "$TEMPLATE" > "$SCOPE_FILE"

# Override horizon/readiness if non-default values specified
if [[ "$HORIZON" != "now" ]]; then
  sed -i '' "s/^horizon: now$/horizon: ${HORIZON}/" "$SCOPE_FILE"
fi
if [[ "$READINESS" != "runnable" ]]; then
  sed -i '' "s/^execution_readiness: runnable$/execution_readiness: ${READINESS}/" "$SCOPE_FILE"
fi

# Append scaffold sections for consistent loop structure
{
  echo ""
  echo "## Phases"
  if (( ${#PHASES[@]} == 0 )); then
    echo "- Step 1: capture and classify findings"
    echo "- Step 2: implement changes"
    echo "- Step 3: verify and close out"
  else
    for phase in "${PHASES[@]}"; do
      if [[ "$phase" == *:* ]]; then
        phase_name="${phase%%:*}"
        phase_desc="${phase#*:}"
        echo "- ${phase_name}: ${phase_desc}"
      else
        echo "- $phase"
      fi
    done
  fi
  echo ""
  echo "## Success Criteria"
  if (( ${#SUCCESS_CRITERIA[@]} == 0 )); then
    echo "- All linked gaps/proposals are captured and linked to this loop."
    echo "- Relevant verify pack(s) pass."
  else
    for criterion in "${SUCCESS_CRITERIA[@]}"; do
      echo "- $criterion"
    done
  fi
  echo ""
  echo "## Definition Of Done"
  if (( ${#DOD_ITEMS[@]} == 0 )); then
    echo "- Scope artifacts updated and committed."
    echo "- Receipted verification run keys recorded."
    echo "- Loop status can be moved to closed."
  else
    for item in "${DOD_ITEMS[@]}"; do
      echo "- $item"
    done
  fi
} >> "$SCOPE_FILE"

echo "CREATED: $LOOP_ID"
echo "File: $SCOPE_FILE"
