#!/usr/bin/env bash
set -euo pipefail

# loops.progress â€” Show gap-level progress for a loop
#
# Usage: loops-progress --loop LOOP-ID
#
# Reads loop scope file metadata, counts linked gaps by status,
# and shows progress percentage.

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../../../.." && pwd)"
SCOPES_DIR="$ROOT/mailroom/state/loop-scopes"
GAPS_FILE="$ROOT/ops/bindings/operational.gaps.yaml"

# Frontmatter field extractor (POSIX-compatible)
_fm_field() {
  local file="$1" field="$2"
  awk '/^---$/{n++; next} n==1{print} n>=2{exit}' "$file" \
    | { grep "^${field}:" || true; } \
    | sed "s/^${field}: *//" \
    | tr -d '"' \
    | head -1
}

LOOP_ID=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    --loop) LOOP_ID="${2:?--loop requires a value}"; shift 2 ;;
    -h|--help)
      echo "Usage: loops-progress --loop LOOP-ID"
      exit 0 ;;
    *) echo "Unknown arg: $1" >&2; exit 2 ;;
  esac
done

[[ -n "$LOOP_ID" ]] || { echo "FAIL: --loop required" >&2; exit 2; }

# Find scope file
SCOPE_FILE="$SCOPES_DIR/${LOOP_ID}.scope.md"
if [[ ! -f "$SCOPE_FILE" ]]; then
  echo "FAIL: Scope file not found: $SCOPE_FILE" >&2
  exit 1
fi

# Extract loop metadata
STATUS="$(_fm_field "$SCOPE_FILE" "status")"
OWNER="$(_fm_field "$SCOPE_FILE" "owner")"
CREATED="$(_fm_field "$SCOPE_FILE" "created")"
OBJECTIVE="$(_fm_field "$SCOPE_FILE" "objective")"

echo "=== LOOP PROGRESS: $LOOP_ID ==="
echo "Status:    ${STATUS:-unknown}"
echo "Owner:     ${OWNER:-unassigned}"
echo "Created:   ${CREATED:-unknown}"
echo "Objective: ${OBJECTIVE:-none}"
echo ""

# Count gaps linked to this loop via python3 + yq JSON
python3 - "$GAPS_FILE" "$LOOP_ID" <<'PY'
import json
import subprocess
import sys

gaps_file = sys.argv[1]
loop_id = sys.argv[2]

try:
    result = subprocess.run(
        ["yq", "e", "-o=json", ".", gaps_file],
        capture_output=True, text=True, check=True
    )
    data = json.loads(result.stdout)
except Exception as e:
    print(f"ERROR: Failed to read gaps: {e}", file=sys.stderr)
    sys.exit(1)

gaps = data.get("gaps", [])
linked = [g for g in gaps if g.get("parent_loop") == loop_id]

if not linked:
    print("Linked gaps: 0")
    print("Progress:    N/A (no gaps linked to this loop)")
    sys.exit(0)

total = len(linked)
by_status = {}
for g in linked:
    s = g.get("status", "unknown")
    by_status[s] = by_status.get(s, 0) + 1

resolved = by_status.get("fixed", 0) + by_status.get("closed", 0)
pct = int(100 * resolved / total) if total > 0 else 0

print(f"Linked gaps: {total}")
print(f"Progress:    {resolved}/{total} ({pct}%)")
print()
print("By status:")
for status in ("open", "fixed", "closed"):
    count = by_status.get(status, 0)
    if count > 0:
        print(f"  {status:10s} {count}")

open_gaps = [g for g in linked if g.get("status") == "open"]
if open_gaps:
    print()
    print("Open gaps:")
    for g in open_gaps:
        gid = g.get("id", "?")
        sev = g.get("severity", "?")
        desc = g.get("description", "").strip()[:60]
        print(f"  {gid} [{sev}] {desc}")
PY
