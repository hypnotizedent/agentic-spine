#!/usr/bin/env bash
set -euo pipefail

# planning.horizon.status â€” Show horizon distribution of open loops
#
# Usage: planning-horizon-status [--json]
#
# Authority: ops/bindings/planning.horizon.contract.yaml

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../../../.." && pwd)"
SCOPES_DIR="$ROOT/mailroom/state/loop-scopes"
MODE="${1:-}"

while [[ $# -gt 0 ]]; do
  case "$1" in
    --) shift ;;
    --json) MODE="--json"; shift ;;
    -h|--help)
      echo "Usage: planning-horizon-status [--json]"
      echo "Show horizon distribution (now/later/future) of open loops."
      exit 0 ;;
    *) shift ;;
  esac
done

exec python3 - "$SCOPES_DIR" "$MODE" <<'PYTHON'
import json
import re
import sys
from pathlib import Path

scopes_dir = Path(sys.argv[1])
mode = sys.argv[2] if len(sys.argv) > 2 else ""

FM_RE = re.compile(r"^---\s*$")

def parse_fm(path):
    lines = path.read_text().splitlines()
    in_fm = False
    fm = {}
    for line in lines:
        if FM_RE.match(line):
            if in_fm:
                break
            in_fm = True
            continue
        if in_fm and ":" in line:
            key, _, val = line.partition(":")
            fm[key.strip()] = val.strip().strip('"')
    return fm

loops = {"now": [], "later": [], "future": []}
for f in sorted(scopes_dir.glob("*.scope.md")):
    fm = parse_fm(f)
    status = fm.get("status", "")
    if status not in ("active", "draft", "open", "planned"):
        continue
    horizon = fm.get("horizon", "now")
    readiness = fm.get("execution_readiness", "runnable")
    entry = {
        "loop_id": fm.get("loop_id", f.stem),
        "horizon": horizon,
        "execution_readiness": readiness,
        "severity": fm.get("severity", "-"),
        "owner": fm.get("owner", "unassigned"),
        "activation_trigger": fm.get("activation_trigger", "manual"),
        "not_before_est": fm.get("not_before_est", ""),
        "depends_on_loop": fm.get("depends_on_loop", ""),
    }
    loops.get(horizon, loops["now"]).append(entry)

if mode == "--json":
    print(json.dumps({
        "horizons": loops,
        "counts": {h: len(v) for h, v in loops.items()},
        "eligible": len([l for l in loops["now"] if l["execution_readiness"] == "runnable"]),
    }, indent=2))
    sys.exit(0)

total = sum(len(v) for v in loops.values())
eligible = len([l for l in loops["now"] if l["execution_readiness"] == "runnable"])

print("=" * 60)
print("  PLANNING HORIZON STATUS")
print("=" * 60)
print()
print(f"Total tracked: {total}  |  Eligible (now+runnable): {eligible}")
print()

for horizon in ("now", "later", "future"):
    items = loops[horizon]
    label = horizon.upper()
    print(f"{label} ({len(items)})")
    print("-" * 60)
    if not items:
        print("  (none)")
    else:
        for l in items:
            readiness_tag = " [blocked]" if l["execution_readiness"] == "blocked" else ""
            trigger_info = ""
            if l["not_before_est"]:
                trigger_info = f" (not_before: {l['not_before_est']})"
            elif l["depends_on_loop"]:
                trigger_info = f" (depends_on: {l['depends_on_loop']})"
            print(f"  [{l['severity']:8s}] {l['owner']:15s} {l['loop_id']}{readiness_tag}{trigger_info}")
    print()

print("=" * 60)
PYTHON
