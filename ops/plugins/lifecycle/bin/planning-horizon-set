#!/usr/bin/env bash
set -euo pipefail

# planning.horizon.set — Set horizon and readiness for a loop
#
# Usage: planning-horizon-set --loop LOOP-ID --horizon now|later|future \
#          [--readiness runnable|blocked] [--not-before-est YYYY-MM-DD] \
#          [--activation-trigger manual|date|dependency] [--depends-on-loop LOOP-ID]
#
# Authority: ops/bindings/planning.horizon.contract.yaml

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../../../.." && pwd)"
SCOPES_DIR="$ROOT/mailroom/state/loop-scopes"
source "$ROOT/ops/lib/git-lock.sh"

LOOP_ID="" HORIZON="" READINESS="" NOT_BEFORE="" TRIGGER="" DEPENDS_ON=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    --) shift ;;
    --loop)               LOOP_ID="${2:?--loop requires a value}"; shift 2 ;;
    --horizon)            HORIZON="${2:?--horizon requires a value}"; shift 2 ;;
    --readiness)          READINESS="${2:?--readiness requires a value}"; shift 2 ;;
    --not-before-est)     NOT_BEFORE="${2:?--not-before-est requires a value}"; shift 2 ;;
    --activation-trigger) TRIGGER="${2:?--activation-trigger requires a value}"; shift 2 ;;
    --depends-on-loop)    DEPENDS_ON="${2:?--depends-on-loop requires a value}"; shift 2 ;;
    -h|--help)
      echo "Usage: planning-horizon-set --loop LOOP-ID --horizon now|later|future [options]"
      echo ""
      echo "Options:"
      echo "  --readiness runnable|blocked"
      echo "  --not-before-est YYYY-MM-DD"
      echo "  --activation-trigger manual|date|dependency"
      echo "  --depends-on-loop LOOP-ID"
      exit 0 ;;
    *) echo "Unknown arg: $1" >&2; exit 2 ;;
  esac
done

[[ -n "$LOOP_ID" ]] || { echo "FAIL: --loop required" >&2; exit 2; }
[[ -n "$HORIZON" ]] || { echo "FAIL: --horizon required" >&2; exit 2; }

case "$HORIZON" in
  now|later|future) ;;
  *) echo "FAIL: --horizon must be now, later, or future (got '$HORIZON')" >&2; exit 2 ;;
esac

if [[ -n "$READINESS" ]]; then
  case "$READINESS" in
    runnable|blocked) ;;
    *) echo "FAIL: --readiness must be runnable or blocked (got '$READINESS')" >&2; exit 2 ;;
  esac
fi

if [[ -n "$TRIGGER" ]]; then
  case "$TRIGGER" in
    manual|date|dependency) ;;
    *) echo "FAIL: --activation-trigger must be manual, date, or dependency (got '$TRIGGER')" >&2; exit 2 ;;
  esac
fi

# Validate date trigger has not_before_est
if [[ "$TRIGGER" == "date" && -z "$NOT_BEFORE" ]]; then
  echo "FAIL: --not-before-est required when --activation-trigger is date" >&2
  exit 2
fi

# Validate dependency trigger has depends_on_loop
if [[ "$TRIGGER" == "dependency" && -z "$DEPENDS_ON" ]]; then
  echo "FAIL: --depends-on-loop required when --activation-trigger is dependency" >&2
  exit 2
fi

SCOPE_FILE="$SCOPES_DIR/${LOOP_ID}.scope.md"
if [[ ! -f "$SCOPE_FILE" ]]; then
  echo "FAIL: Scope file not found: $SCOPE_FILE" >&2
  exit 1
fi

acquire_git_lock gaps || exit 1
trap 'release_git_lock' EXIT INT TERM

_fm_field() {
  local file="$1" field="$2"
  awk '/^---$/{n++; next} n==1{print} n>=2{exit}' "$file" \
    | { grep "^${field}:" || true; } \
    | sed "s/^${field}: *//" \
    | tr -d '"' \
    | head -1
}

# Helper: set or update a frontmatter field
_set_fm_field() {
  local file="$1" field="$2" value="$3"
  local tmp_file
  tmp_file="$(mktemp "${file}.tmp.XXXXXX")"

  if grep -q "^${field}:" <(awk '/^---$/{n++; next} n==1{print} n>=2{exit}' "$file"); then
    # Field exists — update it
    awk -v field="$field" -v value="$value" '
      BEGIN { in_fm=0; replaced=0 }
      {
        if ($0 == "---") {
          if (in_fm == 0) { in_fm=1; print; next }
          if (in_fm == 1) { in_fm=2; print; next }
        }
        if (in_fm == 1 && replaced == 0 && index($0, field ":") == 1) {
          print field ": " value
          replaced=1
          next
        }
        print
      }
    ' "$file" > "$tmp_file"
  else
    # Field does not exist — add before closing ---
    awk -v field="$field" -v value="$value" '
      BEGIN { in_fm=0; added=0 }
      {
        if ($0 == "---") {
          if (in_fm == 0) { in_fm=1; print; next }
          if (in_fm == 1 && added == 0) {
            print field ": " value
            added=1
            in_fm=2
            print; next
          }
        }
        print
      }
    ' "$file" > "$tmp_file"
  fi

  mv "$tmp_file" "$file"
}

# Boundary model normalization:
# - deferred horizons must not remain status=active/open
# - horizon=now promotes planned -> active
current_status="$(_fm_field "$SCOPE_FILE" "status")"
case "$current_status" in
  closed|done|archived)
    echo "FAIL: cannot change horizon for closed loop (status=$current_status): $LOOP_ID" >&2
    exit 1
    ;;
esac

normalized_status="$current_status"
if [[ "$HORIZON" == "now" ]]; then
  case "$current_status" in
    planned|"")
      normalized_status="active"
      ;;
  esac
else
  normalized_status="planned"
  if [[ -z "$TRIGGER" ]]; then
    existing_trigger="$(_fm_field "$SCOPE_FILE" "activation_trigger")"
    if [[ -n "$existing_trigger" ]]; then
      TRIGGER="$existing_trigger"
    else
      TRIGGER="manual"
    fi
  fi
fi

# Apply horizon
_set_fm_field "$SCOPE_FILE" "horizon" "$HORIZON"
_set_fm_field "$SCOPE_FILE" "status" "$normalized_status"

# Apply readiness if specified
if [[ -n "$READINESS" ]]; then
  _set_fm_field "$SCOPE_FILE" "execution_readiness" "$READINESS"
fi

# Apply activation trigger if specified
if [[ -n "$TRIGGER" ]]; then
  _set_fm_field "$SCOPE_FILE" "activation_trigger" "$TRIGGER"
fi

# Apply not_before_est if specified
if [[ -n "$NOT_BEFORE" ]]; then
  _set_fm_field "$SCOPE_FILE" "not_before_est" "$NOT_BEFORE"
fi

# Apply depends_on_loop if specified
if [[ -n "$DEPENDS_ON" ]]; then
  _set_fm_field "$SCOPE_FILE" "depends_on_loop" "$DEPENDS_ON"
fi

echo "UPDATED: $LOOP_ID"
echo "  status: $normalized_status"
echo "  horizon: $HORIZON"
[[ -n "$READINESS" ]] && echo "  execution_readiness: $READINESS"
[[ -n "$TRIGGER" ]] && echo "  activation_trigger: $TRIGGER"
[[ -n "$NOT_BEFORE" ]] && echo "  not_before_est: $NOT_BEFORE"
[[ -n "$DEPENDS_ON" ]] && echo "  depends_on_loop: $DEPENDS_ON"
echo "File: $SCOPE_FILE"
