#!/usr/bin/env bash
set -euo pipefail

# loops.background.start â€” mark a loop as background-active with heartbeat metadata.
#
# Usage:
#   loops-background-start --loop-id LOOP-ID [--terminal-id ID] [--ttl-minutes N]
#                          [--blocked-by "reason"] [--note "text"]

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../../../.." && pwd)"
SCOPES_DIR="$ROOT/mailroom/state/loop-scopes"
LOOP_HEARTBEAT_DIR="$ROOT/mailroom/state/loop-heartbeats"
CONTRACT="$ROOT/ops/bindings/stabilization.mode.yaml"
source "$ROOT/ops/lib/git-lock.sh"

usage() {
  cat <<'EOF'
Usage:
  loops-background-start --loop-id LOOP-ID [--terminal-id ID] [--ttl-minutes N]
                         [--blocked-by "reason"] [--note "text"]

Marks a loop as execution_mode=background and stamps heartbeat metadata:
- active_terminal
- last_heartbeat_utc
- heartbeat_ttl_minutes
EOF
}

loop_id=""
terminal_id="${SPINE_TERMINAL_ID:-}"
ttl_minutes=""
blocked_by=""
note=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    --) shift ;;
    --loop-id) loop_id="${2:?--loop-id requires a value}"; shift 2 ;;
    --terminal-id) terminal_id="${2:?--terminal-id requires a value}"; shift 2 ;;
    --ttl-minutes) ttl_minutes="${2:?--ttl-minutes requires a value}"; shift 2 ;;
    --blocked-by) blocked_by="${2:?--blocked-by requires a value}"; shift 2 ;;
    --note) note="${2:?--note requires a value}"; shift 2 ;;
    -h|--help) usage; exit 0 ;;
    *) echo "Unknown arg: $1" >&2; usage >&2; exit 2 ;;
  esac
done

[[ -n "$loop_id" ]] || { echo "FAIL: --loop-id required" >&2; exit 2; }

if [[ -z "$ttl_minutes" ]]; then
  ttl_minutes="$(yq e -r '.terminal_contract.heartbeat_ttl_minutes // 45' "$CONTRACT" 2>/dev/null || echo 45)"
fi
[[ "$ttl_minutes" =~ ^[0-9]+$ ]] || { echo "FAIL: --ttl-minutes must be numeric" >&2; exit 2; }

if [[ -z "$terminal_id" ]]; then
  terminal_id="$(hostname -s | tr '[:lower:]' '[:upper:]')-LOCAL-01"
fi

scope_file="$SCOPES_DIR/${loop_id}.scope.md"
[[ -f "$scope_file" ]] || { echo "FAIL: scope file not found: $scope_file" >&2; exit 1; }

heartbeat_at="$(date -u +%Y-%m-%dT%H:%M:%SZ)"

acquire_git_lock gaps || exit 1
tmp_file="$(mktemp "${scope_file}.tmp.XXXXXX")"
trap 'rm -f "$tmp_file" 2>/dev/null || true; release_git_lock' EXIT INT TERM

python3 - "$scope_file" "$terminal_id" "$ttl_minutes" "$heartbeat_at" "$blocked_by" "$note" > "$tmp_file" <<'PY'
from pathlib import Path
import re
import sys

scope = Path(sys.argv[1])
terminal_id = sys.argv[2]
ttl_minutes = sys.argv[3]
heartbeat_at = sys.argv[4]
blocked_by = sys.argv[5]
note = sys.argv[6]

text = scope.read_text()
lines = text.splitlines(keepends=True)
fm_markers = [i for i, line in enumerate(lines) if line.strip() == "---"]
if len(fm_markers) < 2:
    raise SystemExit(f"FAIL: missing YAML frontmatter in {scope}")

fm_start, fm_end = fm_markers[0], fm_markers[1]
fm_lines = lines[fm_start + 1:fm_end]

def yaml_scalar(value: str, numeric: bool = False) -> str:
    if numeric:
        return value
    if re.fullmatch(r"[A-Za-z0-9._@/-]+", value):
        return value
    escaped = value.replace("\\", "\\\\").replace('"', '\\"')
    return f"\"{escaped}\""

def upsert(field: str, value: str, numeric: bool = False) -> None:
    rendered = f"{field}: {yaml_scalar(value, numeric=numeric)}\n"
    for idx, line in enumerate(fm_lines):
        if re.match(rf"^{re.escape(field)}:\s*", line):
            fm_lines[idx] = rendered
            return
    insert_at = len(fm_lines)
    for idx, line in enumerate(fm_lines):
        if re.match(r"^objective:\s*", line):
            insert_at = idx
            break
    fm_lines.insert(insert_at, rendered)

upsert("execution_mode", "background")
upsert("active_terminal", terminal_id)
upsert("last_heartbeat_utc", heartbeat_at)
upsert("heartbeat_ttl_minutes", ttl_minutes, numeric=True)
if blocked_by:
    upsert("blocked_by", blocked_by)
if note:
    upsert("operator_note", note)

result = lines[:fm_start + 1] + fm_lines + lines[fm_end:]
sys.stdout.write("".join(result))
PY

mv "$tmp_file" "$scope_file"
trap - EXIT INT TERM
release_git_lock

mkdir -p "$LOOP_HEARTBEAT_DIR"
safe_loop_id="$(printf '%s' "$loop_id" | tr -cs 'A-Za-z0-9._-' '_')"
loop_heartbeat_file="$LOOP_HEARTBEAT_DIR/${safe_loop_id}.yaml"
loop_tmp_file="${loop_heartbeat_file}.tmp.$$"
cat > "$loop_tmp_file" <<EOF
version: 1
loop_id: "$loop_id"
terminal_id: "$terminal_id"
last_heartbeat_utc: "$heartbeat_at"
heartbeat_ttl_minutes: $ttl_minutes
expires_at: ""
terminal_status: "active"
EOF
mv "$loop_tmp_file" "$loop_heartbeat_file"

echo "loops.background.start"
echo "loop_id: $loop_id"
echo "execution_mode: background"
echo "active_terminal: $terminal_id"
echo "last_heartbeat_utc: $heartbeat_at"
echo "heartbeat_ttl_minutes: $ttl_minutes"
if [[ -n "$blocked_by" ]]; then
  echo "blocked_by: $blocked_by"
fi
if [[ -n "$note" ]]; then
  echo "operator_note: $note"
fi
echo "scope_file: $scope_file"
echo "loop_heartbeat_file: $loop_heartbeat_file"
