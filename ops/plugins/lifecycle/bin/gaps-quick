#!/usr/bin/env bash
set -euo pipefail

# gaps.quick â€” One-liner gap filing with auto-defaults
#
# Usage: gaps-quick (--description "desc" | --description-file path) \
#                   [--type T] [--severity S] [--loop LOOP-ID] \
#                   [--doc path] [--no-commit]
#
# Computes next gap ID automatically, fills defaults from lifecycle.rules.yaml,
# then delegates to gaps-file for atomic commit + optional auto-claim.

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../../../.." && pwd)"
source "$ROOT/ops/plugins/lifecycle/lib/next-gap-id.sh"
source "$ROOT/ops/plugins/lifecycle/lib/lifecycle-rules.sh"
source "$ROOT/ops/plugins/loops/lib/gap-claims.sh"

# Parse arguments
DESCRIPTION="" DESCRIPTION_FILE="" TYPE="" SEVERITY="" LOOP="" DOC="" NO_COMMIT=0

while [[ $# -gt 0 ]]; do
  case "$1" in
    --) shift ;;
    --description) DESCRIPTION="${2:?--description requires a value}"; shift 2 ;;
    --description-file) DESCRIPTION_FILE="${2:?--description-file requires a value}"; shift 2 ;;
    --type)        TYPE="${2:?--type requires a value}"; shift 2 ;;
    --severity)    SEVERITY="${2:?--severity requires a value}"; shift 2 ;;
    --loop)        LOOP="${2:?--loop requires a value}"; shift 2 ;;
    --doc)         DOC="${2:?--doc requires a value}"; shift 2 ;;
    --no-commit)   NO_COMMIT=1; shift ;;
    -h|--help)
      echo "Usage: gaps-quick (--description \"desc\" | --description-file path) [--type T] [--severity S] [--loop LOOP-ID] [--doc path] [--no-commit]"
      echo ""
      echo "Files a new gap with auto-generated ID and defaults from lifecycle.rules.yaml."
      echo "Delegates to gaps.file for atomic commit + policy-driven auto-claim."
      exit 0 ;;
    *) echo "Unknown arg: $1" >&2; exit 2 ;;
  esac
done

if [[ -n "$DESCRIPTION" && -n "$DESCRIPTION_FILE" ]]; then
  echo "FAIL: cannot specify both --description and --description-file" >&2
  exit 2
fi
if [[ -n "$DESCRIPTION_FILE" ]]; then
  [[ -f "$DESCRIPTION_FILE" ]] || { echo "FAIL: --description-file not found: $DESCRIPTION_FILE" >&2; exit 2; }
fi
if [[ -z "$DESCRIPTION" && -z "$DESCRIPTION_FILE" ]]; then
  echo "FAIL: --description or --description-file required" >&2
  exit 2
fi

# Compute defaults from rules SSOT
[[ -z "$TYPE" ]]     && TYPE="$(gap_quick_default_type)"
[[ -z "$SEVERITY" ]] && SEVERITY="$(gap_quick_default_severity)"
DISCOVERED_BY="$(gap_quick_default_discovered_by)"

# Compute next ID
GAP_ID="$(next_gap_id)"

# Build delegation args
ARGS=(
  --id "$GAP_ID"
  --type "$TYPE"
  --severity "$SEVERITY"
  --discovered-by "$DISCOVERED_BY"
)
if [[ -n "$DESCRIPTION_FILE" ]]; then
  ARGS+=(--description-file "$DESCRIPTION_FILE")
else
  ARGS+=(--description "$DESCRIPTION")
fi
[[ -n "$LOOP" ]] && ARGS+=(--parent-loop "$LOOP")
[[ -n "$DOC" ]]  && ARGS+=(--doc "$DOC")
[[ "$NO_COMMIT" -eq 1 ]] && ARGS+=(--no-commit)

# Delegate to gaps-file (handles git-lock, commit, auto-claim)
"$ROOT/ops/plugins/loops/bin/gaps-file" "${ARGS[@]}"

# Report quick-filed summary
CLAIMED="false"
if [[ -f "$(claim_file "$GAP_ID")" ]]; then
  CLAIMED="true"
fi

echo "QUICK-FILED: $GAP_ID (type=$TYPE, severity=$SEVERITY, loop=${LOOP:-none}, claimed=$CLAIMED)"
