#!/usr/bin/env bash
# backup.vzdump.run - Trigger a vzdump run on pve for selected VMIDs.
# Mutating. Default is dry-run (prints the command). Use --execute to run.
#
# Usage:
#   backup-vzdump-run [--vmids 204,205,...] [--storage tank-backups] [--compress zstd] [--mode snapshot] [--maxfiles 2] [--execute]

set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../../../.." && pwd)"
SSH_TARGETS_FILE="${SSH_TARGETS_FILE:-$ROOT/ops/bindings/ssh.targets.yaml}"

_need() { command -v "$1" >/dev/null 2>&1 || { echo "STOP: missing dependency: $1" >&2; exit 2; }; }
_need yq
_need ssh

if [[ ! -f "$SSH_TARGETS_FILE" ]]; then
  echo "STOP: missing ssh targets binding: $SSH_TARGETS_FILE" >&2
  exit 2
fi

TARGET_ID="pve"
VMIDS_CSV="204,205,206,207,209,210"
STORAGE="tank-backups"
COMPRESS="zstd"
MODE="snapshot"
MAXFILES="2"
EXECUTE="0"

while [[ $# -gt 0 ]]; do
  case "$1" in
    --vmids) VMIDS_CSV="${2:-}"; shift 2;;
    --storage) STORAGE="${2:-}"; shift 2;;
    --compress) COMPRESS="${2:-}"; shift 2;;
    --mode) MODE="${2:-}"; shift 2;;
    --maxfiles) MAXFILES="${2:-}"; shift 2;;
    --execute) EXECUTE="1"; shift;;
    --dry-run) EXECUTE="0"; shift;;
    -h|--help)
      echo "Usage: $0 [--vmids <csv>] [--storage <name>] [--compress <algo>] [--mode <snapshot|stop|suspend>] [--maxfiles <n>] [--execute]"
      exit 0
      ;;
    *) echo "STOP: unknown arg: $1" >&2; exit 2;;
  esac
done

DEF_PORT="$(yq -r '.ssh.defaults.port // 22' "$SSH_TARGETS_FILE")"
DEF_BATCH="$(yq -r '.ssh.defaults.batch_mode // true' "$SSH_TARGETS_FILE")"
DEF_STRICT="$(yq -r '.ssh.defaults.strict_host_key_checking // "no"' "$SSH_TARGETS_FILE")"
DEF_KNOWN_HOSTS="$(yq -r '.ssh.defaults.user_known_hosts_file // "/dev/null"' "$SSH_TARGETS_FILE")"
DEF_TO="$(yq -r '.ssh.defaults.connect_timeout_sec // 6' "$SSH_TARGETS_FILE")"

SSH_HOST="$(yq -r ".ssh.targets[] | select(.id == \"$TARGET_ID\") | .host // \"\"" "$SSH_TARGETS_FILE" | head -n1)"
SSH_USER="$(yq -r ".ssh.targets[] | select(.id == \"$TARGET_ID\") | .user // \"root\"" "$SSH_TARGETS_FILE" | head -n1)"
SSH_PORT="$(yq -r ".ssh.targets[] | select(.id == \"$TARGET_ID\") | .port // ${DEF_PORT}" "$SSH_TARGETS_FILE" | head -n1)"
SSH_TO="$(yq -r ".ssh.targets[] | select(.id == \"$TARGET_ID\") | .connect_timeout_sec // ${DEF_TO}" "$SSH_TARGETS_FILE" | head -n1)"

if [[ -z "$SSH_HOST" || "$SSH_HOST" == "null" ]]; then
  echo "STOP: unknown ssh target id: $TARGET_ID" >&2
  exit 2
fi

ssh_opts=(
  -o "ConnectTimeout=$SSH_TO"
  -o "StrictHostKeyChecking=$DEF_STRICT"
  -o "UserKnownHostsFile=$DEF_KNOWN_HOSTS"
  -o "NumberOfPasswordPrompts=0"
  -o "LogLevel=ERROR"
  -p "$SSH_PORT"
)
if [[ "$DEF_BATCH" == "true" ]]; then
  ssh_opts+=(-o "BatchMode=yes")
fi

REMOTE_SCRIPT='
set -euo pipefail
VMIDS_CSV="$1"
STORAGE="$2"
COMPRESS="$3"
MODE="$4"
MAXFILES="$5"
EXECUTE="$6"

vmids_space="${VMIDS_CSV//,/ }"

echo "backup.vzdump.run"
echo "node: $(hostname)"
echo "vmids: ${VMIDS_CSV}"
echo "storage: ${STORAGE}"
echo "compress: ${COMPRESS}"
echo "mode: ${MODE}"
echo "maxfiles: ${MAXFILES}"
echo "execute: ${EXECUTE}"
echo

cmd=(vzdump ${vmids_space} --storage "${STORAGE}" --compress "${COMPRESS}" --mode "${MODE}" --maxfiles "${MAXFILES}")
printf "command: %q " "${cmd[@]}"
echo

if [[ "$EXECUTE" != "1" ]]; then
  echo "DRY-RUN: not executing."
  exit 0
fi

echo
echo "=== running vzdump ==="
time "${cmd[@]}"
'

echo "backup.vzdump.run (local)"
ssh "${ssh_opts[@]}" "${SSH_USER}@${SSH_HOST}" "bash -lc $(printf "%q" "$REMOTE_SCRIPT") -- $(printf "%q" "$VMIDS_CSV") $(printf "%q" "$STORAGE") $(printf "%q" "$COMPRESS") $(printf "%q" "$MODE") $(printf "%q" "$MAXFILES") $(printf "%q" "$EXECUTE")"

