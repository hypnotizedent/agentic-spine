#!/usr/bin/env bash
# backup.vzdump.vmid.set - Update vmid list for a vzdump job in /etc/pve/jobs.cfg.
# Mutating. Writes a timestamped backup of jobs.cfg in-place.
#
# Usage:
#   backup-vzdump-vmid-set --vmids 204,205,206,207,209,210 [--job <job_id>] [--dry-run|--execute]

set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../../../.." && pwd)"
SSH_TARGETS_FILE="${SSH_TARGETS_FILE:-$ROOT/ops/bindings/ssh.targets.yaml}"

_need() { command -v "$1" >/dev/null 2>&1 || { echo "STOP: missing dependency: $1" >&2; exit 2; }; }
_need yq
_need ssh
_need python3
_need diff

if [[ ! -f "$SSH_TARGETS_FILE" ]]; then
  echo "STOP: missing ssh targets binding: $SSH_TARGETS_FILE" >&2
  exit 2
fi

TARGET_ID="pve"
JOB_ID=""
VMIDS=""
MODE="dry-run"

while [[ $# -gt 0 ]]; do
  case "$1" in
    --job) JOB_ID="${2:-}"; shift 2;;
    --vmids) VMIDS="${2:-}"; shift 2;;
    --dry-run) MODE="dry-run"; shift;;
    --execute) MODE="execute"; shift;;
    -h|--help)
      echo "Usage: $0 --vmids <csv> [--job <job_id>] [--dry-run|--execute]"
      exit 0
      ;;
    *) echo "STOP: unknown arg: $1" >&2; exit 2;;
  esac
done

if [[ -z "$VMIDS" ]]; then
  echo "STOP: --vmids is required" >&2
  exit 2
fi

DEF_PORT="$(yq -r '.ssh.defaults.port // 22' "$SSH_TARGETS_FILE")"
DEF_BATCH="$(yq -r '.ssh.defaults.batch_mode // true' "$SSH_TARGETS_FILE")"
DEF_STRICT="$(yq -r '.ssh.defaults.strict_host_key_checking // "no"' "$SSH_TARGETS_FILE")"
DEF_KNOWN_HOSTS="$(yq -r '.ssh.defaults.user_known_hosts_file // "/dev/null"' "$SSH_TARGETS_FILE")"
DEF_TO="$(yq -r '.ssh.defaults.connect_timeout_sec // 6' "$SSH_TARGETS_FILE")"

SSH_HOST="$(yq -r ".ssh.targets[] | select(.id == \"$TARGET_ID\") | .host // \"\"" "$SSH_TARGETS_FILE" | head -n1)"
SSH_USER="$(yq -r ".ssh.targets[] | select(.id == \"$TARGET_ID\") | .user // \"root\"" "$SSH_TARGETS_FILE" | head -n1)"
SSH_PORT="$(yq -r ".ssh.targets[] | select(.id == \"$TARGET_ID\") | .port // ${DEF_PORT}" "$SSH_TARGETS_FILE" | head -n1)"
SSH_TO="$(yq -r ".ssh.targets[] | select(.id == \"$TARGET_ID\") | .connect_timeout_sec // ${DEF_TO}" "$SSH_TARGETS_FILE" | head -n1)"

if [[ -z "$SSH_HOST" || "$SSH_HOST" == "null" ]]; then
  echo "STOP: unknown ssh target id: $TARGET_ID" >&2
  exit 2
fi

ssh_opts=(
  -n
  -o "ConnectTimeout=$SSH_TO"
  -o "StrictHostKeyChecking=$DEF_STRICT"
  -o "UserKnownHostsFile=$DEF_KNOWN_HOSTS"
  -o "NumberOfPasswordPrompts=0"
  -o "LogLevel=ERROR"
  -p "$SSH_PORT"
)
if [[ "$DEF_BATCH" == "true" ]]; then
  ssh_opts+=(-o "BatchMode=yes")
fi

REMOTE_SCRIPT='
set -euo pipefail

JOB_ID="$1"
VMIDS="$2"
MODE="$3"

CFG="/etc/pve/jobs.cfg"
if [[ ! -f "$CFG" ]]; then
  echo "STOP: missing $CFG" >&2
  exit 2
fi

job_id="$JOB_ID"
if [[ -z "$job_id" ]]; then
  # If job not provided, select the only vzdump job, else STOP.
  n="$(awk "/^vzdump:/ {c++} END{print c+0}" "$CFG")"
  if [[ "$n" -eq 0 ]]; then
    echo "STOP: no vzdump jobs found in $CFG" >&2
    exit 2
  fi
  if [[ "$n" -gt 1 ]]; then
    echo "STOP: multiple vzdump jobs found; pass --job <id>" >&2
    awk "/^vzdump:/ {print \"- \" \$2}" "$CFG" | sed "s/:$//"
    exit 2
  fi
  job_id="$(awk "/^vzdump:/ {print \$2; exit}" "$CFG" | sed "s/:$//")"
fi

ts="$(date -u +%Y%m%dT%H%M%SZ)"
bkp="${CFG}.bak.${ts}"
tmp="/tmp/jobs.cfg.${ts}.$$"

cp -a "$CFG" "$tmp"

python3 - "$tmp" "$job_id" "$VMIDS" <<'PY'
import sys, re
from pathlib import Path

path = Path(sys.argv[1])
job = sys.argv[2]
vmids = sys.argv[3]

txt = path.read_text()
lines = txt.splitlines(True)

out = []
in_job = False
job_found = False
vmid_updated = False

job_header = re.compile(rf"^vzdump:\s*{re.escape(job)}\s*$")
top_header = re.compile(r"^[A-Za-z0-9_-]+:\s*.*$")

for line in lines:
    if job_header.match(line.strip()):
        in_job = True
        job_found = True
        out.append(line)
        continue
    # Job block ends when we hit a new top-level header (non-indented "<name>: ...").
    if in_job and top_header.match(line) and not line.startswith((" ", "\t")):
        in_job = False
    if in_job and line.lstrip().startswith("vmid "):
        indent = re.match(r"^\s*", line).group(0)
        out.append(f"{indent}vmid {vmids}\n")
        vmid_updated = True
        continue
    out.append(line)

if not job_found:
    raise SystemExit(f"STOP: vzdump job '{job}' not found")
if not vmid_updated:
    # Insert vmid line after the header line if missing.
    out2 = []
    inserted = False
    for i, line in enumerate(out):
        out2.append(line)
        if not inserted and job_header.match(line.strip()):
            out2.append("    vmid " + vmids + "\n")
            inserted = True
    out = out2

path.write_text("".join(out))
PY

echo "backup.vzdump.vmid.set"
echo "job_id: $job_id"
echo "vmids: $VMIDS"
echo "mode: $MODE"

if [[ "$MODE" == "dry-run" ]]; then
  echo
  echo "DRY-RUN: showing diff only; not writing."
  diff -u "$CFG" "$tmp" || true
  rm -f "$tmp"
  exit 0
fi

cp -a "$CFG" "$bkp"
echo "backup: $bkp"

cp -a "$tmp" "$CFG"
rm -f "$tmp"
sync
echo "updated: $CFG"
'

echo "backup.vzdump.vmid.set (remote)"
ssh "${ssh_opts[@]}" "${SSH_USER}@${SSH_HOST}" "bash -lc $(printf "%q" "$REMOTE_SCRIPT") -- $(printf "%q" "$JOB_ID") $(printf "%q" "$VMIDS") $(printf "%q" "$MODE")"
