#!/usr/bin/env bash
set -euo pipefail

# domains.portfolio.status â€” unified view of registrar + DNS + zone status per domain
# Orchestrates cloudflare.zone.list + cloudflare.registrar.status into a single view
# Requires: CLOUDFLARE_API_TOKEN via secrets injection

ROOT="$(cd "$(dirname "$0")/../../../../" && pwd)"
SECRETS_EXEC="$ROOT/ops/plugins/secrets/bin/secrets-exec"
CF_LIB="$ROOT/ops/plugins/cloudflare/lib/cloudflare-api.sh"

if [[ -z "${SPINE_SECRETS_INJECTED:-}" ]]; then
  export SPINE_SECRETS_INJECTED=1
  exec "$SECRETS_EXEC" -- "$0" "$@"
fi

source "$CF_LIB"

CF_API="${CLOUDFLARE_API_BASE:-https://api.cloudflare.com/client/v4}"
INVENTORY="$ROOT/ops/bindings/cloudflare.inventory.yaml"

cf_require_auth || exit $?

# Parse args
while [[ $# -gt 0 ]]; do
  case "$1" in
    --json) JSON_OUT=1; shift ;;
    --) shift ;;
    *) shift ;;
  esac
done

python3 - "$CF_API" "$INVENTORY" "${JSON_OUT:-0}" "${CF_AUTH_MODE_PREFERRED:-unknown}" <<'PYEOF'
import json, sys, os, time, urllib.request, urllib.error, yaml

api = sys.argv[1]
inventory = sys.argv[2]
json_out = sys.argv[3] == "1"
preferred_mode = sys.argv[4]
token = os.environ.get("CLOUDFLARE_API_TOKEN", "")
auth_email = os.environ.get("CLOUDFLARE_AUTH_EMAIL", "")
global_key = os.environ.get("CLOUDFLARE_GLOBAL_API_KEY", "")
rate_limited = False

with open(inventory) as f:
    inv = yaml.safe_load(f) or {}
account_id = inv.get("account_id", os.environ.get("CLOUDFLARE_ACCOUNT_ID", ""))

class RateLimitExhausted(Exception):
    """Raised when 429 retries are exhausted."""
    pass

def headers_for(mode):
    base = {"Content-Type": "application/json"}
    if mode == "token":
        base["Authorization"] = f"Bearer {token}"
    else:
        base["X-Auth-Email"] = auth_email
        base["X-Auth-Key"] = global_key
    return base

def get(url):
    global preferred_mode
    max_attempts = 4
    modes = []
    if preferred_mode == "token" and token:
        modes.append("token")
        if auth_email and global_key:
            modes.append("global")
    elif preferred_mode == "global" and auth_email and global_key:
        modes.append("global")
        if token:
            modes.append("token")
    else:
        if token:
            modes.append("token")
        if auth_email and global_key:
            modes.append("global")
    if not modes:
        raise RuntimeError("missing Cloudflare auth")

    last_exc = None
    for idx, mode in enumerate(modes):
        for attempt in range(max_attempts):
            req = urllib.request.Request(url, headers=headers_for(mode))
            try:
                with urllib.request.urlopen(req, timeout=20) as resp:
                    preferred_mode = mode
                    return json.loads(resp.read().decode("utf-8"))
            except urllib.error.HTTPError as exc:
                last_exc = exc
                if exc.code == 429:
                    if attempt + 1 < max_attempts:
                        retry_after = exc.headers.get("Retry-After", "")
                        try:
                            delay = max(2, min(int(retry_after), 30))
                        except Exception:
                            delay = 2 ** attempt
                        time.sleep(delay)
                        continue
                    # All retries exhausted for 429
                    raise RateLimitExhausted(f"429 after {max_attempts} attempts on {url}")
                if exc.code in (401, 403) and idx + 1 < len(modes):
                    break
                raise
            except Exception as exc:
                last_exc = exc
                if attempt + 1 < max_attempts:
                    time.sleep(attempt + 1)
                    continue
                if idx + 1 < len(modes):
                    break
                raise
    if last_exc:
        raise last_exc
    raise RuntimeError("Cloudflare request failed")

# 1. Fetch all zones
all_zones = {}
page = 1
try:
    while True:
        data = get(f"{api}/zones?per_page=50&page={page}")
        if not data.get("success"):
            break
        for z in data.get("result", []):
            all_zones[z["name"]] = z
        info = data.get("result_info", {})
        if page >= info.get("total_pages", 1):
            break
        page += 1
except RateLimitExhausted:
    print("STOP: rate-limited (HTTP 429) during zone list fetch after retry exhaustion", file=sys.stderr)
    sys.exit(7)

# 2. Fetch registrar status per domain
results = []
for domain_name in sorted(all_zones.keys()):
    z = all_zones[domain_name]
    zid = z["id"]

    # Zone info
    entry = {
        "domain": domain_name,
        "zone_status": z.get("status", "unknown"),
        "plan": z.get("plan", {}).get("name", "unknown"),
        "name_servers": z.get("name_servers", []),
    }

    # DNS record count
    try:
        dns = get(f"{api}/zones/{zid}/dns_records?per_page=1")
        entry["dns_records"] = (dns.get("result_info") or {}).get("total_count", 0)
    except RateLimitExhausted:
        entry["dns_records"] = "rate_limited"
        rate_limited = True
    except Exception:
        entry["dns_records"] = "error"

    # SPF check (apex TXT containing v=spf1)
    try:
        spf = get(f"{api}/zones/{zid}/dns_records?type=TXT&name={domain_name}&per_page=100")
        spf_records = [r for r in spf.get("result", []) if "v=spf1" in r.get("content", "")]
        entry["spf"] = spf_records[0]["content"][:60] if spf_records else "MISSING"
    except RateLimitExhausted:
        entry["spf"] = "rate_limited"
        rate_limited = True
    except Exception:
        entry["spf"] = "error"

    # DMARC check (apex _dmarc TXT)
    try:
        dmarc = get(f"{api}/zones/{zid}/dns_records?type=TXT&name=_dmarc.{domain_name}&per_page=10")
        dmarc_records = [r for r in dmarc.get("result", []) if "v=DMARC1" in r.get("content", "")]
        entry["dmarc"] = dmarc_records[0]["content"][:60] if dmarc_records else "MISSING"
    except RateLimitExhausted:
        entry["dmarc"] = "rate_limited"
        rate_limited = True
    except Exception:
        entry["dmarc"] = "error"

    # Registrar status
    try:
        reg = get(f"{api}/accounts/{account_id}/registrar/domains/{domain_name}")
        if reg.get("success"):
            r = reg.get("result", {})
            entry["registrar"] = "cloudflare"
            reg_status = r.get("registry_statuses", r.get("status", "unknown"))
            entry["registrar_status"] = ",".join(reg_status) if isinstance(reg_status, list) else str(reg_status)
            entry["auto_renew"] = r.get("auto_renew", None)
            entry["expires_at"] = str(r.get("expires_at", ""))[:10]
            entry["locked"] = r.get("locked", None)
            ti = r.get("transfer_in", {})
            if ti and ti.get("status"):
                entry["transfer_status"] = ti["status"]
        else:
            entry["registrar"] = "external"
    except RateLimitExhausted:
        entry["registrar"] = "rate_limited"
        rate_limited = True
    except urllib.error.HTTPError as e:
        entry["registrar"] = "external" if e.code == 404 else f"error_{e.code}"
    except Exception:
        entry["registrar"] = "error"

    results.append(entry)

overall_status = "rate_limited" if rate_limited else "ok"

if json_out:
    print(json.dumps({"status": overall_status, "domains": results}, indent=2))
else:
    print("domains.portfolio.status")
    print(f"auth_mode: {preferred_mode}")
    print(f"domains: {len(results)}")
    if rate_limited:
        print("warning: some requests were rate-limited (HTTP 429) after retry exhaustion")
    print()
    fmt = "{:<28s} {:<10s} {:<12s} {:<8s} {:<10s} {:<8s} {:<8s}"
    print(fmt.format("DOMAIN", "ZONE", "REGISTRAR", "DNS#", "EXPIRES", "SPF", "DMARC"))
    print("-" * 84)
    for r in results:
        reg = r.get("registrar", "?")
        if r.get("transfer_status"):
            reg = f"{reg}({r['transfer_status'][:6]})"
        spf = "OK" if r.get("spf", "").startswith("v=spf1") else r.get("spf", "?")[:8]
        dmarc = "OK" if r.get("dmarc", "").startswith("v=DMARC1") else r.get("dmarc", "?")[:8]
        print(fmt.format(
            r["domain"],
            r.get("zone_status", "?")[:10],
            reg[:12],
            str(r.get("dns_records", "?"))[:8],
            r.get("expires_at", "-")[:10],
            spf,
            dmarc,
        ))

if rate_limited:
    sys.exit(7)
PYEOF
