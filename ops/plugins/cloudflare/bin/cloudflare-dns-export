#!/usr/bin/env bash
# cloudflare-dns-export â€” export full DNS records for all bound zones to mailroom/outbox
set -euo pipefail

ROOT="$(cd "$(dirname "$0")/../../../../" && pwd)"
SECRETS_EXEC="$ROOT/ops/plugins/secrets/bin/secrets-exec"
CF_LIB="$ROOT/ops/plugins/cloudflare/lib/cloudflare-api.sh"

if [[ -z "${SPINE_SECRETS_INJECTED:-}" ]]; then
  export SPINE_SECRETS_INJECTED=1
  exec "$SECRETS_EXEC" -- "$0" "$@"
fi

source "$CF_LIB"

CF_API="${CLOUDFLARE_API_BASE:-https://api.cloudflare.com/client/v4}"
cf_require_auth || exit $?

OUTBOX="$ROOT/mailroom/outbox/domains"
mkdir -p "$OUTBOX"

ZONES="$(cf_api_get "${CF_API}/zones?per_page=50")" || {
  echo "STOP: failed to fetch zones" >&2
  exit 2
}
echo "$ZONES" | python3 -c "
import json, os, sys, urllib.request, urllib.error
from datetime import datetime, timezone

print('cloudflare.dns.export')
zones = json.load(sys.stdin).get('result', [])
print(f'zones: {len(zones)}')
api = os.environ.get('CLOUDFLARE_API_BASE', 'https://api.cloudflare.com/client/v4').rstrip('/')
token = os.environ.get('CLOUDFLARE_API_TOKEN', '')
auth_email = os.environ.get('CLOUDFLARE_AUTH_EMAIL', '')
global_key = os.environ.get('CLOUDFLARE_GLOBAL_API_KEY', '')
preferred_mode = 'token' if token else 'global'
outbox = os.environ.get('SPINE_DNS_OUTBOX', '$OUTBOX')
ts = datetime.now(timezone.utc).strftime('%Y-%m-%dT%H:%M:%SZ')
date_tag = datetime.now(timezone.utc).strftime('%Y%m%d')

def headers_for(mode):
    base = {'Content-Type': 'application/json'}
    if mode == 'token':
        base['Authorization'] = f'Bearer {token}'
    else:
        base['X-Auth-Email'] = auth_email
        base['X-Auth-Key'] = global_key
    return base

def request_json(url, mode):
    req = urllib.request.Request(url, headers=headers_for(mode))
    with urllib.request.urlopen(req, timeout=30) as resp:
        return json.loads(resp.read().decode())

def get(url):
    global preferred_mode
    modes = []
    if preferred_mode == 'token' and token:
        modes.append('token')
        if auth_email and global_key:
            modes.append('global')
    elif preferred_mode == 'global' and auth_email and global_key:
        modes.append('global')
        if token:
            modes.append('token')
    else:
        if token:
            modes.append('token')
        if auth_email and global_key:
            modes.append('global')
    if not modes:
        raise RuntimeError('missing Cloudflare auth')

    last_exc = None
    for idx, mode in enumerate(modes):
        try:
            payload = request_json(url, mode)
            preferred_mode = mode
            return payload
        except urllib.error.HTTPError as exc:
            last_exc = exc
            if exc.code in (401, 403) and idx + 1 < len(modes):
                continue
            raise
        except Exception as exc:
            last_exc = exc
            if idx + 1 < len(modes):
                continue
            raise
    if last_exc:
        raise last_exc
    raise RuntimeError('Cloudflare request failed')

for zone in zones:
    zid = zone.get('id')
    name = zone.get('name')

    # Fetch all records (paginate)
    all_records = []
    page = 1
    while True:
        try:
            data = get(f'{api}/zones/{zid}/dns_records?per_page=100&page={page}')
        except Exception as exc:
            print(f'- {name}: STOP (dns export failed: {exc})')
            break

        results = data.get('result', [])
        all_records.extend(results)
        info = data.get('result_info', {})
        total_pages = info.get('total_pages', 1)
        if page >= total_pages:
            break
        page += 1

    # Write JSON export
    export = {
        'zone': name,
        'zone_id': zid,
        'exported_at': ts,
        'total_records': len(all_records),
        'records': [
            {
                'type': r.get('type'),
                'name': r.get('name'),
                'content': r.get('content'),
                'proxied': r.get('proxied'),
                'ttl': r.get('ttl'),
                'priority': r.get('priority'),
            }
            for r in sorted(all_records, key=lambda x: (x.get('type', ''), x.get('name', '')))
        ],
    }

    json_path = os.path.join(outbox, f'{name}-cf-dns-export-{date_tag}.json')
    with open(json_path, 'w') as f:
        json.dump(export, f, indent=2)

    print(f'- {name}: {len(all_records)} records -> {json_path}')

print('OK')
" SPINE_DNS_OUTBOX="$OUTBOX"
echo "auth_mode: ${CF_AUTH_MODE_EFFECTIVE:-${CF_AUTH_MODE_PREFERRED:-unknown}}"
