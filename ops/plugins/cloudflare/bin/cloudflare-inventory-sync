#!/usr/bin/env bash
set -euo pipefail
ROOT="$(cd "$(dirname "$0")/../../../../" && pwd)"
SECRETS_EXEC="$ROOT/ops/plugins/secrets/bin/secrets-exec"
CF_LIB="$ROOT/ops/plugins/cloudflare/lib/cloudflare-api.sh"
BINDING_FILE="$ROOT/ops/bindings/cloudflare.inventory.yaml"
export ROOT

if [[ -z "${SPINE_SECRETS_INJECTED:-}" ]]; then
  export SPINE_SECRETS_INJECTED=1
  exec "$SECRETS_EXEC" -- "$0" "$@"
fi

source "$CF_LIB"

if [[ ! -f "$BINDING_FILE" ]]; then
  echo "FAIL: binding file missing" >&2
  exit 1
fi

export CLOUDFLARE_API_BASE="${CLOUDFLARE_API_BASE:-https://api.cloudflare.com/client/v4}"
CF_API="$CLOUDFLARE_API_BASE"
cf_require_auth || exit $?
if [[ -z "${CLOUDFLARE_ACCOUNT_ID:-}" ]]; then
  echo "STOP: CLOUDFLARE_ACCOUNT_ID missing" >&2
  exit 2
fi

TMP_ZONES="$(mktemp)"
TMP_TUNNELS="$(mktemp)"
trap 'rm -f "$TMP_ZONES" "$TMP_TUNNELS" 2>/dev/null || true' EXIT

cf_api_get "${CF_API}/zones?per_page=50" > "$TMP_ZONES" || {
  echo "STOP: failed to fetch zones" >&2
  exit 2
}
cf_api_get "${CF_API}/accounts/${CLOUDFLARE_ACCOUNT_ID}/tunnels" > "$TMP_TUNNELS" || {
  echo "STOP: failed to fetch tunnels" >&2
  exit 2
}

export TMP_ZONES TMP_TUNNELS

python3 - <<'PY'
import json, os, sys
root = os.environ["ROOT"]
with open(os.path.join(root, "ops/bindings/cloudflare.inventory.yaml")) as f:
    binding = json.load(f)

with open(os.environ["TMP_ZONES"], "r", encoding="utf-8") as f:
    data_zones = json.load(f)
with open(os.environ["TMP_TUNNELS"], "r", encoding="utf-8") as f:
    data_tunnels = json.load(f)

live_zones = {z['name'] for z in data_zones.get('result', [])}
live_tunnels = {t['name'] for t in data_tunnels.get('result', [])}

binding_zones = {z['name'] for z in binding.get('zones', []) if z.get('name')}
binding_tunnels = {t['name'] for t in binding.get('tunnels', []) if t.get('name')}

missing_zones = binding_zones - live_zones
extra_zones = live_zones - binding_zones
missing_tunnels = binding_tunnels - live_tunnels
extra_tunnels = live_tunnels - binding_tunnels

if missing_zones or missing_tunnels or extra_zones or extra_tunnels:
    print("cloudflare.inventory.sync")
    if missing_zones:
        print(f"MISSING_ZONES: {sorted(missing_zones)}")
    if extra_zones:
        print(f"EXTRA_ZONES: {sorted(extra_zones)}")
    if missing_tunnels:
        print(f"MISSING_TUNNELS: {sorted(missing_tunnels)}")
    if extra_tunnels:
        print(f"EXTRA_TUNNELS: {sorted(extra_tunnels)}")
    sys.exit(1)
print("cloudflare.inventory.sync OK")
PY
echo "auth_mode: ${CF_AUTH_MODE_EFFECTIVE:-${CF_AUTH_MODE_PREFERRED:-unknown}}"
