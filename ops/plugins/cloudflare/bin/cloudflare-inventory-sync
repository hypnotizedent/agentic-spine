#!/usr/bin/env bash
set -euo pipefail
ROOT="$(cd "$(dirname "$0")/../../../../" && pwd)"
SECRETS_EXEC="$ROOT/ops/plugins/secrets/bin/secrets-exec"
BINDING_FILE="$ROOT/ops/bindings/cloudflare.inventory.yaml"
export ROOT

if [[ -z "${SPINE_SECRETS_INJECTED:-}" ]]; then
  export SPINE_SECRETS_INJECTED=1
  exec "$SECRETS_EXEC" -- "$0" "$@"
fi

if [[ ! -f "$BINDING_FILE" ]]; then
  echo "FAIL: binding file missing" >&2
  exit 1
fi

export CLOUDFLARE_API_BASE="${CLOUDFLARE_API_BASE:-https://api.cloudflare.com/client/v4}"
CF_API="$CLOUDFLARE_API_BASE"
if [[ -z "${CLOUDFLARE_API_TOKEN:-}" ]]; then
  echo "STOP: CLOUDFLARE_API_TOKEN missing" >&2
  exit 2
fi
if [[ -z "${CLOUDFLARE_ACCOUNT_ID:-}" ]]; then
  echo "STOP: CLOUDFLARE_ACCOUNT_ID missing" >&2
  exit 2
fi

python3 - <<'PY'
import json, os, subprocess, sys
root = os.environ["ROOT"]
with open(os.path.join(root, "ops/bindings/cloudflare.inventory.yaml")) as f:
    binding = json.load(f)

def fetch(url):
    import urllib.request
    req = urllib.request.Request(url, headers={
        "Authorization": f"Bearer {os.environ['CLOUDFLARE_API_TOKEN']}",
        "Content-Type": "application/json"
    })
    with urllib.request.urlopen(req, timeout=20) as resp:
        return json.loads(resp.read().decode())

data_zones = fetch(f"{os.environ['CLOUDFLARE_API_BASE'].rstrip('/')}/zones?per_page=50")
data_tunnels = fetch(f"{os.environ['CLOUDFLARE_API_BASE'].rstrip('/')}/accounts/{os.environ['CLOUDFLARE_ACCOUNT_ID']}/tunnels")

live_zones = {z['name'] for z in data_zones.get('result', [])}
live_tunnels = {t['name'] for t in data_tunnels.get('result', [])}

binding_zones = {z['name'] for z in binding.get('zones', []) if z.get('name')}
binding_tunnels = {t['name'] for t in binding.get('tunnels', []) if t.get('name')}

missing_zones = binding_zones - live_zones
extra_zones = live_zones - binding_zones
missing_tunnels = binding_tunnels - live_tunnels
extra_tunnels = live_tunnels - binding_tunnels

if missing_zones or missing_tunnels or extra_zones or extra_tunnels:
    print("cloudflare.inventory.sync")
    if missing_zones:
        print(f"MISSING_ZONES: {sorted(missing_zones)}")
    if extra_zones:
        print(f"EXTRA_ZONES: {sorted(extra_zones)}")
    if missing_tunnels:
        print(f"MISSING_TUNNELS: {sorted(missing_tunnels)}")
    if extra_tunnels:
        print(f"EXTRA_TUNNELS: {sorted(extra_tunnels)}")
    sys.exit(1)
print("cloudflare.inventory.sync OK")
PY
