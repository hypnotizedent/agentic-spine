#!/usr/bin/env bash
set -euo pipefail

# cloudflare.zone.list â€” read-only listing of all Cloudflare zones with activation status
# Shows: zone name, id, status, plan, name_servers, activated_on
# Requires: CLOUDFLARE_API_TOKEN via secrets injection

ROOT="$(cd "$(dirname "$0")/../../../../" && pwd)"
SECRETS_EXEC="$ROOT/ops/plugins/secrets/bin/secrets-exec"
CF_LIB="$ROOT/ops/plugins/cloudflare/lib/cloudflare-api.sh"

if [[ -z "${SPINE_SECRETS_INJECTED:-}" ]]; then
  export SPINE_SECRETS_INJECTED=1
  exec "$SECRETS_EXEC" -- "$0" "$@"
fi

source "$CF_LIB"

CF_API="${CLOUDFLARE_API_BASE:-https://api.cloudflare.com/client/v4}"
cf_require_auth || exit $?

# Parse args
while [[ $# -gt 0 ]]; do
  case "$1" in
    --json) JSON_OUT=1; shift ;;
    --) shift ;;
    *) shift ;;
  esac
done

TMP_PAGES="$(mktemp)"
trap 'rm -f "$TMP_PAGES" 2>/dev/null || true' EXIT

page=1
while true; do
  PAGE_JSON="$(cf_api_get "${CF_API}/zones?per_page=50&page=${page}")" || {
    echo "STOP: Cloudflare zones request failed (network/auth)." >&2
    exit 2
  }
  echo "$PAGE_JSON" | python3 -c '
import json, sys
data = json.load(sys.stdin)
if not data.get("success", False):
    print("STOP: Cloudflare API returned success=false for zones.", file=sys.stderr)
    raise SystemExit(2)
'
  printf '%s\n' "$PAGE_JSON" >> "$TMP_PAGES"
  total_pages="$(echo "$PAGE_JSON" | python3 -c '
import json, sys
data = json.load(sys.stdin)
print((data.get("result_info") or {}).get("total_pages", 1))
')"
  if [[ "$page" -ge "$total_pages" ]]; then
    break
  fi
  page=$((page + 1))
done

python3 - "$TMP_PAGES" "${JSON_OUT:-0}" "${CF_AUTH_MODE_EFFECTIVE:-${CF_AUTH_MODE_PREFERRED:-unknown}}" <<'PYEOF'
import json, sys
pages_file = sys.argv[1]
json_out = sys.argv[2] == "1"
auth_mode = sys.argv[3]

all_zones = []
with open(pages_file, "r", encoding="utf-8") as f:
    for line in f:
        line = line.strip()
        if not line:
            continue
        data = json.loads(line)
        all_zones.extend(data.get("result", []))

results = []
for z in all_zones:
    results.append({
        "name": z.get("name"),
        "id": z.get("id"),
        "status": z.get("status"),
        "plan": z.get("plan", {}).get("name", "unknown"),
        "name_servers": z.get("name_servers", []),
        "activated_on": z.get("activated_on", "unknown"),
        "paused": z.get("paused", False),
    })

if json_out:
    print(json.dumps(results, indent=2))
else:
    print("cloudflare.zone.list")
    print(f"auth_mode: {auth_mode}")
    print(f"zones: {len(results)}")
    print()
    fmt = "{:<30s} {:<12s} {:<15s} {:<12s} {:<6s}"
    print(fmt.format("ZONE", "STATUS", "PLAN", "ACTIVATED", "PAUSED"))
    print("-" * 75)
    for r in results:
        print(fmt.format(
            r["name"],
            r["status"],
            r["plan"][:15],
            str(r["activated_on"])[:10],
            str(r["paused"]),
        ))
PYEOF
