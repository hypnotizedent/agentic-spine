#!/usr/bin/env bash
set -euo pipefail

# cloudflare.status â€” spine-native Cloudflare read-only status
# Requires: secrets.binding, secrets.auth.status, secrets.projects.status
# Outputs: zones count + per-zone DNS record counts (no values)

# Root of repo (this file lives at ops/plugins/cloudflare/bin/)
ROOT="$(cd "$(dirname "$0")/../../../../" && pwd)"
SECRETS_EXEC="$ROOT/ops/plugins/secrets/bin/secrets-exec"
CF_LIB="$ROOT/ops/plugins/cloudflare/lib/cloudflare-api.sh"

# Re-exec ourselves under secrets injection (single capability receipt; no nested caps)
if [[ -z "${SPINE_SECRETS_INJECTED:-}" ]]; then
  export SPINE_SECRETS_INJECTED=1
  exec "$SECRETS_EXEC" -- "$0" "$@"
fi

source "$CF_LIB"

CF_API="${CLOUDFLARE_API_BASE:-https://api.cloudflare.com/client/v4}"
cf_require_auth || exit $?

# Fetch zones (names + ids only)
ZONES_JSON="$(cf_api_get "${CF_API}/zones?per_page=50")" || {
  echo "STOP: Cloudflare zones request failed (network/auth)." >&2
  exit 2
}

TMP_ZONES="$(mktemp)"
trap 'rm -f "$TMP_ZONES" 2>/dev/null || true' EXIT
printf '%s\n' "$ZONES_JSON" > "$TMP_ZONES"

zones_tsv="$(python3 - "$TMP_ZONES" <<'PY'
import json, sys
with open(sys.argv[1], "r", encoding="utf-8") as f:
    data = json.load(f)
if not data.get("success", False):
    print("STOP: Cloudflare API returned success=false for zones.", file=sys.stderr)
    raise SystemExit(2)
for z in data.get("result", []):
    print(f"{z.get('id','')}\t{z.get('name','<unknown>')}")
PY
)"

echo "cloudflare.status"
echo "auth_mode: ${CF_AUTH_MODE_EFFECTIVE:-${CF_AUTH_MODE_PREFERRED:-unknown}}"
echo "zones: $(printf '%s\n' "$zones_tsv" | sed '/^$/d' | wc -l | tr -d ' ')"

while IFS=$'\t' read -r zid name; do
  [[ -n "${zid:-}" ]] || continue
  DNS_JSON="$(cf_api_get "${CF_API}/zones/${zid}/dns_records?per_page=1" || true)"
  if [[ -z "$DNS_JSON" ]]; then
    echo "- ${name}: STOP (dns_records request failed)"
    continue
  fi
  total="$(printf '%s\n' "$DNS_JSON" | python3 -c '
import json, sys
data = json.load(sys.stdin)
if not data.get("success", False):
    print("")
else:
    print((data.get("result_info") or {}).get("total_count", ""))
')"
  if [[ -z "$total" ]]; then
    echo "- ${name}: STOP (dns_records success=false)"
  else
    echo "- ${name}: dns_records=${total}"
  fi
done <<< "$zones_tsv"
