#!/usr/bin/env bash
set -euo pipefail

# home-health-check: HTTP health probes for home services

echo "=== Home Services Health Check ==="
echo ""

check_service() {
    local name="$1" url="$2" expect="$3"
    local http_code
    http_code=$(curl -s -o /dev/null -w "%{http_code}" -m 5 "$url" 2>/dev/null || echo "000")
    if [[ "$http_code" == "$expect" ]]; then
        echo "  $name: OK (HTTP $http_code)"
    else
        echo "  $name: FAIL (HTTP $http_code, expected $expect)"
    fi
}

HA_HOST="${HA_HOST:-10.0.0.100}"
HA_PORT="${HA_PORT:-8123}"
check_service "Home Assistant" "http://${HA_HOST}:${HA_PORT}/api/" "401"

echo ""
echo "--- Stopped / Decommissioned services (skipped) ---"
echo "  Vaultwarden (VM 102): decommissioned 2026-02-16 (superseded by infra-core)"
echo "  Pi-hole (LXC 105): stopped"
echo "  Immich-home (VM 101): stopped"
echo "  download-home (LXC 103): stopped"

echo ""
echo "=== Done ==="
