#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../../../.." && pwd)"
RULES_FILE="$ROOT/ops/bindings/alerting.rules.yaml"
JSON_MODE=0

usage() {
  cat <<'USAGE'
alerting-status

Usage:
  alerting-status [--rules <path>] [--json]

Shows alert history counts and cooldown timers by domain.
USAGE
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --rules)
      RULES_FILE="${2:-}"
      shift 2
      ;;
    --json)
      JSON_MODE=1
      shift
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      echo "FAIL: unknown argument: $1" >&2
      exit 2
      ;;
  esac
done

[[ -f "$RULES_FILE" ]] || { echo "FAIL: missing rules file: $RULES_FILE" >&2; exit 1; }

ALERT_DIR_REL="$(yq -r '.defaults.alert_outbox_dir // "mailroom/outbox/alerts"' "$RULES_FILE")"
ALERT_DIR="$ROOT/$ALERT_DIR_REL"
COOLDOWN_DIR="$ALERT_DIR/.cooldown"
mkdir -p "$ALERT_DIR" "$COOLDOWN_DIR"

now_epoch="$(date +%s)"
rows_json="[]"

while IFS= read -r domain; do
  [[ -z "$domain" || "$domain" == "null" ]] && continue

  cooldown="$(yq -r ".rules[] | select(.domain_id == \"$domain\") | .cooldown_seconds // 0" "$RULES_FILE")"
  [[ "$cooldown" =~ ^[0-9]+$ ]] || cooldown=0

  last_epoch=0
  remaining=0
  cooldown_file="$COOLDOWN_DIR/$domain"
  if [[ -f "$cooldown_file" ]]; then
    raw="$(cat "$cooldown_file" 2>/dev/null || echo 0)"
    if [[ "$raw" =~ ^[0-9]+$ ]]; then
      last_epoch="$raw"
      delta=$(( now_epoch - last_epoch ))
      if (( delta < cooldown )); then
        remaining=$(( cooldown - delta ))
      fi
    fi
  fi

  count="$(find "$ALERT_DIR" -maxdepth 1 -type f -name "ALERT-*-${domain}.yaml" 2>/dev/null | wc -l | tr -d ' ')"

  row="$(jq -n --arg domain "$domain" --argjson alerts "$count" --argjson cooldown_seconds "$cooldown" --argjson last_epoch "$last_epoch" --argjson cooldown_remaining_seconds "$remaining" '{domain:$domain,alerts:$alerts,cooldown_seconds:$cooldown_seconds,last_epoch:$last_epoch,cooldown_remaining_seconds:$cooldown_remaining_seconds}')"
  rows_json="$(jq -c --argjson row "$row" '. + [$row]' <<<"$rows_json")"
done < <(yq -r '.rules[].domain_id' "$RULES_FILE")

if [[ "$JSON_MODE" -eq 1 ]]; then
  jq -n --arg rules "$RULES_FILE" --arg alert_dir "$ALERT_DIR" --argjson domains "$rows_json" '{capability:"alerting.status",rules:$rules,alert_dir:$alert_dir,domains:$domains}'
  exit 0
fi

echo "alerting.status"
echo "rules: $RULES_FILE"
echo "alert_dir: $ALERT_DIR"
echo
printf "%-20s %-8s %-8s %-10s\n" "domain" "alerts" "cooldown" "remaining"
printf "%-20s %-8s %-8s %-10s\n" "--------------------" "--------" "--------" "----------"

jq -r '.[] | [.domain, (.alerts|tostring), (.cooldown_seconds|tostring), (.cooldown_remaining_seconds|tostring)] | @tsv' <<<"$rows_json" \
  | while IFS=$'\t' read -r d c cd rem; do
      printf "%-20s %-8s %-8s %-10s\n" "$d" "$c" "$cd" "$rem"
    done
