#!/usr/bin/env bash
# ═══════════════════════════════════════════════════════════════════════════
# ha-status — Unified HA status dashboard
# ═══════════════════════════════════════════════════════════════════════════
set -euo pipefail

SPINE_ROOT="${SPINE_ROOT:-$HOME/code/agentic-spine}"
SPINE_CODE="${SPINE_CODE:-$SPINE_ROOT}"
BINDINGS_DIR="$SPINE_ROOT/ops/bindings"
CAP_RUNNER="$SPINE_CODE/bin/ops"

echo "═══════════════════════════════════════════════════════════════════════════"
echo "HOME ASSISTANT STATUS"
echo "═══════════════════════════════════════════════════════════════════════════"
echo

# ═══════════════════════════════════════════════════════════════════════════
# 1. API HEALTH
# ═══════════════════════════════════════════════════════════════════════════

echo "┌─ API HEALTH ─────────────────────────────────────────────────────────────┐"

HA_HEALTH=$("$CAP_RUNNER" cap run ha.health.status 2>/dev/null || true)
if echo "$HA_HEALTH" | grep -q "status: OK"; then
  API_STATUS="✓ UP"
  HA_VERSION=$(echo "$HA_HEALTH" | grep "version:" | head -1 | awk '{print $2}' || echo "unknown")
else
  API_STATUS="✗ DOWN"
  HA_VERSION="n/a"
fi

printf "│  %-20s %s\n" "Status:" "$API_STATUS"
printf "│  %-20s %s\n" "HA Version:" "$HA_VERSION"
echo "└──────────────────────────────────────────────────────────────────────────┘"
echo

# ═══════════════════════════════════════════════════════════════════════════
# 2. ENTITY COUNTS (from SSOT baseline)
# ═══════════════════════════════════════════════════════════════════════════

echo "┌─ ENTITIES ───────────────────────────────────────────────────────────────┐"

BASELINE="$BINDINGS_DIR/ha.ssot.baseline.yaml"
if [[ -f "$BASELINE" ]]; then
  TOTAL=$(yq e '.counts.entities // 0' "$BASELINE")
  DEVICES=$(yq e '.counts.devices // 0' "$BASELINE")
  AUTOMATIONS=$(yq e '.counts.automations // 0' "$BASELINE")
  SCRIPTS=$(yq e '.counts.scripts // 0' "$BASELINE")
  SCENES=$(yq e '.counts.scenes // 0' "$BASELINE")
  INTEGRATIONS=$(yq e '.counts.integrations // 0' "$BASELINE")
  ADDONS=$(yq e '.counts.addons // 0' "$BASELINE")
  
  UNAVAIL=$(yq e '.health.entities_unavailable // 0' "$BASELINE")
  EXP_UNAVAIL=$(yq e '.health.entities_expected_unavailable // 0' "$BASELINE")
  UNEXP_UNAVAIL=$((UNAVAIL - EXP_UNAVAIL))
  
  UNKNOWN=$(yq e '.health.entities_unknown // 0' "$BASELINE")
  EXP_UNKNOWN=$(yq e '.health.entities_expected_unknown // 0' "$BASELINE")
  UNEXP_UNKNOWN=$((UNKNOWN - EXP_UNKNOWN))
  
  printf "│  %-20s %s\n" "Total Entities:" "$TOTAL"
  printf "│  %-20s %s\n" "Devices:" "$DEVICES"
  printf "│  %-20s %s\n" "Automations:" "$AUTOMATIONS"
  printf "│  %-20s %s\n" "Scripts:" "$SCRIPTS"
  printf "│  %-20s %s\n" "Scenes:" "$SCENES"
  printf "│  %-20s %s\n" "Integrations:" "$INTEGRATIONS"
  printf "│  %-20s %s\n" "Add-ons:" "$ADDONS"
  echo "│"
  if (( UNEXP_UNAVAIL > 0 )); then
    printf "│  %-20s %s %s\n" "Unavailable:" "$UNAVAIL" "($UNEXP_UNAVAIL unexpected)"
  else
    printf "│  %-20s %s (all expected)\n" "Unavailable:" "$UNAVAIL"
  fi
  if (( UNEXP_UNKNOWN > 0 )); then
    printf "│  %-20s %s %s\n" "Unknown:" "$UNKNOWN" "($UNEXP_UNKNOWN unexpected)"
  else
    printf "│  %-20s %s (all expected)\n" "Unknown:" "$UNKNOWN"
  fi
else
  echo "│  No baseline found. Run: ops cap run ha.ssot.baseline.build"
fi

echo "└──────────────────────────────────────────────────────────────────────────┘"
echo

# ═══════════════════════════════════════════════════════════════════════════
# 3. ADD-ON STATUS
# ═══════════════════════════════════════════════════════════════════════════

echo "┌─ ADD-ONS ────────────────────────────────────────────────────────────────┐"

ADDONS_FILE="$BINDINGS_DIR/ha.addons.yaml"
if [[ -f "$ADDONS_FILE" ]]; then
  TOTAL_ADDONS=$(yq e '[.addons[]] | length' "$ADDONS_FILE" 2>/dev/null || echo "0")
  STARTED=$(yq e '[.addons[] | select(.state == "started")] | length' "$ADDONS_FILE" 2>/dev/null || echo "0")
  STOPPED=$(yq e '[.addons[] | select(.state == "stopped")] | length' "$ADDONS_FILE" 2>/dev/null || echo "0")
  ERRORS=$(yq e '[.addons[] | select(.state == "error")] | length' "$ADDONS_FILE" 2>/dev/null || echo "0")
  
  printf "│  %-20s %s\n" "Total:" "$TOTAL_ADDONS"
  printf "│  %-20s %s\n" "Started:" "$STARTED"
  printf "│  %-20s %s\n" "Stopped:" "$STOPPED"
  
  if (( ERRORS > 0 )); then
    printf "│  %-20s \033[31m%s\033[0m\n" "Errors:" "$ERRORS"
    echo "│"
    echo "│  Add-ons with errors:"
    yq e '.addons[] | select(.state == "error") | "    - " + .slug' "$ADDONS_FILE" 2>/dev/null | head -5
  else
    printf "│  %-20s %s\n" "Errors:" "0"
  fi
else
  echo "│  No add-on data. Run: ops cap run ha.addons.snapshot"
fi

echo "└──────────────────────────────────────────────────────────────────────────┘"
echo

# ═══════════════════════════════════════════════════════════════════════════
# 4. DEVICE MAP / ORPHANS
# ═══════════════════════════════════════════════════════════════════════════

echo "┌─ DEVICES ────────────────────────────────────────────────────────────────┐"

DEVICE_MAP="$BINDINGS_DIR/ha.device.map.yaml"
if [[ -f "$DEVICE_MAP" ]]; then
  TOTAL_DEVICES=$(yq e '.summary.device_count // 0' "$DEVICE_MAP" 2>/dev/null || echo "0")
  MATCHED=$(yq e '.summary.network_matched // 0' "$DEVICE_MAP" 2>/dev/null || echo "0")
  Z2M_MATCHED=$(yq e '.summary.z2m_matched // 0' "$DEVICE_MAP" 2>/dev/null || echo "0")
  ORPHANS=$(yq e '.summary.orphans // 0' "$DEVICE_MAP" 2>/dev/null || echo "0")
  
  printf "│  %-20s %s\n" "Total HA Devices:" "$TOTAL_DEVICES"
  printf "│  %-20s %s\n" "Network Matched:" "$MATCHED"
  printf "│  %-20s %s\n" "Z2M Matched:" "$Z2M_MATCHED"
  printf "│  %-20s %s\n" "Orphans:" "$ORPHANS"
  
  Z2M_FILE="$BINDINGS_DIR/z2m.devices.yaml"
  if [[ -f "$Z2M_FILE" ]]; then
    Z2M_COUNT=$(yq e '.devices | length // 0' "$Z2M_FILE" 2>/dev/null || echo "0")
    printf "│  %-20s %s\n" "Z2M Devices:" "$Z2M_COUNT"
  fi
else
  echo "│  No device map. Run: ops cap run ha.device.map.build"
fi

echo "└──────────────────────────────────────────────────────────────────────────┘"
echo

# ═══════════════════════════════════════════════════════════════════════════
# 5. BINDING FRESHNESS
# ═══════════════════════════════════════════════════════════════════════════

echo "┌─ BINDING FRESHNESS ──────────────────────────────────────────────────────┐"

BINDINGS=(
  "ha.addons.yaml"
  "ha.automations.yaml"
  "ha.dashboards.yaml"
  "ha.helpers.yaml"
  "ha.integrations.yaml"
  "ha.scenes.yaml"
  "ha.scripts.yaml"
  "ha.hacs.yaml"
  "ha.entity.state.baseline.yaml"
  "ha.device.map.yaml"
  "ha.ssot.baseline.yaml"
  "z2m.devices.yaml"
)

NOW=$(date +%s)
STALE_COUNT=0

for binding in "${BINDINGS[@]}"; do
  FILE="$BINDINGS_DIR/$binding"
  if [[ -f "$FILE" ]]; then
    GENERATED=$(yq e '.generated // ""' "$FILE" 2>/dev/null || true)
    if [[ -n "$GENERATED" && "$GENERATED" != "null" ]]; then
      GEN_TS=$(date -j -f "%Y-%m-%dT%H:%M:%SZ" "$GENERATED" +%s 2>/dev/null || echo "0")
      if [[ "$GEN_TS" -gt 0 ]]; then
        AGE_DAYS=$(( (NOW - GEN_TS) / 86400 ))
        if (( AGE_DAYS > 7 )); then
          printf "│  %-35s \033[33m%s\033[0m\n" "$binding" "${AGE_DAYS}d old"
          STALE_COUNT=$((STALE_COUNT + 1))
        else
          printf "│  %-35s %s\n" "$binding" "${AGE_DAYS}d"
        fi
      else
        printf "│  %-35s %s\n" "$binding" "no timestamp"
      fi
    else
      printf "│  %-35s %s\n" "$binding" "no timestamp"
    fi
  else
    printf "│  %-35s \033[31m%s\033[0m\n" "$binding" "missing"
    STALE_COUNT=$((STALE_COUNT + 1))
  fi
done

if (( STALE_COUNT > 0 )); then
  echo "│"
  echo "│  \033[33m$STALE_COUNT stale/missing bindings. Run: ops cap run ha.refresh\033[0m"
fi

echo "└──────────────────────────────────────────────────────────────────────────┘"
echo

# ═══════════════════════════════════════════════════════════════════════════
# 6. OPEN HA GAPS
# ═══════════════════════════════════════════════════════════════════════════

echo "┌─ OPEN HA GAPS ───────────────────────────────────────────────────────────┐"

GAPS_FILE="$BINDINGS_DIR/operational.gaps.yaml"
if [[ -f "$GAPS_FILE" ]]; then
  HA_GAPS=$(yq e '.gaps[] | select(.tags[]? | test("ha|home-assistant|z2m|zigbee")) | select(.status == "open") | "  [" + .priority + "] " + .id + ": " + .title' "$GAPS_FILE" 2>/dev/null || true)
  
  if [[ -n "$HA_GAPS" ]]; then
    echo "$HA_GAPS" | head -10
    GAP_COUNT=$(echo "$HA_GAPS" | wc -l | tr -d ' ')
    if (( GAP_COUNT > 10 )); then
      echo "│  ... and $((GAP_COUNT - 10)) more"
    fi
  else
    echo "│  No open HA-related gaps"
  fi
else
  echo "│  No gaps registry"
fi

echo "└──────────────────────────────────────────────────────────────────────────┘"
echo

echo "═══════════════════════════════════════════════════════════════════════════"
echo "Run 'ops cap run ha.refresh' to update all bindings"
echo "═══════════════════════════════════════════════════════════════════════════"
