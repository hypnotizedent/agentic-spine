#!/usr/bin/env bash
set -euo pipefail

# ha.ssot.baseline.build — Build unified HA SSOT baseline from all sub-bindings
# Reads all HA sub-bindings + queries HA API for live infrastructure facts.
# Output: ops/bindings/ha.ssot.baseline.yaml

SPINE_ROOT="${SPINE_ROOT:-$HOME/code/agentic-spine}"
OUTPUT="$SPINE_ROOT/ops/bindings/ha.ssot.baseline.yaml"
BINDINGS_DIR="$SPINE_ROOT/ops/bindings"
INFISICAL_AGENT="${SPINE_ROOT}/ops/tools/infisical-agent.sh"
HA_HOST="${HA_HOST:-10.0.0.100}"
HA_PORT="${HA_PORT:-8123}"
HA_BASE="http://${HA_HOST}:${HA_PORT}"

TMPDIR_WORK=$(mktemp -d)
trap 'rm -rf "$TMPDIR_WORK"' EXIT

echo "ha.ssot.baseline.build"
echo

# ─────────────────────────────────────────────────────────────────────────────
# PRECONDITIONS
# ─────────────────────────────────────────────────────────────────────────────

command -v python3 >/dev/null 2>&1 || { echo "STOP (2): python3 not found"; exit 2; }
command -v curl >/dev/null 2>&1 || { echo "STOP (2): curl not found"; exit 2; }

# ─────────────────────────────────────────────────────────────────────────────
# RETRIEVE HA TOKEN + LIVE DATA
# ─────────────────────────────────────────────────────────────────────────────

if [[ ! -x "$INFISICAL_AGENT" ]]; then
  echo "STOP (2): infisical-agent.sh not found"
  exit 2
fi

HA_TOKEN=$("$INFISICAL_AGENT" get home-assistant prod HA_API_TOKEN 2>/dev/null) || true

if [[ -z "${HA_TOKEN:-}" ]]; then
  echo "STOP (2): could not retrieve HA_API_TOKEN from Infisical"
  exit 2
fi

# Fetch HA config for version info
echo "Fetching HA config..."
curl -s --connect-timeout 10 -H "Authorization: Bearer $HA_TOKEN" \
  "${HA_BASE}/api/config" > "$TMPDIR_WORK/config.json" 2>/dev/null || echo '{}' > "$TMPDIR_WORK/config.json"

# Fetch supervisor info for supervisor version
echo "Fetching supervisor info..."
SSH_TARGET="hassio@ha"
SSH_OPTS="-o ConnectTimeout=10 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o BatchMode=yes -o LogLevel=ERROR"
ssh $SSH_OPTS "$SSH_TARGET" \
  'bash -l -c '"'"'curl -s -H "Authorization: Bearer $SUPERVISOR_TOKEN" http://supervisor/supervisor/info'"'"'' \
  > "$TMPDIR_WORK/supervisor.json" 2>/dev/null || echo '{}' > "$TMPDIR_WORK/supervisor.json"

echo
echo "Building unified baseline..."

# ─────────────────────────────────────────────────────────────────────────────
# BUILD UNIFIED BASELINE (Python)
# ─────────────────────────────────────────────────────────────────────────────

python3 - "$TMPDIR_WORK" "$OUTPUT" "$BINDINGS_DIR" << 'PYEOF'
import json, sys, datetime, os

try:
    import yaml
except ImportError:
    print("STOP (2): PyYAML not installed", file=sys.stderr)
    sys.exit(2)

tmpdir, out_path, bindings_dir = sys.argv[1], sys.argv[2], sys.argv[3]

now = datetime.datetime.now(datetime.timezone.utc)
now_str = now.strftime('%Y-%m-%dT%H:%M:%SZ')

# ── Helper: load YAML binding ───────────────────────────────────────────────
def load_binding(filename):
    path = os.path.join(bindings_dir, filename)
    if not os.path.isfile(path):
        return None, path
    with open(path, 'r') as f:
        try:
            data = yaml.safe_load(f)
        except yaml.YAMLError:
            return None, path
    return data, path

def binding_age_days(data):
    """Compute age in days from 'generated' field."""
    if not data or 'generated' not in data:
        return -1
    try:
        gen = datetime.datetime.strptime(data['generated'], '%Y-%m-%dT%H:%M:%SZ')
        gen = gen.replace(tzinfo=datetime.timezone.utc)
        return (now - gen).days
    except (ValueError, TypeError):
        return -1

# ── Load HA config ───────────────────────────────────────────────────────────
with open(os.path.join(tmpdir, 'config.json'), 'r') as f:
    try:
        ha_config = json.load(f)
    except json.JSONDecodeError:
        ha_config = {}

with open(os.path.join(tmpdir, 'supervisor.json'), 'r') as f:
    try:
        supervisor = json.load(f)
    except json.JSONDecodeError:
        supervisor = {}

ha_version = ha_config.get('version', 'unknown')
supervisor_version = supervisor.get('data', {}).get('version', 'unknown')

# ── Sub-binding manifest ─────────────────────────────────────────────────────
sub_bindings = [
    'ha.addons.yaml',
    'ha.automations.yaml',
    'ha.dashboards.yaml',
    'ha.helpers.yaml',
    'ha.integrations.yaml',
    'ha.scenes.yaml',
    'ha.scripts.yaml',
    'ha.hacs.yaml',
    'ha.entity.state.baseline.yaml',
    'ha.device.map.yaml',
    'z2m.devices.yaml',
    'zwave.devices.yaml',
]

# Optional bindings (may not exist depending on HA config)
optional_bindings = []

binding_index = []
missing_bindings = []

for filename in sub_bindings + optional_bindings:
    data, path = load_binding(filename)
    is_optional = filename in optional_bindings

    if data is None:
        if not is_optional:
            missing_bindings.append(filename)
        binding_index.append({
            'path': filename,
            'exists': False,
            'generated': None,
            'age_days': -1,
            'optional': is_optional,
        })
    else:
        age = binding_age_days(data)
        binding_index.append({
            'path': filename,
            'exists': True,
            'generated': data.get('generated', ''),
            'age_days': age,
            'optional': is_optional,
        })

# ── Load summary counts from sub-bindings ────────────────────────────────────
addons_data, _ = load_binding('ha.addons.yaml')
automations_data, _ = load_binding('ha.automations.yaml')
helpers_data, _ = load_binding('ha.helpers.yaml')
integrations_data, _ = load_binding('ha.integrations.yaml')
scenes_data, _ = load_binding('ha.scenes.yaml')
scripts_data, _ = load_binding('ha.scripts.yaml')
hacs_data, _ = load_binding('ha.hacs.yaml')
entity_data, _ = load_binding('ha.entity.state.baseline.yaml')
device_map_data, _ = load_binding('ha.device.map.yaml')
z2m_data, _ = load_binding('z2m.devices.yaml')
zwave_data, _ = load_binding('zwave.devices.yaml')
dashboard_data, _ = load_binding('ha.dashboards.yaml')

# Safe getters
def sget(data, *keys, default=0):
    """Navigate nested dict keys, return default if missing."""
    obj = data
    for k in keys:
        if obj is None or not isinstance(obj, dict):
            return default
        obj = obj.get(k)
    return obj if obj is not None else default

# ── Counts ───────────────────────────────────────────────────────────────────
entity_total = sget(entity_data, 'summary', 'total_entities')
entity_by_domain = sget(entity_data, 'summary', 'by_domain', default={})
device_count = sget(device_map_data, 'summary', 'device_count') or len(sget(device_map_data, 'devices', default=[]))
addon_count = sget(addons_data, 'addon_count')
integration_count = sget(integrations_data, 'summary', 'integration_count')
automation_count = sget(automations_data, 'summary', 'automation_count')
script_count = sget(scripts_data, 'summary', 'script_count')
scene_count = sget(scenes_data, 'summary', 'scene_count')
helper_count = sget(helpers_data, 'summary', 'helper_count')
hacs_count = sget(hacs_data, 'summary', 'repo_count')
dashboard_count = sget(dashboard_data, 'summary', 'dashboard_count')
z2m_count = sget(z2m_data, 'z2m_devices', 'device_count') or len(sget(z2m_data, 'z2m_devices', 'devices', default=[]))
zwave_count = sget(zwave_data, 'device_count') or len(sget(zwave_data, 'devices', default=[]))

# ── Helpers by domain ────────────────────────────────────────────────────────
helpers_by_domain = sget(helpers_data, 'summary', 'by_domain', default={})

# ── Health ───────────────────────────────────────────────────────────────────
entities_unavailable = sget(entity_data, 'health', 'entities_unavailable')
entities_expected_unavailable = sget(entity_data, 'health', 'entities_expected_unavailable')
entities_unexpected_unavailable = sget(entity_data, 'health', 'entities_unexpected_unavailable')
entities_unknown = sget(entity_data, 'health', 'entities_unknown')
entities_expected_unknown = sget(entity_data, 'health', 'entities_expected_unknown')
entities_unexpected_unknown = sget(entity_data, 'health', 'entities_unexpected_unknown')
automations_enabled = sget(automations_data, 'summary', 'enabled_count')

addons_started = 0
addons_errors = 0
if addons_data and 'addons' in addons_data:
    for a in addons_data['addons']:
        if a.get('state') == 'started':
            addons_started += 1
        if a.get('state') == 'error':
            addons_errors += 1

# ── Coordinator info from Z2M + Z-Wave bindings ─────────────────────────────
coordinators = {}

# Zigbee (Z2M)
if z2m_data:
    coordinators['zigbee'] = {
        'coordinator': sget(z2m_data, 'z2m_devices', 'coordinator', default='SLZB-06'),
        'z2m_device_count': z2m_count,
    }

# Z-Wave
if zwave_data:
    coordinators['zwave'] = {
        'controller_ip': sget(zwave_data, 'controller_ip', default=''),
        'serial_connected': sget(zwave_data, 'serial_connected', default=''),
        'node_count': zwave_count,
    }

# ── Build unified baseline ───────────────────────────────────────────────────
baseline = {
    'schema_version': '1.0',
    'generated': now_str,
    'source': 'ha.ssot.baseline.build',

    'infrastructure': {
        'vm_id': 100,
        'host': 'proxmox-home',
        'local_ip': '10.0.0.100',
        'tailscale_ip': '100.67.120.1',
        'ha_version': ha_version,
        'supervisor_version': supervisor_version,
    },

    'coordinators': coordinators,

    'counts': {
        'entities': entity_total,
        'devices': device_count,
        'addons': addon_count,
        'integrations': integration_count,
        'automations': automation_count,
        'scripts': script_count,
        'scenes': scene_count,
        'helpers': {
            'total': helper_count,
            'by_domain': helpers_by_domain,
        },
        'dashboards': dashboard_count,
        'hacs_repos': hacs_count,
        'z2m_devices': z2m_count,
        'zwave_nodes': zwave_count,
    },

    'health': {
        'entities_unavailable': entities_unavailable,
        'entities_expected_unavailable': entities_expected_unavailable,
        'entities_unexpected_unavailable': entities_unexpected_unavailable,
        'entities_unknown': entities_unknown,
        'entities_expected_unknown': entities_expected_unknown,
        'entities_unexpected_unknown': entities_unexpected_unknown,
        'automations_enabled': automations_enabled,
        'addons_started': addons_started,
        'addons_errors': addons_errors,
    },

    'bindings': binding_index,
}

if missing_bindings:
    baseline['missing_bindings'] = missing_bindings

header = '# HA SSOT Unified Baseline\n'
header += '# Auto-generated by ha.ssot.baseline.build — do not hand-edit.\n'
header += '# Single source of truth index for the entire HA installation.\n'
header += '# Status: authoritative\n\n'

with open(out_path, 'w') as f:
    f.write(header)
    yaml.dump(baseline, f, default_flow_style=False, sort_keys=False, allow_unicode=True, width=120)

# ── Summary ──────────────────────────────────────────────────────────────────
print(f"Wrote {out_path}")
print()
print(f"  HA {ha_version} / Supervisor {supervisor_version}")
print(f"  {entity_total} entities, {device_count} devices")
print(f"  {addon_count} add-ons ({addons_started} started, {addons_errors} errors)")
print(f"  {integration_count} integrations, {automation_count} automations, {script_count} scripts, {scene_count} scenes")
print(f"  {helper_count} helpers, {hacs_count} HACS repos")
print(f"  {z2m_count} Z2M devices, {zwave_count} Z-Wave nodes")
print()
print(f"  Health: {entities_unavailable} unavailable ({entities_expected_unavailable} expected, {entities_unexpected_unavailable} unexpected)")
print(f"          {entities_unknown} unknown ({entities_expected_unknown} expected, {entities_unexpected_unknown} unexpected)")
print(f"          {automations_enabled} automations enabled")
print()

existing = sum(1 for b in binding_index if b['exists'])
total = len(binding_index)
print(f"  Bindings: {existing}/{total} on disk")
if missing_bindings:
    print(f"  Missing: {', '.join(missing_bindings)}")

for b in binding_index:
    status = 'OK' if b['exists'] else ('OPTIONAL' if b['optional'] else 'MISSING')
    age = f"{b['age_days']}d" if b['age_days'] >= 0 else 'n/a'
    print(f"    {b['path']:45s}  {status:8s}  age={age}")
PYEOF

echo
echo "sha256: $(shasum -a 256 "$OUTPUT" | cut -d' ' -f1)"
