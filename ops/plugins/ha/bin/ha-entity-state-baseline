#!/usr/bin/env bash
set -euo pipefail

# ha.entity.state.baseline — Snapshot all HA entity states as a regression-proof baseline
# Queries HA REST API for all entity states, cross-references expected-unavailable allowlist.
# Output: ops/bindings/ha.entity.state.baseline.yaml

SPINE_ROOT="${SPINE_ROOT:-$HOME/code/agentic-spine}"
OUTPUT="$SPINE_ROOT/ops/bindings/ha.entity.state.baseline.yaml"
EXPECTED_UNAVAIL="$SPINE_ROOT/ops/bindings/ha.entity.state.expected-unavailable.yaml"
EXPECTED_UNKNOWN="$SPINE_ROOT/ops/bindings/ha.entity.state.expected-unknown.yaml"
INFISICAL_AGENT="${SPINE_ROOT}/ops/tools/infisical-agent.sh"
HA_HOST="${HA_HOST:-10.0.0.100}"
HA_PORT="${HA_PORT:-8123}"
HA_BASE="http://${HA_HOST}:${HA_PORT}"

TMPDIR_WORK=$(mktemp -d)
trap 'rm -rf "$TMPDIR_WORK"' EXIT

echo "ha.entity.state.baseline"
echo

# ─────────────────────────────────────────────────────────────────────────────
# PRECONDITIONS
# ─────────────────────────────────────────────────────────────────────────────

command -v python3 >/dev/null 2>&1 || { echo "STOP (2): python3 not found"; exit 2; }
command -v curl >/dev/null 2>&1 || { echo "STOP (2): curl not found"; exit 2; }

# ─────────────────────────────────────────────────────────────────────────────
# RETRIEVE HA TOKEN
# ─────────────────────────────────────────────────────────────────────────────

if [[ ! -x "$INFISICAL_AGENT" ]]; then
  echo "STOP (2): infisical-agent.sh not found"
  exit 2
fi

HA_TOKEN=$("$INFISICAL_AGENT" get home-assistant prod HA_API_TOKEN 2>/dev/null) || true

if [[ -z "${HA_TOKEN:-}" ]]; then
  echo "STOP (2): could not retrieve HA_API_TOKEN from Infisical"
  exit 2
fi

# ─────────────────────────────────────────────────────────────────────────────
# QUERY HA API — all states
# ─────────────────────────────────────────────────────────────────────────────

echo "Fetching all states..."
HTTP_CODE=$(curl -s -o "$TMPDIR_WORK/states.json" -w '%{http_code}' --connect-timeout 10 \
  -H "Authorization: Bearer $HA_TOKEN" "${HA_BASE}/api/states" 2>/dev/null) || HTTP_CODE="000"

if [[ "$HTTP_CODE" != "200" ]]; then
  echo "STOP (2): /api/states returned HTTP $HTTP_CODE"
  exit 2
fi

echo
echo "Building entity state baseline..."

# ─────────────────────────────────────────────────────────────────────────────
# BUILD YAML BINDING (Python)
# ─────────────────────────────────────────────────────────────────────────────

python3 - "$TMPDIR_WORK" "$OUTPUT" "$EXPECTED_UNAVAIL" "$EXPECTED_UNKNOWN" << 'PYEOF'
import json, sys, datetime, os
from collections import Counter

try:
    import yaml
except ImportError:
    print("STOP (2): PyYAML not installed", file=sys.stderr)
    sys.exit(2)

tmpdir, out_path, expected_unavail_path, expected_unknown_path = sys.argv[1], sys.argv[2], sys.argv[3], sys.argv[4]

# ── Load all states ──────────────────────────────────────────────────────────
with open(os.path.join(tmpdir, 'states.json'), 'r') as f:
    all_states = json.load(f)

# ── Load expected-unavailable allowlist ──────────────────────────────────────
expected_unavail_ids = set()
if os.path.isfile(expected_unavail_path):
    with open(expected_unavail_path, 'r') as f:
        try:
            eu_data = yaml.safe_load(f) or {}
        except yaml.YAMLError:
            eu_data = {}
    for entry in eu_data.get('entities', []):
        eid = entry.get('entity_id', '')
        if eid:
            expected_unavail_ids.add(eid)

# ── Load expected-unknown allowlist ───────────────────────────────────────
expected_unknown_ids = set()
if os.path.isfile(expected_unknown_path):
    with open(expected_unknown_path, 'r') as f:
        try:
            eu_unk_data = yaml.safe_load(f) or {}
        except yaml.YAMLError:
            eu_unk_data = {}
    for entry in eu_unk_data.get('entities', []):
        eid = entry.get('entity_id', '')
        if eid:
            expected_unknown_ids.add(eid)

# ── Process all entities ─────────────────────────────────────────────────────
entities = []
domain_counts = Counter()
state_counts = Counter()
unavailable_count = 0
unknown_count = 0
expected_unavail_count = 0
unexpected_unavail_count = 0
expected_unknown_count = 0
unexpected_unknown_count = 0

for entity in sorted(all_states, key=lambda e: e.get('entity_id', '')):
    eid = entity.get('entity_id', '')
    if not eid:
        continue

    state = entity.get('state', '')
    attrs = entity.get('attributes', {})
    domain = eid.split('.')[0]

    domain_counts[domain] += 1
    state_counts[state] += 1

    if state == 'unavailable':
        unavailable_count += 1
        if eid in expected_unavail_ids:
            expected_unavail_count += 1
        else:
            unexpected_unavail_count += 1
    elif state == 'unknown':
        unknown_count += 1
        if eid in expected_unknown_ids:
            expected_unknown_count += 1
        else:
            unexpected_unknown_count += 1

    entities.append({
        'entity_id': eid,
        'domain': domain,
        'state': state,
        'friendly_name': attrs.get('friendly_name', ''),
    })

# ── Build output binding ─────────────────────────────────────────────────────
binding = {
    'schema_version': '1.0',
    'generated': datetime.datetime.now(datetime.timezone.utc).strftime('%Y-%m-%dT%H:%M:%SZ'),
    'source': 'ha.entity.state.baseline',
    'summary': {
        'total_entities': len(entities),
        'by_domain': dict(sorted(domain_counts.items())),
        'by_state': dict(sorted(state_counts.items())),
    },
    'health': {
        'entities_unavailable': unavailable_count,
        'entities_expected_unavailable': expected_unavail_count,
        'entities_unexpected_unavailable': unexpected_unavail_count,
        'entities_unknown': unknown_count,
        'entities_expected_unknown': expected_unknown_count,
        'entities_unexpected_unknown': unexpected_unknown_count,
        'expected_unavailable_allowlist': expected_unavail_path.split('/')[-1],
        'expected_unknown_allowlist': expected_unknown_path.split('/')[-1],
    },
    'entities': entities,
}

header = '# HA Entity State Baseline (SSOT)\n'
header += '# Auto-generated by ha.entity.state.baseline — do not hand-edit.\n'
header += '# Full entity state dump via HA REST API.\n'
header += '# Status: authoritative\n\n'

with open(out_path, 'w') as f:
    f.write(header)
    yaml.dump(binding, f, default_flow_style=False, sort_keys=False, allow_unicode=True, width=120)

# ── Summary ──────────────────────────────────────────────────────────────────
print(f"Wrote {out_path}")
print(f"  {len(entities)} total entities across {len(domain_counts)} domains")
print(f"  {unavailable_count} unavailable ({expected_unavail_count} expected, {unexpected_unavail_count} unexpected)")
print(f"  {unknown_count} unknown ({expected_unknown_count} expected, {unexpected_unknown_count} unexpected)")
print()
print("Top domains:")
for domain, count in sorted(domain_counts.items(), key=lambda x: -x[1])[:10]:
    print(f"  {domain}: {count}")
PYEOF

echo
echo "sha256: $(shasum -a 256 "$OUTPUT" | cut -d' ' -f1)"
