#!/usr/bin/env bash
set -euo pipefail

# media.sonarr.metrics.today — TV series daily metrics from Sonarr (read-only)
#
# Usage (via spine):
#   ./bin/ops cap run media.sonarr.metrics.today
#   ./bin/ops cap run media.sonarr.metrics.today --date 2026-02-25
#   ./bin/ops cap run media.sonarr.metrics.today --tz utc
#   ./bin/ops cap run media.sonarr.metrics.today --sample 10
#
# Contract:
# - Reads Sonarr endpoint from ops/bindings/services.health.yaml (id=sonarr)
# - Requires SONARR_API_KEY injected via secrets-exec (do NOT print it)
# - Queries missing episodes, today's grabs, series completion %
# - Outputs a bounded sample of episode titles (best-effort)

ROOT="$(cd "$(dirname "$0")/../../../../" && pwd)"
SECRETS_EXEC="$ROOT/ops/plugins/secrets/bin/secrets-exec"
SERVICES_BINDING="$ROOT/ops/bindings/services.health.yaml"

# Re-exec under secrets injection (single capability receipt; no nested caps).
if [[ -z "${SPINE_SECRETS_INJECTED:-}" ]]; then
  export SPINE_SECRETS_INJECTED=1
  exec "$SECRETS_EXEC" -- "$0" "$@"
fi

usage() {
  cat <<'USAGE'
media.sonarr.metrics.today

Args:
  --date YYYY-MM-DD   (default: today, based on --tz)
  --tz   local|utc    (default: local)
  --sample N          (default: 5)

Example:
  ./bin/ops cap run media.sonarr.metrics.today --tz utc --date 2026-02-25 --sample 10
USAGE
}

DATE_STR=""
TZ_MODE="local"
SAMPLE_SIZE="5"

while [[ $# -gt 0 ]]; do
  case "$1" in
    --date)
      DATE_STR="${2:-}"; shift 2 ;;
    --tz)
      TZ_MODE="${2:-}"; shift 2 ;;
    --sample)
      SAMPLE_SIZE="${2:-}"; shift 2 ;;
    -h|--help)
      usage; exit 0 ;;
    --)
      shift ;;
    *)
      echo "FAIL: unknown arg: $1" >&2
      usage >&2
      exit 1 ;;
  esac
done

if [[ "$TZ_MODE" != "local" && "$TZ_MODE" != "utc" ]]; then
  echo "FAIL: --tz must be 'local' or 'utc' (got: $TZ_MODE)" >&2
  exit 1
fi

if ! [[ "$SAMPLE_SIZE" =~ ^[0-9]+$ ]]; then
  echo "FAIL: --sample must be an integer (got: $SAMPLE_SIZE)" >&2
  exit 1
fi

command -v yq >/dev/null 2>&1 || { echo "MISSING_DEP: yq" >&2; exit 1; }
command -v curl >/dev/null 2>&1 || { echo "MISSING_DEP: curl" >&2; exit 1; }
command -v python3 >/dev/null 2>&1 || { echo "MISSING_DEP: python3" >&2; exit 1; }

if [[ -z "${SONARR_API_KEY:-}" ]]; then
  echo "STOP: SONARR_API_KEY not present in injected environment." >&2
  echo "hint: set SONARR_API_KEY in Infisical under /spine/vm-infra/media-stack/download" >&2
  exit 2
fi

SONARR_PING_URL="$(yq -r '.endpoints[] | select(.id=="sonarr") | .url // ""' "$SERVICES_BINDING")"
if [[ -z "${SONARR_PING_URL:-}" || "${SONARR_PING_URL:-}" == "null" ]]; then
  echo "STOP: sonarr endpoint missing in binding: $SERVICES_BINDING" >&2
  exit 2
fi

SONARR_BASE="${SONARR_PING_URL%/ping}"
SONARR_BASE="${SONARR_BASE%/}"

if [[ -z "${DATE_STR:-}" ]]; then
  if [[ "$TZ_MODE" == "utc" ]]; then
    DATE_STR="$(date -u +%Y-%m-%d)"
  else
    DATE_STR="$(date +%Y-%m-%d)"
  fi
fi

# Quick reachability check (no auth).
curl -fsS --max-time 5 "${SONARR_BASE}/ping" >/dev/null 2>&1 || {
  echo "STOP: sonarr ping failed: ${SONARR_BASE}/ping" >&2
  exit 2
}

python3 - "$SONARR_BASE" "$DATE_STR" "$TZ_MODE" "$SAMPLE_SIZE" <<'PY'
import datetime as _dt
import json as _json
import os as _os
import sys as _sys
import urllib.error as _ue
import urllib.request as _ur

base = _sys.argv[1].rstrip("/")
date_str = _sys.argv[2]
tz_mode = _sys.argv[3]
sample_size = int(_sys.argv[4])
api_key = _os.environ.get("SONARR_API_KEY", "")

def _fail_stop(msg: str) -> None:
    print(f"STOP: {msg}", file=_sys.stderr)
    raise SystemExit(2)

def _iso_to_dt(s: str):
    if not s:
        return None
    if s.endswith("Z"):
        s = s[:-1] + "+00:00"
    try:
        return _dt.datetime.fromisoformat(s)
    except ValueError:
        if "." in s:
            head, rest = s.split(".", 1)
            tz = ""
            if "+" in rest:
                tz = "+" + rest.split("+", 1)[1]
            elif "-" in rest:
                tz = "-" + rest.split("-", 1)[1]
            try:
                return _dt.datetime.fromisoformat(head + tz)
            except ValueError:
                return None
        return None

def _req_json(url: str):
    req = _ur.Request(url, headers={"X-Api-Key": api_key})
    with _ur.urlopen(req, timeout=60) as resp:
        body = resp.read().decode("utf-8")
        return _json.loads(body)

try:
    d = _dt.date.fromisoformat(date_str)
except ValueError:
    _fail_stop(f"invalid --date (expected YYYY-MM-DD): {date_str}")

if tz_mode == "utc":
    tz = _dt.timezone.utc
else:
    tz = _dt.datetime.now().astimezone().tzinfo

start = _dt.datetime(d.year, d.month, d.day, 0, 0, 0, tzinfo=tz)
end = start + _dt.timedelta(days=1)

# 1. Missing episodes (wanted)
try:
    wanted_data = _req_json(f"{base}/api/v3/wanted/missing?pageSize=1&sortKey=airDateUtc&sortDirection=descending")
    missing_count = wanted_data.get("totalRecords", 0)
except _ue.HTTPError as e:
    if e.code in (401, 403):
        _fail_stop("sonarr API auth failed (check SONARR_API_KEY)")
    _fail_stop(f"sonarr API HTTP error: {e.code}")
except _ue.URLError:
    _fail_stop("sonarr API unreachable (network/DNS)")
except Exception as e:
    _fail_stop(f"sonarr API error: {type(e).__name__}: {e}")

# 2. Today's grabs from history
matches = []
page = 1
page_size = 10
max_pages = 20

try:
    while page <= max_pages:
        url = f"{base}/api/v3/history?page={page}&pageSize={page_size}&sortKey=date&sortDirection=descending"
        data = _req_json(url)
        records = data.get("records") or []
        if not records:
            break

        stop = False
        for r in records:
            dt = _iso_to_dt(r.get("date", ""))
            if dt is None:
                continue
            if dt.tzinfo is None:
                dt = dt.replace(tzinfo=_dt.timezone.utc)

            dt_tz = dt.astimezone(tz)
            if dt_tz < start:
                stop = True
                break
            if dt_tz >= end:
                continue
            if r.get("eventType") != "downloadFolderImported":
                continue
            matches.append(r)

        if stop:
            break
        page += 1
except Exception:
    pass  # non-fatal — grabs count is best-effort

grabs_count = len(matches)

# 3. Series stats
try:
    series = _req_json(f"{base}/api/v3/series")
    total_series = len(series)
    complete_series = sum(1 for s in series if s.get("statistics", {}).get("percentOfEpisodes", 0) >= 100)
    completion_pct = round((complete_series / total_series * 100), 1) if total_series > 0 else 0.0
except Exception:
    total_series = -1
    complete_series = -1
    completion_pct = -1

# 4. Sample episode titles from today's grabs
episode_ids = []
for r in matches:
    eid = r.get("episodeId")
    if isinstance(eid, int) and eid not in episode_ids:
        episode_ids.append(eid)
    if len(episode_ids) >= sample_size:
        break

def _episode_title(eid: int) -> str:
    try:
        e = _req_json(f"{base}/api/v3/episode/{eid}")
        title = e.get("title") or str(eid)
        series_title = e.get("series", {}).get("title", "Unknown")
        season = e.get("seasonNumber", 0)
        episode = e.get("episodeNumber", 0)
        return f"{series_title} S{season:02d}E{episode:02d} - {title}"
    except Exception:
        return str(eid)

samples = [_episode_title(eid) for eid in episode_ids] if sample_size > 0 else []

print("media.sonarr.metrics.today")
print(f"service: sonarr")
print(f"base_url: {base}")
print(f"tz: {tz_mode}")
print(f"date: {date_str}")
print(f"window_start: {start.isoformat()}")
print(f"window_end: {end.isoformat()}")
print(f"missing_episodes: {missing_count}")
print(f"grabs_today: {grabs_count}")
print(f"total_series: {total_series}")
print(f"complete_series: {complete_series}")
print(f"completion_pct: {completion_pct}")
print("sample_episodes:")
if samples:
    for s in samples:
        print(f"- {s}")
else:
    print("- (none)")
PY
