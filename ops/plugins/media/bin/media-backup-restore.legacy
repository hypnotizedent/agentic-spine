#!/usr/bin/env bash
# media.backup.restore - Restore a media service config from governed backup snapshots.
set -euo pipefail

ROOT="${SPINE_ROOT:-$(cd "$(dirname "$0")/../../../.." && pwd)}"
VM_BINDING="$ROOT/ops/bindings/vm.lifecycle.yaml"
SERVICES_HEALTH="$ROOT/ops/bindings/services.health.yaml"

usage() {
  cat <<'USAGE'
media.backup.restore - Restore media service config from backup

Args:
  --vm HOST            Required: download-stack|streaming-stack
  --service NAME       Required: media service id (for example: radarr, sonarr, jellyfin)
  --backup-file PATH   Optional: explicit backup archive path on target VM
  --retention DAYS     Optional: backup lookup window (default: 7)
  --dry-run            Preview restore plan without mutation

Examples:
  ./bin/ops cap run media.backup.restore --vm download-stack --service radarr --dry-run
  ./bin/ops cap run media.backup.restore --vm streaming-stack --service jellyfin
USAGE
}

stop() {
  echo "FAIL: $*" >&2
  exit 1
}

VM=""
SERVICE=""
BACKUP_FILE=""
RETENTION_DAYS=7
DRY_RUN=0

while [[ $# -gt 0 ]]; do
  case "$1" in
    --) shift ;;
    --vm) VM="${2:-}"; shift 2 ;;
    --service) SERVICE="${2:-}"; shift 2 ;;
    --backup-file) BACKUP_FILE="${2:-}"; shift 2 ;;
    --retention) RETENTION_DAYS="${2:-}"; shift 2 ;;
    --dry-run) DRY_RUN=1; shift ;;
    -h|--help) usage; exit 0 ;;
    *) stop "unknown argument: $1" ;;
  esac
done

[[ -n "$VM" ]] || stop "--vm is required"
[[ -n "$SERVICE" ]] || stop "--service is required"
[[ "$RETENTION_DAYS" =~ ^[0-9]+$ ]] || stop "--retention must be numeric"

case "$VM" in
  download-stack|streaming-stack) ;;
  *) stop "--vm must be download-stack or streaming-stack" ;;
esac

command -v yq >/dev/null 2>&1 || stop "missing dependency: yq"
command -v ssh >/dev/null 2>&1 || stop "missing dependency: ssh"
command -v curl >/dev/null 2>&1 || stop "missing dependency: curl"
[[ -f "$VM_BINDING" ]] || stop "missing VM binding: $VM_BINDING"
[[ -f "$SERVICES_HEALTH" ]] || stop "missing services health binding: $SERVICES_HEALTH"

service_config_rel() {
  local vm="$1"
  local service="$2"

  case "$service" in
    radarr|sonarr|lidarr|prowlarr|sabnzbd|qbittorrent)
      [[ "$vm" == "download-stack" ]] || return 1
      echo "download-stack/${service}/config"
      ;;
    jellyfin|navidrome|jellyseerr|bazarr|homarr)
      [[ "$vm" == "streaming-stack" ]] || return 1
      echo "streaming-stack/${service}/config"
      ;;
    *)
      return 1
      ;;
  esac
}

config_rel="$(service_config_rel "$VM" "$SERVICE" 2>/dev/null || true)"
[[ -n "$config_rel" ]] || stop "service '$SERVICE' is not restore-mapped for vm '$VM'"

container_name="$SERVICE"

get_vm_ssh_ref() {
  local vm="$1"
  local target user

  target="$(yq -r ".vms[] | select(.hostname == \"$vm\") | .ssh_target // .hostname // \"\"" "$VM_BINDING" 2>/dev/null || true)"
  user="$(yq -r ".vms[] | select(.hostname == \"$vm\") | .ssh_user // \"\"" "$VM_BINDING" 2>/dev/null || true)"

  [[ -n "$target" && "$target" != "null" ]] || return 1

  if [[ -n "$user" && "$user" != "null" ]]; then
    echo "${user}@${target}"
  else
    echo "$target"
  fi
}

ssh_ref="$(get_vm_ssh_ref "$VM" 2>/dev/null || true)"
[[ -n "$ssh_ref" ]] || stop "no ssh target found for vm '$VM'"

mapfile -t backups < <(ssh -o BatchMode=yes -o ConnectTimeout=10 -o StrictHostKeyChecking=no "$ssh_ref" \
  "find /opt/backups/media-config -maxdepth 1 -type f -name '${VM}-*.tar.gz' -mtime -${RETENTION_DAYS} -print | sort -r" 2>/dev/null || true)

if [[ "${#backups[@]}" -eq 0 ]]; then
  stop "no backups found on $VM within ${RETENTION_DAYS} day(s)"
fi

selected_backup="$BACKUP_FILE"
if [[ -z "$selected_backup" ]]; then
  selected_backup="${backups[0]}"
fi

if ! ssh -o BatchMode=yes -o ConnectTimeout=10 -o StrictHostKeyChecking=no "$ssh_ref" \
  "test -f '$selected_backup'" >/dev/null 2>&1; then
  stop "selected backup does not exist on $VM: $selected_backup"
fi

cat <<INFO
media.backup.restore
====================
vm: $VM
service: $SERVICE
config_path: /opt/stacks/$config_rel
selected_backup: $selected_backup
retention_days: $RETENTION_DAYS
dry_run: $( [[ "$DRY_RUN" -eq 1 ]] && echo true || echo false )

available_backups:
INFO
for b in "${backups[@]}"; do
  echo "  - $b"
done

if [[ "$DRY_RUN" -eq 1 ]]; then
  echo
  echo "DRY_RUN: would stop container '$container_name', restore '$config_rel' from '$selected_backup', and start container."
  exit 0
fi

restore_script=$(cat <<'REMOTE'
set -euo pipefail

BACKUP_FILE="$1"
CONFIG_REL="$2"
CONTAINER_NAME="$3"

DOCKER_CMD="docker"
if ! docker ps >/dev/null 2>&1; then
  if command -v sudo >/dev/null 2>&1 && sudo -n docker ps >/dev/null 2>&1; then
    DOCKER_CMD="sudo -n docker"
  else
    echo "docker unavailable" >&2
    exit 1
  fi
fi

if ! tar -tzf "$BACKUP_FILE" | grep -q "^${CONFIG_REL}/"; then
  echo "backup archive does not contain ${CONFIG_REL}/" >&2
  exit 1
fi

if $DOCKER_CMD ps --format '{{.Names}}' | grep -Fxq "$CONTAINER_NAME"; then
  $DOCKER_CMD stop "$CONTAINER_NAME" >/dev/null 2>&1 || true
fi

rm -rf "/opt/stacks/${CONFIG_REL}"
mkdir -p "/opt/stacks/$(dirname "$CONFIG_REL")"
tar -xzf "$BACKUP_FILE" -C /opt/stacks "$CONFIG_REL"

$DOCKER_CMD start "$CONTAINER_NAME" >/dev/null 2>&1 || true

printf 'restored=%s\n' "$CONFIG_REL"
REMOTE
)

if ! ssh -o BatchMode=yes -o ConnectTimeout=15 -o StrictHostKeyChecking=no "$ssh_ref" \
  "bash -lc $(printf '%q' "$restore_script") -- $(printf '%q' "$selected_backup") $(printf '%q' "$config_rel") $(printf '%q' "$container_name")"; then
  stop "remote restore failed on $VM"
fi

endpoint_url="$(yq e -r ".endpoints[] | select(.id == \"$SERVICE\") | .url // \"\"" "$SERVICES_HEALTH" | head -n1)"
endpoint_expect="$(yq e -r ".endpoints[] | select(.id == \"$SERVICE\") | .expect // 200" "$SERVICES_HEALTH" | head -n1)"

if [[ -n "$endpoint_url" && "$endpoint_url" != "null" ]]; then
  [[ "$endpoint_expect" =~ ^[0-9]+$ ]] || endpoint_expect=200
  health_code="$(curl -fsS -o /dev/null -w '%{http_code}' --max-time 12 "$endpoint_url" 2>/dev/null || true)"
  if [[ "$health_code" != "$endpoint_expect" ]]; then
    stop "post-restore health check failed for $SERVICE (expected ${endpoint_expect}, got ${health_code:-none})"
  fi
  echo "health_check: PASS (${SERVICE} http=${health_code})"
else
  echo "health_check: SKIP (no services.health endpoint for ${SERVICE})"
fi

echo "OK: restore completed for ${SERVICE} on ${VM}"
