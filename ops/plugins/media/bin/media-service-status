#!/usr/bin/env bash
# media.service.status — Get container status for media services
#
# Usage:
#   ./bin/ops cap run media.service.status
#   ./bin/ops cap run media.service.status --vm download-stack
#   ./bin/ops cap run media.service.status --service radarr
#   ./bin/ops cap run media.service.status --json
#
# Contract:
# - Queries docker ps on media VMs
# - Maps container names to service names from media.services.yaml
# - Reports status: running|exited|missing

set -euo pipefail

ROOT="$(cd "$(dirname "$0")/../../../.." && pwd)"
SERVICE_BINDING="$ROOT/ops/bindings/media.services.yaml"
VM_BINDING="$ROOT/ops/bindings/vm.lifecycle.yaml"
SCHEMA_VERSION="1.0.0"
GENERATED_AT="$(date -u +%Y-%m-%dT%H:%M:%SZ)"

usage() {
  cat <<'USAGE'
media.service.status — Get container status for media services

Args:
  --vm HOST         Check only this VM (download-stack|streaming-stack)
  --service NAME    Check only this service
  --json            Output JSON format

Examples:
  ./bin/ops cap run media.service.status --vm download-stack
  ./bin/ops cap run media.service.status --service radarr --json
USAGE
}

VM_FILTER=""
SERVICE_FILTER=""
OUTPUT_JSON=false

while [[ $# -gt 0 ]]; do
  case "$1" in
    --vm)
      VM_FILTER="${2:-}"; shift 2 ;;
    --service)
      SERVICE_FILTER="${2:-}"; shift 2 ;;
    --json)
      OUTPUT_JSON=true; shift ;;
    -h|--help)
      usage; exit 0 ;;
    *)
      echo "FAIL: unknown arg: $1" >&2; usage >&2; exit 1 ;;
  esac
done

command -v yq >/dev/null 2>&1 || { echo "MISSING_DEP: yq" >&2; exit 2; }
command -v ssh >/dev/null 2>&1 || { echo "MISSING_DEP: ssh" >&2; exit 2; }
if $OUTPUT_JSON; then
  command -v jq >/dev/null 2>&1 || { echo "MISSING_DEP: jq" >&2; exit 2; }
fi

MEDIA_VMS=("download-stack" "streaming-stack")

get_vm_ssh_ref() {
  local vm="$1"
  local target user

  target=$(yq -r ".vms[] | select(.hostname == \"$vm\") | .ssh_target // .hostname // \"\"" "$VM_BINDING" 2>/dev/null || echo "")
  user=$(yq -r ".vms[] | select(.hostname == \"$vm\") | .ssh_user // \"\"" "$VM_BINDING" 2>/dev/null || echo "")

  if [[ -z "$target" || "$target" == "null" ]]; then
    echo ""
    return 1
  fi

  if [[ -n "$user" && "$user" != "null" ]]; then
    echo "${user}@${target}"
  else
    echo "$target"
  fi
}

get_vm_containers() {
  local vm="$1"
  local ssh_ref
  local docker_cmd
  local out
  ssh_ref=$(get_vm_ssh_ref "$vm" 2>/dev/null || true)
  [[ -z "$ssh_ref" ]] && return 0

  docker_cmd="docker ps -a --format '{{.Names}}\t{{.Status}}'"
  out=$(ssh -o BatchMode=yes -o ConnectTimeout=10 "$ssh_ref" "$docker_cmd" 2>&1 || true)
  if echo "$out" | grep -qi "permission denied while trying to connect to the docker api"; then
    out=$(ssh -o BatchMode=yes -o ConnectTimeout=10 "$ssh_ref" "sudo -n $docker_cmd" 2>&1 || true)
  fi

  # If sudo fallback also fails, return empty list and let caller report missing containers.
  if echo "$out" | grep -qi "^sudo: "; then
    echo ""
    return 0
  fi

  printf '%s\n' "$out"
}

get_service_container() {
  local service="$1"
  yq -r ".services[\"$service\"].container // \"$service\"" "$SERVICE_BINDING" 2>/dev/null || echo "$service"
}

get_service_vm() {
  local service="$1"
  yq -r ".services[\"$service\"].vm // \"\"" "$SERVICE_BINDING" 2>/dev/null || echo ""
}

parse_status() {
  local container_status="$1"
  if [[ "$container_status" =~ ^Up ]]; then
    echo "running"
  elif [[ "$container_status" =~ ^Exited ]]; then
    echo "exited"
  elif [[ "$container_status" =~ ^Created ]]; then
    echo "created"
  else
    echo "unknown"
  fi
}

declare -A ALL_RESULTS

for vm in "${MEDIA_VMS[@]}"; do
  if [[ -n "$VM_FILTER" && "$vm" != "$VM_FILTER" ]]; then
    continue
  fi

  # Get all containers on this VM
  declare -A VM_CONTAINERS
  while IFS=$'\t' read -r name status; do
    [[ -z "$name" ]] && continue
    VM_CONTAINERS["$name"]="$status"
  done < <(get_vm_containers "$vm")

  # Get services for this VM
  services=$(yq -r ".services | to_entries[] | select(.value.vm == \"$vm\") | .key" "$SERVICE_BINDING" 2>/dev/null)

  for service in $services; do
    if [[ -n "$SERVICE_FILTER" && "$service" != "$SERVICE_FILTER" ]]; then
      continue
    fi

    container=$(get_service_container "$service")

    if [[ -n "${VM_CONTAINERS[$container]:-}" ]]; then
      status=$(parse_status "${VM_CONTAINERS[$container]}")
      ALL_RESULTS["$service"]="$vm:$status:${VM_CONTAINERS[$container]}"
    else
      ALL_RESULTS["$service"]="$vm:missing:container-not-found"
    fi
  done

  unset VM_CONTAINERS
done

# Output
if $OUTPUT_JSON; then
  services_json="$(
    for service in $(printf '%s\n' "${!ALL_RESULTS[@]}" | sort); do
      IFS=':' read -r vm status detail <<< "${ALL_RESULTS[$service]}"
      printf '%s\t%s\t%s\t%s\n' "$service" "$vm" "$status" "$detail"
    done | jq -R -s '
      split("\n")
      | map(select(length > 0))
      | map(split("\t") | {service: .[0], vm: .[1], status: .[2], detail: .[3]})
    '
  )"

  overall_status="ok"
  if jq -e 'any(.[]; .status != "running")' >/dev/null 2>&1 <<<"$services_json"; then
    overall_status="warn"
  fi

  jq -n \
    --arg capability "media.service.status" \
    --arg schema_version "$SCHEMA_VERSION" \
    --arg generated_at "$GENERATED_AT" \
    --arg status "$overall_status" \
    --arg vm_filter "$VM_FILTER" \
    --arg service_filter "$SERVICE_FILTER" \
    --argjson services "$services_json" \
    '{
      capability: $capability,
      schema_version: $schema_version,
      generated_at: $generated_at,
      status: $status,
      data: {
        vm_filter: (if $vm_filter == "" then null else $vm_filter end),
        service_filter: (if $service_filter == "" then null else $service_filter end),
        counts: {
          total: ($services | length),
          running: ($services | map(select(.status == "running")) | length),
          exited: ($services | map(select(.status == "exited")) | length),
          missing: ($services | map(select(.status == "missing")) | length),
          created: ($services | map(select(.status == "created")) | length),
          unknown: ($services | map(select(.status == "unknown")) | length)
        },
        services: $services
      }
    }'
else
  echo "media.service.status"
  echo "===================="
  printf "%-25s %-20s %-12s %s\n" "SERVICE" "VM" "STATUS" "DETAIL"
  printf "%-25s %-20s %-12s %s\n" "-------" "--" "------" "------"

  # Sort by VM then service
  for vm in "${MEDIA_VMS[@]}"; do
    for service in $(echo "${!ALL_RESULTS[@]}" | tr ' ' '\n' | sort); do
      result="${ALL_RESULTS[$service]}"
      if [[ "$result" == "$vm:"* ]]; then
        IFS=':' read -r svm status detail <<< "$result"
        printf "%-25s %-20s %-12s %s\n" "$service" "$svm" "$status" "$detail"
      fi
    done
  done
fi
