#!/usr/bin/env bash
# media.slskd.status — slskd (Soulseek) runtime status
#
# Usage:
#   ./bin/ops cap run media.slskd.status
#   ./bin/ops cap run media.slskd.status --json
#
# Contract:
# - SSHs to download-stack to query slskd container status and API
# - slskd runs behind gluetun (network_mode: service:gluetun)
# - API port 5030 is exposed via gluetun
# - Exit 0 if connected, exit 1 if issues, exit 2 on config error

set -euo pipefail

ROOT="$(cd "$(dirname "$0")/../../../.." && pwd)"
SSH_TARGETS="$ROOT/ops/bindings/ssh.targets.yaml"
GENERATED_AT="$(date -u +%Y-%m-%dT%H:%M:%SZ)"

usage() {
  cat <<'USAGE'
media.slskd.status — slskd (Soulseek) runtime telemetry

Args:
  --json      Output JSON format
  --timeout   SSH/HTTP timeout in seconds (default: 10)

Examples:
  ./bin/ops cap run media.slskd.status
  ./bin/ops cap run media.slskd.status --json
USAGE
}

OUTPUT_JSON=false
TIMEOUT_SEC=10

while [[ $# -gt 0 ]]; do
  case "$1" in
    --json)     OUTPUT_JSON=true; shift ;;
    --timeout)  TIMEOUT_SEC="${2:-10}"; shift 2 ;;
    -h|--help)  usage; exit 0 ;;
    --)         shift ;;
    *)          echo "FAIL: unknown arg: $1" >&2; usage >&2; exit 1 ;;
  esac
done

command -v yq >/dev/null 2>&1 || { echo "MISSING_DEP: yq" >&2; exit 2; }
command -v ssh >/dev/null 2>&1 || { echo "MISSING_DEP: ssh" >&2; exit 2; }

if [[ ! -f "$SSH_TARGETS" ]]; then
  echo "STOP: ssh targets not found: $SSH_TARGETS" >&2
  exit 2
fi

SSH_HOST=$(yq -r '.ssh.targets[] | select(.id == "download-stack") | .host // ""' "$SSH_TARGETS" 2>/dev/null || true)
SSH_USER=$(yq -r '.ssh.targets[] | select(.id == "download-stack") | .user // "ubuntu"' "$SSH_TARGETS" 2>/dev/null || true)

if [[ -z "$SSH_HOST" ]]; then
  echo "STOP: download-stack SSH target not found" >&2
  exit 2
fi

SSH_OPTS="-o ConnectTimeout=$TIMEOUT_SEC -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o BatchMode=yes -o LogLevel=ERROR"

ssh_cmd() {
  ssh $SSH_OPTS "${SSH_USER}@${SSH_HOST}" "$@" 2>/dev/null
}

# Check 1: Container status
CONTAINER_STATE=$(ssh_cmd "sudo docker inspect --format='{{.State.Status}}' slskd 2>/dev/null" || echo "not_found")

# Check 2: Container uptime
STARTED_AT=$(ssh_cmd "sudo docker inspect --format='{{.State.StartedAt}}' slskd 2>/dev/null" || echo "unknown")

# Check 3: slskd application state from API (authoritative connection telemetry)
SLSKD_URL="http://localhost:5030"
# slskd often enables API-key auth; read key from in-container config first.
SLSKD_CONFIG=$(ssh_cmd "sudo docker exec slskd sh -lc 'cat /app/slskd.yml' 2>/dev/null" || echo "")
SLSKD_API_KEY=$(printf '%s\n' "$SLSKD_CONFIG" | awk '/^[[:space:]]*key:[[:space:]]*/ {print $2; exit}' || true)

if [[ -n "$SLSKD_API_KEY" ]]; then
  APP_JSON=$(ssh_cmd "curl -fsS --max-time 5 -H 'X-API-Key: ${SLSKD_API_KEY}' ${SLSKD_URL}/api/v0/application 2>/dev/null" || echo "")
else
  APP_JSON=$(ssh_cmd "curl -fsS --max-time 5 ${SLSKD_URL}/api/v0/application 2>/dev/null" || echo "")
fi

# Fallback for unauthenticated deployments or stale config.
if [[ -z "$APP_JSON" ]]; then
  APP_JSON=$(ssh_cmd "curl -fsS --max-time 5 ${SLSKD_URL}/api/v0/application 2>/dev/null" || echo "")
fi

API_REACHABLE="false"
IS_CONNECTED="false"
IS_LOGGED_IN="false"
SOULSEEK_STATE="unknown"
SOULSEEK_SERVER="unknown"
SOULSEEK_CONNECTED="false"

if [[ -n "$APP_JSON" ]]; then
  API_REACHABLE="true"
  PARSED_FIELDS=$(APP_JSON="$APP_JSON" python3 - <<'PY' 2>/dev/null || true
import json
import os
import sys

raw = os.environ.get("APP_JSON", "").strip()
is_connected = "false"
is_logged_in = "false"
state = "unknown"
server = "unknown"

if raw:
    try:
        data = json.loads(raw)
        server_obj = data.get("server") if isinstance(data.get("server"), dict) else {}
        is_connected = "true" if bool(data.get("isConnected", server_obj.get("isConnected", False))) else "false"
        is_logged_in = "true" if bool(data.get("isLoggedIn", server_obj.get("isLoggedIn", False))) else "false"

        api_state = data.get("state") or server_obj.get("state")
        if isinstance(api_state, str) and api_state.strip():
            state = api_state.strip()

        server_raw = (
            data.get("serverAddress")
            or data.get("serverHost")
            or data.get("server")
            or server_obj.get("ipEndPoint")
            or server_obj.get("address")
        )
        if isinstance(server_raw, dict):
            host = server_raw.get("host") or server_raw.get("hostname")
            port = server_raw.get("port")
            if host and port:
                server = f"{host}:{port}"
            elif host:
                server = str(host)
        elif server_raw:
            server = str(server_raw)
    except Exception:
        pass

print(f"is_connected={is_connected}")
print(f"is_logged_in={is_logged_in}")
print(f"state={state}")
print(f"server={server}")
PY
)

  while IFS='=' read -r key value; do
    case "$key" in
      is_connected) IS_CONNECTED="$value" ;;
      is_logged_in) IS_LOGGED_IN="$value" ;;
      state) SOULSEEK_STATE="$value" ;;
      server) SOULSEEK_SERVER="$value" ;;
    esac
  done <<< "$PARSED_FIELDS"
fi

# Check 4: Transfer stats from Docker stats
TRANSFER_LINE=$(ssh_cmd "sudo docker stats --no-stream --format '{{.NetIO}}' slskd 2>/dev/null" || echo "unknown")

# Check 5: Detect recent SQLite lock failures in logs (common NFS symptom)
RECENT_LOGS=$(ssh_cmd "sudo docker logs slskd --tail 200 2>&1" || echo "")
DB_LOCK_ERRORS=$(printf '%s' "$RECENT_LOGS" | grep -ci "database is locked" || true)

# Canonical Soulseek connectivity signal: API booleans/state
if [[ "$IS_CONNECTED" == "true" && "$IS_LOGGED_IN" == "true" ]]; then
  SOULSEEK_CONNECTED="true"
elif echo "$SOULSEEK_STATE" | grep -qi "connected"; then
  SOULSEEK_CONNECTED="true"
fi

# Determine status
STATUS="ok"
ISSUES=()

if [[ "$CONTAINER_STATE" != "running" ]]; then
  STATUS="fail"
  ISSUES+=("slskd container not running (state=$CONTAINER_STATE)")
fi

if [[ "$API_REACHABLE" != "true" ]]; then
  STATUS="fail"
  ISSUES+=("slskd API unreachable at $SLSKD_URL")
fi

if [[ "$API_REACHABLE" == "true" && "$SOULSEEK_CONNECTED" != "true" ]]; then
  STATUS="fail"
  ISSUES+=("Soulseek connection not established (state=$SOULSEEK_STATE, isConnected=$IS_CONNECTED, isLoggedIn=$IS_LOGGED_IN)")
fi

if [[ "$DB_LOCK_ERRORS" -gt 0 ]]; then
  if [[ "$STATUS" != "fail" ]]; then
    STATUS="warn"
  fi
  ISSUES+=("SQLite lock errors in recent logs ($DB_LOCK_ERRORS); slskd DB storage may be lock-unsafe")
fi

if $OUTPUT_JSON; then
  command -v jq >/dev/null 2>&1 || { echo "MISSING_DEP: jq" >&2; exit 2; }
  ISSUES_JSON=$(printf '%s\n' "${ISSUES[@]+"${ISSUES[@]}"}" | jq -R -s 'split("\n") | map(select(length > 0))')
  jq -n \
    --arg capability "media.slskd.status" \
    --arg generated_at "$GENERATED_AT" \
    --arg status "$STATUS" \
    --arg container_state "$CONTAINER_STATE" \
    --arg started_at "$STARTED_AT" \
    --arg soulseek_connected "$SOULSEEK_CONNECTED" \
    --arg is_connected "$IS_CONNECTED" \
    --arg is_logged_in "$IS_LOGGED_IN" \
    --arg soulseek_state "$SOULSEEK_STATE" \
    --arg soulseek_server "$SOULSEEK_SERVER" \
    --arg api_reachable "$API_REACHABLE" \
    --argjson db_lock_errors "$DB_LOCK_ERRORS" \
    --arg net_io "$TRANSFER_LINE" \
    --argjson issues "$ISSUES_JSON" \
    '{
      capability: $capability,
      generated_at: $generated_at,
      status: $status,
      data: {
        container_state: $container_state,
        started_at: $started_at,
        soulseek_connected: ($soulseek_connected == "true"),
        is_connected: ($is_connected == "true"),
        is_logged_in: ($is_logged_in == "true"),
        soulseek_state: $soulseek_state,
        soulseek_server: $soulseek_server,
        api_reachable: ($api_reachable == "true"),
        db_lock_errors: $db_lock_errors,
        net_io: $net_io,
        issues: $issues
      }
    }'
else
  echo "media.slskd.status"
  echo "==================="
  echo "status: $STATUS"
  echo "container_state: $CONTAINER_STATE"
  echo "started_at: $STARTED_AT"
  echo "soulseek_connected: $SOULSEEK_CONNECTED"
  echo "is_connected: $IS_CONNECTED"
  echo "is_logged_in: $IS_LOGGED_IN"
  echo "soulseek_state: $SOULSEEK_STATE"
  echo "soulseek_server: $SOULSEEK_SERVER"
  echo "api_reachable: $API_REACHABLE"
  echo "db_lock_errors: $DB_LOCK_ERRORS"
  echo "net_io: $TRANSFER_LINE"
  echo "generated_at: $GENERATED_AT"
  if [[ ${#ISSUES[@]} -gt 0 ]]; then
    echo "issues:"
    for i in "${ISSUES[@]}"; do
      echo "  - $i"
    done
  fi
fi

if [[ "$STATUS" == "fail" ]]; then
  exit 1
fi
exit 0
