#!/usr/bin/env bash
# Build projected view of internet.asset.registry from canonical sources.
# Emits ops/bindings/internet.asset.registry.projected.yaml with freshness metadata.
set -euo pipefail

ROOT="${SPINE_ROOT:-$HOME/code/agentic-spine}"
AUTHORITY="$ROOT/ops/bindings/internet.asset.registry.yaml"
PROJECTION="$ROOT/ops/bindings/internet.asset.registry.projected.yaml"
HW_INV="$ROOT/ops/bindings/hardware.inventory.yaml"
VM_LIFE="$ROOT/ops/bindings/vm.lifecycle.yaml"
HOME_DEV="$ROOT/ops/bindings/home.device.registry.yaml"
NET_SNAP="$ROOT/ops/bindings/network.inventory.snapshot.yaml"
PARTS_INV="$ROOT/ops/bindings/hardware.parts.inventory.yaml"

while [[ $# -gt 0 ]]; do
  case "$1" in
    --) shift ;;
    -h|--help) echo "Usage: internet-asset-registry-build"; exit 0 ;;
    *) echo "internet.asset.registry.build FAIL: unknown arg: $1" >&2; exit 2 ;;
  esac
done

command -v yq >/dev/null 2>&1 || { echo "internet.asset.registry.build FAIL: yq missing" >&2; exit 1; }
command -v python3 >/dev/null 2>&1 || { echo "internet.asset.registry.build FAIL: python3 missing" >&2; exit 1; }
[[ -f "$AUTHORITY" ]] || { echo "internet.asset.registry.build FAIL: missing authority $AUTHORITY" >&2; exit 1; }

# Collect source freshness
hw_updated="$(yq -r '.updated_at // "unknown"' "$HW_INV" 2>/dev/null || echo "missing")"
vm_updated="$(yq -r '.updated // "unknown"' "$VM_LIFE" 2>/dev/null || echo "missing")"
home_updated="n/a"
net_updated="$(yq -r '.updated_at // "unknown"' "$NET_SNAP" 2>/dev/null || echo "missing")"
parts_updated="$(yq -r '.updated_at // "unknown"' "$PARTS_INV" 2>/dev/null || echo "missing")"
authority_updated="$(yq -r '.updated_at // "unknown"' "$AUTHORITY")"

# Count assets from authority
asset_count="$(yq -r '.assets | length' "$AUTHORITY")"
site_count="$(yq -r '.sites | length' "$AUTHORITY")"

NOW_UTC="$(python3 -c "from datetime import datetime,timezone; print(datetime.now(timezone.utc).strftime('%Y-%m-%dT%H:%M:%SZ'))")"
NOW_ET="$(TZ='America/New_York' date '+%Y-%m-%dT%H:%M:%S%z' 2>/dev/null || echo "$NOW_UTC")"

# Build projection
cat > "$PROJECTION" <<YAML
# Internet Asset Registry — Projected View
# projection_of: ops/bindings/internet.asset.registry.yaml
# Auto-generated by internet.asset.registry.build capability.
# Do NOT edit manually — rebuild with: ./bin/ops cap run internet.asset.registry.build

projection_of: ops/bindings/internet.asset.registry.yaml
status: generated
authority_state: projection
generated_at_utc: "$NOW_UTC"
generated_at_et: "$NOW_ET"
timezone: "America/New_York"

source_freshness:
  authority: "$authority_updated"
  hardware_inventory: "$hw_updated"
  vm_lifecycle: "$vm_updated"
  home_device_registry: "$home_updated"
  network_inventory_snapshot: "$net_updated"
  hardware_parts_inventory: "$parts_updated"

summary:
  total_assets: $asset_count
  sites: $site_count
YAML

# Append per-site asset counts
for site in home shop; do
  count="$(yq -r "[.assets[] | select(.site == \"$site\")] | length" "$AUTHORITY")"
  echo "  ${site}_assets: $count" >> "$PROJECTION"
done

# Append lifecycle breakdown
echo "  lifecycle_breakdown:" >> "$PROJECTION"
for state in active planned decommissioned tombstoned extra; do
  count="$(yq -r "[.assets[] | select(.lifecycle_state == \"$state\")] | length" "$AUTHORITY")"
  echo "    $state: $count" >> "$PROJECTION"
done

# Append provenance breakdown
echo "  provenance_breakdown:" >> "$PROJECTION"
for level in machine_verified receipt_verified user_confirmed candidate_unverified; do
  count="$(yq -r "[.assets[] | select(.provenance == \"$level\")] | length" "$AUTHORITY")"
  echo "    $level: $count" >> "$PROJECTION"
done

# Append domain breakdown
echo "  domain_breakdown:" >> "$PROJECTION"
for domain in compute storage networking power cabling rack hardware; do
  count="$(yq -r "[.assets[] | select(.domain == \"$domain\")] | length" "$AUTHORITY")"
  [[ "$count" -gt 0 ]] && echo "    $domain: $count" >> "$PROJECTION"
done

# Append flat asset index for lookup
echo "" >> "$PROJECTION"
echo "asset_index:" >> "$PROJECTION"
yq -r '.assets[] | "  - asset_id: " + .asset_id + "\n    site: " + .site + "\n    class: " + .class + "\n    lifecycle_state: " + .lifecycle_state + "\n    provenance: " + .provenance' "$AUTHORITY" >> "$PROJECTION"

echo "internet.asset.registry.build PASS: projected $asset_count assets to $PROJECTION (generated $NOW_UTC)"
