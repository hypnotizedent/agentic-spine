#!/usr/bin/env bash
# secrets-namespace-status - verify Infisical namespace hygiene for spine VM infra keys
set -euo pipefail

SPINE_REPO="${SPINE_REPO:-$HOME/code/agentic-spine}"
BINDING="$SPINE_REPO/ops/bindings/secrets.binding.yaml"
CREDENTIALS_FILE="${HOME}/.config/infisical/credentials"

for dep in yq jq curl; do
  command -v "$dep" >/dev/null 2>&1 || { echo "MISSING_DEP: $dep"; exit 1; }
done

[[ -f "$BINDING" ]] || { echo "MISSING: $BINDING"; exit 2; }

# Always source canonical credentials first so rotated values win over stale
# exported shell variables.
if [[ -f "$CREDENTIALS_FILE" ]]; then
  # shellcheck disable=SC1090
  source "$CREDENTIALS_FILE"
fi

API_URL="$(yq e -r '.infisical.api_url // ""' "$BINDING")"
PROJECT_ID="$(yq e -r '.infisical.project // ""' "$BINDING")"
ENV_NAME="$(yq e -r '.infisical.environment // ""' "$BINDING")"
BASE_PATH="$(yq e -r '.infisical.base_path // ""' "$BINDING")"
CLIENT_ID="${INFISICAL_UNIVERSAL_AUTH_CLIENT_ID:-}"
CLIENT_SECRET="${INFISICAL_UNIVERSAL_AUTH_CLIENT_SECRET:-}"

[[ -n "$API_URL" && -n "$PROJECT_ID" && -n "$ENV_NAME" && -n "$BASE_PATH" ]] || {
  echo "STOP: incomplete secrets binding"; exit 2;
}
[[ -n "$CLIENT_ID" && -n "$CLIENT_SECRET" ]] || {
  echo "STOP: missing Infisical auth variables"; exit 2;
}

TOKEN="$(curl -fsS -X POST "$API_URL/api/v1/auth/universal-auth/login" \
  -H 'Content-Type: application/json' \
  -d "{\"clientId\":\"$CLIENT_ID\",\"clientSecret\":\"$CLIENT_SECRET\"}" \
  | jq -r '.accessToken // empty')"

[[ -n "$TOKEN" ]] || { echo "FAIL: auth token unavailable"; exit 1; }

RAW_JSON="$(curl -fsS "$API_URL/api/v3/secrets/raw?workspaceId=$PROJECT_ID&environment=$ENV_NAME&recursive=true" \
  -H "Authorization: Bearer $TOKEN")"

TOTAL="$(echo "$RAW_JSON" | jq -r '.secrets | length')"
ROOT_COUNT="$(echo "$RAW_JSON" | jq -r '[.secrets[] | select((.secretPath // "/") == "/")] | length')"

echo "secrets.namespace.status"
echo "project_id: $PROJECT_ID"
echo "environment: $ENV_NAME"
echo "base_path: $BASE_PATH"
echo "total_keys: $TOTAL"
echo "root_path_keys: $ROOT_COUNT"
echo

echo "path_distribution:"
echo "$RAW_JSON" | jq -r '.secrets[] | (.secretPath // "/")' | sort | uniq -c | sort -nr | awk '{print "  - path: "$2" count: "$1}'

echo
VM_INFRA_PATH="/spine/vm-infra/caddy-auth"
REQUIRED_KEYS=(AUTHENTIK_SECRET_KEY AUTHENTIK_DB_PASSWORD)
FAILURES=0

for key in "${REQUIRED_KEYS[@]}"; do
  mapfile -t matches < <(echo "$RAW_JSON" | jq -r --arg k "$key" '.secrets[] | select(.secretKey == $k) | (.secretPath // "/")')
  if (( ${#matches[@]} == 0 )); then
    echo "FAIL: missing required key: $key"
    FAILURES=$((FAILURES + 1))
    continue
  fi

  correct=0
  for p in "${matches[@]}"; do
    [[ "$p" == "$VM_INFRA_PATH" ]] && correct=1
    [[ "$p" == "/" ]] && echo "FAIL: $key present at root path '/' (legacy collision risk)"
  done

  if (( correct == 0 )); then
    echo "FAIL: $key not found at required path: $VM_INFRA_PATH"
    FAILURES=$((FAILURES + 1))
  else
    echo "PASS: $key is namespaced at $VM_INFRA_PATH"
  fi
done

echo
if (( FAILURES > 0 )); then
  echo "status: FAIL"
  exit 1
fi

if (( ROOT_COUNT > 0 )); then
  echo "status: OK_WITH_LEGACY_DEBT"
  echo "note: root-path keys exist; keep new VM-infra keys under /spine/* only"
  exit 0
fi

echo "status: OK"
exit 0
