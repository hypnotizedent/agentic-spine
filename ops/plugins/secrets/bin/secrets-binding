#!/usr/bin/env bash
# secrets.binding â€” prints non-secret secrets provider binding (SSOT)
set -euo pipefail

SPINE_REPO="${SPINE_REPO:-$HOME/code/agentic-spine}"
BIND="$SPINE_REPO/ops/bindings/secrets.binding.yaml"

echo "=== secrets.binding ==="
echo "SPINE_REPO: $SPINE_REPO"
echo "BINDING:    $BIND"
echo

command -v yq >/dev/null 2>&1 || { echo "MISSING_DEP: yq"; exit 1; }
[[ -f "$BIND" ]] || { echo "MISSING: secrets.binding.yaml"; exit 2; }

prov="$(yq e '.provider' "$BIND")"
api="$(yq e '.infisical.api_url' "$BIND")"
internal_api="$(yq e '.infisical.internal_api_url // ""' "$BIND")"
proj="$(yq e '.infisical.project' "$BIND")"
env="$(yq e '.infisical.environment' "$BIND")"
base="$(yq e '.infisical.base_path' "$BIND")"

echo "provider:     $prov"
echo "api_url:      ${api:-<unset>}"
echo "internal_api: ${internal_api:-<unset>}"
echo "project:      ${proj:-<unset>}"
echo "environment:  ${env:-<unset>}"
echo "base_path:    ${base:-<unset>}"
echo

# validate required non-secret fields
missing=0
[[ -n "${api:-}" && "$api" != "null" ]] || { echo "MISSING_FIELD: infisical.api_url"; missing=1; }
[[ -n "${proj:-}" && "$proj" != "null" ]] || { echo "MISSING_FIELD: infisical.project"; missing=1; }
[[ -n "${env:-}" && "$env" != "null" ]] || { echo "MISSING_FIELD: infisical.environment"; missing=1; }
[[ -n "${base:-}" && "$base" != "null" ]] || { echo "MISSING_FIELD: infisical.base_path"; missing=1; }

echo
if [[ "$missing" -ne 0 ]]; then
  echo "STATUS: STOP (binding incomplete)"
  exit 2
fi

echo "STATUS: OK (binding complete)"
exit 0
