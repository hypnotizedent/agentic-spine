#!/usr/bin/env bash
set -euo pipefail
umask 077

CREDS="${INFISICAL_CREDS_FILE:-$HOME/.config/infisical/credentials}"

# STOP semantics: 2 = operator action required
stop() {
  echo "STOP: $*" >&2
  exit 2
}

# 1) exists
[[ -f "$CREDS" ]] || stop "missing creds file: $CREDS"

# 2) perms 600 (macOS + linux)
perm=""
if stat -f '%Lp' "$CREDS" >/dev/null 2>&1; then
  perm="$(stat -f '%Lp' "$CREDS")"
elif stat -c '%a' "$CREDS" >/dev/null 2>&1; then
  perm="$(stat -c '%a' "$CREDS")"
else
  stop "cannot stat perms for creds file: $CREDS"
fi
[[ "$perm" == "600" ]] || stop "creds perms are $perm, expected 600 (fix: chmod 600 \"$CREDS\")"

# 3) shape check (no values printed)
# Require the expected export lines exist (names only)
if ! rg -q "INFISICAL_UNIVERSAL_AUTH_CLIENT_ID" "$CREDS"; then
  stop "creds file missing INFISICAL_UNIVERSAL_AUTH_CLIENT_ID export line"
fi
if ! rg -q "INFISICAL_UNIVERSAL_AUTH_CLIENT_SECRET" "$CREDS"; then
  stop "creds file missing INFISICAL_UNIVERSAL_AUTH_CLIENT_SECRET export line"
fi

echo "OK: creds file present + perm 600 + expected exports (no values printed)"
echo
echo "To load into THIS shell session, run:"
echo "  source \"$CREDS\""
echo
echo "Then prove auth:"
echo "  cd \"$PWD\" && ./bin/ops cap run secrets.auth.status"
