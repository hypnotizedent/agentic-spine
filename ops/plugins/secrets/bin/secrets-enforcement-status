#!/usr/bin/env bash
# secrets-enforcement-status - strict governance contract status for secrets routing.
set -euo pipefail

SPINE_REPO="${SPINE_REPO:-$HOME/code/agentic-spine}"
CONTRACT="$SPINE_REPO/ops/bindings/secrets.enforcement.contract.yaml"
POLICY="$SPINE_REPO/ops/bindings/secrets.namespace.policy.yaml"

command -v yq >/dev/null 2>&1 || { echo "MISSING_DEP: yq"; exit 1; }
[[ -f "$CONTRACT" ]] || { echo "FAIL: missing $CONTRACT"; exit 1; }
[[ -f "$POLICY" ]] || { echo "FAIL: missing $POLICY"; exit 1; }

yq e '.' "$CONTRACT" >/dev/null 2>&1 || { echo "FAIL: invalid YAML in $CONTRACT"; exit 1; }
yq e '.' "$POLICY" >/dev/null 2>&1 || { echo "FAIL: invalid YAML in $POLICY"; exit 1; }

mode="$(yq e -r '.mode // ""' "$CONTRACT")"
root_allowed="$(yq e -r '.enforcement.root_path_allowed' "$CONTRACT" 2>/dev/null || echo true)"
unknown_allowed="$(yq e -r '.enforcement.unknown_infrastructure_keys_allowed' "$CONTRACT" 2>/dev/null || echo true)"
inferred_allowed="$(yq e -r '.enforcement.inferred_routes_allowed' "$CONTRACT" 2>/dev/null || echo true)"
ambiguous_allowed="$(yq e -r '.enforcement.ambiguous_routes_allowed' "$CONTRACT" 2>/dev/null || echo true)"
aliases_allowed="$(yq e -r '.enforcement.deprecated_alias_writes_allowed' "$CONTRACT" 2>/dev/null || echo true)"
root_mode="$(yq e -r '.freeze.mode // "legacy_freeze"' "$POLICY")"
alias_count="$(yq e -r '.deprecated_aliases | length' "$CONTRACT" 2>/dev/null || echo 0)"

for var_name in root_allowed unknown_allowed inferred_allowed ambiguous_allowed aliases_allowed; do
  case "${!var_name}" in
    true|false) ;;
    *) printf -v "$var_name" "%s" "true" ;;
  esac
done

echo "secrets.enforcement.status"
echo "contract: $CONTRACT"
echo "mode: $mode"
echo "policy_root_mode: $root_mode"
echo "root_path_allowed: $root_allowed"
echo "unknown_infrastructure_keys_allowed: $unknown_allowed"
echo "inferred_routes_allowed: $inferred_allowed"
echo "ambiguous_routes_allowed: $ambiguous_allowed"
echo "deprecated_alias_writes_allowed: $aliases_allowed"
echo "deprecated_alias_count: $alias_count"

if [[ "$mode" != "strict" ]]; then
  echo "status: FAIL"
  echo "reason: contract mode must be strict"
  exit 1
fi
if [[ "$root_mode" != "hard_zero" ]]; then
  echo "status: FAIL"
  echo "reason: namespace policy freeze.mode must be hard_zero"
  exit 1
fi
if [[ "$root_allowed" == "true" || "$unknown_allowed" == "true" || "$inferred_allowed" == "true" || "$ambiguous_allowed" == "true" || "$aliases_allowed" == "true" ]]; then
  echo "status: FAIL"
  echo "reason: one or more enforcement toggles are permissive"
  exit 1
fi

echo "status: OK"
