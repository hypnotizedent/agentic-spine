#!/usr/bin/env bash
set -euo pipefail

# secrets.identity.rbac.lock — Downgrade identity roles on deprecated projects
#
# Contract:
# - MUTATING: changes identity roles in Infisical (admin → viewer)
# - Requires secrets.binding + secrets.auth.status
# - Targets only projects with lifecycle: deprecated|delete_candidate|overlaps
# - Uses Infisical API v2 to update identity membership roles
# - No secret values in output
# - Dry-run by default; pass --execute to mutate
#
# Usage:
#   ./bin/ops cap run secrets.identity.rbac.lock          # dry-run
#   ./bin/ops cap run secrets.identity.rbac.lock --execute # mutate

SPINE_REPO="${SPINE_REPO:-$HOME/code/agentic-spine}"
[[ -d "$SPINE_REPO" ]] || SPINE_REPO="$HOME/code/agentic-spine"

DRY_RUN=true
for arg in "$@"; do
  case "$arg" in
    --execute) DRY_RUN=false ;;
  esac
done

# Dependencies
command -v curl >/dev/null 2>&1 || { echo "MISSING_DEP: curl"; exit 1; }
command -v jq >/dev/null 2>&1 || { echo "MISSING_DEP: jq"; exit 1; }
command -v yq >/dev/null 2>&1 || { echo "MISSING_DEP: yq"; exit 1; }

# Binding
BINDING_FILE="$SPINE_REPO/ops/bindings/secrets.binding.yaml"
INVENTORY_FILE="$SPINE_REPO/ops/bindings/secrets.inventory.yaml"
[[ -f "$BINDING_FILE" ]] || { echo "FAIL: binding file missing"; exit 1; }
[[ -f "$INVENTORY_FILE" ]] || { echo "FAIL: inventory file missing"; exit 1; }

INF_API_URL="$(yq -r '.infisical.internal_api_url // .infisical.api_url // ""' "$BINDING_FILE")"
[[ -n "$INF_API_URL" && "$INF_API_URL" != "null" ]] || { echo "FAIL: binding missing api_url"; exit 1; }

# Auth via canonical agent
INFISICAL_AGENT="$SPINE_REPO/ops/tools/infisical-agent.sh"
[[ -x "$INFISICAL_AGENT" ]] || { echo "FAIL: infisical-agent.sh not found"; exit 1; }

TOKEN=$("$INFISICAL_AGENT" auth-token 2>/dev/null) || true
[[ -n "$TOKEN" ]] || { echo "FAIL: auth-token failed"; exit 1; }

# Extract identity ID from JWT payload via canonical agent
IDENTITY_ID="$("$INFISICAL_AGENT" jwt-decode "$TOKEN" 2>/dev/null | jq -r '.identityId // .sub // empty' 2>/dev/null || true)"

echo "=== secrets.identity.rbac.lock ==="
echo "mode: $(if $DRY_RUN; then echo 'dry-run'; else echo 'EXECUTE'; fi)"
echo "identity_id: ${IDENTITY_ID:-unknown}"
echo "target_role: viewer"
echo

[[ -n "$IDENTITY_ID" ]] || { echo "FAIL: cannot determine identity ID from token"; exit 1; }

# Target deprecated projects only
TARGET_ROLE="viewer"
success=0
failures=0
skipped=0

echo "actions:"

while IFS='|' read -r name pid lifecycle; do
  name="$(echo "$name" | xargs)"
  pid="$(echo "$pid" | xargs)"
  lifecycle="$(echo "$lifecycle" | xargs)"
  [[ -n "$name" && -n "$pid" ]] || continue

  # Only target deprecated lifecycle projects
  case "$lifecycle" in
    deprecated|delete_candidate|overlaps) ;;
    *) continue ;;
  esac

  # Get current role
  set +e
  resp="$(curl -s --max-time 10 -w '\n%{http_code}' -X GET \
    "${INF_API_URL}/api/v2/workspace/${pid}/identity-memberships" \
    -H "Authorization: Bearer $TOKEN" 2>/dev/null)"
  rc=$?
  set -e

  if [[ "$rc" -ne 0 || -z "$resp" ]]; then
    echo "  - project: $name"
    echo "    action: SKIP (unreachable)"
    echo
    skipped=$((skipped + 1))
    continue
  fi

  resp_code="$(echo "$resp" | tail -n1)"
  resp_body="$(echo "$resp" | sed '$d')"

  if [[ "$resp_code" != "200" ]]; then
    echo "  - project: $name"
    echo "    action: SKIP (HTTP $resp_code)"
    echo
    skipped=$((skipped + 1))
    continue
  fi

  current_role="$(echo "$resp_body" | jq -r --arg iid "$IDENTITY_ID" \
    '.identityMemberships[]? | select(.identity.id == $iid) | .roles[0].role // "none"' 2>/dev/null || true)"

  if [[ -z "$current_role" || "$current_role" == "none" ]]; then
    echo "  - project: $name"
    echo "    action: SKIP (no membership found)"
    echo
    skipped=$((skipped + 1))
    continue
  fi

  if [[ "$current_role" == "$TARGET_ROLE" ]]; then
    echo "  - project: $name"
    echo "    current_role: $current_role"
    echo "    action: SKIP (already $TARGET_ROLE)"
    echo
    skipped=$((skipped + 1))
    continue
  fi

  echo "  - project: $name"
  echo "    id: $pid"
  echo "    lifecycle: $lifecycle"
  echo "    current_role: $current_role"
  echo "    target_role: $TARGET_ROLE"

  if $DRY_RUN; then
    echo "    action: WOULD_CHANGE (dry-run)"
    echo
    continue
  fi

  # Execute the role change
  set +e
  patch_resp="$(curl -s --max-time 10 -w '\n%{http_code}' -X PATCH \
    "${INF_API_URL}/api/v2/workspace/${pid}/identity-memberships/${IDENTITY_ID}" \
    -H "Authorization: Bearer $TOKEN" \
    -H "Content-Type: application/json" \
    -d "{\"roles\":[{\"role\":\"$TARGET_ROLE\"}]}" 2>/dev/null)"
  patch_rc=$?
  set -e

  if [[ "$patch_rc" -ne 0 || -z "$patch_resp" ]]; then
    echo "    action: FAILED (unreachable)"
    echo
    failures=$((failures + 1))
    continue
  fi

  patch_code="$(echo "$patch_resp" | tail -n1)"

  if [[ "$patch_code" == "200" ]]; then
    echo "    action: CHANGED ($current_role → $TARGET_ROLE)"
    echo
    success=$((success + 1))
  else
    patch_body="$(echo "$patch_resp" | sed '$d')"
    error_msg="$(echo "$patch_body" | jq -r '.message // "unknown"' 2>/dev/null || echo "unknown")"
    echo "    action: FAILED (HTTP $patch_code: $error_msg)"
    echo
    failures=$((failures + 1))
  fi

done < <(yq -r '.projects[] | [.name, .id, .lifecycle] | join("|")' "$INVENTORY_FILE")

echo "summary:"
echo "  changed: $success"
echo "  skipped: $skipped"
echo "  failures: $failures"
echo

if [[ "$failures" -gt 0 ]]; then
  echo "status: DEGRADED"
  echo "reason: $failures role change(s) failed"
  exit 1
elif $DRY_RUN; then
  echo "status: DRY_RUN"
  echo "reason: pass --execute to apply changes"
else
  echo "status: OK"
  echo "reason: all deprecated project roles locked to $TARGET_ROLE"
fi
