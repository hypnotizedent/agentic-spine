#!/usr/bin/env bash
set -euo pipefail

# secrets.inventory.status - Local-only inventory read (no network, no secrets)
# Purpose: Report what the SSOT inventory says
# Reason codes: missing_file, invalid_schema, empty_projects, ok

SPINE_REPO="${SPINE_REPO:-$HOME/code/agentic-spine}"
INVENTORY="$SPINE_REPO/ops/bindings/secrets.inventory.yaml"

echo "secrets.inventory.status"
echo "binding: $INVENTORY"
echo

# Precondition: yq
command -v yq >/dev/null 2>&1 || { echo "STOP: missing dependency: yq" >&2; exit 2; }

# Check file exists
if [[ ! -f "$INVENTORY" ]]; then
  echo "status: STOP"
  echo "reason: missing_file"
  echo "fix: create ops/bindings/secrets.inventory.yaml from workbench SSOT"
  exit 2
fi

# Validate schema version
VERSION="$(yq -r '.version // "missing"' "$INVENTORY")"
if [[ "$VERSION" == "missing" || "$VERSION" == "null" ]]; then
  echo "status: STOP"
  echo "reason: invalid_schema"
  echo "fix: add 'version: 1' to secrets.inventory.yaml"
  exit 2
fi

# Count projects
PROJECT_COUNT="$(yq -r '.projects | length' "$INVENTORY")"
if [[ "$PROJECT_COUNT" -eq 0 ]]; then
  echo "status: STOP"
  echo "reason: empty_projects"
  echo "fix: add projects[] to secrets.inventory.yaml"
  exit 2
fi

# Extract metadata
SOURCE_REPO="$(yq -r '.source.repo // "unknown"' "$INVENTORY")"
SOURCE_PATH="$(yq -r '.source.path // "unknown"' "$INVENTORY")"
SOURCE_COMMIT="$(yq -r '.source.commit // "unknown"' "$INVENTORY" | cut -c1-8)"
LAST_SYNCED="$(yq -r '.source.last_synced // "unknown"' "$INVENTORY")"
INFISICAL_URL="$(yq -r '.infisical.api_url // "unset"' "$INVENTORY")"
INFISICAL_ENV="$(yq -r '.infisical.environment // "unset"' "$INVENTORY")"

# Count by lifecycle
ACTIVE_COUNT="$(yq -r '[.projects[] | select(.lifecycle == "active")] | length' "$INVENTORY")"
CLEAN_COUNT="$(yq -r '[.projects[] | select(.lifecycle == "clean")] | length' "$INVENTORY")"
ISSUE_COUNT="$(yq -r '[.projects[] | select(.lifecycle != "active" and .lifecycle != "clean")] | length' "$INVENTORY")"
KNOWN_ISSUES="$(yq -r '.known_issues | length' "$INVENTORY")"
CRITICAL_ISSUES="$(yq -r '[.known_issues[] | select(.severity == "critical")] | length' "$INVENTORY")"

echo "source:"
echo "  repo: $SOURCE_REPO"
echo "  path: $SOURCE_PATH"
echo "  commit: $SOURCE_COMMIT"
echo "  last_synced: $LAST_SYNCED"
echo
echo "infisical:"
echo "  api_url: $INFISICAL_URL"
echo "  environment: $INFISICAL_ENV"
echo
echo "projects:"
echo "  total: $PROJECT_COUNT"
echo "  active: $ACTIVE_COUNT"
echo "  clean: $CLEAN_COUNT"
echo "  needs_attention: $ISSUE_COUNT"
echo
echo "known_issues:"
echo "  total: $KNOWN_ISSUES"
echo "  critical: $CRITICAL_ISSUES"
echo

# List projects (names only, safe)
echo "project_names:"
yq -r '.projects[].name' "$INVENTORY" | while read -r name; do
  lifecycle="$(yq -r ".projects[] | select(.name == \"$name\") | .lifecycle" "$INVENTORY")"
  printf "  - %-20s (%s)\n" "$name" "$lifecycle"
done

echo
echo "status: OK"
echo "reason: ok"
exit 0
