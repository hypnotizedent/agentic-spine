#!/usr/bin/env bash
# secrets.set.interactive â€” safely set secrets without leaking values
#
# Prompts with read -s (no echo); prints only key name + OK/FAIL.
# Never prints secret values to stdout or receipts.
#
# Usage:
#   secrets-set-interactive [project] [env]
#   secrets-set-interactive infrastructure prod
#
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SPINE_ROOT="${SPINE_ROOT:-$(cd "$SCRIPT_DIR/../../../.." && pwd)}"
AGENT="$SPINE_ROOT/ops/tools/infisical-agent.sh"

[[ -f "$AGENT" ]] || { echo "STOP (2): missing infisical-agent.sh at $AGENT"; exit 2; }

PROJECT="${1:-infrastructure}"
ENV="${2:-prod}"

echo "secrets.set.interactive"
echo "project: $PROJECT  env: $ENV"
echo

while true; do
  read -r -p "Key name (or 'done' to exit): " key
  [[ "$key" != "done" ]] || break
  [[ -n "$key" ]] || continue

  read -r -s -p "Value for $key: " value
  echo  # newline after hidden input

  if [[ -z "$value" ]]; then
    echo "  $key -> SKIP (empty value)"
    continue
  fi

  if "$AGENT" set "$PROJECT" "$ENV" "$key" "$value" >/dev/null 2>&1; then
    echo "  $key -> OK"
  else
    echo "  $key -> FAIL"
  fi
  unset value
done

echo
echo "done"
