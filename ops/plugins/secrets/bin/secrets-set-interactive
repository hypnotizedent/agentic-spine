#!/usr/bin/env bash
# secrets.set.interactive â€” safely set secrets without leaking values
#
# Prompts with read -s (no echo); prints only key name + OK/FAIL.
# Never prints secret values to stdout or receipts.
#
# Usage:
#   secrets-set-interactive [project] [env]
#   secrets-set-interactive infrastructure prod
#
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SPINE_ROOT="${SPINE_ROOT:-$(cd "$SCRIPT_DIR/../../../.." && pwd)}"
AGENT="$SPINE_ROOT/ops/tools/infisical-agent.sh"

[[ -f "$AGENT" ]] || { echo "STOP (2): missing infisical-agent.sh at $AGENT"; exit 2; }

# Resolve binding project from SSOT
BINDING_FILE="$SPINE_ROOT/ops/bindings/secrets.binding.yaml"
if [[ -f "$BINDING_FILE" ]] && command -v yq >/dev/null 2>&1; then
  BINDING_PROJECT="$(yq -r '.infisical.project // ""' "$BINDING_FILE" 2>/dev/null || true)"
fi
BINDING_PROJECT="${BINDING_PROJECT:-01ddd93a-e0f8-4c7c-ad9f-903d76ef94d9}"

# Active projects allowed for interactive writes
ACTIVE_PROJECTS="infrastructure mint-os-api n8n media-stack immich home-assistant"

PROJECT="${1:-infrastructure}"
ENV="${2:-prod}"

# Gate: reject deprecated projects for writes
is_active() {
  for p in $ACTIVE_PROJECTS; do
    [[ "$p" == "$1" ]] && return 0
  done
  return 1
}

if ! is_active "$PROJECT"; then
  echo "STOP: project '$PROJECT' is deprecated or unknown."
  echo "Governed writes target active projects only: $ACTIVE_PROJECTS"
  exit 1
fi

echo "secrets.set.interactive"
echo "project: $PROJECT  env: $ENV"
echo

while true; do
  read -r -p "Key name (or 'done' to exit): " key
  [[ "$key" != "done" ]] || break
  [[ -n "$key" ]] || continue

  read -r -s -p "Value for $key: " value
  echo  # newline after hidden input

  if [[ -z "$value" ]]; then
    echo "  $key -> SKIP (empty value)"
    continue
  fi

  if "$AGENT" set "$PROJECT" "$ENV" "$key" "$value" >/dev/null 2>&1; then
    echo "  $key -> OK"
  else
    echo "  $key -> FAIL"
  fi
  unset value
done

echo
echo "done"
