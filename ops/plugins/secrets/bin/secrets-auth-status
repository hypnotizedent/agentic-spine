#!/usr/bin/env bash
# secrets.auth.status â€” verifies Infisical auth is present (NO values printed)
set -euo pipefail

echo "=== secrets.auth.status ==="
command -v infisical >/dev/null 2>&1 || { echo "MISSING_DEP: infisical"; exit 1; }

# Check for auth env vars (names only, no values)
need_any=0
for v in INFISICAL_TOKEN INFISICAL_UNIVERSAL_AUTH_CLIENT_SECRET; do
  val="${!v:-}"
  if [[ -n "$val" ]]; then need_any=1; fi
done

echo "env:"
for v in INFISICAL_API_URL INFISICAL_TOKEN INFISICAL_UNIVERSAL_AUTH_CLIENT_ID INFISICAL_UNIVERSAL_AUTH_CLIENT_SECRET; do
  val="${!v:-}"
  [[ -n "$val" ]] && echo "  SET: $v" || echo "  MISSING: $v"
done

echo
if [[ "$need_any" -eq 0 ]]; then
  echo "STATUS: STOP (no auth present)"
  exit 2
fi

# Soft CLI check (non-secret): show version only
infisical --version >/dev/null 2>&1 || true
echo "STATUS: OK (auth variables present)"
exit 0
