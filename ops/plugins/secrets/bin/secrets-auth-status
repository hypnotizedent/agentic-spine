#!/usr/bin/env bash
# secrets.auth.status — verifies Infisical auth is present (NO values printed)
set -euo pipefail

echo "=== secrets.auth.status ==="

# Source credentials file if env vars not already set (same pattern as infisical-agent.sh)
CREDENTIALS_FILE="${HOME}/.config/infisical/credentials"
if [[ -z "${INFISICAL_UNIVERSAL_AUTH_CLIENT_SECRET:-}" && -f "$CREDENTIALS_FILE" ]]; then
  source "$CREDENTIALS_FILE"
fi

# Soft CLI check — not required (infisical-agent.sh uses API directly)
if command -v infisical >/dev/null 2>&1; then
  echo "cli: installed"
else
  echo "cli: not installed (optional — infisical-agent.sh uses API directly)"
fi

# Check for auth env vars (names only, no values)
need_any=0
for v in INFISICAL_TOKEN INFISICAL_UNIVERSAL_AUTH_CLIENT_SECRET; do
  val="${!v:-}"
  if [[ -n "$val" ]]; then need_any=1; fi
done

echo "env:"
for v in INFISICAL_API_URL INFISICAL_TOKEN INFISICAL_UNIVERSAL_AUTH_CLIENT_ID INFISICAL_UNIVERSAL_AUTH_CLIENT_SECRET; do
  val="${!v:-}"
  [[ -n "$val" ]] && echo "  SET: $v" || echo "  MISSING: $v"
done

echo
if [[ "$need_any" -eq 0 ]]; then
  echo "STATUS: STOP (no auth present)"
  echo "hint: ensure ~/.config/infisical/credentials exists with INFISICAL_UNIVERSAL_AUTH_CLIENT_SECRET"
  exit 2
fi

echo "STATUS: OK (auth variables present)"
exit 0
