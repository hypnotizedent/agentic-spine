#!/usr/bin/env bash
set -euo pipefail

# secrets.projects.status - Compare SSOT inventory vs live Infisical projects
# Requires: secrets.binding, secrets.auth.status
# Output: counts + deltas (names only, no IDs, no secrets)

SPINE_REPO="${SPINE_REPO:-$HOME/code/agentic-spine}"
INVENTORY="$SPINE_REPO/ops/bindings/secrets.inventory.yaml"
BINDING="$SPINE_REPO/ops/bindings/secrets.binding.yaml"

# Source credentials if available
CREDENTIALS_FILE="${HOME}/.config/infisical/credentials"
if [[ -f "$CREDENTIALS_FILE" ]]; then
  source "$CREDENTIALS_FILE"
fi

echo "secrets.projects.status"
echo

# ─────────────────────────────────────────────────────────────────────────────
# PRECONDITIONS
# ─────────────────────────────────────────────────────────────────────────────

# Dependencies
command -v yq >/dev/null 2>&1 || { echo "status: STOP"; echo "reason: missing_dep_yq"; exit 2; }
command -v jq >/dev/null 2>&1 || { echo "status: STOP"; echo "reason: missing_dep_jq"; exit 2; }
command -v curl >/dev/null 2>&1 || { echo "status: STOP"; echo "reason: missing_dep_curl"; exit 2; }

# Inventory file
if [[ ! -f "$INVENTORY" ]]; then
  echo "status: STOP"
  echo "reason: missing_inventory"
  echo "fix: run secrets.inventory.status to verify inventory exists"
  exit 2
fi

# Binding file (canonical API URL + auth target)
if [[ ! -f "$BINDING" ]]; then
  echo "status: STOP"
  echo "reason: missing_binding"
  echo "fix: ensure ops/bindings/secrets.binding.yaml exists"
  exit 2
fi

# Auth check (names only, no values)
# Binding is canonical: do not allow env var to override, since it may point at a forward-auth URL (HTTP 302/HTML).
INFISICAL_API_URL="$(yq -r '.infisical.internal_api_url // .infisical.api_url // ""' "$BINDING")"
CLIENT_ID="${INFISICAL_UNIVERSAL_AUTH_CLIENT_ID:-}"
CLIENT_SECRET="${INFISICAL_UNIVERSAL_AUTH_CLIENT_SECRET:-}"

if [[ -z "$INFISICAL_API_URL" || "$INFISICAL_API_URL" == "null" ]]; then
  echo "status: STOP"
  echo "reason: binding_missing_api_url"
  echo "fix: set infisical.api_url (and optionally infisical.internal_api_url) in ops/bindings/secrets.binding.yaml"
  exit 2
fi

if [[ -z "$CLIENT_SECRET" ]]; then
  echo "status: STOP"
  echo "reason: auth_missing"
  echo "fix: source ~/.config/infisical/credentials or run secrets.auth.load"
  exit 2
fi

# ─────────────────────────────────────────────────────────────────────────────
# READ EXPECTED PROJECTS FROM INVENTORY
# ─────────────────────────────────────────────────────────────────────────────

EXPECTED_NAMES="$(yq -r '.projects[].name' "$INVENTORY" | sort)"
EXPECTED_COUNT="$(echo "$EXPECTED_NAMES" | wc -l | tr -d ' ')"

echo "inventory:"
echo "  source: $INVENTORY"
echo "  projects_expected: $EXPECTED_COUNT"
echo

# ─────────────────────────────────────────────────────────────────────────────
# AUTHENTICATE (no secrets printed)
# ─────────────────────────────────────────────────────────────────────────────

set +e
AUTH_RESPONSE="$(curl -s --max-time 10 -w '\n%{http_code}' -X POST "${INFISICAL_API_URL}/api/v1/auth/universal-auth/login" \
  -H "Content-Type: application/json" \
  -d "{\"clientId\": \"${CLIENT_ID}\", \"clientSecret\": \"${CLIENT_SECRET}\"}" 2>/dev/null)"
curl_rc=$?
set -e

if [[ "$curl_rc" -ne 0 || -z "${AUTH_RESPONSE:-}" ]]; then
  echo "status: STOP"
  echo "reason: api_unreachable"
  exit 2
fi

AUTH_CODE="$(echo "$AUTH_RESPONSE" | tail -n1)"
AUTH_BODY="$(echo "$AUTH_RESPONSE" | sed '$d')"

if [[ "$AUTH_CODE" =~ ^30[1278]$ ]]; then
  echo "status: STOP"
  echo "reason: api_redirected"
  echo "api_url: $INFISICAL_API_URL"
  exit 2
fi

if [[ "$AUTH_CODE" != "200" ]]; then
  if echo "$AUTH_BODY" | jq -e . >/dev/null 2>&1; then
    ERROR_MSG="$(echo "$AUTH_BODY" | jq -r '.message // "auth failed"')"
  else
    ERROR_MSG="non_json_response"
  fi
  echo "status: STOP"
  echo "reason: api_auth_failed"
  echo "error: $ERROR_MSG"
  exit 2
fi

if ! echo "$AUTH_BODY" | jq -e . >/dev/null 2>&1; then
  echo "status: STOP"
  echo "reason: api_non_json"
  echo "api_url: $INFISICAL_API_URL"
  exit 2
fi

ACCESS_TOKEN="$(echo "$AUTH_BODY" | jq -r '.accessToken // empty')"

if [[ -z "$ACCESS_TOKEN" ]]; then
  ERROR_MSG="$(echo "$AUTH_BODY" | jq -r '.message // "unknown"')"
  echo "status: STOP"
  echo "reason: api_auth_failed"
  echo "error: $ERROR_MSG"
  exit 2
fi

# ─────────────────────────────────────────────────────────────────────────────
# FETCH LIVE PROJECTS (names only)
# ─────────────────────────────────────────────────────────────────────────────

set +e
LIVE_RESPONSE="$(curl -s --max-time 10 -w '\n%{http_code}' -X GET "${INFISICAL_API_URL}/api/v1/workspace" \
  -H "Authorization: Bearer $ACCESS_TOKEN" 2>/dev/null)"
curl_rc=$?
set -e

if [[ "$curl_rc" -ne 0 || -z "${LIVE_RESPONSE:-}" ]]; then
  echo "status: STOP"
  echo "reason: api_unreachable"
  exit 2
fi

LIVE_CODE="$(echo "$LIVE_RESPONSE" | tail -n1)"
LIVE_BODY="$(echo "$LIVE_RESPONSE" | sed '$d')"

if [[ "$LIVE_CODE" =~ ^30[1278]$ ]]; then
  echo "status: STOP"
  echo "reason: api_redirected"
  echo "api_url: $INFISICAL_API_URL"
  exit 2
fi

if [[ "$LIVE_CODE" != "200" ]]; then
  if echo "$LIVE_BODY" | jq -e . >/dev/null 2>&1; then
    ERROR_MSG="$(echo "$LIVE_BODY" | jq -r '.message // "api error"')"
  else
    ERROR_MSG="non_json_response"
  fi
  echo "status: STOP"
  echo "reason: api_error"
  echo "error: $ERROR_MSG"
  exit 2
fi

if ! echo "$LIVE_BODY" | jq -e '.workspaces' >/dev/null 2>&1; then
  echo "status: STOP"
  echo "reason: api_non_json"
  echo "api_url: $INFISICAL_API_URL"
  exit 2
fi

if echo "$LIVE_BODY" | jq -e '.workspaces' >/dev/null 2>&1; then
  LIVE_NAMES="$(echo "$LIVE_BODY" | jq -r '.workspaces[].name' | sort)"
  LIVE_COUNT="$(echo "$LIVE_NAMES" | wc -l | tr -d ' ')"
else
  echo "status: STOP"
  echo "reason: api_error"
  echo "error: invalid_json"
  exit 2
fi

echo "live:"
echo "  api_url: $INFISICAL_API_URL"
echo "  projects_found: $LIVE_COUNT"
echo

# ─────────────────────────────────────────────────────────────────────────────
# COMPARE: EXPECTED vs LIVE
# ─────────────────────────────────────────────────────────────────────────────

# Projects in inventory but not live
MISSING="$(comm -23 <(echo "$EXPECTED_NAMES") <(echo "$LIVE_NAMES") | grep -v '^$' || true)"
if [[ -z "$MISSING" ]]; then
  MISSING_COUNT=0
else
  MISSING_COUNT="$(echo "$MISSING" | wc -l | tr -d ' ')"
fi

# Projects live but not in inventory
EXTRA="$(comm -13 <(echo "$EXPECTED_NAMES") <(echo "$LIVE_NAMES") | grep -v '^$' || true)"
if [[ -z "$EXTRA" ]]; then
  EXTRA_COUNT=0
else
  EXTRA_COUNT="$(echo "$EXTRA" | wc -l | tr -d ' ')"
fi

echo "parity:"
echo "  expected: $EXPECTED_COUNT"
echo "  found: $LIVE_COUNT"
echo "  missing: $MISSING_COUNT"
echo "  extra: $EXTRA_COUNT"

if [[ "$MISSING_COUNT" -gt 0 ]]; then
  echo
  echo "missing_projects:"
  echo "$MISSING" | while read -r name; do
    [[ -n "$name" ]] && echo "  - $name"
  done
fi

if [[ "$EXTRA_COUNT" -gt 0 ]]; then
  echo
  echo "extra_projects:"
  echo "$EXTRA" | while read -r name; do
    [[ -n "$name" ]] && echo "  - $name"
  done
fi

# ─────────────────────────────────────────────────────────────────────────────
# KNOWN ISSUES SUMMARY (from inventory)
# ─────────────────────────────────────────────────────────────────────────────

CRITICAL_COUNT="$(yq -r '[.known_issues[] | select(.severity == "critical")] | length' "$INVENTORY")"
HIGH_COUNT="$(yq -r '[.known_issues[] | select(.severity == "high")] | length' "$INVENTORY")"
MEDIUM_COUNT="$(yq -r '[.known_issues[] | select(.severity == "medium")] | length' "$INVENTORY")"

echo
echo "known_issues:"
echo "  critical: $CRITICAL_COUNT"
echo "  high: $HIGH_COUNT"
echo "  medium: $MEDIUM_COUNT"

# ─────────────────────────────────────────────────────────────────────────────
# STATUS
# ─────────────────────────────────────────────────────────────────────────────

echo
if [[ "$MISSING_COUNT" -gt 0 ]]; then
  echo "status: DEGRADED"
  echo "reason: drift_missing"
  exit 1
elif [[ "$EXTRA_COUNT" -gt 0 ]]; then
  echo "status: DEGRADED"
  echo "reason: drift_extra"
  exit 1
elif [[ "$CRITICAL_COUNT" -gt 0 ]]; then
  echo "status: OK"
  echo "reason: ok_with_critical_issues"
  exit 0
else
  echo "status: OK"
  echo "reason: ok"
  exit 0
fi
