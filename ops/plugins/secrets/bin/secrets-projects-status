#!/usr/bin/env bash
set -euo pipefail

# If SPINE_REPO env var is set (by capability runner), use it; otherwise compute
if [ -n "${SPINE_REPO:-}" ]; then
  SPINE_ROOT="$SPINE_REPO"
else
  # Fallback: compute from script location
  SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
  SPINE_ROOT="$(cd "$SCRIPT_DIR/../../../.." && pwd)"
fi

BINDING="$SPINE_ROOT/ops/bindings/secrets.binding.yaml"
MAP="$SPINE_ROOT/docs/core/INFISICAL_PROJECTS.md"

echo "════════════════════════════════════════"
echo "CAPABILITY: secrets.projects.status"
echo "════════════════════════════════════════"
echo

# Preconditions: files exist
test -f "$BINDING" || { echo "STOP: missing binding file: $BINDING"; exit 2; }
test -f "$MAP" || { echo "STOP: missing projects map: $MAP"; exit 2; }

# Pull project id/name from binding (extract UUID from quoted YAML value).
BOUND_ID="$(grep 'project:' "$BINDING" | head -1 | sed -E 's/.*"([a-f0-9-]{36})".*/\1/' || true)"
BOUND_ENV="$(grep 'environment:' "$BINDING" | head -1 | sed -E 's/.*:[[:space:]]+"?([a-zA-Z0-9_]+)"?.*/\1/' || true)"

if test -z "${BOUND_ID:-}"; then
  echo "STOP: could not read project from binding: $BINDING"
  exit 2
fi
if test -z "${BOUND_ENV:-}"; then
  BOUND_ENV="prod"
fi

echo "Binding:"
echo "  project_id: $BOUND_ID"
echo "  environment: $BOUND_ENV"
echo

# Extract the catalog table and show it (small, deterministic).
echo "Project catalog (excerpt):"
awk '
  BEGIN {in_table=0}
  /^\|[[:space:]]*lifecycle[[:space:]]*\|/ {in_table=1}
  in_table {print}
  in_table && /^[[:space:]]*$/ {exit}
' "$MAP" | head -50

echo

# Enforce: bound project must be ACTIVE per SSOT map table.
# The ACTIVE row for infrastructure contains: | **ACTIVE** | **infrastructure** | `01ddd93a...` |
if grep -q "| \*\*ACTIVE\*\* |.*\`$BOUND_ID\`" "$MAP" 2>/dev/null || \
   grep -q "| ACTIVE |.*\`$BOUND_ID\`" "$MAP" 2>/dev/null || \
   grep -q "|.*ACTIVE.*|$BOUND_ID|" "$MAP" 2>/dev/null; then
  echo "OK: bound project ($BOUND_ID) is ACTIVE in docs/core/INFISICAL_PROJECTS.md"
  exit 0
fi

echo "STOP: bound project ($BOUND_ID) is NOT marked ACTIVE in docs/core/INFISICAL_PROJECTS.md"
echo "Fix: update the lifecycle table or change ops/bindings/secrets.binding.yaml"
exit 2
