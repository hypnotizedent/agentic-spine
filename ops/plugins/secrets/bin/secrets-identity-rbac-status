#!/usr/bin/env bash
set -euo pipefail

# secrets.identity.rbac.status â€” Probe identity project memberships and roles
#
# Contract:
# - Read-only: no mutations
# - Requires secrets.binding + secrets.auth.status
# - Reports identity ID, project memberships, and roles (no secret values)
# - Uses Infisical API v2 identity-memberships endpoint
#
# Output: structured YAML-like report of identity -> project -> role mappings

SPINE_REPO="${SPINE_REPO:-$HOME/code/agentic-spine}"
[[ -d "$SPINE_REPO" ]] || SPINE_REPO="$HOME/code/agentic-spine"

# Dependencies
command -v curl >/dev/null 2>&1 || { echo "MISSING_DEP: curl"; exit 1; }
command -v jq >/dev/null 2>&1 || { echo "MISSING_DEP: jq"; exit 1; }
command -v yq >/dev/null 2>&1 || { echo "MISSING_DEP: yq"; exit 1; }

# Binding
BINDING_FILE="$SPINE_REPO/ops/bindings/secrets.binding.yaml"
INVENTORY_FILE="$SPINE_REPO/ops/bindings/secrets.inventory.yaml"
[[ -f "$BINDING_FILE" ]] || { echo "FAIL: binding file missing"; exit 1; }
[[ -f "$INVENTORY_FILE" ]] || { echo "FAIL: inventory file missing"; exit 1; }

INF_API_URL="$(yq -r '.infisical.internal_api_url // .infisical.api_url // ""' "$BINDING_FILE")"
[[ -n "$INF_API_URL" && "$INF_API_URL" != "null" ]] || { echo "FAIL: binding missing api_url"; exit 1; }

# Auth via canonical agent
INFISICAL_AGENT="$SPINE_REPO/ops/tools/infisical-agent.sh"
[[ -x "$INFISICAL_AGENT" ]] || { echo "FAIL: infisical-agent.sh not found"; exit 1; }

TOKEN=$("$INFISICAL_AGENT" auth-token 2>/dev/null) || true
[[ -n "$TOKEN" ]] || { echo "FAIL: auth-token failed"; exit 1; }

# Extract identity ID from JWT payload via canonical agent
IDENTITY_ID="$("$INFISICAL_AGENT" jwt-decode "$TOKEN" 2>/dev/null | jq -r '.identityId // .sub // empty' 2>/dev/null || true)"

echo "=== secrets.identity.rbac.status ==="
echo
echo "identity_id: ${IDENTITY_ID:-unknown}"
echo "api_url: $INF_API_URL"
echo

# Read project list from inventory
echo "project_memberships:"

project_count=0
deprecated_writable=0

while IFS='|' read -r name pid lifecycle; do
  name="$(echo "$name" | xargs)"
  pid="$(echo "$pid" | xargs)"
  lifecycle="$(echo "$lifecycle" | xargs)"
  [[ -n "$name" && -n "$pid" ]] || continue

  # Query identity memberships for this project
  set +e
  resp="$(curl -s --max-time 10 -w '\n%{http_code}' -X GET \
    "${INF_API_URL}/api/v2/workspace/${pid}/identity-memberships" \
    -H "Authorization: Bearer $TOKEN" 2>/dev/null)"
  rc=$?
  set -e

  if [[ "$rc" -ne 0 || -z "$resp" ]]; then
    echo "  - project: $name"
    echo "    id: $pid"
    echo "    lifecycle: $lifecycle"
    echo "    membership: error_unreachable"
    echo
    continue
  fi

  resp_code="$(echo "$resp" | tail -n1)"
  resp_body="$(echo "$resp" | sed '$d')"

  if [[ "$resp_code" != "200" ]]; then
    echo "  - project: $name"
    echo "    id: $pid"
    echo "    lifecycle: $lifecycle"
    echo "    membership: error_http_${resp_code}"
    echo
    continue
  fi

  # Find our identity's membership (role is under .roles[0].role, not .role)
  if [[ -n "$IDENTITY_ID" && "$IDENTITY_ID" != "unknown" ]]; then
    my_role="$(echo "$resp_body" | jq -r --arg iid "$IDENTITY_ID" \
      '.identityMemberships[]? | select(.identity.id == $iid) | .roles[0].role // "none"' 2>/dev/null || true)"
    my_membership_id="$(echo "$resp_body" | jq -r --arg iid "$IDENTITY_ID" \
      '.identityMemberships[]? | select(.identity.id == $iid) | .id // "none"' 2>/dev/null || true)"
  else
    # Try to find any membership (fallback when identity ID unknown)
    my_role="$(echo "$resp_body" | jq -r '.identityMemberships[0]?.roles[0].role // "none"' 2>/dev/null || true)"
    my_membership_id="$(echo "$resp_body" | jq -r '.identityMemberships[0]?.id // "none"' 2>/dev/null || true)"
  fi

  [[ -n "$my_role" ]] || my_role="none"
  [[ -n "$my_membership_id" ]] || my_membership_id="none"

  # Determine if deprecated + writable
  is_deprecated="false"
  case "$lifecycle" in
    deprecated|delete_candidate|overlaps) is_deprecated="true" ;;
  esac

  writable="false"
  case "$my_role" in
    admin|member) writable="true" ;;
  esac

  if [[ "$is_deprecated" == "true" && "$writable" == "true" ]]; then
    deprecated_writable=$((deprecated_writable + 1))
  fi

  echo "  - project: $name"
  echo "    id: $pid"
  echo "    lifecycle: $lifecycle"
  echo "    role: ${my_role:-none}"
  echo "    membership_id: ${my_membership_id:-none}"
  echo "    deprecated: $is_deprecated"
  echo "    writable: $writable"
  echo

  project_count=$((project_count + 1))
done < <(yq -r '.projects[] | [.name, .id, .lifecycle] | join("|")' "$INVENTORY_FILE")

echo "summary:"
echo "  total_projects: $project_count"
echo "  deprecated_writable: $deprecated_writable"
echo

if [[ "$deprecated_writable" -gt 0 ]]; then
  echo "status: WARN"
  echo "reason: identity has write access to $deprecated_writable deprecated project(s)"
else
  echo "status: OK"
  echo "reason: no write access to deprecated projects"
fi
