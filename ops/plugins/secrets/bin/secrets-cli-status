#!/usr/bin/env bash
# secrets-cli-status — Hash parity check for infisical-agent.sh
# Canonical: agentic-spine/ops/tools/infisical-agent.sh
# Vendored:  workbench/scripts/agents/infisical-agent.sh
# Read-only capability — safe to run any time.
set -euo pipefail

SP="${SPINE_ROOT:-$HOME/Code/agentic-spine}"
WB="${WORKBENCH_ROOT:-$HOME/Code/workbench}"

CANONICAL="$SP/ops/tools/infisical-agent.sh"
VENDORED="$WB/scripts/agents/infisical-agent.sh"

if [[ ! -f "$CANONICAL" ]]; then
  echo "FAIL canonical missing: $CANONICAL"
  exit 1
fi

CANONICAL_HASH=$(shasum -a 256 "$CANONICAL" | awk '{print $1}')

if [[ ! -f "$VENDORED" ]]; then
  echo "WARN vendored copy missing: $VENDORED (spine-only mode)"
  echo "  canonical: $CANONICAL_HASH"
  exit 0
fi

VENDORED_HASH=$(shasum -a 256 "$VENDORED" | awk '{print $1}')

if [[ "$CANONICAL_HASH" != "$VENDORED_HASH" ]]; then
  echo "FAIL hash mismatch"
  echo "  canonical: $CANONICAL_HASH"
  echo "  vendored:  $VENDORED_HASH"
  echo "  Fix: cp $CANONICAL $VENDORED"
  exit 1
fi

echo "PASS hashes match: ${CANONICAL_HASH:0:12}..."
exit 0
