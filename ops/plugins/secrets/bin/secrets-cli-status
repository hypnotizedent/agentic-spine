#!/usr/bin/env bash
# secrets-cli-status — Validate shim delegation for infisical-agent.sh
# Canonical: agentic-spine/ops/tools/infisical-agent.sh
# Vendored:  workbench/scripts/agents/infisical-agent.sh (shim)
# Read-only capability — safe to run any time.
set -euo pipefail

SP="${SPINE_ROOT:-$HOME/code/agentic-spine}"
WB="${WORKBENCH_ROOT:-$HOME/code/workbench}"

CANONICAL="$SP/ops/tools/infisical-agent.sh"
SHIM="$WB/scripts/agents/infisical-agent.sh"

if [[ ! -f "$CANONICAL" ]]; then
  echo "FAIL canonical missing: $CANONICAL"
  exit 1
fi

if [[ ! -x "$CANONICAL" ]]; then
  echo "FAIL canonical not executable: $CANONICAL"
  exit 1
fi

if [[ ! -f "$SHIM" ]]; then
  echo "WARN shim missing: $SHIM (spine-only mode)"
  echo "  canonical: $CANONICAL (exists, executable)"
  exit 0
fi

if [[ ! -x "$SHIM" ]]; then
  echo "FAIL shim not executable: $SHIM"
  exit 1
fi

if ! grep -q "ops/tools/infisical-agent.sh" "$SHIM"; then
  echo "FAIL shim does not delegate to canonical"
  echo "  Expected delegation to: $CANONICAL"
  echo "  Shim content does not reference ops/tools/infisical-agent.sh"
  exit 1
fi

if ! grep -qE 'exec bash .*\$CANONICAL|exec .*\$CANONICAL.*\$@' "$SHIM"; then
  echo "FAIL shim does not use exec delegation pattern"
  echo "  Expected: exec bash \"\$CANONICAL\" \"\$@\""
  exit 1
fi

echo "PASS shim delegation valid"
echo "  canonical: $CANONICAL"
echo "  shim:      $SHIM"
echo "  pattern:   exec bash \$CANONICAL \$@"
exit 0
