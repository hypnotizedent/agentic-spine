#!/usr/bin/env bash
# secrets-p1-root-cleanup - guarded cleanup for P1 keys at root path '/'
set -euo pipefail

SPINE_REPO="${SPINE_REPO:-$HOME/code/agentic-spine}"
POLICY="$SPINE_REPO/ops/bindings/secrets.namespace.policy.yaml"
CREDENTIALS_FILE="${HOME}/.config/infisical/credentials"
EXECUTE=0

if [[ "${1:-}" == "--execute" ]]; then
  EXECUTE=1
fi

for dep in yq infisical curl jq; do
  command -v "$dep" >/dev/null 2>&1 || { echo "MISSING_DEP: $dep"; exit 1; }
done
[[ -f "$POLICY" ]] || { echo "MISSING: $POLICY"; exit 2; }
yq e '.' "$POLICY" >/dev/null 2>&1 || { echo "FAIL: invalid policy YAML"; exit 1; }

if [[ -f "$CREDENTIALS_FILE" ]]; then
  # shellcheck disable=SC1090
  source "$CREDENTIALS_FILE"
fi

PROJECT_ID="$(yq e -r '.infisical.project_id // ""' "$POLICY")"
ENV_NAME="$(yq e -r '.infisical.environment // ""' "$POLICY")"
ROOT_PATH="$(yq e -r '.freeze.root_path // "/"' "$POLICY")"
API_URL="${INFISICAL_API_URL:-https://secrets.ronny.works}"

[[ -n "$PROJECT_ID" && -n "$ENV_NAME" ]] || { echo "FAIL: policy missing project/env"; exit 1; }

mapfile -t P1_KEYS < <(yq e -r '.rules.key_path_overrides | to_entries[] | select(.value == "/spine/platform/security") | .key' "$POLICY" 2>/dev/null || true)
(( ${#P1_KEYS[@]} > 0 )) || { echo "FAIL: no P1 keys found in policy overrides"; exit 1; }

TOKEN=""
if [[ "$EXECUTE" -eq 1 ]]; then
  auth_resp="$(curl -s -w '\n%{http_code}' -X POST "$API_URL/api/v1/auth/universal-auth/login" \
    -H 'Content-Type: application/json' \
    -d "{\"clientId\":\"${INFISICAL_UNIVERSAL_AUTH_CLIENT_ID:-}\",\"clientSecret\":\"${INFISICAL_UNIVERSAL_AUTH_CLIENT_SECRET:-}\"}")"
  auth_code="$(echo "$auth_resp" | tail -n1)"
  auth_body="$(echo "$auth_resp" | sed '$d')"
  [[ "$auth_code" == "200" ]] || { echo "FAIL: auth failed for execute mode (HTTP $auth_code)"; exit 1; }
  TOKEN="$(echo "$auth_body" | jq -r '.accessToken // empty')"
  [[ -n "$TOKEN" ]] || { echo "FAIL: missing access token for execute mode"; exit 1; }
fi

echo "secrets.p1.root_cleanup"
echo "mode: $([[ "$EXECUTE" -eq 1 ]] && echo execute || echo dry_run)"
echo "project_id: $PROJECT_ID"
echo "environment: $ENV_NAME"
echo "root_path: $ROOT_PATH"
echo "target_path: /spine/platform/security"
echo

ok=0
skip=0
fail=0
deleted=0

for key in "${P1_KEYS[@]}"; do
  dst_path="$(yq e -r ".rules.key_path_overrides.${key} // \"\"" "$POLICY")"
  [[ -n "$dst_path" && "$dst_path" != "null" ]] || {
    echo "FAIL: $key missing destination path in policy"
    fail=$((fail + 1))
    continue
  }

  root_val="$(infisical secrets get "$key" --projectId "$PROJECT_ID" --env "$ENV_NAME" --path "$ROOT_PATH" --plain --silent 2>/dev/null || true)"
  dst_val="$(infisical secrets get "$key" --projectId "$PROJECT_ID" --env "$ENV_NAME" --path "$dst_path" --plain --silent 2>/dev/null || true)"

  if [[ -z "$dst_val" ]]; then
    echo "FAIL: $key missing at destination path $dst_path"
    fail=$((fail + 1))
    continue
  fi

  if [[ -z "$root_val" ]]; then
    echo "SKIP: $key already absent at root"
    skip=$((skip + 1))
    continue
  fi

  if [[ "$root_val" != "$dst_val" ]]; then
    echo "FAIL: $key root/destination mismatch"
    fail=$((fail + 1))
    continue
  fi

  if [[ "$EXECUTE" -eq 1 ]]; then
    del_resp="$(curl -s -w '\n%{http_code}' -X DELETE "$API_URL/api/v3/secrets/raw/$key" \
      -H "Authorization: Bearer $TOKEN" \
      -H 'Content-Type: application/json' \
      -d "{\"workspaceId\":\"$PROJECT_ID\",\"environment\":\"$ENV_NAME\",\"secretPath\":\"$ROOT_PATH\"}")"
    del_code="$(echo "$del_resp" | tail -n1)"
    del_body="$(echo "$del_resp" | sed '$d')"
    if [[ "$del_code" == "200" ]] && echo "$del_body" | jq -e '.secret' >/dev/null 2>&1; then
      echo "DELETED: $key from root"
      deleted=$((deleted + 1))
      ok=$((ok + 1))
    else
      msg="$(echo "$del_body" | jq -r '.message // "delete failed"' 2>/dev/null || echo 'delete failed')"
      echo "FAIL: delete failed for $key ($msg)"
      fail=$((fail + 1))
    fi
  else
    echo "READY: $key root copy eligible for delete"
    ok=$((ok + 1))
  fi
done

echo
echo "summary: ok=$ok skip=$skip fail=$fail deleted=$deleted"

if (( fail > 0 )); then
  echo "status: FAIL"
  exit 1
fi

echo "status: OK"
exit 0
