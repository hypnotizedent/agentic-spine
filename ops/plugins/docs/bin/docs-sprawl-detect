#!/usr/bin/env bash
set -euo pipefail

# docs.sprawl.detect — Report governance doc sprawl metrics
# Safety: read-only (scans files, no modifications)
# Exit: always 0 (diagnostic capability)

ROOT="${SPINE_CODE:-$(cd "$(dirname "${BASH_SOURCE[0]}")/../../../.." && pwd)}"
DOCS="$ROOT/docs"

if [[ ! -d "$DOCS" ]]; then
  echo "STOP: docs/ not found at $DOCS" >&2
  exit 2
fi

echo "docs.sprawl.detect"
echo "root: $ROOT"
echo

# ─────────────────────────────────────────────────────────────────────────
# Count docs by directory
# ─────────────────────────────────────────────────────────────────────────
echo "--- Document counts by directory ---"

count_dir() { [[ -d "$1" ]] && find "$1" ${2:+"$2" "$3"} -type f -name "*.md" | wc -l | tr -d ' ' || echo 0; }
count_dir_all() { [[ -d "$1" ]] && find "$1" ${2:+"$2" "$3"} -type f \( -name "*.md" -o -name "*.yaml" \) | wc -l | tr -d ' ' || echo 0; }

count_core=$(count_dir "$DOCS/core")
count_governance=$(count_dir_all "$DOCS/governance" -maxdepth 1)
count_governance_audits=$(count_dir "$DOCS/governance/_audits")
count_brain=$(count_dir "$DOCS/brain")
count_legacy=$(count_dir "$DOCS/legacy")
count_sessions=$(count_dir "$DOCS/sessions")

echo "  core:              $count_core"
echo "  governance:        $count_governance"
echo "  governance/_audits: $count_governance_audits"
echo "  brain:             $count_brain"
echo "  legacy:            $count_legacy"
echo "  sessions:          $count_sessions"

total=$((count_core + count_governance + count_governance_audits + count_brain + count_legacy + count_sessions))
echo ""
echo "  total:             $total"

# ─────────────────────────────────────────────────────────────────────────
# Count governance docs by status (frontmatter)
# ─────────────────────────────────────────────────────────────────────────
echo ""
echo "--- Governance docs by status ---"

# POSIX-compatible status counting (no associative arrays for macOS bash 3.2)
c_authoritative=0; c_reference=0; c_deprecated=0; c_merged=0
c_archived=0; c_generated=0; c_draft=0; c_other=0

while IFS= read -r f; do
  status_value=""
  in_fm=false
  line_num=0
  while IFS= read -r line; do
    line_num=$((line_num+1))
    [[ "$line_num" -gt 15 ]] && break
    if [[ "$line" == "---" ]]; then
      if [[ "$in_fm" == "true" ]]; then break; fi
      in_fm=true; continue
    fi
    if [[ "$in_fm" == "true" && "$line" =~ ^status:[[:space:]]*(.*) ]]; then
      status_value="${BASH_REMATCH[1]}"
      status_value="${status_value//\"/}"
      status_value="${status_value//\'/}"
      status_value="$(echo "$status_value" | xargs)"
      break
    fi
  done < "$f"

  if [[ -z "$status_value" ]]; then
    status_value="$(head -10 "$f" | grep -oiE 'authoritative|reference|deprecated|merged|archived|generated|draft' | head -1 | tr '[:upper:]' '[:lower:]' || true)"
  fi

  case "${status_value:-other}" in
    authoritative) c_authoritative=$((c_authoritative+1)) ;;
    reference)     c_reference=$((c_reference+1)) ;;
    deprecated)    c_deprecated=$((c_deprecated+1)) ;;
    merged)        c_merged=$((c_merged+1)) ;;
    archived)      c_archived=$((c_archived+1)) ;;
    generated)     c_generated=$((c_generated+1)) ;;
    draft)         c_draft=$((c_draft+1)) ;;
    *)             c_other=$((c_other+1)) ;;
  esac
done < <(find "$DOCS/governance" -maxdepth 1 -name "*.md" 2>/dev/null | sort)

echo "  authoritative: $c_authoritative"
echo "  reference:     $c_reference"
echo "  deprecated:    $c_deprecated"
echo "  merged:        $c_merged"
echo "  archived:      $c_archived"
echo "  draft:         $c_draft"
echo "  other:         $c_other"

# ─────────────────────────────────────────────────────────────────────────
# Sprawl warnings
# ─────────────────────────────────────────────────────────────────────────
echo ""
echo "--- Sprawl assessment ---"
if [[ "$count_governance" -gt 100 ]]; then
  echo "WARN: governance/ exceeds 100 docs ($count_governance) — consider consolidation"
else
  echo "  governance/ doc count ($count_governance) within threshold (100 max)"
fi

if [[ "$count_legacy" -gt 0 ]]; then
  echo "  legacy/ contains $count_legacy docs (review for archival or deletion)"
fi

echo ""
echo "total_surface: $total"
echo "status: OK (diagnostic)"
