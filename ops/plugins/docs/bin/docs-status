#!/usr/bin/env bash
set -euo pipefail

# docs.status â€” Verify workbench infrastructure docs strict-core baseline
# Safety: read-only (counts files, no modifications)

WORKBENCH="${WORKBENCH:-$HOME/code/workbench}"
DOCS_DIR="$WORKBENCH/docs/infrastructure"

_need() { command -v "$1" >/dev/null 2>&1 || { echo "STOP: missing dependency: $1" >&2; exit 2; }; }
_need find

if [[ ! -d "$DOCS_DIR" ]]; then
  echo "STOP: docs/infrastructure not found at $DOCS_DIR" >&2
  exit 2
fi

echo "docs.status"
echo "path: $DOCS_DIR"
echo

# Count by subdirectory (strict-core should have none)
printf "%-25s %-6s %-14s %s\n" "directory" "count" "expected" "status"
printf "%-25s %-6s %-14s %s\n" "-------------------------" "------" "--------------" "----------"

TOTAL=0
DEGRADED=0

for dir in $(find "$DOCS_DIR" -mindepth 1 -maxdepth 1 -type d | sort); do
  name="$(basename "$dir")"
  count="$(find "$dir" -type f \( -name '*.md' -o -name '*.yaml' -o -name '*.json' \) | wc -l | tr -d ' ')"
  expected="0 (strict-core)"
  status="DRIFT"
  DEGRADED=$((DEGRADED+1))
  printf "%-25s %-6s %-14s %s\n" "$name" "$count" "$expected" "$status"
  TOTAL=$((TOTAL + count))
done

# Top-level files (core SSOTs only; strict-core baseline expects at least 5)
TOP_COUNT="$(find "$DOCS_DIR" -maxdepth 1 -type f | wc -l | tr -d ' ')"
TOP_STATUS="OK"
if [[ "$TOP_COUNT" -lt 5 ]]; then TOP_STATUS="DRIFT"; fi
printf "%-25s %-6s %-14s %s\n" "(top-level)" "$TOP_COUNT" ">=5" "$TOP_STATUS"
TOTAL=$((TOTAL + TOP_COUNT))

echo
echo "total_files: $TOTAL"
echo "expected_minimum: 5"
if [[ "$TOTAL" -ge 5 ]] && [[ "$DEGRADED" -eq 0 ]]; then
  echo "status: OK"
else
  echo "status: DRIFT (strict-core baseline mismatch)"
fi
echo "degraded_dirs: $DEGRADED"
