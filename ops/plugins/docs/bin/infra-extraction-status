#!/usr/bin/env bash
set -euo pipefail

# infra.extraction.status â€” Track infrastructure extraction coverage into workbench
# Safety: read-only (checks file existence only)

WORKBENCH="${WORKBENCH:-$HOME/code/workbench}"

_need() { command -v "$1" >/dev/null 2>&1 || { echo "STOP: missing dependency: $1" >&2; exit 2; }; }
_need find
_need awk

echo "infra.extraction.status"
echo "workbench: $WORKBENCH"
echo

# 23 asset groups defined inline: check_group name path min_count
# "path" is relative to $WORKBENCH
# "min_count" is minimum expected files for EXTRACTED status

printf "%-22s %-6s %-6s %-14s\n" "asset_group" "found" "min" "status"
printf "%-22s %-6s %-6s %-14s\n" "----------------------" "------" "------" "--------------"

EXTRACTED=0
PARTIAL=0
NOT_EXTRACTED=0
TOTAL_GROUPS=0

# Workbench infra docs are quarantined under docs/legacy/** by design.
# Keep the literal docs/legacy reference on a single, clearly-marked line so
# docs.lint can distinguish intentional quarantine references from accidental coupling.
QUARANTINE_INFRA_DOCS="docs/legacy/infrastructure" # quarantine

check_group() {
  local name="$1" path="$2" min="$3"
  local full_path="$WORKBENCH/$path"
  local count=0

  TOTAL_GROUPS=$((TOTAL_GROUPS+1))

  if [[ ! -d "$full_path" ]]; then
    count=0
  elif [[ "$name" == "authority-docs" ]]; then
    count="$(find "$full_path" -maxdepth 1 -type f | wc -l | tr -d ' ')"
  else
    count="$(find "$full_path" -type f | wc -l | tr -d ' ')"
  fi

  local status
  if [[ "$count" -ge "$min" ]]; then
    status="EXTRACTED"
    EXTRACTED=$((EXTRACTED+1))
  elif [[ "$count" -gt 0 ]]; then
    status="PARTIAL"
    PARTIAL=$((PARTIAL+1))
  else
    status="NOT_EXTRACTED"
    NOT_EXTRACTED=$((NOT_EXTRACTED+1))
  fi

  printf "%-22s %-6s %-6s %-14s\n" "$name" "$count" "$min" "$status"
}

# The docs/infrastructure/** surfaces are pointer-only (see workbench AUTHORITY_INDEX.md).
check_group "runbooks"         "$QUARANTINE_INFRA_DOCS/runbooks"              30
check_group "reference"        "$QUARANTINE_INFRA_DOCS/reference"             16
check_group "locations"        "$QUARANTINE_INFRA_DOCS/reference/locations"   2
check_group "hardware"         "$QUARANTINE_INFRA_DOCS/reference/top-level"   2
check_group "architecture"     "$QUARANTINE_INFRA_DOCS/reference/architecture" 4
check_group "audits"           "$QUARANTINE_INFRA_DOCS/reference/audits"      5
check_group "cloudflare-docs"  "$QUARANTINE_INFRA_DOCS/reference/cloudflare"  3
check_group "domains"          "$QUARANTINE_INFRA_DOCS/reference/domains"     2
check_group "guides"           "$QUARANTINE_INFRA_DOCS/reference/guides"      6
check_group "homelab"          "$QUARANTINE_INFRA_DOCS/reference/homelab"     3
check_group "rag-docs"         "$QUARANTINE_INFRA_DOCS/reference/rag"         6
check_group "secrets-docs"     "$QUARANTINE_INFRA_DOCS/reference/secrets"     2
check_group "authority-docs"   "$QUARANTINE_INFRA_DOCS/reference"             18
check_group "mcp-docs"         "$QUARANTINE_INFRA_DOCS/reference/mcp"         3
check_group "microsoft-docs"   "$QUARANTINE_INFRA_DOCS/reference/microsoft"   2
check_group "n8n-docs"         "$QUARANTINE_INFRA_DOCS/reference/n8n"         3
check_group "compose-stacks"   "infra/compose"                     8
check_group "n8n-workflows"    "infra/compose/n8n/workflows"       30
check_group "mcpjungle"        "infra/compose/mcpjungle"           10
check_group "data-inventories" "infra/data"                        6
check_group "templates"        "infra/templates"                   5
check_group "cloudflare-ops"   "infra/cloudflare"                  3
check_group "dotfiles-ssh"     "dotfiles/ssh"                      3

echo
COVERAGE=$(awk -v e="$EXTRACTED" -v p="$PARTIAL" -v t="$TOTAL_GROUPS" 'BEGIN{printf "%.1f", (e + 0.5 * p) / t * 100}')
echo "extracted: $EXTRACTED"
echo "partial: $PARTIAL"
echo "not_extracted: $NOT_EXTRACTED"
echo "total_groups: $TOTAL_GROUPS"
echo "coverage: ${COVERAGE}%"

if (( EXTRACTED + PARTIAL >= TOTAL_GROUPS - 2 )); then
  echo "status: OK"
else
  echo "status: INCOMPLETE"
fi
