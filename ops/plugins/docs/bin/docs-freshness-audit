#!/usr/bin/env bash
set -euo pipefail

# docs.freshness.audit — Audit freshness of authoritative governance + core docs
# Safety: read-only (scans files, no modifications)
# Exit: always 0 (diagnostic capability, not enforcement)

ROOT="${SPINE_CODE:-$(cd "$(dirname "${BASH_SOURCE[0]}")/../../../.." && pwd)}"
GOV="$ROOT/docs/governance"
CORE="$ROOT/docs/core"

if [[ ! -d "$GOV" ]]; then
  echo "STOP: docs/governance/ not found at $GOV" >&2
  exit 2
fi

echo "docs.freshness.audit"
echo "root: $ROOT"
echo

TODAY_EPOCH=$(date +%s)
FRESH=0
WARN_COUNT=0
STALE_COUNT=0
MISSING_COUNT=0

# ─────────────────────────────────────────────────────────────────────────
# scan_dir — scan a directory for freshness metadata
# ─────────────────────────────────────────────────────────────────────────
scan_dir() {
  local dir="$1"
  local label="$2"

  if [[ ! -d "$dir" ]]; then
    echo "SKIP     $label/ (directory not found)"
    return
  fi

  echo "── $label ──"

  while IFS= read -r f; do
    rel="${f#$ROOT/}"

    # Extract last_verified or last_reviewed from first 15 lines
    # Handles YAML frontmatter (last_verified:) and markdown bold (**Last verified:**)
    date_str=""
    date_str="$(head -15 "$f" | grep -oE '[*]{0,2}(last_verified|last_reviewed|Last verified|Last reviewed)[*]{0,2}:[*]{0,2}[[:space:]]*[0-9]{4}-[0-9]{2}-[0-9]{2}' | head -1 | grep -oE '[0-9]{4}-[0-9]{2}-[0-9]{2}' || true)"

    if [[ -z "$date_str" ]]; then
      echo "MISSING  $rel"
      MISSING_COUNT=$((MISSING_COUNT+1))
      continue
    fi

    # Calculate age in days
    if date_epoch=$(date -j -f "%Y-%m-%d" "$date_str" +%s 2>/dev/null || date -d "$date_str" +%s 2>/dev/null); then
      age_days=$(( (TODAY_EPOCH - date_epoch) / 86400 ))
    else
      echo "MISSING  $rel (unparseable date: $date_str)"
      MISSING_COUNT=$((MISSING_COUNT+1))
      continue
    fi

    if [[ "$age_days" -gt 21 ]]; then
      echo "STALE    ${age_days}d  $rel  (last: $date_str)"
      STALE_COUNT=$((STALE_COUNT+1))
    elif [[ "$age_days" -gt 14 ]]; then
      echo "WARN     ${age_days}d  $rel  (last: $date_str)"
      WARN_COUNT=$((WARN_COUNT+1))
    else
      echo "FRESH    ${age_days}d  $rel  (last: $date_str)"
      FRESH=$((FRESH+1))
    fi
  done < <(find "$dir" -maxdepth 1 \( -name "*.md" -o -name "*.yaml" \) 2>/dev/null \
    | grep -v "_index.yaml" \
    | sort)

  echo
}

# ─────────────────────────────────────────────────────────────────────────
# Scan both governance and core authoritative directories
# ─────────────────────────────────────────────────────────────────────────
scan_dir "$GOV" "docs/governance"
scan_dir "$CORE" "docs/core"

# ─────────────────────────────────────────────────────────────────────────
# SUMMARY
# ─────────────────────────────────────────────────────────────────────────
echo "fresh: $FRESH"
echo "warn: $WARN_COUNT"
echo "stale: $STALE_COUNT"
echo "missing: $MISSING_COUNT"
echo "status: OK (diagnostic)"
