#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SPINE_ROOT="${SPINE_ROOT:-$(cd "$SCRIPT_DIR/../../../.." && pwd)}"
STATE_ROOT="${RECOVERY_STATE_ROOT:-$SPINE_ROOT/ops/plugins/recovery/state}"
COOLDOWN_DIR="${RECOVERY_COOLDOWN_DIR:-$STATE_ROOT/cooldown}"
ATTEMPTS_DIR="${RECOVERY_ATTEMPTS_DIR:-$STATE_ROOT/attempts}"
AUDIT_LOG="${RECOVERY_AUDIT_LOG:-$SPINE_ROOT/mailroom/logs/recovery-dispatch.ndjson}"
BINDING_FILE="${RECOVERY_ACTIONS_FILE:-$SPINE_ROOT/ops/bindings/recovery.actions.yaml}"
JSON_MODE=0

if [[ "${1:-}" == "--json" ]]; then
  JSON_MODE=1
fi

mkdir -p "$COOLDOWN_DIR" "$ATTEMPTS_DIR"

action_count=0
deterministic_actions=0
freshness_actions=0
if command -v yq >/dev/null 2>&1 && [[ -f "$BINDING_FILE" ]]; then
  action_count="$(yq e '.actions | length' "$BINDING_FILE" 2>/dev/null || echo 0)"
  deterministic_actions="$(yq e '[.actions[] | select((.trigger.failure_class // "deterministic") == "deterministic")] | length' "$BINDING_FILE" 2>/dev/null || echo 0)"
  freshness_actions="$(yq e '[.actions[] | select((.trigger.failure_class // "deterministic") == "freshness")] | length' "$BINDING_FILE" 2>/dev/null || echo 0)"
fi

if [[ "$JSON_MODE" -eq 1 ]]; then
  command -v jq >/dev/null 2>&1 || { echo "recovery.status FAIL: jq required for --json" >&2; exit 1; }
  jq -cn \
    --arg state_root "$STATE_ROOT" \
    --arg cooldown_dir "$COOLDOWN_DIR" \
    --arg attempts_dir "$ATTEMPTS_DIR" \
    --arg audit_log "$AUDIT_LOG" \
    --arg binding_file "$BINDING_FILE" \
    --argjson action_count "${action_count:-0}" \
    --argjson deterministic_actions "${deterministic_actions:-0}" \
    --argjson freshness_actions "${freshness_actions:-0}" \
    --argjson cooldown_files "$(find "$COOLDOWN_DIR" -type f -maxdepth 1 2>/dev/null | jq -R -s 'split("\n") | map(select(length > 0))')" \
    --argjson attempts_files "$(find "$ATTEMPTS_DIR" -type f -maxdepth 1 2>/dev/null | jq -R -s 'split("\n") | map(select(length > 0))')" \
    '{state_root:$state_root,cooldown_dir:$cooldown_dir,attempts_dir:$attempts_dir,audit_log:$audit_log,binding_file:$binding_file,action_count:$action_count,deterministic_actions:$deterministic_actions,freshness_actions:$freshness_actions,cooldown_files:$cooldown_files,attempt_files:$attempts_files}'
  exit 0
fi

echo "recovery.status"
echo "state_root: $STATE_ROOT"
echo "cooldown_dir: $COOLDOWN_DIR"
echo "attempts_dir: $ATTEMPTS_DIR"
echo "audit_log: $AUDIT_LOG"
echo "binding_file: $BINDING_FILE"
echo "action_count: $action_count"
echo "deterministic_actions: $deterministic_actions"
echo "freshness_actions: $freshness_actions"
echo

echo "attempt_counters:"
if find "$ATTEMPTS_DIR" -type f -maxdepth 1 | grep -q .; then
  while IFS= read -r f; do
    [[ -z "$f" ]] && continue
    printf '  %s=%s\n' "$(basename "$f")" "$(cat "$f" 2>/dev/null || echo 0)"
  done < <(find "$ATTEMPTS_DIR" -type f -maxdepth 1 | sort)
else
  echo "  (none)"
fi

echo "cooldowns:"
if find "$COOLDOWN_DIR" -type f -maxdepth 1 | grep -q .; then
  while IFS= read -r f; do
    [[ -z "$f" ]] && continue
    printf '  %s=%s\n' "$(basename "$f")" "$(cat "$f" 2>/dev/null || echo 0)"
  done < <(find "$COOLDOWN_DIR" -type f -maxdepth 1 | sort)
else
  echo "  (none)"
fi

echo "recent_audit:"
if [[ -f "$AUDIT_LOG" ]]; then
  tail -n 10 "$AUDIT_LOG"
else
  echo "  (no audit log yet)"
fi
