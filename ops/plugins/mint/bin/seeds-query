#!/usr/bin/env bash
# seeds-query - Query artwork_seeds on mint-data via SSH + psql
#
# Read-only. No mutations.
# STOP=2 on preconditions.
#
# Usage:
#   seeds-query                        # latest 20 seeds
#   seeds-query --status pending       # filter by status
#   seeds-query --source quote-page    # filter by source
#   seeds-query --email foo@bar.com    # filter by email
#   seeds-query --limit 50             # change result limit
#   seeds-query --count                # count only

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SPINE_ROOT="${SPINE_ROOT:-$(cd "$SCRIPT_DIR/../../../.." && pwd)}"
SSH_BINDING="$SPINE_ROOT/ops/bindings/ssh.targets.yaml"

stop(){ echo "STOP (2): $*" >&2; exit 2; }

command -v yq >/dev/null 2>&1 || stop "missing dependency: yq"
command -v ssh >/dev/null 2>&1 || stop "missing dependency: ssh"
[[ -f "$SSH_BINDING" ]] || stop "missing binding: $SSH_BINDING"

# Resolve mint-data SSH target
HOST="$(yq -r '.ssh.targets[] | select(.id == "mint-data") | .host' "$SSH_BINDING" | head -n1)"
USER="$(yq -r '.ssh.targets[] | select(.id == "mint-data") | .user // "ubuntu"' "$SSH_BINDING" | head -n1)"
[[ -n "$HOST" && "$HOST" != "null" ]] || stop "mint-data not found in ssh.targets"

# Parse args
STATUS="" SOURCE="" EMAIL="" LIMIT=20 COUNT_ONLY=false
while [[ $# -gt 0 ]]; do
  case "$1" in
    --status)  STATUS="$2"; shift 2 ;;
    --source)  SOURCE="$2"; shift 2 ;;
    --email)   EMAIL="$2"; shift 2 ;;
    --limit)   LIMIT="$2"; shift 2 ;;
    --count)   COUNT_ONLY=true; shift ;;
    *) stop "unknown arg: $1" ;;
  esac
done

# Validate inputs (prevent injection)
validate_input() {
  local val="$1" name="$2"
  if [[ "$val" =~ [^a-zA-Z0-9@._-] ]]; then
    stop "invalid $name value: $val (alphanumeric, @, ., _, - only)"
  fi
}
[[ -n "$STATUS" ]] && validate_input "$STATUS" "status"
[[ -n "$SOURCE" ]] && validate_input "$SOURCE" "source"
[[ -n "$EMAIL" ]]  && validate_input "$EMAIL" "email"
[[ "$LIMIT" =~ ^[0-9]+$ ]] || stop "invalid limit: $LIMIT"

# Build WHERE clause
WHERE_PARTS=()
[[ -n "$STATUS" ]] && WHERE_PARTS+=("status = '$STATUS'")
[[ -n "$SOURCE" ]] && WHERE_PARTS+=("source = '$SOURCE'")
[[ -n "$EMAIL" ]]  && WHERE_PARTS+=("customer_email = '$EMAIL'")

WHERE=""
if [[ ${#WHERE_PARTS[@]} -gt 0 ]]; then
  WHERE="WHERE $(IFS=" AND "; echo "${WHERE_PARTS[*]}")"
fi

SSH_OPTS=(-o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o BatchMode=yes -o LogLevel=ERROR)

echo "mint.seeds.query"
echo "host: ${USER}@${HOST} (mint-data VM 212)"
[[ -n "$STATUS" ]] && echo "filter.status: $STATUS"
[[ -n "$SOURCE" ]] && echo "filter.source: $SOURCE"
[[ -n "$EMAIL" ]]  && echo "filter.email: $EMAIL"
echo

if [[ "$COUNT_ONLY" == "true" ]]; then
  QUERY="SELECT count(*) AS total FROM artwork_seeds $WHERE;"
else
  QUERY="SELECT id, customer_email, source, status, created_at FROM artwork_seeds $WHERE ORDER BY created_at DESC LIMIT $LIMIT;"
fi

set +e
RESULT="$(ssh "${SSH_OPTS[@]}" "${USER}@${HOST}" \
  "docker exec mint-postgres psql -U postgres -d artwork -c \"$QUERY\"" 2>&1)"
rc=$?
set -e

if [[ "$rc" -ne 0 ]]; then
  echo "ERROR: query failed (rc=$rc)"
  echo "$RESULT"
  exit 1
fi

echo "$RESULT"
echo
echo "status: OK"
exit 0
