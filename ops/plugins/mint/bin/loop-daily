#!/usr/bin/env bash
# loop-daily - Run the mint-agent daily operating loop
#
# Executes the golden loop sequence:
#   1. agent.route mint-modules
#   2. verify.pack.run mint-agent
#   3. mint.modules.health
#   4. mint.migrate.dryrun
#
# Read-only. No mutations.
# STOP=2 on preconditions.
#
# Usage:
#   loop-daily              # run full loop
#   loop-daily --summary    # one-line summary only

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SPINE_ROOT="${SPINE_ROOT:-$(cd "$SCRIPT_DIR/../../../.." && pwd)}"
OPS="$SPINE_ROOT/bin/ops"

SUMMARY_ONLY=false
[[ "${1:-}" == "--summary" ]] && SUMMARY_ONLY=true

[[ -x "$OPS" ]] || { echo "STOP (2): ops entrypoint not found: $OPS" >&2; exit 2; }

echo "mint.loop.daily"
echo "started: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
echo ""

pass=0
fail=0
results=()

run_step() {
  local name="$1"
  shift
  local cap_args=("$@")
  local rc

  if [[ "$SUMMARY_ONLY" == "false" ]]; then
    echo "--- $name ---"
  fi

  set +e
  output=$("$OPS" cap run "${cap_args[@]}" 2>&1)
  rc=$?
  set -e

  if [[ "$rc" -eq 0 ]]; then
    pass=$((pass + 1))
    results+=("$name: PASS")
    if [[ "$SUMMARY_ONLY" == "false" ]]; then
      echo "$output" | tail -5
      echo ""
    fi
  else
    fail=$((fail + 1))
    results+=("$name: FAIL")
    if [[ "$SUMMARY_ONLY" == "false" ]]; then
      echo "$output" | tail -10
      echo ""
    fi
  fi
}

run_step "agent.route" agent.route mint-modules
run_step "verify.pack.run" verify.pack.run mint-agent
run_step "mint.modules.health" mint.modules.health
run_step "mint.migrate.dryrun" mint.migrate.dryrun

echo "=== SUMMARY ==="
for r in "${results[@]}"; do
  echo "  $r"
done
echo ""

total=$((pass + fail))
echo "result: ${pass}/${total} passed"

if [[ "$fail" -gt 0 ]]; then
  echo "status: FAIL"
  exit 1
fi

echo "status: OK"
