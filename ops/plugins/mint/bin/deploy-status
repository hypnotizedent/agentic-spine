#!/usr/bin/env bash
# deploy-status - Docker container status for mint fresh-slate VMs
#
# Checks mint-apps (VM 213) and mint-data (VM 212) compose stacks.
# Stack paths are read from docker.compose.targets.yaml to avoid hidden sub-stack drift.
# Reports container names, states, status, image, and stack source.
# Read-only. No mutations.
# STOP=2 on preconditions.
#
# Usage:
#   deploy-status                # check both VMs
#   deploy-status mint-apps      # check app plane only
#   deploy-status mint-data      # check data plane only

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SPINE_ROOT="${SPINE_ROOT:-$(cd "$SCRIPT_DIR/../../../.." && pwd)}"
SSH_BINDING="$SPINE_ROOT/ops/bindings/ssh.targets.yaml"
COMPOSE_BINDING="$SPINE_ROOT/ops/bindings/docker.compose.targets.yaml"
PROBE_BINDING="$SPINE_ROOT/ops/bindings/mint.probe.targets.yaml"

stop(){ echo "STOP (2): $*" >&2; exit 2; }

command -v yq >/dev/null 2>&1 || stop "missing dependency: yq"
command -v ssh >/dev/null 2>&1 || stop "missing dependency: ssh"
[[ -f "$SSH_BINDING" ]] || stop "missing binding: $SSH_BINDING"
[[ -f "$COMPOSE_BINDING" ]] || stop "missing binding: $COMPOSE_BINDING"
[[ -f "$PROBE_BINDING" ]] || stop "missing binding: $PROBE_BINDING"

FILTER="${1:-}"

SSH_OPTS=(-o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o BatchMode=yes -o LogLevel=ERROR)

DATA_TARGET_ID="$(yq -r '.targets.data_plane.ssh_target // ""' "$PROBE_BINDING")"
APP_TARGET_ID="$(yq -r '.targets.app_plane.ssh_target // ""' "$PROBE_BINDING")"
[[ -n "$DATA_TARGET_ID" && "$DATA_TARGET_ID" != "null" ]] || stop "missing data_plane.ssh_target in $PROBE_BINDING"
[[ -n "$APP_TARGET_ID" && "$APP_TARGET_ID" != "null" ]] || stop "missing app_plane.ssh_target in $PROBE_BINDING"
TARGETS=("$DATA_TARGET_ID" "$APP_TARGET_ID")

echo "mint.deploy.status"
echo "probe.binding: $PROBE_BINDING"
echo "targets: data=$DATA_TARGET_ID app=$APP_TARGET_ID"
echo

total=0
healthy=0
checked_targets=0

for target in "${TARGETS[@]}"; do
  if [[ -n "$FILTER" && "$target" != "$FILTER" ]]; then continue; fi
  checked_targets=$((checked_targets + 1))

  host="$(yq -r ".ssh.targets[] | select(.id == \"$target\") | .host" "$SSH_BINDING" | head -n1)"
  user="$(yq -r ".ssh.targets[] | select(.id == \"$target\") | .user // \"ubuntu\"" "$SSH_BINDING" | head -n1)"
  [[ -n "$host" && "$host" != "null" ]] || { echo "$target: NOT FOUND in ssh.targets"; continue; }

  echo "=== $target (${user}@${host}) ==="
  stack_count="$(yq -r ".targets.\"$target\".stacks | length" "$COMPOSE_BINDING")"
  if [[ "$stack_count" == "null" || -z "$stack_count" || "$stack_count" == "0" ]]; then
    echo "STATUS: NO STACKS DECLARED IN BINDING"
    echo
    continue
  fi

  printf "%-20s %-30s %-10s %-25s %s\n" "STACK" "CONTAINER" "STATE" "STATUS" "IMAGE"
  for ((i=0; i<stack_count; i++)); do
    stack_name="$(yq -r ".targets.\"$target\".stacks[$i].name // \"stack_$i\"" "$COMPOSE_BINDING")"
    stack_path="$(yq -r ".targets.\"$target\".stacks[$i].path // \"\"" "$COMPOSE_BINDING")"
    [[ -n "$stack_path" && "$stack_path" != "null" ]] || continue

    set +e
    out="$(ssh "${SSH_OPTS[@]}" "${user}@${host}" \
      "if [ -d \"$stack_path\" ]; then cd \"$stack_path\" && docker compose ps -a --format '{{.Name}}\t{{.State}}\t{{.Status}}\t{{.Image}}' 2>/dev/null; else echo '__STACK_PATH_MISSING__'; fi" 2>&1)"
    rc=$?
    set -e

    if [[ "$rc" -ne 0 ]]; then
      printf "%-20s %-30s %-10s %-25s %s\n" "$stack_name" "-" "FAIL" "rc=$rc" "$stack_path"
      continue
    fi

    if grep -q "__STACK_PATH_MISSING__" <<<"$out"; then
      printf "%-20s %-30s %-10s %-25s %s\n" "$stack_name" "-" "MISSING" "dir_missing" "$stack_path"
      continue
    fi

    if [[ -z "$out" ]]; then
      printf "%-20s %-30s %-10s %-25s %s\n" "$stack_name" "-" "EMPTY" "no_containers" "$stack_path"
      continue
    fi

    while IFS=$'\t' read -r name state status image; do
      [[ -n "$name" && -n "$state" && -n "$image" ]] || continue
      total=$((total + 1))
      printf "%-20s %-30s %-10s %-25s %s\n" "$stack_name" "$name" "$state" "$status" "$image"
      [[ "${state,,}" == "running" ]] && healthy=$((healthy + 1))
    done <<< "$out"
  done
  echo
done

if [[ -n "$FILTER" && "$checked_targets" -eq 0 ]]; then
  echo "STOP (2): unknown target '$FILTER'"
  exit 2
fi

echo "summary: $healthy/$total containers running"
if [[ "$healthy" -eq "$total" && "$total" -gt 0 ]]; then
  echo "status: OK"
elif [[ "$healthy" -gt 0 ]]; then
  echo "status: DEGRADED"
else
  echo "status: FAIL"
fi
exit 0
