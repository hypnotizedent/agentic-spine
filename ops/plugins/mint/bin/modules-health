#!/usr/bin/env bash
# modules-health - HTTP health probe for mint module endpoints (fresh-slate)
#
# Checks all app modules on mint-apps (VM 213) plus data plane on mint-data (VM 212):
#   files-api, quote-page, order-intake, finance-adapter, pricing, suppliers, shipping, payment
#   minio, postgres, redis
#
# Read-only. No mutations.
# STOP=2 on preconditions.
#
# Usage:
#   modules-health              # check all mint endpoints
#   modules-health <component>  # check specific component

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SPINE_ROOT="${SPINE_ROOT:-$(cd "$SCRIPT_DIR/../../../.." && pwd)}"
SSH_BINDING="$SPINE_ROOT/ops/bindings/ssh.targets.yaml"
PROBE_BINDING="$SPINE_ROOT/ops/bindings/mint.probe.targets.yaml"

stop(){ echo "STOP (2): $*" >&2; exit 2; }

command -v yq >/dev/null 2>&1 || stop "missing dependency: yq"
command -v curl >/dev/null 2>&1 || stop "missing dependency: curl"
command -v ssh >/dev/null 2>&1 || stop "missing dependency: ssh"
[[ -f "$SSH_BINDING" ]] || stop "missing binding: $SSH_BINDING"
[[ -f "$PROBE_BINDING" ]] || stop "missing binding: $PROBE_BINDING"

FILTER="${1:-}"

APP_TARGET_ID="$(yq -r '.targets.app_plane.ssh_target // ""' "$PROBE_BINDING")"
DATA_TARGET_ID="$(yq -r '.targets.data_plane.ssh_target // ""' "$PROBE_BINDING")"
[[ -n "$APP_TARGET_ID" && "$APP_TARGET_ID" != "null" ]] || stop "missing app plane target in $PROBE_BINDING"
[[ -n "$DATA_TARGET_ID" && "$DATA_TARGET_ID" != "null" ]] || stop "missing data plane target in $PROBE_BINDING"

MINT_APPS_HOST="$(yq -r ".ssh.targets[] | select(.id == \"$APP_TARGET_ID\") | .host" "$SSH_BINDING" | head -n1)"
MINT_DATA_HOST="$(yq -r ".ssh.targets[] | select(.id == \"$DATA_TARGET_ID\") | .host" "$SSH_BINDING" | head -n1)"
MINT_APPS_USER="$(yq -r ".ssh.targets[] | select(.id == \"$APP_TARGET_ID\") | .user // \"ubuntu\"" "$SSH_BINDING" | head -n1)"
MINT_DATA_USER="$(yq -r ".ssh.targets[] | select(.id == \"$DATA_TARGET_ID\") | .user // \"ubuntu\"" "$SSH_BINDING" | head -n1)"

[[ -n "$MINT_APPS_HOST" && "$MINT_APPS_HOST" != "null" ]] || stop "$APP_TARGET_ID not found in ssh.targets"
[[ -n "$MINT_DATA_HOST" && "$MINT_DATA_HOST" != "null" ]] || stop "$DATA_TARGET_ID not found in ssh.targets"

echo "mint.modules.health"
echo "probe.binding: $PROBE_BINDING"
echo "$APP_TARGET_ID: ${MINT_APPS_USER}@${MINT_APPS_HOST} (VM $(yq -r '.targets.app_plane.vm_id // "?"' "$PROBE_BINDING"))"
echo "$DATA_TARGET_ID: ${MINT_DATA_USER}@${MINT_DATA_HOST} (VM $(yq -r '.targets.data_plane.vm_id // "?"' "$PROBE_BINDING"))"
echo

declare -a HTTP_ROWS=()
while IFS=$'\t' read -r name port path; do
  [[ -z "$name" ]] && continue
  HTTP_ROWS+=("$name|$APP_TARGET_ID|http://${MINT_APPS_HOST}:${port}${path}")
done < <(yq -r '.targets.app_plane.http_checks[] | [.id, (.port|tostring), .health_path] | @tsv' "$PROBE_BINDING")

while IFS=$'\t' read -r name port path; do
  [[ -z "$name" ]] && continue
  HTTP_ROWS+=("$name|$DATA_TARGET_ID|http://${MINT_DATA_HOST}:${port}${path}")
done < <(yq -r '.targets.data_plane.http_checks[] | [.id, (.port|tostring), .health_path] | @tsv' "$PROBE_BINDING")

SSH_OPTS=(-o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o BatchMode=yes -o LogLevel=ERROR)

printf "%-16s %-10s %-10s %s\n" "COMPONENT" "STATUS" "TIME" "NOTE"

fail=0
checked=0

check_http() {
  local name="$1" target_id="$2" url="$3"
  if [[ -n "$FILTER" && "$name" != "$FILTER" ]]; then return; fi
  checked=$((checked + 1))
  local start_ms end_ms dur_ms http_code curl_exit
  start_ms="$(python3 -c 'import time; print(int(time.time()*1000))')"
  set +e
  http_code="$(curl -fsS -o /dev/null -w "%{http_code}" --connect-timeout 5 --max-time 10 "$url" 2>/dev/null)"
  curl_exit=$?
  set -e
  end_ms="$(python3 -c 'import time; print(int(time.time()*1000))')"
  dur_ms=$((end_ms - start_ms))
  if [[ "$curl_exit" -eq 0 && "$http_code" == "200" ]]; then
    printf "%-16s %-10s %-10s %s\n" "$name" "OK" "${dur_ms}ms" "target=$target_id"
  elif [[ "$curl_exit" -eq 0 ]]; then
    printf "%-16s %-10s %-10s %s\n" "$name" "DEGRADED" "${dur_ms}ms" "target=$target_id http=$http_code"
    fail=1
  elif [[ "$curl_exit" -eq 28 ]]; then
    printf "%-16s %-10s %-10s %s\n" "$name" "TIMEOUT" "${dur_ms}ms" "target=$target_id"
    fail=1
  elif [[ "$curl_exit" -eq 7 ]]; then
    printf "%-16s %-10s %-10s %s\n" "$name" "REFUSED" "${dur_ms}ms" "target=$target_id"
    fail=1
  else
    printf "%-16s %-10s %-10s %s\n" "$name" "FAIL" "${dur_ms}ms" "target=$target_id curl=$curl_exit"
    fail=1
  fi
}

check_ssh_service() {
  local name="$1" target_id="$2" host="$3" user="$4" cmd="$5"
  if [[ -n "$FILTER" && "$name" != "$FILTER" ]]; then return; fi
  checked=$((checked + 1))
  local start_ms end_ms dur_ms
  start_ms="$(python3 -c 'import time; print(int(time.time()*1000))')"
  set +e
  local out
  out="$(ssh "${SSH_OPTS[@]}" "${user}@${host}" "$cmd" 2>&1)"
  local rc=$?
  set -e
  end_ms="$(python3 -c 'import time; print(int(time.time()*1000))')"
  dur_ms=$((end_ms - start_ms))
  if [[ "$rc" -eq 0 ]]; then
    printf "%-16s %-10s %-10s %s\n" "$name" "OK" "${dur_ms}ms" "target=$target_id"
  else
    printf "%-16s %-10s %-10s %s\n" "$name" "FAIL" "${dur_ms}ms" "target=$target_id rc=$rc"
    fail=1
  fi
}

# HTTP checks
for row in "${HTTP_ROWS[@]}"; do
  IFS='|' read -r name target_id url <<< "$row"
  check_http "$name" "$target_id" "$url"
done

while IFS=$'\t' read -r name cmd; do
  [[ -z "$name" ]] && continue
  check_ssh_service "$name" "$DATA_TARGET_ID" "$MINT_DATA_HOST" "$MINT_DATA_USER" "$cmd"
done < <(yq -r '.targets.data_plane.ssh_checks[] | [.id, .command] | @tsv' "$PROBE_BINDING")

echo

if [[ "$checked" -eq 0 && -n "$FILTER" ]]; then
  echo "STOP (2): component '$FILTER' not found"
  exit 2
fi

if [[ "$fail" -eq 1 ]]; then
  echo "status: FAIL (some components unhealthy)"
else
  echo "status: OK (all components healthy)"
fi
exit 0
