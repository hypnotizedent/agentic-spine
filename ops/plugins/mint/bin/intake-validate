#!/usr/bin/env bash
# intake-validate - Validate a JSON payload against order-intake contract
#
# POSTs to the live order-intake /intake/validate endpoint on mint-apps.
# Read-only (validation only, no seed creation).
# STOP=2 on preconditions.
#
# Usage:
#   intake-validate <json-file>          # validate file contents
#   echo '{"key":"val"}' | intake-validate -   # validate from stdin

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SPINE_ROOT="${SPINE_ROOT:-$(cd "$SCRIPT_DIR/../../../.." && pwd)}"
SSH_BINDING="$SPINE_ROOT/ops/bindings/ssh.targets.yaml"

stop(){ echo "STOP (2): $*" >&2; exit 2; }

command -v yq >/dev/null 2>&1 || stop "missing dependency: yq"
command -v curl >/dev/null 2>&1 || stop "missing dependency: curl"
[[ -f "$SSH_BINDING" ]] || stop "missing binding: $SSH_BINDING"

INPUT="${1:-}"
[[ -n "$INPUT" ]] || stop "usage: intake-validate <json-file|-> (- for stdin)"

# Resolve mint-apps host
HOST="$(yq -r '.ssh.targets[] | select(.id == "mint-apps") | .host' "$SSH_BINDING" | head -n1)"
[[ -n "$HOST" && "$HOST" != "null" ]] || stop "mint-apps not found in ssh.targets"

VALIDATE_URL="http://${HOST}:3400/intake/validate"

echo "mint.intake.validate"
echo "endpoint: $VALIDATE_URL"
echo

# Read input
if [[ "$INPUT" == "-" ]]; then
  PAYLOAD="$(cat)"
else
  [[ -f "$INPUT" ]] || stop "file not found: $INPUT"
  PAYLOAD="$(cat "$INPUT")"
fi

# Validate it's JSON
if ! echo "$PAYLOAD" | python3 -c "import json,sys; json.load(sys.stdin)" 2>/dev/null; then
  stop "input is not valid JSON"
fi

echo "payload: $(echo "$PAYLOAD" | python3 -c "import json,sys; d=json.load(sys.stdin); print(f'{len(json.dumps(d))} bytes, {len(d)} top-level keys')")"
echo

# POST to validate endpoint
set +e
RESPONSE="$(curl -sS -X POST -H "Content-Type: application/json" \
  --connect-timeout 5 --max-time 10 \
  -d "$PAYLOAD" \
  "$VALIDATE_URL" 2>&1)"
curl_rc=$?
set -e

if [[ "$curl_rc" -ne 0 ]]; then
  echo "ERROR: curl failed (rc=$curl_rc)"
  echo "$RESPONSE"
  exit 1
fi

# Pretty-print response
echo "response:"
echo "$RESPONSE" | python3 -c "import json,sys; print(json.dumps(json.load(sys.stdin),indent=2))" 2>/dev/null || echo "$RESPONSE"
echo

# Check if valid
if echo "$RESPONSE" | python3 -c "import json,sys; d=json.load(sys.stdin); sys.exit(0 if d.get('valid') else 1)" 2>/dev/null; then
  echo "status: VALID"
else
  echo "status: INVALID"
fi
exit 0
