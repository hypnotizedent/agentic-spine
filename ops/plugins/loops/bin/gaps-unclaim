#!/usr/bin/env bash
set -euo pipefail

# gaps.unclaim â€” Release a gap claim
#
# Usage: gaps-unclaim --id <GAP_ID>
# Compat: gaps-unclaim <GAP_ID>
#
# Removes the claim file. Only the owning process (or stale-recovery)
# can release a claim.

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../../../.." && pwd)"
source "$ROOT/ops/plugins/loops/lib/gap-claims.sh"

if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
  echo "Usage: gaps-unclaim --id <GAP_ID>"
  echo "Compat: gaps-unclaim <GAP_ID>"
  exit 0
fi

GAP_ID=""
LEGACY_POSITIONAL=0

# Backward-compat positional id (deprecated)
if [[ "${1:-}" != "" && "${1:0:1}" != "-" ]]; then
  GAP_ID="$1"
  LEGACY_POSITIONAL=1
  shift
fi

while [[ $# -gt 0 ]]; do
  case "$1" in
    --id) GAP_ID="${2:?--id requires a value}"; shift 2 ;;
    *) echo "Unknown arg: $1" >&2; exit 2 ;;
  esac
done

[[ -n "$GAP_ID" ]] || { echo "FAIL: --id required" >&2; exit 2; }

if [[ "$LEGACY_POSITIONAL" -eq 1 ]]; then
  echo "WARN: positional GAP_ID is deprecated; use --id <GAP_ID>" >&2
fi

unclaim_gap "$GAP_ID" || exit 1

echo "UNCLAIMED: $GAP_ID"
