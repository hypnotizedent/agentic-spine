#!/usr/bin/env bash
set -euo pipefail

# network.home.dhcp.audit — Audit home UniFi DHCP reservations against device registry
# Uses UNIFI_HOME_API_KEY via X-API-KEY header (no cookie auth needed).
# Proxied through proxmox-home SSH (UDR7 is LAN-only).

SPINE_ROOT="${SPINE_ROOT:-$HOME/code/agentic-spine}"
REGISTRY="$SPINE_ROOT/ops/bindings/home.device.registry.yaml"
SSH_BINDING="$SPINE_ROOT/ops/bindings/ssh.targets.yaml"
INFISICAL_AGENT="$SPINE_ROOT/ops/tools/infisical-agent.sh"
TMPDIR_WORK=$(mktemp -d)
trap 'rm -rf "$TMPDIR_WORK"' EXIT

echo "network.home.dhcp.audit"
echo

# ── Dependencies ──
command -v yq >/dev/null 2>&1 || { echo "STOP (2): missing dependency: yq"; exit 2; }
command -v jq >/dev/null 2>&1 || { echo "STOP (2): missing dependency: jq"; exit 2; }
[[ -f "$REGISTRY" ]] || { echo "STOP (2): home.device.registry.yaml not found"; exit 2; }

# ── Resolve API key ──
API_KEY="${UNIFI_HOME_API_KEY:-}"
if [[ -z "$API_KEY" && -f "$INFISICAL_AGENT" ]]; then
  API_KEY="$("$INFISICAL_AGENT" get-cached home-assistant prod UNIFI_HOME_API_KEY 2>/dev/null || true)"
fi
if [[ -z "$API_KEY" ]]; then
  echo "STOP (2): UNIFI_HOME_API_KEY not available (check Infisical home-assistant/prod)"
  exit 2
fi

# ── Resolve SSH proxy ──
PROXY_HOST="$(yq -r '.ssh.targets[] | select(.id == "proxmox-home") | .host' "$SSH_BINDING")"
PROXY_USER="$(yq -r '.ssh.targets[] | select(.id == "proxmox-home") | .user // "root"' "$SSH_BINDING")"
UDR_HOST="$(yq -r '.ssh.targets[] | select(.id == "udr-home") | .host' "$SSH_BINDING")"

SSH_OPTS="-o ConnectTimeout=10 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o BatchMode=yes -o LogLevel=ERROR"

# ── Query UniFi API for all configured clients ──
api_b64="$(printf '%s' "$API_KEY" | base64)"

ssh $SSH_OPTS "${PROXY_USER}@${PROXY_HOST}" "bash -s" <<SSHEOF > "$TMPDIR_WORK/clients.json" 2>/dev/null
set -euo pipefail
api_key="\$(echo '$api_b64' | base64 -d)"
curl -sk "https://${UDR_HOST}/proxy/network/api/s/default/rest/user" \
  -H "X-API-KEY: \$api_key" \
  -H "Accept: application/json" 2>/dev/null
SSHEOF

if [[ ! -s "$TMPDIR_WORK/clients.json" ]]; then
  echo "FAIL: could not query UniFi API via proxmox-home"
  exit 1
fi

# ── Cross-reference against device registry ──
python3 - "$TMPDIR_WORK/clients.json" "$REGISTRY" << 'PYEOF'
import json, sys

try:
    import yaml
except ImportError:
    print("STOP (2): PyYAML not installed", file=sys.stderr)
    sys.exit(2)

clients_path, registry_path = sys.argv[1], sys.argv[2]

with open(clients_path) as f:
    api_data = json.load(f)
with open(registry_path) as f:
    registry = yaml.safe_load(f)

clients = {c['mac']: c for c in api_data.get('data', [])}
reg_devices = registry.get('devices', [])

errors = 0
warnings = 0
ok_count = 0

print("=" * 70)
print("HOME NETWORK DHCP AUDIT")
print("=" * 70)
print()

# Check 1: Registry devices with IPs should have DHCP reservations
print("--- DHCP Reservation Check ---")
for dev in reg_devices:
    mac_raw = dev.get('mac')
    if not mac_raw:
        continue
    mac = mac_raw.lower()
    ip = dev.get('ip')
    name = dev.get('name', 'unknown')

    if not ip or ip == 'dynamic':
        continue

    client = clients.get(mac)
    if not client:
        print(f"  WARN: {name} ({mac}) — not found in UniFi client list")
        warnings += 1
        continue

    has_reservation = client.get('use_fixedip', False)
    fixed_ip = client.get('fixed_ip', '')

    category = dev.get('category', 'unknown')
    # Personal/mobile devices don't need reservations
    needs_reservation = category in ('infrastructure', 'coordinator', 'iot')

    if has_reservation and fixed_ip == ip:
        print(f"  OK:   {name:25s} {ip:15s} reserved={fixed_ip}")
        ok_count += 1
    elif has_reservation and fixed_ip != ip:
        print(f"  FAIL: {name:25s} registry={ip} but reserved={fixed_ip}")
        errors += 1
    elif needs_reservation:
        print(f"  FAIL: {name:25s} {ip:15s} NO RESERVATION (will drift on reboot)")
        errors += 1
    else:
        print(f"  INFO: {name:25s} {ip:15s} no reservation (dynamic/{category} — expected)")
        ok_count += 1

print()

# Check 2: Unknown UniFi clients not in registry
print("--- Unknown Device Check ---")
reg_macs = {d['mac'].lower() for d in reg_devices if d.get('mac')}
unknown = []
for mac, client in sorted(clients.items(), key=lambda x: x[1].get('ip', x[1].get('last_ip', ''))):
    if mac not in reg_macs:
        ip = client.get('ip', client.get('last_ip', 'n/a'))
        name = client.get('name', client.get('hostname', 'unknown'))
        unknown.append((name, mac, ip))

if unknown:
    for name, mac, ip in unknown:
        print(f"  UNKNOWN: {name:25s} {mac}  {ip}")
    warnings += len(unknown)
else:
    print("  None — all UniFi clients are in the registry")

print()
print("=" * 70)
print(f"RESULT: {ok_count} OK, {errors} FAIL, {warnings} WARN")
if errors > 0:
    print("AUDIT FAIL — fix missing reservations or IP mismatches")
    sys.exit(1)
else:
    print("AUDIT PASS")
PYEOF

# ── Write YAML summary binding ──
SUMMARY_FILE="$SPINE_ROOT/ops/bindings/home.dhcp.audit.yaml"
TIMESTAMP="$(date -u '+%Y-%m-%dT%H:%M:%SZ')"
cat > "$SUMMARY_FILE" <<YAMLEOF
# Auto-generated by network.home.dhcp.audit — do not edit manually
schema_version: 1
generated: "$TIMESTAMP"
summary:
  registry_devices_checked: $(python3 -c "
import yaml, sys
with open('$REGISTRY') as f:
    r = yaml.safe_load(f)
devs = [d for d in r.get('devices', []) if d.get('mac') and d.get('ip') and d.get('ip') != 'dynamic']
print(len(devs))
")
  unifi_clients_total: $(jq '.data | length' "$TMPDIR_WORK/clients.json")
YAMLEOF
echo "Summary written to $SUMMARY_FILE"
