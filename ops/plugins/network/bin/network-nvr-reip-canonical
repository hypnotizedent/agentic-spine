#!/usr/bin/env bash
# network-nvr-reip-canonical — Re-IP Hikvision NVR to canonical .216 via ISAPI
#
# Mutating capability. Requires manual approval.
#
# Steps:
#  1. Read canonical target IP from DEVICE_IDENTITY_SSOT.md for nvr-shop
#  2. Discover current IP (UniFi by MAC or --current-ip flag)
#  3. Get NVR credentials from Infisical
#  4. Execute ISAPI PUT from pve (digest auth)
#  5. Verify from pve (ping, neigh MAC, HTTP banner)
#
# Usage:
#   network-nvr-reip-canonical                    # auto-discover current IP via UniFi
#   network-nvr-reip-canonical --current-ip X.X.X.X  # specify current IP
#
# Exit:
#   0  OK (re-IP succeeded + verified)
#   1  FAIL (re-IP failed or verification failed)
#   2  STOP (missing deps)
#
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SPINE_ROOT="${SPINE_ROOT:-$(cd "$SCRIPT_DIR/../../../.." && pwd)}"

SSH_BINDING="$SPINE_ROOT/ops/bindings/ssh.targets.yaml"
SSOT_DEVICE="$SPINE_ROOT/docs/governance/DEVICE_IDENTITY_SSOT.md"
UNIFI_AGENT="$SPINE_ROOT/ops/tools/unifi-agent.sh"
INFISICAL_AGENT="$SPINE_ROOT/ops/tools/infisical-agent.sh"

NVR_MAC="24:0f:9b:30:f1:e7"
NVR_ID="nvr-shop"

stop(){ echo "STOP (2): $*" >&2; exit 2; }

command -v yq >/dev/null 2>&1 || stop "missing dependency: yq"
command -v jq >/dev/null 2>&1 || stop "missing dependency: jq"
command -v ssh >/dev/null 2>&1 || stop "missing dependency: ssh"
[[ -f "$SSH_BINDING" ]] || stop "missing binding: $SSH_BINDING"
[[ -f "$SSOT_DEVICE" ]] || stop "missing SSOT: $SSOT_DEVICE"
[[ -f "$INFISICAL_AGENT" ]] || stop "missing infisical-agent.sh"

# Parse args
CURRENT_IP=""
while [[ $# -gt 0 ]]; do
  case "$1" in
    --current-ip) CURRENT_IP="${2:-}"; shift 2 ;;
    -h|--help) echo "Usage: network-nvr-reip-canonical [--current-ip X.X.X.X]"; exit 0 ;;
    *) shift ;;
  esac
done

# ── Resolve canonical target IP from SSOT ──
CANONICAL_IP="$(yq -r ".ssh.targets[] | select(.id == \"$NVR_ID\") | .host" "$SSH_BINDING")"
[[ -n "$CANONICAL_IP" && "$CANONICAL_IP" != "null" ]] || stop "nvr-shop not found in ssh.targets.yaml"

echo "network.nvr.reip.canonical"
echo "device: $NVR_ID"
echo "canonical_ip: $CANONICAL_IP"
echo "mac: $NVR_MAC"
echo

# ── Resolve pve SSH ──
PVE_HOST="$(yq -r '.ssh.targets[] | select(.id == "pve") | .host' "$SSH_BINDING")"
PVE_USER="$(yq -r '.ssh.targets[] | select(.id == "pve") | .user // "root"' "$SSH_BINDING")"
[[ -n "$PVE_HOST" && "$PVE_HOST" != "null" ]] || stop "pve not found in ssh.targets.yaml"

DEF_STRICT="$(yq -r '.ssh.defaults.strict_host_key_checking // "no"' "$SSH_BINDING")"
DEF_KNOWN_HOSTS="$(yq -r '.ssh.defaults.user_known_hosts_file // "/dev/null"' "$SSH_BINDING")"
DEF_TO="$(yq -r '.ssh.defaults.connect_timeout_sec // 5' "$SSH_BINDING")"

ssh_opts=(
  -o "ConnectTimeout=${DEF_TO}"
  -o "StrictHostKeyChecking=${DEF_STRICT}"
  -o "UserKnownHostsFile=${DEF_KNOWN_HOSTS}"
  -o "BatchMode=yes"
  -o "LogLevel=ERROR"
)

# Test pve reachability
if ! ssh "${ssh_opts[@]}" "${PVE_USER}@${PVE_HOST}" "echo ok" >/dev/null 2>&1; then
  stop "cannot reach pve at ${PVE_USER}@${PVE_HOST}"
fi

# ── Discover current IP ──
if [[ -z "$CURRENT_IP" ]]; then
  echo "discovering current IP via UniFi (MAC=$NVR_MAC)..."
  if [[ -x "$UNIFI_AGENT" ]]; then
    clients_json="$("$UNIFI_AGENT" clients --json 2>/dev/null || true)"
    if [[ -n "$clients_json" ]]; then
      CURRENT_IP="$(echo "$clients_json" | jq -r --arg mac "$NVR_MAC" '.[] | select(.mac == $mac) | .ip // empty' 2>/dev/null || true)"
    fi
  fi

  if [[ -z "$CURRENT_IP" ]]; then
    echo "FAIL: could not discover NVR current IP via UniFi"
    echo "hint: run with --current-ip <ip> or ensure UniFi credentials are set"
    exit 1
  fi
fi

echo "current_ip: $CURRENT_IP"

if [[ "$CURRENT_IP" == "$CANONICAL_IP" ]]; then
  echo
  echo "NVR is already at canonical IP $CANONICAL_IP — no re-IP needed"
  echo "result: OK (already canonical)"
  exit 0
fi

echo

# ── Get NVR credentials ──
echo "resolving NVR credentials..."
NVR_USER="${NVR_ADMIN_USER:-}"
NVR_PASS="${NVR_ADMIN_PASSWORD:-}"

if [[ -z "$NVR_USER" || -z "$NVR_PASS" ]]; then
  NVR_USER="$("$INFISICAL_AGENT" get-cached infrastructure prod NVR_ADMIN_USER 2>/dev/null || true)"
  NVR_PASS="$("$INFISICAL_AGENT" get-cached infrastructure prod NVR_ADMIN_PASSWORD 2>/dev/null || true)"
fi

if [[ -z "$NVR_USER" || -z "$NVR_PASS" ]]; then
  echo "FAIL: NVR credentials not available"
  echo "hint: ops cap run secrets.set.interactive infrastructure prod"
  echo "      then set keys NVR_ADMIN_USER and NVR_ADMIN_PASSWORD"
  exit 1
fi
echo "credentials: resolved (user only: $NVR_USER)"
echo

# ── Execute ISAPI re-IP from pve ──
echo "executing ISAPI PUT to re-IP $CURRENT_IP -> $CANONICAL_IP..."

ISAPI_XML="<NetworkInterface><IPAddress><ipVersion>v4</ipVersion><addressingType>static</addressingType><ipAddress>${CANONICAL_IP}</ipAddress><subnetMask>255.255.255.0</subnetMask><DefaultGateway><ipAddress>192.168.1.1</ipAddress></DefaultGateway><PrimaryDNS><ipAddress>192.168.1.204</ipAddress></PrimaryDNS></IPAddress></NetworkInterface>"

set +e
isapi_result="$(
  ssh "${ssh_opts[@]}" "${PVE_USER}@${PVE_HOST}" "bash -s" <<EOF
set -euo pipefail
umask 077

current_ip=$(printf '%q' "$CURRENT_IP")
nvr_user=$(printf '%q' "$NVR_USER")
nvr_pass=$(printf '%q' "$NVR_PASS")

xml="$(cat <<'XML'
$ISAPI_XML
XML
)"

netrc="\$(mktemp /tmp/nvr-netrc.XXXXXX)"
cleanup(){ rm -f "\$netrc" 2>/dev/null || true; }
trap cleanup EXIT INT TERM

chmod 600 "\$netrc"
cat > "\$netrc" <<NETRC
machine \$current_ip
login \$nvr_user
password \$nvr_pass
NETRC

resp="\$(printf '%s' "\$xml" | curl -sk --digest --netrc-file "\$netrc" -X PUT "http://\${current_ip}/ISAPI/System/Network/interfaces/1" \
  -H "Content-Type: application/xml" \
  --data-binary @- \
  -w '\\n%{http_code}' 2>/dev/null || true)"

echo "\$resp"
EOF
)" 2>/dev/null
isapi_rc=$?
set -e

http_code="$(echo "$isapi_result" | tail -1)"
response_body="$(echo "$isapi_result" | head -n -1)"

echo "ISAPI response: HTTP $http_code"

if [[ "$http_code" != "200" ]]; then
  echo "FAIL: ISAPI PUT returned HTTP $http_code"
  echo "response: $response_body"
  exit 1
fi

echo "ISAPI PUT accepted. Waiting 15s for NVR to apply new IP..."
sleep 15

# ── Verify from pve ──
echo
echo "== verification =="

verify_script="$(cat <<VERIFY
set -e
echo "ping:"
if ping -c3 -W2 ${CANONICAL_IP} >/dev/null 2>&1; then
  echo "  ok"
else
  echo "  fail"
fi

echo "neigh:"
neigh="\$(ip neigh show ${CANONICAL_IP} 2>/dev/null | head -1)"
echo "  \$neigh"
mac="\$(echo "\$neigh" | grep -oP '([0-9a-f]{2}:){5}[0-9a-f]{2}' || echo 'unknown')"
echo "  mac: \$mac"

echo "http:"
http_code="\$(curl -sk -o /dev/null -w '%{http_code}' --max-time 5 "http://${CANONICAL_IP}/" 2>/dev/null || echo '000')"
echo "  status: \$http_code"
VERIFY
)"

verify_output="$(ssh "${ssh_opts[@]}" "${PVE_USER}@${PVE_HOST}" "bash -c $(printf '%q' "$verify_script")" 2>/dev/null)" || true
echo "$verify_output"

# Check results
ping_ok=0
mac_ok=0
http_ok=0

echo "$verify_output" | grep -q 'ping:' && echo "$verify_output" | grep -A1 'ping:' | grep -q 'ok' && ping_ok=1
echo "$verify_output" | grep -qi "$NVR_MAC" && mac_ok=1
http_status="$(echo "$verify_output" | grep 'status:' | tail -1 | awk '{print $2}')"
[[ "$http_status" == "200" || "$http_status" == "401" ]] && http_ok=1

echo
echo "== summary =="
echo "  ping: $([ $ping_ok -eq 1 ] && echo 'PASS' || echo 'FAIL')"
echo "  mac:  $([ $mac_ok -eq 1 ] && echo "PASS ($NVR_MAC)" || echo 'FAIL (MAC mismatch)')"
echo "  http: $([ $http_ok -eq 1 ] && echo "PASS (HTTP $http_status)" || echo "FAIL (HTTP $http_status)")"
echo

if [[ $ping_ok -eq 1 && $mac_ok -eq 1 && $http_ok -eq 1 ]]; then
  echo "result: OK (NVR re-IP to $CANONICAL_IP verified)"
  exit 0
else
  echo "result: FAIL (verification incomplete — check manually)"
  exit 1
fi
