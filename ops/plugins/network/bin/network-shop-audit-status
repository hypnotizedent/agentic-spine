#!/usr/bin/env bash
# network-shop-audit-status - Composite shop-network SSOT parity audit (local files only)
#
# Checks (no SSH/ping; pure SSOT + bindings):
#  1) Duplicate IPs in ssh.targets.yaml (IPv4 only)
#  2) ssh.targets.yaml ↔ DEVICE_IDENTITY_SSOT.md parity (Shop LAN endpoints)
#  3) ssh.targets.yaml ↔ SHOP_SERVER_SSOT.md parity (shop managed device rows)
#  4) Cross-SSOT parity (DEVICE_IDENTITY_SSOT ↔ SHOP_SERVER_SSOT)
#  5) Coverage: Shop LAN endpoints in DEVICE_IDENTITY_SSOT must exist in ssh.targets.yaml
#
# Exit:
#  0 PASS
#  1 FAIL (drift findings)
#  2 STOP (preconditions)
#
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SPINE_ROOT="${SPINE_ROOT:-$(cd "$SCRIPT_DIR/../../../.." && pwd)}"

BINDING="$SPINE_ROOT/ops/bindings/ssh.targets.yaml"
SSOT_DEVICE="$SPINE_ROOT/docs/governance/DEVICE_IDENTITY_SSOT.md"
SSOT_SHOP="$SPINE_ROOT/docs/governance/SHOP_SERVER_SSOT.md"

stop(){ echo "STOP (2): $*" >&2; exit 2; }

command -v yq >/dev/null 2>&1 || stop "missing dependency: yq (brew install yq)"
command -v python3 >/dev/null 2>&1 || stop "missing dependency: python3"
[[ -f "$BINDING" ]] || stop "missing binding: $BINDING"
[[ -f "$SSOT_DEVICE" ]] || stop "missing SSOT: $SSOT_DEVICE"
[[ -f "$SSOT_SHOP" ]] || stop "missing SSOT: $SSOT_SHOP"

tmpdir="$(mktemp -d /tmp/network-shop-audit.XXXXXX)"
cleanup(){ rm -rf "$tmpdir" 2>/dev/null || true; }
trap cleanup EXIT INT TERM

findings=0

echo "network.shop.audit.status"
echo "binding: $BINDING"
echo "ssot-device: $SSOT_DEVICE"
echo "ssot-shop: $SSOT_SHOP"
echo

# ── Extract bindings: id -> host (IPv4 only) ───────────────────────────────
bindings_tsv="$tmpdir/bindings.tsv"
yq -r '.ssh.targets[] | [.id, (.host // "")] | @tsv' "$BINDING" \
  | awk -F'\t' 'NF>=2 && $1!="null" && $2 ~ /^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$/ {print $1 "\t" $2}' \
  > "$bindings_tsv"

# ── Extract DEVICE_IDENTITY shop LAN endpoints: id -> ip ───────────────────
device_tsv="$tmpdir/device.tsv"
python3 - "$SSOT_DEVICE" >"$device_tsv" <<'PY'
import re,sys
path=sys.argv[1]
rows=[]
for line in open(path,'r',encoding='utf-8',errors='ignore'):
    if not line.startswith("|"): continue
    parts=[p.strip() for p in line.strip().split("|")[1:-1]]
    if len(parts) < 3: continue
    site=parts[0]
    if site != "Shop": continue
    dev=parts[1].strip("`").strip()
    ip=parts[2].strip()
    if not re.match(r"^\d+\.\d+\.\d+\.\d+$", ip): continue
    if not dev: continue
    rows.append((dev, ip))
for dev,ip in rows:
    print(f"{dev}\t{ip}")
PY

# ── Extract SHOP_SERVER "Devices" table: id -> ip (best-effort) ────────────
shop_tsv="$tmpdir/shop.tsv"
python3 - "$SSOT_SHOP" >"$shop_tsv" <<'PY'
import re,sys
path=sys.argv[1]
rows=[]
for line in open(path,'r',encoding='utf-8',errors='ignore'):
    if not line.startswith("|"): continue
    parts=[p.strip() for p in line.strip().split("|")[1:-1]]
    # Look for rows like: | WiFi AP | `ap-shop` (EAP225) | `http://192.168.1.185` | ...
    if len(parts) < 3: continue
    namecol=parts[1]
    m=re.search(r"`([a-z0-9\\-]+)`", namecol)
    if not m: continue
    dev=m.group(1)
    ipm=re.search(r"(\\d+\\.\\d+\\.\\d+\\.\\d+)", " ".join(parts))
    if not ipm: continue
    ip=ipm.group(1)
    rows.append((dev, ip))
for dev,ip in rows:
    print(f"{dev}\t{ip}")
PY

echo -n "check 1: duplicate IPs in bindings... "
dup_report="$tmpdir/dup.txt"
awk -F'\t' '{print $2}' "$bindings_tsv" | sort | uniq -c | awk '$1>1 {print $2 "\t" $1}' > "$dup_report" || true
if [[ -s "$dup_report" ]]; then
  echo "FAIL"
  while IFS=$'\t' read -r ip count; do
    ids="$(awk -F'\t' -v ip="$ip" '$2==ip {print $1}' "$bindings_tsv" | tr '\n' ' ' | sed 's/ $//')"
    echo "  DRIFT: duplicate_ip ip=$ip count=$count ids=[$ids]"
  done < "$dup_report"
  findings=$((findings + $(wc -l <"$dup_report" | tr -d ' ')))
else
  echo "OK"
fi

echo -n "check 2: binding ↔ DEVICE_IDENTITY parity... "
par2="$tmpdir/par2.txt"
python3 - "$bindings_tsv" "$device_tsv" >"$par2" <<'PY'
import sys
bind={}
for line in open(sys.argv[1],'r'):
    dev,ip=line.rstrip("\n").split("\t",1)
    bind[dev]=ip
devss={}
for line in open(sys.argv[2],'r'):
    dev,ip=line.rstrip("\n").split("\t",1)
    devss[dev]=ip
drifts=[]
for dev,ip in devss.items():
    if dev in bind and bind[dev]!=ip:
        drifts.append((dev,bind[dev],ip))
for dev,bip,dip in sorted(drifts):
    print(f"{dev}\t{bip}\t{dip}")
PY
if [[ -s "$par2" ]]; then
  echo "FAIL"
  while IFS=$'\t' read -r dev bip dip; do
    echo "  DRIFT: ${dev} binding=${bip} DEVICE_IDENTITY_SSOT=${dip}"
    echo "    fix: $SSOT_DEVICE (Shop row for \`${dev}\`)"
  done < "$par2"
  findings=$((findings + $(wc -l <"$par2" | tr -d ' ')))
else
  echo "OK"
fi

echo -n "check 3: binding ↔ SHOP_SERVER parity... "
par3="$tmpdir/par3.txt"
python3 - "$bindings_tsv" "$shop_tsv" >"$par3" <<'PY'
import sys
bind={}
for line in open(sys.argv[1],'r'):
    dev,ip=line.rstrip("\n").split("\t",1)
    bind[dev]=ip
shop={}
for line in open(sys.argv[2],'r'):
    dev,ip=line.rstrip("\n").split("\t",1)
    shop[dev]=ip
drifts=[]
for dev,ip in shop.items():
    if dev in bind and bind[dev]!=ip:
        drifts.append((dev,bind[dev],ip))
for dev,bip,sip in sorted(drifts):
    print(f"{dev}\t{bip}\t{sip}")
PY
if [[ -s "$par3" ]]; then
  echo "FAIL"
  while IFS=$'\t' read -r dev bip sip; do
    echo "  DRIFT: ${dev} binding=${bip} SHOP_SERVER_SSOT=${sip}"
    echo "    fix: $SSOT_SHOP (row containing \`${dev}\`)"
  done < "$par3"
  findings=$((findings + $(wc -l <"$par3" | tr -d ' ')))
else
  echo "OK"
fi

echo -n "check 4: cross-SSOT parity (DEVICE_IDENTITY ↔ SHOP_SERVER)... "
par4="$tmpdir/par4.txt"
python3 - "$device_tsv" "$shop_tsv" >"$par4" <<'PY'
import sys
devss={}
for line in open(sys.argv[1],'r'):
    dev,ip=line.rstrip("\n").split("\t",1)
    devss[dev]=ip
shop={}
for line in open(sys.argv[2],'r'):
    dev,ip=line.rstrip("\n").split("\t",1)
    shop[dev]=ip
drifts=[]
for dev,ip in devss.items():
    if dev in shop and shop[dev]!=ip:
        drifts.append((dev,ip,shop[dev]))
for dev,dip,sip in sorted(drifts):
    print(f"{dev}\t{dip}\t{sip}")
PY
if [[ -s "$par4" ]]; then
  echo "FAIL"
  while IFS=$'\t' read -r dev dip sip; do
    echo "  DRIFT: ${dev} DEVICE_IDENTITY_SSOT=${dip} SHOP_SERVER_SSOT=${sip}"
    echo "    fix: $SSOT_DEVICE and/or $SSOT_SHOP"
  done < "$par4"
  findings=$((findings + $(wc -l <"$par4" | tr -d ' ')))
else
  echo "OK"
fi

echo -n "check 5: coverage (SSOT devices → bindings)... "
par5="$tmpdir/par5.txt"
python3 - "$device_tsv" "$bindings_tsv" >"$par5" <<'PY'
import sys
devs=set()
for line in open(sys.argv[1],'r'):
    dev,_ip=line.rstrip("\n").split("\t",1)
    devs.add(dev)
bind=set()
for line in open(sys.argv[2],'r'):
    dev,_ip=line.rstrip("\n").split("\t",1)
    bind.add(dev)
missing=sorted([d for d in devs if d not in bind])
for d in missing:
    print(d)
PY
if [[ -s "$par5" ]]; then
  echo "FAIL"
  while read -r dev; do
    echo "  DRIFT: missing_binding id=${dev}"
    echo "    fix: $BINDING (add ssh.targets entry for \`${dev}\`)"
  done < "$par5"
  findings=$((findings + $(wc -l <"$par5" | tr -d ' ')))
else
  echo "OK"
fi

echo
echo "DRIFT FINDINGS: $findings"
echo
if [[ "$findings" -eq 0 ]]; then
  echo "result: PASS"
  exit 0
fi
echo "result: FAIL (${findings} drift finding(s))"
exit 1

