#!/usr/bin/env bash
# network-unifi-clients-snapshot â€” Snapshot UniFi client list (MAC/IP/name)
#
# Thin wrapper around unifi-agent.sh clients.
# Registered as capability: network.unifi.clients.snapshot
#
# Exit:
#   0  OK
#   1  FAIL
#   2  STOP (missing deps)
#
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SPINE_ROOT="${SPINE_ROOT:-$(cd "$SCRIPT_DIR/../../../.." && pwd)}"
AGENT="$SPINE_ROOT/ops/tools/unifi-agent.sh"
OBSERVED_BINDING="$SPINE_ROOT/ops/bindings/network.unifi.shop.clients.observed.yaml"

[[ -f "$AGENT" ]] || { echo "STOP (2): missing unifi-agent.sh at $AGENT"; exit 2; }
[[ -x "$AGENT" ]] || { echo "STOP (2): unifi-agent.sh not executable"; exit 2; }
[[ -f "$OBSERVED_BINDING" ]] || { echo "STOP (2): missing observed binding: $OBSERVED_BINDING"; exit 2; }
command -v yq >/dev/null 2>&1 || { echo "STOP (2): missing dependency: yq"; exit 2; }

echo "network.unifi.clients.snapshot"
echo

"$AGENT" clients "$@"

NOW_UTC="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
TODAY_UTC="$(date -u +%Y-%m-%d)"
yq -i \
  ".generated_at = \"$NOW_UTC\" | .updated_at = \"$TODAY_UTC\" | .last_verified = \"$TODAY_UTC\"" \
  "$OBSERVED_BINDING"
