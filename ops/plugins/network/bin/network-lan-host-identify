#!/usr/bin/env bash
# network-lan-host-identify - Identify LAN host(s) via probe_via (ping + ARP/neigh + best-effort HTTP banner)
#
# Read-only. Intended to resolve SSOT drift when a device's IP moved (e.g., AP).
#
# Usage:
#   network-lan-host-identify --probe-via pve 192.168.1.185 192.168.1.249
#
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SPINE_ROOT="${SPINE_ROOT:-$(cd "$SCRIPT_DIR/../../../.." && pwd)}"
SSH_BINDING="$SPINE_ROOT/ops/bindings/ssh.targets.yaml"

stop(){ echo "STOP (2): $*" >&2; exit 2; }

command -v yq >/dev/null 2>&1 || stop "missing dependency: yq"
command -v ssh >/dev/null 2>&1 || stop "missing dependency: ssh"
[[ -f "$SSH_BINDING" ]] || stop "missing binding: $SSH_BINDING"

PROBE_VIA="pve"
ips=()

while [[ $# -gt 0 ]]; do
  case "$1" in
    --probe-via) PROBE_VIA="${2:-}"; shift 2 ;;
    -h|--help)
      sed -n '1,60p' "$0" | sed 's/^# //'
      exit 0
      ;;
    *)
      ips+=("$1")
      shift
      ;;
  esac
done

[[ "${#ips[@]}" -gt 0 ]] || stop "no IPs provided"

DEF_STRICT="$(yq -r '.ssh.defaults.strict_host_key_checking // "no"' "$SSH_BINDING")"
DEF_KNOWN_HOSTS="$(yq -r '.ssh.defaults.user_known_hosts_file // "/dev/null"' "$SSH_BINDING")"
DEF_TO="$(yq -r '.ssh.defaults.connect_timeout_sec // 5' "$SSH_BINDING")"

probe_host="$(yq -r ".ssh.targets[] | select(.id == \"$PROBE_VIA\") | .host" "$SSH_BINDING")"
probe_user="$(yq -r ".ssh.targets[] | select(.id == \"$PROBE_VIA\") | .user // \"root\"" "$SSH_BINDING")"
[[ -n "$probe_host" && "$probe_host" != "null" ]] || stop "probe_via '$PROBE_VIA' not found in ssh.targets.yaml"

ssh_opts=(
  -o "ConnectTimeout=${DEF_TO}"
  -o "StrictHostKeyChecking=${DEF_STRICT}"
  -o "UserKnownHostsFile=${DEF_KNOWN_HOSTS}"
  -o "BatchMode=yes"
  -o "LogLevel=ERROR"
)

echo "network.lan.host.identify"
echo "binding: $SSH_BINDING"
echo "probe_via: $PROBE_VIA (${probe_user}@${probe_host})"
echo

remote="$(cat <<'SH'
set -euo pipefail
ip="$1"
echo "== ${ip} =="

if ping -c1 -W1 "$ip" >/dev/null 2>&1; then
  echo "ping: ok"
else
  echo "ping: fail"
fi

echo "neigh:"
ip neigh show "$ip" 2>/dev/null || true

echo "tcp:"
for p in 80 443 22; do
  if command -v timeout >/dev/null 2>&1; then
    if timeout 2 bash -lc "cat < /dev/null > /dev/tcp/$ip/$p" >/dev/null 2>&1; then
      echo "  $p: open"
    else
      echo "  $p: closed"
    fi
  else
    echo "  $p: skip (no timeout)"
  fi
done

echo "http.banner:"
if command -v curl >/dev/null 2>&1; then
  curl -sS -I --max-time 2 "http://$ip/" 2>/dev/null | tr -d "\r" | sed -n '1,6p' || true
else
  echo "  skip (no curl)"
fi
echo
SH
)"

for ip in "${ips[@]}"; do
  ssh "${ssh_opts[@]}" "${probe_user}@${probe_host}" "bash -lc $(printf "%q" "$remote") -- $(printf "%q" "$ip")" || true
done

echo "status: OK"
exit 0
