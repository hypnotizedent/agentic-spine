#!/usr/bin/env bash
set -euo pipefail

# host-macbook-drift-check
#
# Read-only drift check for MacBook host alignment to spine/workbench governance.
#
# Checks:
# - Claude entrypoint shim compliance (enforced)
# - Workbench hotkey docs + managed-config symlink invariants
#
# Exits nonzero on drift.

SPINE="${SPINE_REPO:-$HOME/code/agentic-spine}"
WORKBENCH="${WORKBENCH_REPO:-$HOME/code/workbench}"

echo "=== host.macbook.drift.check ==="
echo "spine:     $SPINE"
echo "workbench: $WORKBENCH"
echo ""

echo "[1] Claude entrypoint (enforce)..."
"$SPINE/ops/plugins/host/bin/host-claude-entrypoint-lock" --enforce
echo ""

echo "[2] Workbench hotkeys + managed configs verifier..."
cd "$WORKBENCH"
bash scripts/root/verify_laptop_hotkeys.sh
echo ""

echo "[3] Bootstrap CLI tools presence..."
BOOT_ERRORS=0
for tool in git jq gh yq rg; do
  if command -v "$tool" >/dev/null 2>&1; then
    echo "  OK   $tool"
  else
    echo "  MISS $tool"
    BOOT_ERRORS=$((BOOT_ERRORS + 1))
  fi
done
if [[ "$BOOT_ERRORS" -gt 0 ]]; then
  echo "FAIL: $BOOT_ERRORS bootstrap CLI tool(s) missing"
  echo "Fix: ./bin/ops cap run host.macbook.bootstrap --execute"
  exit 1
fi
echo ""

echo "PASS: macbook drift check"

