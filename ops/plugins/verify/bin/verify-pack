#!/usr/bin/env bash
set -euo pipefail

ROOT="${SPINE_ROOT:-$(cd "$(dirname "${BASH_SOURCE[0]}")/../../../.." && pwd)}"
RUNTIME="$ROOT/ops/plugins/verify/bin/verify-topology"
RING_POLICY="$ROOT/ops/bindings/verify.ring.policy.yaml"

[[ -x "$RUNTIME" ]] || {
  echo "verify.pack FAIL: missing runtime: $RUNTIME" >&2
  exit 1
}
[[ -f "$RING_POLICY" ]] || {
  echo "verify.pack FAIL: missing ring policy: $RING_POLICY" >&2
  exit 1
}

usage() {
  cat <<'USAGE'
verify-pack

Usage:
  verify-pack list
  verify-pack explain <agent_id|domain>
  verify-pack run [<agent_id|domain>] [--json]

Notes:
  - verify.pack dispatches to topology-driven runtime.
  - Day-to-day defaults to the configured default agent profile.
  - Pack run enforces the standard verify ring latency budget.
USAGE
}

sub="${1:-}"
case "$sub" in
  list)
    shift
    exec "$RUNTIME" pack-list "$@"
    ;;
  explain)
    shift
    [[ $# -ge 1 ]] || { usage >&2; exit 2; }
    exec "$RUNTIME" pack-explain "$@"
    ;;
  run)
    shift
    target="${1:-}"
    if [[ "$target" == "workbench" ]]; then
      lock_script=""
      wb_budget=""
      lock_script="$ROOT/ops/plugins/verify/bin/workbench-budget-regression-lock"
      [[ -x "$lock_script" ]] || { echo "verify.pack FAIL: missing regression lock: $lock_script" >&2; exit 1; }
      "$lock_script"
      wb_budget="$(yq e -r '.pack_budget_overrides_seconds.workbench // ""' "$RING_POLICY" 2>/dev/null || true)"
      [[ "$wb_budget" =~ ^[0-9]+$ ]] || { echo "verify.pack FAIL: invalid workbench pack budget override in $RING_POLICY" >&2; exit 1; }
      exec env VERIFY_RING_ENTRYPOINT=standard VERIFY_RING_BUDGET_OVERRIDE_SECONDS="$wb_budget" "$RUNTIME" pack-run "$@"
    fi
    # Communications pack can trigger local tailscale browser auth popups on some
    # macOS clients; default this pack to passive probe mode unless explicitly set.
    if [[ "$target" == "communications" && -z "${VERIFY_TAILSCALE_PROBE_MODE:-}" ]]; then
      exec env VERIFY_RING_ENTRYPOINT=standard VERIFY_TAILSCALE_PROBE_MODE=passive "$RUNTIME" pack-run "$@"
    fi
    exec env VERIFY_RING_ENTRYPOINT=standard "$RUNTIME" pack-run "$@"
    ;;
  -h|--help|"")
    usage
    ;;
  *)
    echo "verify.pack FAIL: unknown subcommand: $sub" >&2
    usage >&2
    exit 2
    ;;
esac
