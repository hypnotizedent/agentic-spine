#!/usr/bin/env bash
set -euo pipefail

ROOT="${SPINE_ROOT:-$HOME/code/agentic-spine}"
POLICY="$ROOT/ops/bindings/gate.portfolio.policy.yaml"
REGISTRY="$ROOT/ops/bindings/gate.registry.yaml"
TOPOLOGY="$ROOT/ops/bindings/gate.execution.topology.yaml"
OUT="${1:-$ROOT/docs/planning/W60_GATE_RECLASSIFICATION_BUDGET_REPORT.md}"

fail() { echo "gate-portfolio-budget-report FAIL: $*" >&2; exit 1; }

for f in "$POLICY" "$REGISTRY" "$TOPOLOGY"; do
  [[ -f "$f" ]] || fail "missing file: $f"
done
command -v yq >/dev/null 2>&1 || fail "missing dependency: yq"

max_inv="$(yq e -r '.limits.max_invariant_gates_per_domain // 10' "$POLICY")"
[[ "$max_inv" =~ ^[0-9]+$ ]] || fail "invalid max_invariant_gates_per_domain"

mapfile -t fresh_kw < <(yq e -r '.classification.heuristic_keywords.freshness[]? // ""' "$POLICY" | sed '/^$/d')
mapfile -t adv_kw < <(yq e -r '.classification.heuristic_keywords.advisory[]? // ""' "$POLICY" | sed '/^$/d')

tmp_classes="$(mktemp)"
tmp_counts="$(mktemp)"
tmp_totals="$(mktemp)"
cleanup() { rm -f "$tmp_classes" "$tmp_counts" "$tmp_totals"; }
trap cleanup EXIT

classify_gate() {
  local gid="$1"
  local name="$2"
  local desc="$3"
  local warn="$4"

  override="$(yq e -r ".classification.explicit_overrides.\"$gid\" // \"\"" "$POLICY")"
  if [[ -n "$override" && "$override" != "null" ]]; then
    printf '%s\n' "$override"
    return
  fi

  if [[ "$warn" == "true" ]]; then
    printf 'advisory\n'
    return
  fi

  blob="$(printf '%s %s' "$name" "$desc" | tr '[:upper:]' '[:lower:]')"
  local kw
  for kw in "${fresh_kw[@]}"; do
    [[ -n "$kw" ]] || continue
    if [[ "$blob" == *"${kw,,}"* ]]; then
      printf 'freshness\n'
      return
    fi
  done
  for kw in "${adv_kw[@]}"; do
    [[ -n "$kw" ]] || continue
    if [[ "$blob" == *"${kw,,}"* ]]; then
      printf 'advisory\n'
      return
    fi
  done

  printf 'invariant\n'
}

while IFS=$'\t' read -r gid name desc warn; do
  [[ -n "$gid" ]] || continue
  cls="$(classify_gate "$gid" "$name" "$desc" "$warn")"
  printf '%s\t%s\n' "$gid" "$cls" >> "$tmp_classes"
done < <(yq e -r '.gates[] | [.id, (.name // ""), (.description // ""), ((.warn_only // false)|tostring)] | @tsv' "$REGISTRY")

while IFS=$'\t' read -r gid dom; do
  [[ -n "$gid" && -n "$dom" ]] || continue
  cls="$(awk -F'\t' -v g="$gid" '$1==g{print $2; exit}' "$tmp_classes")"
  [[ -n "$cls" ]] || cls="invariant"
  printf '%s\t%s\n' "$dom" "$cls" >> "$tmp_counts"
done < <(yq e -r '.gate_assignments[] | [.gate_id, .primary_domain] | @tsv' "$TOPOLOGY")

awk -F'\t' '{k=$1 FS $2; c[k]++; d[$1]=1} END {for (x in c){split(x,a,FS); printf "%s\t%s\t%d\n", a[1], a[2], c[x]}}' "$tmp_counts" | sort > "$tmp_totals"

{
  echo "# W60 Gate Reclassification And Budget Report"
  echo
  echo "Date: $(date -u +%Y-%m-%d) (UTC)"
  echo "Policy source: ops/bindings/gate.portfolio.policy.yaml"
  echo
  echo "Max invariant gates per domain: $max_inv"
  echo
  echo "| domain | invariant | freshness | advisory | total | waiver_required | waiver_status |"
  echo "|---|---:|---:|---:|---:|---|---|"

  fail_count=0
  while IFS=$'\t' read -r dom; do
    inv="$(awk -F'\t' -v d="$dom" '$1==d && $2=="invariant"{print $3}' "$tmp_totals")"; inv="${inv:-0}"
    fre="$(awk -F'\t' -v d="$dom" '$1==d && $2=="freshness"{print $3}' "$tmp_totals")"; fre="${fre:-0}"
    adv="$(awk -F'\t' -v d="$dom" '$1==d && $2=="advisory"{print $3}' "$tmp_totals")"; adv="${adv:-0}"
    total=$((inv + fre + adv))

    waiver_required="no"
    waiver_status="n/a"
    if [[ "$inv" -gt "$max_inv" ]]; then
      waiver_required="yes"
      receipt="$(yq e -r ".waivers.\"$dom\".receipt // \"\"" "$POLICY")"
      expiry="$(yq e -r ".waivers.\"$dom\".expires_on // \"\"" "$POLICY")"
      if [[ -n "$receipt" && "$receipt" != "null" && -n "$expiry" && "$expiry" != "null" ]]; then
        waiver_status="approved, expires $expiry"
      else
        waiver_status="MISSING"
        fail_count=$((fail_count + 1))
      fi
    fi

    printf '| %s | %s | %s | %s | %s | %s | %s |\n' "$dom" "$inv" "$fre" "$adv" "$total" "$waiver_required" "$waiver_status"
  done < <(awk -F'\t' '{print $1}' "$tmp_totals" | sort -u)

  echo
  echo "Generated by: ops/plugins/verify/bin/gate-portfolio-budget-report"
} > "$OUT"

if [[ "${fail_count:-0}" -gt 0 ]]; then
  fail "missing waiver metadata for $fail_count over-budget domain(s)"
fi

echo "gate-portfolio-budget-report PASS: ${OUT#$ROOT/}"
