#!/usr/bin/env bash
set -euo pipefail

ROOT="${SPINE_ROOT:-$(cd "$(dirname "${BASH_SOURCE[0]}")/../../../.." && pwd)}"
REGISTRY="$ROOT/ops/bindings/gate.registry.yaml"

usage() {
  cat <<'USAGE'
gate-registry-add

Usage:
  gate-registry-add \
    --gate-id DNN \
    --name <name> \
    --category <category> \
    --description <text> \
    --severity <low|medium|high|critical> \
    --check-script <surfaces/verify/*.sh> \
    [--fix-hint <text>] [--inline true|false]
USAGE
}

fail() {
  echo "gate.registry.add FAIL: $*" >&2
  exit 1
}

[[ -f "$REGISTRY" ]] || fail "missing registry: $REGISTRY"
command -v yq >/dev/null 2>&1 || fail "missing required tool: yq"

GATE_ID=""
NAME=""
CATEGORY=""
DESCRIPTION=""
SEVERITY="medium"
CHECK_SCRIPT=""
FIX_HINT=""
INLINE="false"

while [[ $# -gt 0 ]]; do
  case "$1" in
    --gate-id) GATE_ID="${2:-}"; shift 2 ;;
    --name) NAME="${2:-}"; shift 2 ;;
    --category) CATEGORY="${2:-}"; shift 2 ;;
    --description) DESCRIPTION="${2:-}"; shift 2 ;;
    --severity) SEVERITY="${2:-}"; shift 2 ;;
    --check-script) CHECK_SCRIPT="${2:-}"; shift 2 ;;
    --fix-hint) FIX_HINT="${2:-}"; shift 2 ;;
    --inline) INLINE="${2:-false}"; shift 2 ;;
    -h|--help) usage; exit 0 ;;
    *) fail "unknown argument: $1" ;;
  esac
done

[[ -n "$GATE_ID" ]] || fail "--gate-id is required"
[[ -n "$NAME" ]] || fail "--name is required"
[[ -n "$CATEGORY" ]] || fail "--category is required"
[[ -n "$DESCRIPTION" ]] || fail "--description is required"
[[ -n "$CHECK_SCRIPT" ]] || fail "--check-script is required"

exists="$(yq e -r ".gates[] | select(.id == \"$GATE_ID\") | .id" "$REGISTRY" | head -n1 || true)"
[[ -z "$exists" ]] || fail "gate '$GATE_ID' already exists"

yq -i "
  .gates += [{
    \"id\": \"$GATE_ID\",
    \"name\": \"$NAME\",
    \"category\": \"$CATEGORY\",
    \"description\": \"$DESCRIPTION\",
    \"severity\": \"$SEVERITY\",
    \"check_script\": \"$CHECK_SCRIPT\",
    \"fix_hint\": \"$FIX_HINT\",
    \"inline\": $INLINE
  }]
" "$REGISTRY"

total="$(yq e '.gates | length' "$REGISTRY")"
retired="$(yq e '[.gates[] | select((.retired // false) == true)] | length' "$REGISTRY")"
active=$((total - retired))

yq -i ".gate_count.total = $total | .gate_count.active = $active | .gate_count.retired = $retired" "$REGISTRY"

echo "gate.registry.add PASS: added $GATE_ID (total=$total active=$active retired=$retired)"
