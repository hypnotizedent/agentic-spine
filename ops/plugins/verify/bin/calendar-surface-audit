#!/usr/bin/env bash
set -euo pipefail

ROOT="${SPINE_ROOT:-$(cd "$(dirname "${BASH_SOURCE[0]}")/../../../.." && pwd)}"
CAPS_FILE="$ROOT/ops/capabilities.yaml"
GLOBAL_BINDING="$ROOT/ops/bindings/calendar.global.yaml"
GLOBAL_SCHEMA="$ROOT/ops/bindings/calendar.global.schema.yaml"
SYNC_CONTRACT="$ROOT/ops/bindings/calendar.sync.contract.yaml"
BACKUP_BINDING="$ROOT/ops/bindings/backup.calendar.yaml"
CAL_OUT_DIR="$ROOT/mailroom/outbox/calendar"
BACKUP_OUT_DIR="$ROOT/mailroom/outbox/backup-calendar"
REPORT_DIR="$ROOT/docs/governance/_audits"
REPORT_FILE="$REPORT_DIR/CALENDAR_SURFACE_AUDIT_$(date +%Y%m%d).md"

JSON_MODE=0
CHECK_ONLY=0
MAX_AGE_MINUTES=720

fail() {
  echo "calendar.surface.audit FAIL: $*" >&2
  exit 1
}

usage() {
  cat <<'USAGE'
calendar-surface-audit

Usage:
  calendar-surface-audit [--json] [--check-only] [--max-age-minutes N]

Options:
  --json              Emit JSON envelope output
  --check-only        Do not write markdown audit artifact
  --max-age-minutes   Freshness threshold for calendar.status (default: 720)
USAGE
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --json)
      JSON_MODE=1
      shift
      ;;
    --check-only)
      CHECK_ONLY=1
      shift
      ;;
    --max-age-minutes)
      MAX_AGE_MINUTES="${2:-}"
      shift 2
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      fail "unknown argument: $1"
      ;;
  esac
done

[[ "$MAX_AGE_MINUTES" =~ ^[0-9]+$ ]] || fail "--max-age-minutes must be a non-negative integer"

command -v yq >/dev/null 2>&1 || fail "required tool missing: yq"
command -v jq >/dev/null 2>&1 || fail "required tool missing: jq"

failures=()
passes=()

record_pass() {
  passes+=("$1")
}

record_fail() {
  failures+=("$1")
}

require_file_yaml() {
  local file="$1"
  local label="$2"
  if [[ ! -f "$file" ]]; then
    record_fail "$label missing: ${file#$ROOT/}"
    return
  fi
  if ! yq e '.' "$file" >/dev/null 2>&1; then
    record_fail "$label invalid YAML: ${file#$ROOT/}"
    return
  fi
  record_pass "$label present"
}

require_exec() {
  local file="$1"
  local label="$2"
  if [[ ! -x "$file" ]]; then
    record_fail "$label missing or non-executable: ${file#$ROOT/}"
    return
  fi
  record_pass "$label executable"
}

expect_capability() {
  local cap="$1"
  local expected_safety="$2"
  local expected_approval="$3"

  local command safety approval
  command="$(yq e -r ".capabilities.\"$cap\".command // \"\"" "$CAPS_FILE" 2>/dev/null || true)"
  safety="$(yq e -r ".capabilities.\"$cap\".safety // \"\"" "$CAPS_FILE" 2>/dev/null || true)"
  approval="$(yq e -r ".capabilities.\"$cap\".approval // \"\"" "$CAPS_FILE" 2>/dev/null || true)"

  if [[ -z "$command" ]]; then
    record_fail "capability missing: $cap"
    return
  fi

  if [[ "$safety" != "$expected_safety" ]]; then
    record_fail "capability safety mismatch for $cap (expected=$expected_safety actual=$safety)"
  fi

  if [[ "$approval" != "$expected_approval" ]]; then
    record_fail "capability approval mismatch for $cap (expected=$expected_approval actual=$approval)"
  fi

  if [[ "$safety" == "$expected_safety" && "$approval" == "$expected_approval" ]]; then
    record_pass "capability contract ok: $cap"
  fi
}

# 1) Required capability matrix (calendar + microsoft + backup + AOF control-plane surfaces)
if [[ ! -f "$CAPS_FILE" ]]; then
  record_fail "missing capabilities registry: ${CAPS_FILE#$ROOT/}"
else
  expect_capability "calendar.generate" "read-only" "auto"
  expect_capability "calendar.status" "read-only" "auto"
  expect_capability "calendar.sync.plan" "read-only" "auto"
  expect_capability "calendar.sync.execute" "mutating" "manual"
  expect_capability "microsoft.calendar.list" "read-only" "auto"
  expect_capability "microsoft.calendar.get" "read-only" "auto"
  expect_capability "microsoft.calendar.create" "mutating" "manual"
  expect_capability "microsoft.calendar.update" "mutating" "manual"
  expect_capability "microsoft.calendar.rsvp" "mutating" "manual"
  expect_capability "backup.calendar.generate" "read-only" "auto"
  expect_capability "spine.briefing" "mutating" "auto"
  expect_capability "spine.control.tick" "read-only" "auto"
  expect_capability "spine.control.plan" "read-only" "auto"
  expect_capability "spine.control.execute" "mutating" "manual"
  expect_capability "spine.control.cycle" "mutating" "manual"
fi

# 2) Canonical bindings/contracts
require_file_yaml "$GLOBAL_BINDING" "calendar.global binding"
require_file_yaml "$GLOBAL_SCHEMA" "calendar.global schema"
require_file_yaml "$SYNC_CONTRACT" "calendar sync contract"
require_file_yaml "$BACKUP_BINDING" "backup calendar binding"

if [[ -f "$GLOBAL_BINDING" ]]; then
  layer_order_json="$(yq e -o=json '.layers.order // []' "$GLOBAL_BINDING" 2>/dev/null || echo '[]')"
  expected_layers='["infrastructure","automation","identity","personal","spine","life"]'
  if jq -e --argjson expected "$expected_layers" '. == $expected' <<<"$layer_order_json" >/dev/null 2>&1; then
    record_pass "calendar.global layers.order canonical"
  else
    record_fail "calendar.global layers.order drift"
  fi
fi

if [[ -f "$SYNC_CONTRACT" ]]; then
  provider="$(yq e -r '.runtime.provider // ""' "$SYNC_CONTRACT" 2>/dev/null || true)"
  sync_approval="$(yq e -r '.capability.approval // ""' "$SYNC_CONTRACT" 2>/dev/null || true)"
  infra_writes="$(yq e -r '.layers.infrastructure.writes_enabled // false' "$SYNC_CONTRACT" 2>/dev/null || true)"
  identity_writes="$(yq e -r '.layers.identity.writes_enabled | tostring' "$SYNC_CONTRACT" 2>/dev/null || true)"
  personal_writes="$(yq e -r '.layers.personal.writes_enabled | tostring' "$SYNC_CONTRACT" 2>/dev/null || true)"

  [[ "$provider" == "microsoft" ]] && record_pass "calendar sync provider is microsoft" || record_fail "calendar sync provider drift (expected microsoft, actual=$provider)"
  [[ "$sync_approval" == "manual" ]] && record_pass "calendar sync approval is manual" || record_fail "calendar sync approval drift (expected manual, actual=$sync_approval)"
  [[ "$infra_writes" == "true" ]] && record_pass "calendar sync spine-authoritative writes enabled" || record_fail "calendar sync infrastructure writes must be enabled"
  [[ "$identity_writes" == "false" ]] && record_pass "calendar sync identity writes disabled" || record_fail "calendar sync identity writes must be disabled"
  [[ "$personal_writes" == "false" ]] && record_pass "calendar sync personal writes disabled" || record_fail "calendar sync personal writes must be disabled"
fi

# 3) Required executable surfaces
require_exec "$ROOT/ops/plugins/calendar/bin/calendar-generate" "calendar generate capability"
require_exec "$ROOT/ops/plugins/calendar/bin/calendar-status" "calendar status capability"
require_exec "$ROOT/ops/plugins/calendar/bin/calendar-sync-plan" "calendar sync planner"
require_exec "$ROOT/ops/plugins/calendar/bin/calendar-sync-execute" "calendar sync executor"
require_exec "$ROOT/ops/plugins/backup/bin/backup-calendar-generate" "backup calendar generator"
require_exec "$ROOT/ops/plugins/briefing/bin/briefing-section-calendar" "briefing calendar section"
require_exec "$ROOT/ops/plugins/evidence/bin/spine-control" "AOF spine-control runtime"

# 4) Required calendar tests
for test_file in \
  "$ROOT/ops/plugins/calendar/tests/test-calendar-generate.sh" \
  "$ROOT/ops/plugins/calendar/tests/test-calendar-status.sh" \
  "$ROOT/ops/plugins/calendar/tests/test-calendar-sync-plan.sh" \
  "$ROOT/ops/plugins/calendar/tests/test-calendar-sync-execute.sh"
do
  if [[ -f "$test_file" ]]; then
    record_pass "calendar test present: ${test_file#$ROOT/}"
  else
    record_fail "calendar test missing: ${test_file#$ROOT/}"
  fi
done

# 5) Runtime artifact and planner checks
if "$ROOT/ops/plugins/calendar/bin/calendar-generate" >/tmp/calendar_surface_generate.out 2>/tmp/calendar_surface_generate.err; then
  record_pass "calendar.generate execution pass"
else
  detail="$(sed -n '1,3p' /tmp/calendar_surface_generate.err | tr '\n' ' ' | xargs || true)"
  record_fail "calendar.generate failed (${detail:-unknown error})"
fi

if "$ROOT/ops/plugins/backup/bin/backup-calendar-generate" >/tmp/calendar_surface_backup_generate.out 2>/tmp/calendar_surface_backup_generate.err; then
  record_pass "backup.calendar.generate execution pass"
else
  detail="$(sed -n '1,3p' /tmp/calendar_surface_backup_generate.err | tr '\n' ' ' | xargs || true)"
  record_fail "backup.calendar.generate failed (${detail:-unknown error})"
fi

calendar_status_json="$(mktemp)"
if "$ROOT/ops/plugins/calendar/bin/calendar-status" --json --max-age-minutes "$MAX_AGE_MINUTES" >"$calendar_status_json" 2>/tmp/calendar_surface_status.err; then
  cal_status="$(jq -r '.status // ""' "$calendar_status_json" 2>/dev/null || true)"
  if [[ "$cal_status" == "ok" ]]; then
    record_pass "calendar.status reports OK"
  else
    record_fail "calendar.status not OK (status=$cal_status)"
  fi
else
  detail="$(sed -n '1,3p' /tmp/calendar_surface_status.err | tr '\n' ' ' | xargs || true)"
  record_fail "calendar.status execution failed (${detail:-unknown error})"
fi

if "$ROOT/ops/plugins/calendar/bin/calendar-sync-plan" >/tmp/calendar_surface_sync_plan.out 2>/tmp/calendar_surface_sync_plan.err; then
  record_pass "calendar.sync.plan execution pass"
else
  detail="$(sed -n '1,3p' /tmp/calendar_surface_sync_plan.err | tr '\n' ' ' | xargs || true)"
  record_fail "calendar.sync.plan failed (${detail:-unknown error})"
fi

if "$ROOT/ops/plugins/evidence/bin/spine-control" tick >/tmp/calendar_surface_tick.out 2>/tmp/calendar_surface_tick.err; then
  record_pass "spine.control.tick execution pass"
else
  detail="$(sed -n '1,3p' /tmp/calendar_surface_tick.err | tr '\n' ' ' | xargs || true)"
  record_fail "spine.control.tick failed (${detail:-unknown error})"
fi

if "$ROOT/ops/plugins/evidence/bin/spine-control" plan >/tmp/calendar_surface_plan.out 2>/tmp/calendar_surface_plan.err; then
  record_pass "spine.control.plan execution pass"
else
  detail="$(sed -n '1,3p' /tmp/calendar_surface_plan.err | tr '\n' ' ' | xargs || true)"
  record_fail "spine.control.plan failed (${detail:-unknown error})"
fi

if [[ -f "$CAL_OUT_DIR/calendar-index.json" ]]; then
  event_count="$(jq -r '.events | length' "$CAL_OUT_DIR/calendar-index.json" 2>/dev/null || echo 0)"
  if [[ "$event_count" =~ ^[0-9]+$ ]] && (( event_count > 0 )); then
    record_pass "calendar index has events (count=$event_count)"
  else
    record_fail "calendar index has no events"
  fi

  layer_count="$(jq -r '[.events[].layer] | unique | length' "$CAL_OUT_DIR/calendar-index.json" 2>/dev/null || echo 0)"
  if [[ "$layer_count" =~ ^[0-9]+$ ]] && (( layer_count >= 6 )); then
    record_pass "calendar index covers expected layer set"
  else
    record_fail "calendar index missing expected layers"
  fi
else
  record_fail "missing calendar index artifact: mailroom/outbox/calendar/calendar-index.json"
fi

for artifact in \
  "$CAL_OUT_DIR/calendar-global.ics" \
  "$CAL_OUT_DIR/calendar-infrastructure.ics" \
  "$CAL_OUT_DIR/calendar-automation.ics" \
  "$CAL_OUT_DIR/calendar-identity.ics" \
  "$CAL_OUT_DIR/calendar-personal.ics" \
  "$CAL_OUT_DIR/calendar-spine.ics" \
  "$CAL_OUT_DIR/calendar-life.ics" \
  "$BACKUP_OUT_DIR/backup-calendar.ics"
do
  if [[ -f "$artifact" ]]; then
    record_pass "artifact present: ${artifact#$ROOT/}"
  else
    record_fail "artifact missing: ${artifact#$ROOT/}"
  fi
done

status="pass"
if (( ${#failures[@]} > 0 )); then
  status="fail"
fi

generated_at="$(date -u +%Y-%m-%dT%H:%M:%SZ)"

if [[ "$CHECK_ONLY" -eq 0 ]]; then
  mkdir -p "$REPORT_DIR"
  {
    echo "# Calendar Surface Audit"
    echo
    echo "- Generated: $generated_at"
    echo "- Capability: calendar.surface.audit"
    echo "- Status: ${status^^}"
    echo "- Checks Passed: ${#passes[@]}"
    echo "- Checks Failed: ${#failures[@]}"
    echo
    echo "## Scope"
    echo "- Calendar SSOT contracts (global/sync/schema/backup)"
    echo "- Calendar + Microsoft + Backup capability matrix"
    echo "- AOF control-plane calendar integration surfaces"
    echo "- Generated artifacts and planner/runtime checks"
    echo
    echo "## Failures"
    if (( ${#failures[@]} == 0 )); then
      echo "- none"
    else
      for row in "${failures[@]}"; do
        echo "- $row"
      done
    fi
    echo
    echo "## Passed Checks"
    for row in "${passes[@]}"; do
      echo "- $row"
    done
  } >"$REPORT_FILE"
fi

if [[ "$JSON_MODE" -eq 1 ]]; then
  failures_json="$(printf '%s\n' "${failures[@]}" | jq -R -s 'split("\n") | map(select(length > 0))')"
  passes_json="$(printf '%s\n' "${passes[@]}" | jq -R -s 'split("\n") | map(select(length > 0))')"
  jq -n \
    --arg capability "calendar.surface.audit" \
    --arg schema_version "1.0" \
    --arg status "$status" \
    --arg generated_at "$generated_at" \
    --arg report_path "$([[ "$CHECK_ONLY" -eq 0 ]] && echo "${REPORT_FILE#$ROOT/}" || echo "")" \
    --argjson check_only "$([[ "$CHECK_ONLY" -eq 1 ]] && echo true || echo false)" \
    --argjson checks_passed "${#passes[@]}" \
    --argjson checks_failed "${#failures[@]}" \
    --argjson passes "$passes_json" \
    --argjson failures "$failures_json" \
    '{capability:$capability,schema_version:$schema_version,status:$status,generated_at:$generated_at,data:{check_only:$check_only,summary:{checks_passed:$checks_passed,checks_failed:$checks_failed},report_path:$report_path,passes:$passes,failures:$failures}}'
else
  echo "calendar.surface.audit"
  echo "status: ${status^^}"
  echo "checks_passed: ${#passes[@]}"
  echo "checks_failed: ${#failures[@]}"
  if [[ "$CHECK_ONLY" -eq 0 ]]; then
    echo "report: ${REPORT_FILE#$ROOT/}"
  fi
  if (( ${#failures[@]} > 0 )); then
    echo ""
    echo "failures:"
    for row in "${failures[@]}"; do
      echo "  - $row"
    done
  fi
fi

rm -f "$calendar_status_json" \
  /tmp/calendar_surface_generate.out /tmp/calendar_surface_generate.err \
  /tmp/calendar_surface_backup_generate.out /tmp/calendar_surface_backup_generate.err \
  /tmp/calendar_surface_status.err \
  /tmp/calendar_surface_sync_plan.out /tmp/calendar_surface_sync_plan.err \
  /tmp/calendar_surface_tick.out /tmp/calendar_surface_tick.err \
  /tmp/calendar_surface_plan.out /tmp/calendar_surface_plan.err >/dev/null 2>&1 || true

if (( ${#failures[@]} > 0 )); then
  exit 1
fi

exit 0
