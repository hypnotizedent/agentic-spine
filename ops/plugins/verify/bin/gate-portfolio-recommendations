#!/usr/bin/env python3
import json
from datetime import datetime, timezone
from pathlib import Path


def fail(message: str) -> None:
    raise SystemExit(f"gate-portfolio-recommendations FAIL: {message}")


def pct(value: float) -> str:
    return f"{value * 100:.2f}%"


def main() -> None:
    root = Path(__file__).resolve().parents[4]
    scorecard_json = root / "docs/planning/W62B_GATE_QUALITY_SCORECARD.json"
    out_md = root / "docs/planning/W62B_GATE_PORTFOLIO_RECOMMENDATIONS.md"

    if not scorecard_json.exists():
        fail(f"missing scorecard json: {scorecard_json}")

    data = json.loads(scorecard_json.read_text(encoding="utf-8"))
    gates = data.get("gates", [])
    if not isinstance(gates, list):
        fail("scorecard json malformed (gates missing)")

    demotion_fail_rate_threshold = 0.50
    demotion_min_exposure = 2
    retirement_min_exposure = 6

    demotion_candidates = []
    retirement_candidates = []

    for gate in gates:
        gate_id = gate.get("id", "")
        gate_class = gate.get("gate_class", "")
        exposure = int(gate.get("exposure_count", 0))
        fail_rate = float(gate.get("fail_rate", 0.0))
        pass_rate = float(gate.get("pass_rate", 0.0))
        fail_count = int(gate.get("fail_count", 0))
        drift = int(gate.get("real_drift_evidence_count", 0))

        if gate_class != "advisory" and exposure >= demotion_min_exposure and fail_rate > demotion_fail_rate_threshold and drift == 0:
            demotion_candidates.append(
                {
                    "id": gate_id,
                    "name": gate.get("name", ""),
                    "gate_class": gate_class,
                    "exposure_count": exposure,
                    "fail_count": fail_count,
                    "fail_rate": fail_rate,
                    "real_drift_evidence_count": drift,
                    "candidate_action": "demote_to_advisory",
                    "rationale": "fail_rate > 50% with zero deterministic drift evidence in horizon",
                }
            )

        if gate_class != "advisory" and exposure >= retirement_min_exposure and pass_rate == 1.0 and fail_count == 0:
            retirement_candidates.append(
                {
                    "id": gate_id,
                    "name": gate.get("name", ""),
                    "gate_class": gate_class,
                    "exposure_count": exposure,
                    "pass_rate": pass_rate,
                    "candidate_action": "retire_review",
                    "rationale": f"pass_rate == 100% for long horizon (>= {retirement_min_exposure} exposures)",
                }
            )

    demotion_candidates.sort(key=lambda x: (-x["fail_rate"], -x["fail_count"], x["id"]))
    retirement_candidates.sort(key=lambda x: (-x["exposure_count"], x["id"]))

    generated_at = datetime.now(timezone.utc).strftime("%Y-%m-%dT%H:%M:%SZ")
    lines = [
        "# W62-B Gate Portfolio Recommendations (Report-Only)",
        "",
        f"Generated: {generated_at}",
        f"Input scorecard: `{scorecard_json}`",
        "",
        "## Rules Evaluated",
        "",
        f"- Demotion recommendation: `fail_rate > {int(demotion_fail_rate_threshold * 100)}%` and `real_drift_evidence_count == 0` and `exposure_count >= {demotion_min_exposure}`.",
        f"- Retirement review recommendation: `pass_rate == 100%` for long horizon (`exposure_count >= {retirement_min_exposure}`).",
        "- Enforcement mode: **report-only**. This capability does **not** mutate `ops/bindings/gate.registry.yaml`.",
        "",
        "## Advisory Demotion Candidates (Report-Only)",
        "",
        "| gate_id | gate_name | current_class | exposure_count | fail_count | fail_rate | real_drift_evidence_count | candidate_action | rationale |",
        "|---|---|---|---:|---:|---:|---:|---|---|",
    ]

    if demotion_candidates:
        for row in demotion_candidates:
            lines.append(
                f"| {row['id']} | {row['name']} | {row['gate_class']} | {row['exposure_count']} | {row['fail_count']} | {pct(row['fail_rate'])} | {row['real_drift_evidence_count']} | {row['candidate_action']} | {row['rationale']} |"
            )
    else:
        lines.append("| none | n/a | n/a | 0 | 0 | 0.00% | 0 | none | no gates met demotion rule in this horizon |")

    lines.extend(
        [
            "",
            "## Retirement Review Candidates (Report-Only)",
            "",
            "| gate_id | gate_name | current_class | exposure_count | pass_rate | candidate_action | rationale |",
            "|---|---|---|---:|---:|---|---|",
        ]
    )

    if retirement_candidates:
        for row in retirement_candidates:
            lines.append(
                f"| {row['id']} | {row['name']} | {row['gate_class']} | {row['exposure_count']} | {pct(row['pass_rate'])} | {row['candidate_action']} | {row['rationale']} |"
            )
    else:
        lines.append("| none | n/a | n/a | 0 | 0.00% | none | no gates met retirement-review rule in this horizon |")

    lines.extend(
        [
            "",
            "## Summary",
            "",
            f"- demotion_candidates: **{len(demotion_candidates)}**",
            f"- retirement_review_candidates: **{len(retirement_candidates)}**",
            "- registry_mutation: **none (report-only)**",
        ]
    )

    out_md.write_text("\n".join(lines) + "\n", encoding="utf-8")

    print("verify.gate_portfolio.recommendations")
    print(f"input_scorecard: {scorecard_json}")
    print(f"recommendations_md: {out_md}")
    print(f"demotion_candidates: {len(demotion_candidates)}")
    print(f"retirement_review_candidates: {len(retirement_candidates)}")


if __name__ == "__main__":
    main()
