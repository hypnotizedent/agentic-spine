#!/usr/bin/env bash
# tenant.storage.audit — Verify runtime storage paths comply with tenant storage contract
set -euo pipefail

ROOT="${SPINE_ROOT:-$HOME/code/agentic-spine}"
CONTRACT="$ROOT/ops/bindings/tenant.storage.contract.yaml"

echo "=== Tenant Storage Audit ==="
echo ""

if [[ ! -f "$CONTRACT" ]]; then
  echo "FAIL: tenant.storage.contract.yaml not found"
  exit 1
fi

ERRORS=0
CHECKS=0

# Check isolation mode
mode="$(grep '^isolation_mode:' "$CONTRACT" | awk '{print $2}')"
echo "isolation_mode: $mode"
echo ""

# Verify each declared boundary path exists
echo "Boundary checks:"
for boundary in receipts ledger mailroom_inbox mailroom_outbox loop_scopes; do
  CHECKS=$((CHECKS + 1))
  current_path="$(sed -n "/^  ${boundary}:/,/^  [a-z]/p" "$CONTRACT" | grep 'current_path:' | head -1 | sed 's/.*: *"//' | sed 's/".*//')"
  if [[ -n "$current_path" ]]; then
    full_path="$ROOT/$current_path"
    if [[ -d "$full_path" ]]; then
      echo "  $boundary: $current_path — EXISTS"
    else
      echo "  $boundary: $current_path — MISSING"
      ERRORS=$((ERRORS + 1))
    fi
  else
    echo "  $boundary: no current_path declared — SKIP"
  fi
done

echo ""
echo "Summary: $CHECKS checked, $ERRORS errors"

if [[ "$ERRORS" -gt 0 ]]; then
  echo "AUDIT: FAIL"
  exit 1
fi

echo "AUDIT: PASS"
exit 0
