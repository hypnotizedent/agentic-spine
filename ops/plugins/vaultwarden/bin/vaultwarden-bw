#!/usr/bin/env bash
# vaultwarden-bw - Run a single bw CLI command through scope-rewriting HTTPS proxy
#
# For multi-command flows (login → unlock → list), source proxy-session.sh instead:
#   source ops/plugins/vaultwarden/lib/proxy-session.sh
#   vw_proxy_start; vw_bw login ...; vw_bw unlock ...; vw_proxy_stop
#
# Usage:
#   vaultwarden-bw <bw-args...>
#   vaultwarden-bw status
#
# Env:
#   VW_PROXY_TARGET - Vaultwarden backend (default: http://192.168.1.204:8081)

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# shellcheck source=../lib/proxy-session.sh
source "$SCRIPT_DIR/../lib/proxy-session.sh"

trap vw_proxy_stop EXIT

# Clear stale bw state if config points to dead proxy
bw logout >/dev/null 2>&1 || true

vw_proxy_start || exit $?
vw_bw "$@"
