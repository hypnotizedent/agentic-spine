#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../../../.." && pwd)"
SPINE_REPO="${SPINE_REPO:-$ROOT}"
SPINE_CODE="${SPINE_CODE:-$ROOT}"
source "$ROOT/ops/lib/runtime-paths.sh"
spine_runtime_resolve_paths

CONFIG="$ROOT/ops/bindings/handoff.config.yaml"
ID=""
NOTE=""

usage() {
  cat <<'USAGE'
session-handoff-close

Usage:
  session-handoff-close --id HO-YYYYMMDD-HHMMSS --note "close note"
USAGE
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --id)
      ID="${2:-}"
      shift 2
      ;;
    --note)
      NOTE="${2:-}"
      shift 2
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      echo "FAIL: unknown argument: $1" >&2
      exit 2
      ;;
  esac
done

[[ -n "$ID" ]] || { echo "FAIL: --id is required" >&2; exit 2; }
[[ -n "$NOTE" ]] || { echo "FAIL: --note is required" >&2; exit 2; }

handoff_dir="$(yq -r '.storage.directory // "mailroom/state/handoffs"' "$CONFIG")"
file="$(spine_resolve_mailroom_path "$handoff_dir")/$ID.yaml"
[[ -f "$file" ]] || { echo "FAIL: handoff not found: $ID" >&2; exit 1; }

current_state="$(yq -r '.state // ""' "$file" 2>/dev/null || true)"
[[ "$current_state" == "active" ]] || {
  echo "FAIL: handoff must be active before close (id=$ID state=${current_state:-unknown})" >&2
  exit 1
}

role_io_enabled="$(yq -r '.role_io.enabled // false' "$CONFIG" 2>/dev/null || echo false)"
if [[ "$role_io_enabled" == "true" ]]; then
  while IFS= read -r field; do
    [[ -n "$field" ]] || continue
    value="$(yq -r ".$field // \"\"" "$file" 2>/dev/null || true)"
    [[ -n "$value" && "$value" != "null" ]] || {
      echo "FAIL: handoff missing role_io field '$field' (id=$ID)" >&2
      exit 1
    }
  done < <(yq -r '.role_io.required_fields[]?' "$CONFIG" 2>/dev/null || true)
fi

closed_at="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
yq -i '.state = "closed"' "$file"
CLOSED_AT="$closed_at" yq -i '.closed_at_utc = strenv(CLOSED_AT)' "$file"
CLOSE_NOTE="$NOTE" yq -i '.close_note = strenv(CLOSE_NOTE)' "$file"

echo "session.handoff.close"
echo "id: $ID"
echo "state: closed"
echo "closed_at_utc: $closed_at"
