#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../../../.." && pwd)"
CONFIG="$ROOT/ops/bindings/handoff.config.yaml"
ID=""
NOTE=""

usage() {
  cat <<'USAGE'
session-handoff-close

Usage:
  session-handoff-close --id HO-YYYYMMDD-HHMMSS --note "close note"
USAGE
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --id)
      ID="${2:-}"
      shift 2
      ;;
    --note)
      NOTE="${2:-}"
      shift 2
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      echo "FAIL: unknown argument: $1" >&2
      exit 2
      ;;
  esac
done

[[ -n "$ID" ]] || { echo "FAIL: --id is required" >&2; exit 2; }
[[ -n "$NOTE" ]] || { echo "FAIL: --note is required" >&2; exit 2; }

handoff_dir="$(yq -r '.storage.directory // "mailroom/state/handoffs"' "$CONFIG")"
file="$ROOT/$handoff_dir/$ID.yaml"
[[ -f "$file" ]] || { echo "FAIL: handoff not found: $ID" >&2; exit 1; }

closed_at="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
yq -i '.state = "closed"' "$file"
CLOSED_AT="$closed_at" yq -i '.closed_at_utc = strenv(CLOSED_AT)' "$file"
CLOSE_NOTE="$NOTE" yq -i '.close_note = strenv(CLOSE_NOTE)' "$file"

echo "session.handoff.close"
echo "id: $ID"
echo "state: closed"
echo "closed_at_utc: $closed_at"
