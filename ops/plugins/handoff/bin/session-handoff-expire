#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../../../.." && pwd)"
CONFIG="$ROOT/ops/bindings/handoff.config.yaml"
JSON_MODE=0

usage() {
  cat <<'USAGE'
session-handoff-expire

Usage:
  session-handoff-expire [--json]

Expires active handoffs where now > expires_at_utc.
USAGE
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --json)
      JSON_MODE=1
      shift
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      echo "FAIL: unknown argument: $1" >&2
      exit 2
      ;;
  esac
done

handoff_dir="$(yq -r '.storage.directory // "mailroom/state/handoffs"' "$CONFIG")"
full_dir="$ROOT/$handoff_dir"
mkdir -p "$full_dir"

now_epoch="$(date +%s)"
expired=0
ids='[]'

while IFS= read -r file; do
  [[ -f "$file" ]] || continue
  state="$(yq -r '.state // ""' "$file")"
  [[ "$state" == "active" ]] || continue

  exp="$(yq -r '.expires_at_utc // ""' "$file")"
  exp_epoch="$(python3 - "$exp" <<'PY'
import datetime as dt
import sys
raw = sys.argv[1]
try:
    t = dt.datetime.fromisoformat(raw.replace("Z", "+00:00"))
    print(int(t.timestamp()))
except Exception:
    print(0)
PY
)"

  if [[ "$exp_epoch" =~ ^[0-9]+$ ]] && (( exp_epoch > 0 && now_epoch > exp_epoch )); then
    expired_at="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
    yq -i '.state = "expired"' "$file"
    EXPIRED_AT="$expired_at" yq -i '.expired_at_utc = strenv(EXPIRED_AT)' "$file"
    id="$(yq -r '.id // ""' "$file")"
    ids="$(jq -c --arg id "$id" '. + [$id]' <<<"$ids")"
    expired=$((expired + 1))
  fi
done < <(find "$full_dir" -maxdepth 1 -type f -name 'HO-*.yaml' | sort)

if [[ "$JSON_MODE" -eq 1 ]]; then
  jq -n --arg capability "session.handoff.expire" --argjson expired "$expired" --argjson ids "$ids" '{capability:$capability,expired:$expired,ids:$ids}'
  exit 0
fi

echo "session.handoff.expire"
echo "expired: $expired"
if (( expired > 0 )); then
  echo "ids: $(jq -r 'join(",")' <<<"$ids")"
fi
