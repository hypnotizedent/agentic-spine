#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../../../.." && pwd)"
CONFIG="$ROOT/ops/bindings/handoff.config.yaml"
SUMMARY=""
LOOPS_RAW=""
ACTIONS_RAW=""
OWNER="${USER:-unknown}"
JSON_MODE=0

usage() {
  cat <<'USAGE'
session-handoff-create

Usage:
  session-handoff-create --summary "..." [--loops "LOOP-A,LOOP-B"] [--actions "task1,task2"] [--owner <name>] [--json]
USAGE
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --summary)
      SUMMARY="${2:-}"
      shift 2
      ;;
    --loops)
      LOOPS_RAW="${2:-}"
      shift 2
      ;;
    --actions)
      ACTIONS_RAW="${2:-}"
      shift 2
      ;;
    --owner)
      OWNER="${2:-}"
      shift 2
      ;;
    --json)
      JSON_MODE=1
      shift
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      echo "FAIL: unknown argument: $1" >&2
      exit 2
      ;;
  esac
done

[[ -n "$SUMMARY" ]] || { echo "FAIL: --summary is required" >&2; exit 2; }

handoff_dir_rel="$(yq -r '.storage.directory // "mailroom/state/handoffs"' "$CONFIG")"
ttl_hours="$(yq -r '.defaults.ttl_hours // 72' "$CONFIG")"
max_active="$(yq -r '.defaults.max_active // 20' "$CONFIG")"

[[ "$ttl_hours" =~ ^[0-9]+$ ]] || ttl_hours=72
[[ "$max_active" =~ ^[0-9]+$ ]] || max_active=20

handoff_dir="$ROOT/$handoff_dir_rel"
mkdir -p "$handoff_dir"

active_count=0
while IFS= read -r file; do
  [[ -f "$file" ]] || continue
  state="$(yq -r '.state // ""' "$file" 2>/dev/null || true)"
  [[ "$state" == "active" ]] && active_count=$((active_count + 1))
done < <(find "$handoff_dir" -maxdepth 1 -type f -name 'HO-*.yaml' 2>/dev/null | sort)

if (( active_count >= max_active )); then
  echo "FAIL: active handoff limit reached ($active_count/$max_active)" >&2
  exit 1
fi

stamp="$(date -u +%Y%m%d-%H%M%S)"
id="HO-$stamp"
file="$handoff_dir/$id.yaml"

read -r created_at expires_at < <(python3 - "$ttl_hours" <<'PY'
import datetime as dt
import sys
hours = int(sys.argv[1])
now = dt.datetime.now(dt.timezone.utc)
exp = now + dt.timedelta(hours=hours)
print(now.strftime("%Y-%m-%dT%H:%M:%SZ"), exp.strftime("%Y-%m-%dT%H:%M:%SZ"))
PY
)

loops_yaml="[]"
actions_yaml="[]"
if [[ -n "$LOOPS_RAW" ]]; then
  loops_yaml="$(python3 - "$LOOPS_RAW" <<'PY'
import json, sys
items = [x.strip() for x in sys.argv[1].split(',') if x.strip()]
print(json.dumps(items))
PY
)"
fi
if [[ -n "$ACTIONS_RAW" ]]; then
  actions_yaml="$(python3 - "$ACTIONS_RAW" <<'PY'
import json, sys
items = [x.strip() for x in sys.argv[1].split(',') if x.strip()]
print(json.dumps(items))
PY
)"
fi

jq -n \
  --arg id "$id" \
  --arg owner "$OWNER" \
  --arg summary "$SUMMARY" \
  --arg created_at "$created_at" \
  --arg expires_at "$expires_at" \
  --argjson loops "$loops_yaml" \
  --argjson actions "$actions_yaml" \
  '{version:"1.0", id:$id, state:"active", owner:$owner, summary:$summary, created_at_utc:$created_at, expires_at_utc:$expires_at, loops:$loops, actions:$actions, notes:[]}' \
  | yq -P '.' >"$file"

if [[ "$JSON_MODE" -eq 1 ]]; then
  jq -n --arg capability "session.handoff.create" --arg id "$id" --arg file "$file" --arg created_at_utc "$created_at" --arg expires_at_utc "$expires_at" '{capability:$capability,id:$id,file:$file,created_at_utc:$created_at_utc,expires_at_utc:$expires_at_utc}'
  exit 0
fi

echo "session.handoff.create"
echo "id: $id"
echo "file: $file"
echo "created_at_utc: $created_at"
echo "expires_at_utc: $expires_at"
