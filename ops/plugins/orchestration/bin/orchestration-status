#!/usr/bin/env bash
set -euo pipefail

source "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/_orchestration-common"

usage() {
  cat <<'USAGE'
orchestration-status - Show orchestration loop status

Usage:
  orchestration-status [--loop-id <id>]
USAGE
}

ROOT="$(orchestration_root)"
LOOP_ID=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    --loop-id) LOOP_ID="${2:-}"; shift 2 ;;
    -h|--help) usage; exit 0 ;;
    *) orchestration_fail "unknown argument: $1" ;;
  esac
done

orchestration_need yq
state_root="$ROOT/mailroom/state/orchestration"
[[ -d "$state_root" ]] || {
  echo "orchestration.status"
  echo "loops: 0"
  exit 0
}

lane_status() {
  local file="$1"
  if [[ -f "$file" ]]; then
    yq e -r '.status // "present"' "$file"
  else
    echo "missing"
  fi
}

print_one() {
  local loop_dir="$1"
  local manifest="$loop_dir/manifest.yaml"
  [[ -f "$manifest" ]] || return 0

  local id base_sha apply_owner loop_status seq_count
  id="$(yq e -r '.loop_id // "unknown"' "$manifest")"
  base_sha="$(yq e -r '.base_sha // ""' "$manifest")"
  apply_owner="$(yq e -r '.apply_owner // ""' "$manifest")"
  loop_status="$(yq e -r '.status // "open"' "$manifest")"
  seq_count="$(yq e '.sequence | length' "$manifest")"

  echo "loop_id: $id"
  echo "  status: $loop_status"
  echo "  base_sha: $base_sha"
  echo "  apply_owner: $apply_owner"
  echo "  sequence: $seq_count"

  while IFS= read -r lane; do
    [[ -z "$lane" || "$lane" == "null" ]] && continue
    ticket_state="$(lane_status "$loop_dir/tickets/$lane.yaml")"
    validation_state="$(lane_status "$loop_dir/validations/$lane.yaml")"
    integration_state="$(lane_status "$loop_dir/integrations/$lane.yaml")"
    echo "  lane[$lane]: ticket=$ticket_state validate=$validation_state integrate=$integration_state"
  done < <(yq e -r '.sequence[]?' "$manifest")

  if [[ -f "$loop_dir/closed.yaml" ]]; then
    close_state="$(yq e -r '.status // ""' "$loop_dir/closed.yaml")"
    close_at="$(yq e -r '.closed_at // ""' "$loop_dir/closed.yaml")"
    close_by="$(yq e -r '.closed_by // ""' "$loop_dir/closed.yaml")"
    echo "  close: $close_state at $close_at by $close_by"
  fi
}

echo "orchestration.status"

if [[ -n "$LOOP_ID" ]]; then
  orchestration_assert_id "$LOOP_ID" "loop id"
  print_one "$(orchestration_loop_dir "$ROOT" "$LOOP_ID")"
  exit 0
fi

count=0
for loop_dir in "$state_root"/*; do
  [[ -d "$loop_dir" ]] || continue
  print_one "$loop_dir"
  count=$((count + 1))
done

echo "loops: $count"
