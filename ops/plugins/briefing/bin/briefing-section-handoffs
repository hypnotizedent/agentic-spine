#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../../../.." && pwd)"

tmp="$(mktemp)"
set +e
"$ROOT/ops/plugins/handoff/bin/session-handoff-status" --json >"$tmp"
rc=$?
set -e

if [[ "$rc" -ne 0 ]] || ! jq -e '.' "$tmp" >/dev/null 2>&1; then
  jq -n --arg section "handoffs" --arg status "degraded" --arg summary "handoff status unavailable" '{section:$section,status:$status,summary:$summary,details:{}}'
  rm -f "$tmp"
  exit 0
fi

active="$(jq -r '.active // 0' "$tmp")"
closed="$(jq -r '.closed // 0' "$tmp")"
expired="$(jq -r '.expired // 0' "$tmp")"

section_status="ok"
if (( active > 0 || expired > 0 )); then
  section_status="degraded"
fi

summary="active=$active closed=$closed expired=$expired"
jq -n \
  --arg section "handoffs" \
  --arg status "$section_status" \
  --arg summary "$summary" \
  --argjson active "$active" \
  --argjson closed "$closed" \
  --argjson expired "$expired" \
  '{section:$section,status:$status,summary:$summary,details:{active:$active,closed:$closed,expired:$expired}}'

rm -f "$tmp"
