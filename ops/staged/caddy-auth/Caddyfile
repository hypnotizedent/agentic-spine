{
	# HTTP only — Cloudflare tunnel handles public TLS.
	# All traffic arrives via CF tunnel (HTTPS→HTTP), so we inject
	# X-Forwarded-Proto https on every Authentik upstream to ensure
	# OAuth redirect URIs and OIDC discovery use https:// scheme.
	auto_https off
}

# ─── Authentik UI/API (no auth — chicken-and-egg) ───
http://{$AUTHENTIK_HOSTNAME} {
	reverse_proxy 127.0.0.1:9000 {
		header_up X-Forwarded-Proto https
	}
}

# ─── Pi-hole admin (Authentik forward auth) ───
http://{$PIHOLE_HOSTNAME} {
	handle /outpost.goauthentik.io/* {
		reverse_proxy 127.0.0.1:9000 {
			header_up X-Forwarded-Proto https
		}
	}
	handle {
		forward_auth 127.0.0.1:9000 {
			uri /outpost.goauthentik.io/auth/caddy
			copy_headers X-Authentik-Username X-Authentik-Groups X-Authentik-Email X-Authentik-Uid
			trusted_proxies private_ranges
		}
		reverse_proxy 127.0.0.1:8053
	}
}

# ─── Vaultwarden (Authentik forward auth) ───
http://{$VAULT_HOSTNAME} {
	handle /outpost.goauthentik.io/* {
		reverse_proxy 127.0.0.1:9000 {
			header_up X-Forwarded-Proto https
		}
	}
	handle {
		forward_auth 127.0.0.1:9000 {
			uri /outpost.goauthentik.io/auth/caddy
			copy_headers X-Authentik-Username X-Authentik-Groups X-Authentik-Email X-Authentik-Uid
			trusted_proxies private_ranges
		}
		reverse_proxy 127.0.0.1:8081
	}
}

# ─── Infisical (Authentik forward auth) ───
http://{$SECRETS_HOSTNAME} {
	handle /outpost.goauthentik.io/* {
		reverse_proxy 127.0.0.1:9000 {
			header_up X-Forwarded-Proto https
		}
	}
	handle {
		forward_auth 127.0.0.1:9000 {
			uri /outpost.goauthentik.io/auth/caddy
			copy_headers X-Authentik-Username X-Authentik-Groups X-Authentik-Email X-Authentik-Uid
			trusted_proxies private_ranges
		}
		reverse_proxy 127.0.0.1:8088
	}
}

# ─── Finances (Authentik forward auth) ───
http://{$FINANCES_HOSTNAME} {
	handle /outpost.goauthentik.io/* {
		reverse_proxy 127.0.0.1:9000 {
			header_up X-Forwarded-Proto https
		}
	}
	handle {
		forward_auth 127.0.0.1:9000 {
			uri /outpost.goauthentik.io/auth/caddy
			copy_headers X-Authentik-Username X-Authentik-Groups X-Authentik-Email X-Authentik-Uid
			trusted_proxies private_ranges
		}
		reverse_proxy {$FINANCES_UPSTREAM}
	}
}

# ─── Investments (Authentik forward auth) ───
http://{$INVESTMENTS_HOSTNAME} {
	handle /outpost.goauthentik.io/* {
		reverse_proxy 127.0.0.1:9000 {
			header_up X-Forwarded-Proto https
		}
	}
	handle {
		forward_auth 127.0.0.1:9000 {
			uri /outpost.goauthentik.io/auth/caddy
			copy_headers X-Authentik-Username X-Authentik-Groups X-Authentik-Email X-Authentik-Uid
			trusted_proxies private_ranges
		}
		reverse_proxy {$INVESTMENTS_UPSTREAM}
	}
}

# ─── Docs (Authentik forward auth) ───
http://{$DOCS_HOSTNAME} {
	handle /outpost.goauthentik.io/* {
		reverse_proxy 127.0.0.1:9000 {
			header_up X-Forwarded-Proto https
		}
	}
	handle {
		forward_auth 127.0.0.1:9000 {
			uri /outpost.goauthentik.io/auth/caddy
			copy_headers X-Authentik-Username X-Authentik-Groups X-Authentik-Email X-Authentik-Uid
			trusted_proxies private_ranges
		}
		reverse_proxy {$DOCS_UPSTREAM}
	}
}

# ─── Mail Archive (Authentik forward auth) ───
http://{$MAIL_ARCHIVE_HOSTNAME} {
	handle /outpost.goauthentik.io/* {
		reverse_proxy 127.0.0.1:9000 {
			header_up X-Forwarded-Proto https
		}
	}
	handle {
		forward_auth 127.0.0.1:9000 {
			uri /outpost.goauthentik.io/auth/caddy
			copy_headers X-Authentik-Username X-Authentik-Groups X-Authentik-Email X-Authentik-Uid
			trusted_proxies private_ranges
		}
		reverse_proxy {$MAIL_ARCHIVE_UPSTREAM}
	}
}

# ─── MinIO Console (Authentik forward auth) ───
http://{$MINIO_HOSTNAME} {
	handle /outpost.goauthentik.io/* {
		reverse_proxy 127.0.0.1:9000 {
			header_up X-Forwarded-Proto https
		}
	}
	handle {
		forward_auth 127.0.0.1:9000 {
			uri /outpost.goauthentik.io/auth/caddy
			copy_headers X-Authentik-Username X-Authentik-Groups X-Authentik-Email X-Authentik-Uid
			trusted_proxies private_ranges
		}
		reverse_proxy {$MINIO_UPSTREAM}
	}
}

# ─── n8n (Authentik forward auth) ───
http://{$N8N_HOSTNAME} {
	handle /outpost.goauthentik.io/* {
		reverse_proxy 127.0.0.1:9000 {
			header_up X-Forwarded-Proto https
		}
	}
	handle {
		forward_auth 127.0.0.1:9000 {
			uri /outpost.goauthentik.io/auth/caddy
			copy_headers X-Authentik-Username X-Authentik-Groups X-Authentik-Email X-Authentik-Uid
			trusted_proxies private_ranges
		}
		reverse_proxy {$N8N_UPSTREAM}
	}
}

# ─── Open WebUI (Authentik forward auth) ───
http://{$CHAT_HOSTNAME} {
	handle /outpost.goauthentik.io/* {
		reverse_proxy 127.0.0.1:9000 {
			header_up X-Forwarded-Proto https
		}
	}
	handle {
		forward_auth 127.0.0.1:9000 {
			uri /outpost.goauthentik.io/auth/caddy
			copy_headers X-Authentik-Username X-Authentik-Groups X-Authentik-Email X-Authentik-Uid
			trusted_proxies private_ranges
		}
		reverse_proxy {$CHAT_UPSTREAM}
	}
}

# ─── Grafana (Authentik forward auth) ───
http://{$GRAFANA_HOSTNAME} {
	handle /outpost.goauthentik.io/* {
		reverse_proxy 127.0.0.1:9000 {
			header_up X-Forwarded-Proto https
		}
	}
	handle {
		forward_auth 127.0.0.1:9000 {
			uri /outpost.goauthentik.io/auth/caddy
			copy_headers X-Authentik-Username X-Authentik-Groups X-Authentik-Email X-Authentik-Uid
			trusted_proxies private_ranges
		}
		reverse_proxy {$GRAFANA_UPSTREAM}
	}
}
