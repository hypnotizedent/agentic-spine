{
	# HTTP only — Cloudflare tunnel handles public TLS.
	# All traffic arrives via CF tunnel (HTTPS→HTTP), so we inject
	# X-Forwarded-Proto https on every Authentik upstream to ensure
	# OAuth redirect URIs and OIDC discovery use https:// scheme.
	auto_https off
}

# ─── Authentik UI/API (no auth — chicken-and-egg) ───
http://{$AUTHENTIK_HOSTNAME} {
	reverse_proxy 127.0.0.1:9000 {
		header_up X-Forwarded-Proto https
	}
}

# ─── Pi-hole admin (Authentik forward auth) ───
http://{$PIHOLE_HOSTNAME} {
	handle /outpost.goauthentik.io/* {
		reverse_proxy 127.0.0.1:9000 {
			header_up X-Forwarded-Proto https
		}
	}
	handle {
		forward_auth 127.0.0.1:9000 {
			uri /outpost.goauthentik.io/auth/caddy
			copy_headers X-Authentik-Username X-Authentik-Groups X-Authentik-Email X-Authentik-Uid
			trusted_proxies private_ranges
		}
		reverse_proxy 127.0.0.1:8053
	}
}

# ─── Vaultwarden (Authentik forward auth) ───
http://{$VAULT_HOSTNAME} {
	handle /outpost.goauthentik.io/* {
		reverse_proxy 127.0.0.1:9000 {
			header_up X-Forwarded-Proto https
		}
	}
	handle {
		forward_auth 127.0.0.1:9000 {
			uri /outpost.goauthentik.io/auth/caddy
			copy_headers X-Authentik-Username X-Authentik-Groups X-Authentik-Email X-Authentik-Uid
			trusted_proxies private_ranges
		}
		reverse_proxy 127.0.0.1:8081
	}
}

# ─── Infisical (Authentik forward auth) ───
http://{$SECRETS_HOSTNAME} {
	handle /outpost.goauthentik.io/* {
		reverse_proxy 127.0.0.1:9000 {
			header_up X-Forwarded-Proto https
		}
	}
	handle {
		forward_auth 127.0.0.1:9000 {
			uri /outpost.goauthentik.io/auth/caddy
			copy_headers X-Authentik-Username X-Authentik-Groups X-Authentik-Email X-Authentik-Uid
			trusted_proxies private_ranges
		}
		reverse_proxy 127.0.0.1:8088
	}
}

# ─── Dead blocks removed 2026-02-12 ───
# LOOP-CLOUDFLARE-INGRESS-PARITY-REMEDIATION-20260212
#
# Removed 8 Caddy blocks that were never hit (tunnel routes directly to services):
#   finances, investments, docs, mail-archive (finance services → VM 211 direct)
#   chat, grafana, minio, n8n (native auth services → direct Tailscale/extra_hosts)
#
# Remaining Caddy-proxied services: auth, pihole, vault, secrets (4 blocks above)
# All other services route direct from cloudflared → service.
