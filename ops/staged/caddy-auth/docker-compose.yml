services:
  caddy:
    image: caddy:latest
    container_name: caddy
    restart: unless-stopped
    network_mode: host
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    environment:
      - AUTHENTIK_HOSTNAME=${AUTHENTIK_HOSTNAME}
      - PIHOLE_HOSTNAME=${PIHOLE_HOSTNAME}
      - VAULT_HOSTNAME=${VAULT_HOSTNAME}
      - SECRETS_HOSTNAME=${SECRETS_HOSTNAME}
      - FINANCES_HOSTNAME=${FINANCES_HOSTNAME}
      - FINANCES_UPSTREAM=${FINANCES_UPSTREAM}
      - INVESTMENTS_HOSTNAME=${INVESTMENTS_HOSTNAME}
      - INVESTMENTS_UPSTREAM=${INVESTMENTS_UPSTREAM}
      - DOCS_HOSTNAME=${DOCS_HOSTNAME}
      - DOCS_UPSTREAM=${DOCS_UPSTREAM}
      - MAIL_ARCHIVE_HOSTNAME=${MAIL_ARCHIVE_HOSTNAME}
      - MAIL_ARCHIVE_UPSTREAM=${MAIL_ARCHIVE_UPSTREAM}
      - MINIO_HOSTNAME=${MINIO_HOSTNAME}
      - MINIO_UPSTREAM=${MINIO_UPSTREAM}
      - N8N_HOSTNAME=${N8N_HOSTNAME}
      - N8N_UPSTREAM=${N8N_UPSTREAM}
      - CHAT_HOSTNAME=${CHAT_HOSTNAME}
      - CHAT_UPSTREAM=${CHAT_UPSTREAM}
      - GRAFANA_HOSTNAME=${GRAFANA_HOSTNAME}
      - GRAFANA_UPSTREAM=${GRAFANA_UPSTREAM}

  authentik-server:
    image: ghcr.io/goauthentik/server:latest
    container_name: authentik-server
    restart: unless-stopped
    command: server
    environment:
      - AUTHENTIK_SECRET_KEY=${AUTHENTIK_SECRET_KEY}
      - AUTHENTIK_REDIS__HOST=authentik-redis
      - AUTHENTIK_POSTGRESQL__HOST=authentik-postgres
      - AUTHENTIK_POSTGRESQL__USER=authentik
      - AUTHENTIK_POSTGRESQL__PASSWORD=${AUTHENTIK_DB_PASSWORD}
      - AUTHENTIK_POSTGRESQL__NAME=authentik
    ports:
      - "9000:9000"
      - "9443:9443"
    depends_on:
      - authentik-postgres
      - authentik-redis

  authentik-worker:
    image: ghcr.io/goauthentik/server:latest
    container_name: authentik-worker
    restart: unless-stopped
    command: worker
    environment:
      - AUTHENTIK_SECRET_KEY=${AUTHENTIK_SECRET_KEY}
      - AUTHENTIK_REDIS__HOST=authentik-redis
      - AUTHENTIK_POSTGRESQL__HOST=authentik-postgres
      - AUTHENTIK_POSTGRESQL__USER=authentik
      - AUTHENTIK_POSTGRESQL__PASSWORD=${AUTHENTIK_DB_PASSWORD}
      - AUTHENTIK_POSTGRESQL__NAME=authentik
    depends_on:
      - authentik-postgres
      - authentik-redis

  authentik-postgres:
    image: postgres:15-alpine
    container_name: authentik-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=authentik
      - POSTGRES_PASSWORD=${AUTHENTIK_DB_PASSWORD}
      - POSTGRES_DB=authentik
    volumes:
      - authentik_postgres:/var/lib/postgresql/data

  authentik-redis:
    image: redis:alpine
    container_name: authentik-redis
    restart: unless-stopped
    command: ["redis-server", "--save", "60", "1", "--loglevel", "warning"]
    volumes:
      - authentik_redis:/data

volumes:
  caddy_data:
    driver: local
  caddy_config:
    driver: local
  authentik_postgres:
    driver: local
  authentik_redis:
    driver: local
