# Status: authoritative
# Last verified: 2026-02-17
# Purpose: Canonical bundle-based secret rotation and verification contract.

version: 1
updated: 2026-02-28
owner: "@ronny"

defaults:
  deprecated_projects:
    - finance-stack
    - mint-os-vault

bundles:
  finance:
    description: "Finance API token rotation bundle (Firefly + Paperless + Ghostfolio)."
    project: infrastructure
    environment: prod
    legacy_projects:
      - finance-stack
    keys:
      - name: FIREFLY_ACCESS_TOKEN
        path: /spine/services/finance
      - name: PAPERLESS_API_TOKEN
        path: /spine/services/paperless
      - name: GHOSTFOLIO_ACCESS_TOKEN
        path: /spine/services/finance
    verify:
      - id: firefly_about
        type: bearer
        key: FIREFLY_ACCESS_TOKEN
        url: http://100.76.153.100:8080/api/v1/about
        expect_http: 200
      - id: paperless_docs
        type: token
        key: PAPERLESS_API_TOKEN
        url: "http://100.76.153.100:8000/api/documents/?page_size=1"
        expect_http: 200
      - id: ghostfolio_user
        type: security_token_exchange
        key: GHOSTFOLIO_ACCESS_TOKEN
        exchange_url: http://100.76.153.100:3333/api/v1/auth/anonymous
        url: http://100.76.153.100:3333/api/v1/user
        expect_http: 200
        # Two-step: POST exchange_url with {"accessToken":"<key>"} → JWT → Bearer for url
    local_env:
      file: /Users/ronnyworks/code/workbench/agents/finance/tools/.env
      static:
        FIREFLY_URL: http://100.76.153.100:8080
        PAPERLESS_URL: http://100.76.153.100:8000
        GHOSTFOLIO_URL: http://100.76.153.100:3333
      secret_keys:
        - FIREFLY_ACCESS_TOKEN
        - PAPERLESS_API_TOKEN
        - GHOSTFOLIO_ACCESS_TOKEN

  media-arr:
    description: "Media ARR/API rotation bundle (Radarr + Sonarr + Lidarr) with downstream parity probes."
    project: infrastructure
    environment: prod
    keys:
      - name: RADARR_API_KEY
        path: /spine/vm-infra/media-stack/download
      - name: SONARR_API_KEY
        path: /spine/vm-infra/media-stack/download
      - name: LIDARR_API_KEY
        path: /spine/vm-infra/media-stack/download
    verify:
      - id: radarr_status
        type: x_api_key
        key: RADARR_API_KEY
        url: http://100.107.36.76:7878/api/v3/system/status
        expect_http: 200
      - id: sonarr_status
        type: x_api_key
        key: SONARR_API_KEY
        url: http://100.107.36.76:8989/api/v3/system/status
        expect_http: 200
      - id: lidarr_status
        type: x_api_key
        key: LIDARR_API_KEY
        url: http://100.107.36.76:8686/api/v1/system/status
        expect_http: 200
      - id: prowlarr_auth
        type: x_api_key
        key: PROWLARR_API_KEY
        url: http://100.107.36.76:9696/api/v1/health
        expect_http: 200
      - id: jellyseerr_auth
        type: x_api_key
        key: JELLYSEERR_API_KEY
        url: http://100.123.207.64:5055/api/v1/settings/main
        expect_http: 200
    local_env:
      file: /Users/ronnyworks/code/workbench/agents/media/tools/.env
      static:
        RADARR_URL: http://100.107.36.76:7878
        SONARR_URL: http://100.107.36.76:8989
        LIDARR_URL: http://100.107.36.76:8686
        PROWLARR_URL: http://100.107.36.76:9696
        JELLYSEERR_URL: http://100.123.207.64:5055
      secret_keys:
        - RADARR_API_KEY
        - SONARR_API_KEY
        - LIDARR_API_KEY
        - PROWLARR_API_KEY
        - JELLYSEERR_API_KEY

  mint-deploy:
    description: "Mint module deploy bundle — shipping, pricing, suppliers, payment, and notifications API/DB/auth keys."
    project: infrastructure
    environment: prod
    keys:
      - name: SHIPPING_API_KEY
        path: /spine/services/shipping
      - name: SHIPPING_DATABASE_URL
        path: /spine/services/shipping
      - name: PRICING_API_KEY
        path: /spine/services/pricing
      - name: PRICING_DATABASE_URL
        path: /spine/services/pricing
      - name: SUPPLIERS_API_KEY
        path: /spine/services/suppliers
      - name: SUPPLIERS_DATABASE_URL
        path: /spine/services/suppliers
      - name: PAYMENT_API_KEY
        path: /spine/services/payment
      - name: PAYMENT_JWT_SECRET
        path: /spine/services/payment
      - name: PAYMENT_DATABASE_URL
        path: /spine/services/payment
      - name: PAYMENT_STRIPE_SECRET_KEY
        path: /spine/services/payment
      - name: PAYMENT_STRIPE_WEBHOOK_SECRET
        path: /spine/services/payment
      - name: NOTIFICATIONS_API_KEY
        path: /spine/services/notifications
      - name: NOTIFICATIONS_JWT_SECRET
        path: /spine/services/notifications
    verify:
      - id: shipping_health
        type: none
        url: http://100.79.183.14:3900/health
        expect_http: 200
      - id: pricing_health
        type: none
        url: http://100.79.183.14:3700/health
        expect_http: 200
      - id: suppliers_health
        type: none
        url: http://100.79.183.14:3800/health
        expect_http: 200

  communications-transactional:
    description: "Transactional communications provider bundle — Resend + Twilio + sender identities."
    project: infrastructure
    environment: prod
    keys:
      - name: RESEND_API_KEY
        path: /spine/services/communications
      - name: FROM_EMAIL
        path: /spine/integrations/commerce-mail
      - name: ADMIN_EMAIL
        path: /spine/services/communications
      - name: TWILIO_ACCOUNT_SID
        path: /spine/services/communications
      - name: TWILIO_AUTH_TOKEN
        path: /spine/services/communications
      - name: TWILIO_PHONE_NUMBER
        path: /spine/services/communications
