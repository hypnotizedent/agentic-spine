# VM Lifecycle Binding (SSOT)
# Non-secret. Spine-native. Tracks every Proxmox VM through its lifecycle.
# Status: authoritative
# Last verified: 2026-02-20
#
# Contract: docs/core/VM_CREATION_CONTRACT.md
# Authority: This binding is the per-VM state tracker. Hardware specs
#            live in SHOP_SERVER_SSOT.md. Service mappings live in
#            SERVICE_REGISTRY.yaml. This binding answers: "what VMs exist,
#            what phase are they in, and what do they host?"
#
# Status values: planning | provisioned | registered | active | decommissioned | abandoned
# Decommission policies: requires_migration_first | requires_final_backup | allow_immediate_destroy

version: 1
updated: "2026-02-20"
owner: "@ronny"

defaults:
  proxmox_host: pve
  profile: spine-ready-v1
  owner: "@ronny"
  decommission_policy: requires_migration_first

# ─────────────────────────────────────────────────────────────
# Shop Site VMs (pve — Dell R730XD)
# ─────────────────────────────────────────────────────────────

vms:
  - id: 200
    hostname: docker-host
    proxmox_host: pve
    role: legacy-production
    owner: "@ronny"
    status: active
    created_at: "2024-01-01"  # pre-spine, approximate
    profile: null  # pre-spine VM, no profile
    lan_ip: 192.168.1.200
    tailscale_ip: 100.92.156.118
    ssh_target: docker-host
    ssh_user: ubuntu
    os: linux-mint
    resources:
      cpu_cores: 16
      memory_mb: 98304  # 96GB
      boot_disk_gb: 300
    stacks:
      - mint-os
      - artwork-module
      - quote-page
      - dashy
    services:
      - mint-os-admin
      - mint-os-customer
      - mint-os-production
      - mint-os-kanban
      - mint-os-job-estimator
      - mint-os-dashboard-api
      - mint-os-postgres
      - mint-os-redis
      - minio
      - files-api
      - quote-page
      - dashy
    backup_target: vm-200-docker-host-primary
    health_probe_policy: selective  # some services deprecated, probes disabled
    decommission_policy: requires_migration_first
    description: >
      Legacy VM. Linux Mint (non-Ubuntu). Pre-dates spine governance.
      Finance stack migrated to VM 211. Mint-os-api marked deprecated.
      Cloud-init disabled.

  - id: 202
    hostname: automation-stack
    proxmox_host: pve
    role: automation
    owner: "@ronny"
    status: active
    created_at: "2025-12-01"  # approximate
    profile: spine-ready-v1
    lan_ip: 192.168.1.110
    tailscale_ip: 100.98.70.70
    ssh_target: automation-stack
    ssh_user: ubuntu
    os: ubuntu-24.04
    resources:
      cpu_cores: 4
      memory_mb: 16384
      boot_disk_gb: 100
    stacks:
      - automation
      - mcpjungle
    services:
      - n8n
      - open-webui
      - ollama
      - automation-postgres
      - automation-redis
      - mcpjungle
    backup_target: vm-202-primary
    health_probe_policy: full
    decommission_policy: requires_migration_first
    description: "Workflow automation + MCP gateway."

  - id: 203
    hostname: immich
    proxmox_host: pve
    role: photo-management
    owner: "@ronny"
    status: active
    created_at: "2025-06-01"  # approximate
    profile: null  # pre-spine
    lan_ip: 192.168.1.203
    tailscale_ip: 100.114.101.50
    ssh_target: immich
    ssh_user: ronny  # cloud-init user
    os: ubuntu-24.04
    resources:
      cpu_cores: 8
      memory_mb: 16384
      boot_disk_gb: 100
    stacks:
      - immich
    services:
      - immich-server
      - immich-ml
      - immich-postgres
      - immich-redis
    backup_target: vm-203-primary
    health_probe_policy: full
    decommission_policy: requires_final_backup
    description: >
      135K+ assets, 3TB library. 8 CPU cores (host passthrough), 100GB boot.
      LAN IP 192.168.1.203 (static). Not in docker.compose.targets.yaml (known exemption).

  - id: 204
    hostname: infra-core
    proxmox_host: pve
    role: core-infrastructure
    owner: "@ronny"
    status: active
    created_at: "2025-12-01"  # approximate
    profile: spine-ready-v1
    lan_ip: 192.168.1.204
    tailscale_ip: 100.92.91.128
    ssh_target: infra-core
    ssh_user: ubuntu
    os: ubuntu-24.04
    resources:
      cpu_cores: 4
      memory_mb: 8192
      boot_disk_gb: 50
    stacks:
      - cloudflared
      - pihole
      - secrets
      - vaultwarden
      - caddy-auth
    services:
      - cloudflared
      - pihole
      - infisical
      - vaultwarden
      - caddy
      - authentik
    backup_target: vm-204-infra-core-primary
    health_probe_policy: full
    decommission_policy: requires_migration_first
    description: "Core infrastructure VM. Hosts reverse proxy, SSO, DNS, secrets, tunnel. Critical path."

  - id: 205
    hostname: observability
    proxmox_host: pve
    role: monitoring
    owner: "@ronny"
    status: active
    created_at: "2025-12-01"  # approximate
    profile: spine-ready-v1
    lan_ip: 192.168.1.205
    tailscale_ip: 100.120.163.70
    ssh_target: observability
    ssh_user: ubuntu
    os: ubuntu-24.04
    resources:
      cpu_cores: 4
      memory_mb: 8192
      boot_disk_gb: 50
    stacks:
      - prometheus
      - grafana
      - loki
      - uptime-kuma
      - node-exporter
    services:
      - prometheus
      - grafana
      - loki
      - uptime-kuma
      - node-exporter
    backup_target: vm-205-observability-primary
    health_probe_policy: full
    decommission_policy: requires_migration_first
    description: "Observability stack. Loki compactor needs >=720s start_period."

  - id: 206
    hostname: dev-tools
    proxmox_host: pve
    role: development
    owner: "@ronny"
    status: active
    created_at: "2025-12-01"  # approximate
    profile: spine-ready-v1
    lan_ip: 192.168.1.206
    tailscale_ip: 100.90.167.39
    ssh_target: dev-tools
    ssh_user: ubuntu
    os: ubuntu-24.04
    resources:
      cpu_cores: 4
      memory_mb: 8192
      boot_disk_gb: 50
    stacks:
      - gitea
    services:
      - gitea
      - gitea-runner
      - gitea-postgres
    backup_target: vm-206-primary
    health_probe_policy: full
    decommission_policy: requires_migration_first
    description: "Git forge. Authentik SSO. CF tunnel for git.ronny.works."

  - id: 207
    hostname: ai-consolidation
    proxmox_host: pve
    role: ai-services
    owner: "@ronny"
    status: active
    created_at: "2026-02-08"
    profile: ai-services-v1
    lan_ip: 192.168.1.8  # DHCP (no VMID parity)
    tailscale_ip: 100.71.17.29
    ssh_target: ai-consolidation
    ssh_user: ubuntu
    os: ubuntu-24.04
    resources:
      cpu_cores: 8
      memory_mb: 32768
      boot_disk_gb: 200
    stacks:
      - ai-consolidation
    services:
      - qdrant
      - anythingllm
    backup_target: vm-207-primary
    health_probe_policy: full
    decommission_policy: requires_migration_first
    description: "AI workloads. DHCP (no static LAN IP). Migrated from MacBook."

  - id: 209
    hostname: download-stack
    proxmox_host: pve
    role: media-download
    owner: "@ronny"
    status: active
    created_at: "2026-02-08"
    profile: spine-ready-v1
    lan_ip: 192.168.1.209
    tailscale_ip: 100.107.36.76
    ssh_target: download-stack
    ssh_user: ubuntu
    os: ubuntu-24.04
    resources:
      cpu_cores: 4
      memory_mb: 8192
      boot_disk_gb: 50
    stacks:
      - download-stack
    services:
      - radarr
      - sonarr
      - lidarr
      - prowlarr
      - sabnzbd
      - tdarr
      - trailarr
      - qbittorrent
      - unpackerr
      - recyclarr
      - flaresolverr
      - slskd
      - soularr
      - swaparr-radarr
      - swaparr-sonarr
      - swaparr-lidarr
      - posterizarr
      - decypharr
      - huntarr
      - autopulse
      - crosswatch
      - crowdsec
    backup_target: vm-209-primary
    health_probe_policy: selective  # tdarr/slskd intentionally stopped
    decommission_policy: requires_migration_first
    description: "Download services. Split from media-stack (VM 201). NFS mounts from pve."

  - id: 210
    hostname: streaming-stack
    proxmox_host: pve
    role: media-streaming
    owner: "@ronny"
    status: active
    created_at: "2026-02-08"
    profile: spine-ready-v1
    lan_ip: 192.168.1.210
    tailscale_ip: 100.123.207.64
    ssh_target: streaming-stack
    ssh_user: ubuntu
    os: ubuntu-24.04
    resources:
      cpu_cores: 4
      memory_mb: 8192
      boot_disk_gb: 50
    stacks:
      - streaming-stack
    services:
      - jellyfin
      - navidrome
      - jellyseerr
      - bazarr
      - homarr
      - wizarr
      - spotisub
      - subgen
    backup_target: vm-210-primary
    health_probe_policy: full
    decommission_policy: requires_migration_first
    description: "Streaming services. Split from media-stack (VM 201). NFS mounts from pve."

  - id: 211
    hostname: finance-stack
    proxmox_host: pve
    role: finance
    owner: "@ronny"
    status: active
    created_at: "2026-02-11"
    profile: spine-ready-v1
    lan_ip: 192.168.1.211
    tailscale_ip: 100.76.153.100
    ssh_target: finance-stack
    ssh_user: ubuntu
    os: ubuntu-24.04
    resources:
      cpu_cores: 4
      memory_mb: 8192
      boot_disk_gb: 96
    stacks:
      - finance
    services:
      - firefly-iii-vm211
      - firefly-importer-vm211
      - firefly-cron-vm211
      - finance-postgres-vm211
      - finance-redis-vm211
      - paperless-ngx-vm211
      - ghostfolio-vm211
      - mail-archiver-vm211
      - mail-archiver-db-vm211
    backup_target: vm-211-primary
    health_probe_policy: full
    decommission_policy: requires_final_backup
    description: "Finance stack. Migrated from docker-host (LOOP-FINANCE-VM-SEPARATION-20260211)."

  - id: 212
    hostname: mint-data
    proxmox_host: pve
    role: mint-data-plane
    owner: "@ronny"
    status: active
    created_at: "2026-02-12"
    profile: spine-ready-v1
    lan_ip: 192.168.1.212
    tailscale_ip: 100.106.72.25
    ssh_target: mint-data
    ssh_user: ubuntu
    os: ubuntu-24.04
    resources:
      cpu_cores: 4
      memory_mb: 8192
      boot_disk_gb: 50
    stacks:
      - mint-data
    services:
      - mint-modules-postgres
      - mint-modules-minio
      - mint-modules-redis
    backup_target: vm-212-mint-data-primary
    health_probe_policy: full
    decommission_policy: requires_final_backup
    description: "Mint fresh-slate data plane. PostgreSQL 16 + MinIO + Redis."

  - id: 213
    hostname: mint-apps
    proxmox_host: pve
    role: mint-app-plane
    owner: "@ronny"
    status: active
    created_at: "2026-02-12"
    profile: spine-ready-v1
    lan_ip: 192.168.1.213
    tailscale_ip: 100.79.183.14
    ssh_target: mint-apps
    ssh_user: ubuntu
    os: ubuntu-24.04
    resources:
      cpu_cores: 4
      memory_mb: 8192
      boot_disk_gb: 50
    stacks:
      - mint-apps
    services:
      - files-api
      - quote-page
      - order-intake
    backup_target: vm-213-mint-apps-primary
    health_probe_policy: full
    decommission_policy: requires_migration_first
    description: "Mint fresh-slate app plane. Artwork + quote-page + order-intake."

# ─────────────────────────────────────────────────────────────
# Decommissioned VMs
# ─────────────────────────────────────────────────────────────

  - id: 201
    hostname: media-stack
    proxmox_host: pve
    role: media
    owner: "@ronny"
    status: decommissioned
    created_at: "2025-06-01"  # approximate
    decommissioned_at: "2026-02-12"
    profile: null
    lan_ip: null
    tailscale_ip: null
    ssh_target: null
    ssh_user: null
    os: ubuntu-24.04
    resources: null
    stacks: []
    services: []
    backup_target: null
    health_probe_policy: none
    decommission_policy: requires_migration_first
    description: >
      Destroyed 2026-02-12 (qm destroy --purge + zfs destroy tank/docker/media-stack).
      Services split to VM 209 (download) and VM 210 (streaming).

# ─────────────────────────────────────────────────────────────
# Home Site VMs/LXCs (proxmox-home — Beelink SER7)
# ─────────────────────────────────────────────────────────────

  - id: 100
    hostname: homeassistant
    proxmox_host: proxmox-home
    role: home-automation
    owner: "@ronny"
    status: active
    created_at: "2024-01-01"  # pre-spine, approximate
    profile: null  # HA OS, not spine-provisioned
    lan_ip: 10.0.0.100
    tailscale_ip: 100.67.120.1
    ssh_target: ha
    ssh_user: hassio
    os: haos  # Home Assistant OS (not standard Ubuntu)
    resources:
      cpu_cores: 2
      memory_mb: 4096
      boot_disk_gb: 32
    stacks: []  # HA OS uses its own supervisor, not docker-compose
    services:
      - home-assistant
    backup_target: home-vm-100-ha-primary
    health_probe_policy: full
    decommission_policy: requires_final_backup
    description: >
      Home Assistant OS VM. Supervisor manages add-ons (Zigbee, Z-Wave, UniFi).
      No docker-compose — HA OS uses its own orchestration. Pre-dates spine.

  - id: 101
    hostname: immich
    proxmox_host: proxmox-home
    role: photo-management
    owner: "@ronny"
    status: decommissioned
    created_at: "2024-01-01"  # pre-spine, approximate
    decommissioned_at: "2026-02-20"
    profile: null  # pre-spine
    lan_ip: null
    tailscale_ip: null
    ssh_target: null
    ssh_user: null
    os: ubuntu-24.04
    resources: null
    stacks: []
    services: []
    backup_target: null
    health_probe_policy: none
    decommission_policy: requires_final_backup
    description: >
      DESTROYED 2026-02-20 (qm destroy 101 --purge). Snapshot + LVM volumes removed.
      Final NAS backup: vzdump-qemu-101-2026_02_15-04_00_03.vma.zst (18GB).
      Shop Immich (VM 203) is canonical. Removed from P2 backup job.

  - id: 102
    hostname: vaultwarden
    proxmox_host: proxmox-home
    role: security
    owner: "@ronny"
    status: decommissioned
    created_at: "2024-01-01"  # pre-spine, approximate
    decommissioned_at: "2026-02-16"
    profile: null  # pre-spine
    lan_ip: 10.0.0.102
    tailscale_ip: 100.93.142.63
    ssh_target: vault
    ssh_user: root
    os: ubuntu-24.04
    resources:
      cpu_cores: 2
      memory_mb: 2048
      boot_disk_gb: 16
    stacks:
      - vaultwarden
    services:
      - vaultwarden
    backup_target: home-vm-102-vaultwarden-primary
    health_probe_policy: none  # decommissioned
    decommission_policy: requires_final_backup
    description: >
      DECOMMISSIONED 2026-02-16. Vaultwarden password manager (home). Superseded by
      infra-core (VM 204). Final vzdump: vzdump-qemu-102-2026_02_15-03_01_25.vma.zst.
      Unsynced stale standby — higher risk than value.

  - id: 103
    hostname: download-home
    proxmox_host: proxmox-home
    role: media-download
    owner: "@ronny"
    status: decommissioned
    created_at: "2024-01-01"  # pre-spine, approximate
    decommissioned_at: "2026-02-20"
    vm_type: lxc
    profile: null  # pre-spine LXC
    lan_ip: null
    tailscale_ip: null
    ssh_target: null
    ssh_user: null
    os: ubuntu  # LXC
    resources: null
    stacks: []
    services: []
    backup_target: null
    health_probe_policy: none
    decommission_policy: allow_immediate_destroy
    description: >
      DESTROYED 2026-02-20 (pct destroy 103 --purge). LVM volume removed.
      Final NAS backup: vzdump-lxc-103-2026_02_20-03_15_03.tar.zst (485MB).
      Shop download-stack (VM 209) is canonical.
      Daily vzdump disabled 2026-02-20 (backup-home-p1-daily enabled=0). Has bind
      mount /mnt/staging (excluded from backup).

  - id: 105
    hostname: pihole-home
    proxmox_host: proxmox-home
    role: dns
    owner: "@ronny"
    status: active
    created_at: "2024-01-01"  # pre-spine, approximate
    vm_type: lxc
    profile: null  # pre-spine LXC
    lan_ip: 10.0.0.53
    tailscale_ip: 100.105.148.96
    ssh_target: pihole-home
    ssh_user: root
    os: ubuntu  # LXC
    resources:
      cpu_cores: 1
      memory_mb: 512
      boot_disk_gb: 4
    stacks: []
    services: []
    backup_target: home-lxc-105-pihole-primary
    health_probe_policy: full
    decommission_policy: allow_immediate_destroy
    description: >
      Reactivated 2026-02-21 for home-local DNS filtering. Active LXC on proxmox-home
      and home DHCP DNS target. Weekly P2 backup target retained.

# ─────────────────────────────────────────────────────────────
# Template VMs (not lifecycle-governed)
# ─────────────────────────────────────────────────────────────

  - id: 9000
    hostname: ubuntu-2404-cloudinit-template
    proxmox_host: pve
    role: template
    owner: "@ronny"
    status: template
    created_at: "2025-12-01"  # approximate
    profile: null
    lan_ip: null
    tailscale_ip: null
    ssh_target: null
    ssh_user: null
    os: ubuntu-24.04
    resources:
      cpu_cores: 2
      memory_mb: 2048
      boot_disk_gb: 4
    stacks: []
    services: []
    backup_target: null
    health_probe_policy: none
    decommission_policy: allow_immediate_destroy
    description: "Cloud-init template. Clone source for all new VMs. Never started directly."
