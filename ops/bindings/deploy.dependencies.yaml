# Deploy Dependencies Binding
# Non-secret. Spine-native.
# Status: authoritative
# Last verified: 2026-02-13
#
# Tracks deployment-time dependencies between services.
# When an upstream config changes, downstream services may cache
# stale discovery/config and need a restart to pick up the change.
#
# This binding is enforced by D51 (caddy-proto-lock) for the Caddy
# proto header case, and serves as a human-readable runbook for
# other dependency chains.
#
# Source of truth for: "what else do I need to restart?"

version: 1
updated: "2026-02-09"

# ─── Dependency Chains ────────────────────────────────────────────

chains:
  - id: caddy-proto-to-oidc
    trigger: "Caddy reverse_proxy config change (proto, host, headers)"
    affected:
      - service: gitea
        host: dev-tools
        reason: "Caches OIDC discovery doc (issuer URL) on startup. Stale cache causes JWT issuer mismatch."
        action: "docker restart gitea"
    gate: D51
    description: |
      Root cause: CF tunnel terminates TLS, Caddy sees HTTP, must inject
      X-Forwarded-Proto https. Without it, Authentik generates http:// OIDC
      URLs. Downstream OAuth2 clients cache the discovery doc at startup
      and will reject tokens with a different issuer until restarted.

  - id: authentik-provider-change
    trigger: "Authentik provider/application config change (redirect URIs, flows, outpost)"
    affected:
      - service: gitea
        host: dev-tools
        reason: "OAuth2 client config (client_id, redirect_uri) baked into Gitea DB."
        action: "Update via Gitea admin UI or API, then restart if OIDC discovery changed."
    gate: null
    description: |
      Gitea stores OAuth2 source config in its database. If the Authentik
      provider's client_id or redirect_uri changes, Gitea's DB entry must
      be updated too. A restart alone won't fix a client_id mismatch.

# ─── Rules ────────────────────────────────────────────────────────

rules:
  - "After ANY Caddy config change: check this file for affected services"
  - "After ANY Authentik provider change: check this file for affected services"
  - "Always restart affected services BEFORE declaring the change complete"
  - "The Caddyfile MUST have `header_up X-Forwarded-Proto https` on ALL reverse_proxy blocks targeting Authentik (port 9000)"
