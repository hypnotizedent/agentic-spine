# Services Health Binding
# Non-secret. Spine-native. Read-only HTTP probes.
#
# Source SSOT: docs/governance/SERVICE_REGISTRY.yaml
# Each endpoint is a known service health URL (no auth required).
#
# Coverage policy:
#   Services with HTTP endpoints get probes here. Internal-only containers
#   (no published ports), portless sidecars, and TCP-only services (postgres,
#   redis) rely on Docker HEALTHCHECK + vzdump VM-level coverage. These are
#   not accidental omissions — they are policy exclusions.

version: 1

defaults:
  connect_timeout_sec: 5
  max_time_sec: 10

endpoints:
  - id: mint-os-api
    host: docker-host
    url: "http://100.92.156.118:3335/health"
    expect: 200
    enabled: false
    notes: "Legacy docker-host service (Mint OS Dashboard API) — decommissioned; disable probe."

  - id: minio
    host: docker-host
    url: "http://100.92.156.118:9000/minio/health/live"
    expect: 200
    enabled: true
    notes: "Active — 8 buckets, 86k+ objects. Re-enabled 2026-02-10 (LOOP-MINIO-VOLUME-PATH-DIVERGENCE-20260210)."

  - id: files-api
    host: docker-host
    url: "http://100.92.156.118:3500/health"
    expect: 200
    notes: "Artwork module API (seeds, assets, presigned URLs)"

  - id: quote-page
    host: docker-host
    url: "http://100.92.156.118:3341/health"
    expect: 200
    notes: "Quote intake form for customer.mintprints.co"

  - id: dashy
    host: docker-host
    url: "http://100.92.156.118:4000/"
    expect: 200
    enabled: true
    notes: "Dashy homelab dashboard (visual runtime map of spine services)"

  # Finance probes on docker-host REMOVED — services migrated to finance-stack VM 211.
  # Live probes are firefly-iii-vm211, paperless-ngx-vm211, ghostfolio-vm211, mail-archiver-vm211 (below).

  - id: caddy
    host: infra-core
    url: "http://100.92.91.128:80/"
    expect: 200
    enabled: true
    notes: "Caddy reverse proxy. SPOF for all infra-core traffic. Returns 200 when healthy."

  - id: cloudflared
    host: infra-core
    url: "http://100.92.91.128:60123/metrics"
    expect: 200
    enabled: false
    notes: "Cloudflared has no --metrics flag in compose and no published ports (network_mode: host). Health signal is docker.compose.status only. To enable: add --metrics=0.0.0.0:60123 to compose command and restart (SPOF risk — schedule maintenance window)."

  - id: infisical
    host: infra-core
    url: "http://100.92.91.128:8088/api/status"
    expect: 200
    notes: "Infisical internal health (no auth)"

  - id: vaultwarden
    host: infra-core
    url: "http://100.92.91.128:8081/alive"
    expect: 200
    notes: "Vaultwarden liveness"

  - id: authentik
    host: infra-core
    url: "http://100.92.91.128:9000/if/flow/initial-setup/"
    expect: 200
    notes: "Authentik initial setup / health-like endpoint"

  - id: pihole
    host: infra-core
    url: "http://100.92.91.128:8053/admin/"
    expect: 302
    notes: "Pi-hole admin UI (no auth required for login page)"

  - id: n8n
    host: automation-stack
    url: "http://100.98.70.70:5678/healthz"
    expect: 200
    notes: "n8n workflow automation"

  - id: open-webui
    host: automation-stack
    url: "http://100.98.70.70:3000/"
    expect: 200
    notes: "Open WebUI chat interface (automation-stack)"

  - id: ollama
    host: automation-stack
    url: "http://100.98.70.70:11434/api/tags"
    expect: 200
    notes: "Ollama API (automation-stack)"

  - id: mcpjungle
    host: automation-stack
    url: "http://100.98.70.70:8080/health"
    expect: 200
    notes: "MCPJungle gateway/runtime"

  - id: prometheus
    host: observability
    url: "http://100.120.163.70:9090/-/healthy"
    expect: 200
    notes: "Prometheus metrics"

  - id: grafana
    host: observability
    url: "http://100.120.163.70:3000/api/health"
    expect: 200
    notes: "Grafana dashboards"

  - id: loki
    host: observability
    url: "http://100.120.163.70:3100/ready"
    expect: 200
    notes: "Loki log aggregation"

  - id: uptime-kuma
    host: observability
    url: "http://100.120.163.70:3001"
    expect: 302
    notes: "Uptime Kuma monitoring"

  - id: node-exporter
    host: observability
    url: "http://100.120.163.70:9100/metrics"
    expect: 200
    notes: "Node exporter host metrics"

  - id: gitea
    host: dev-tools
    url: "http://100.90.167.39:3000/api/healthz"
    expect: 200
    notes: "Gitea Git forge"

  - id: qdrant
    host: ai-consolidation
    url: "http://100.71.17.29:6333/healthz"
    expect: 200
    notes: "Qdrant vector DB (VM 207)"

  - id: anythingllm
    host: ai-consolidation
    url: "http://100.71.17.29:3002/api/ping"
    expect: 200
    notes: "AnythingLLM RAG interface (VM 207)"

  # ─── Immich (VM 203) ─────────────────────────────────────────────────
  - id: immich
    host: immich
    url: "http://100.114.101.50:2283/api/server/ping"
    expect: 200
    enabled: true
    notes: "Immich photo management (VM 203). Re-enabled 2026-02-11 after GAP-OP-094 fix."

  # ─── Download Stack (VM 209) ───────────────────────────────────────
  - id: radarr
    host: download-stack
    url: "http://100.107.36.76:7878/ping"
    expect: 200
    notes: "Radarr movie management"

  - id: sonarr
    host: download-stack
    url: "http://100.107.36.76:8989/ping"
    expect: 200
    notes: "Sonarr TV management"

  - id: prowlarr
    host: download-stack
    url: "http://100.107.36.76:9696/ping"
    expect: 200
    notes: "Prowlarr indexer manager"

  - id: lidarr
    host: download-stack
    url: "http://100.107.36.76:8686/ping"
    expect: 200
    notes: "Lidarr music management"

  - id: sabnzbd
    host: download-stack
    url: "http://100.107.36.76:8080/"
    expect: 200
    notes: "SABnzbd Usenet downloader web UI"

  - id: tdarr
    host: download-stack
    url: "http://100.107.36.76:8265/"
    expect: 200
    enabled: false
    notes: "Tdarr transcode automation web UI (intentionally stopped during soak; disable probe until re-enabled)"

  - id: flaresolverr
    host: download-stack
    url: "http://100.107.36.76:8191/health"
    expect: 200
    notes: "FlareSolverr challenge solver"

  - id: slskd
    host: download-stack
    url: "http://100.107.36.76:5030/metrics"
    expect: 200
    enabled: false
    notes: "Localhost-bound by design; Docker health is authoritative signal. Disable external probe until probe_via:ssh feature exists."

  - id: download-node-exporter
    host: download-stack
    url: "http://100.107.36.76:9100/metrics"
    expect: 200
    notes: "Node exporter on download-stack"

  # ─── Streaming Stack (VM 210) ────────────────────────────────────
  - id: jellyfin
    host: streaming-stack
    url: "http://100.123.207.64:8096/health"
    expect: 200
    notes: "Jellyfin video streaming"

  - id: navidrome
    host: streaming-stack
    url: "http://100.123.207.64:4533/ping"
    expect: 200
    notes: "Navidrome music streaming"

  - id: jellyseerr
    host: streaming-stack
    url: "http://100.123.207.64:5055"
    expect: 307
    notes: "Jellyseerr request management (307 redirect to login is healthy)"

  - id: bazarr
    host: streaming-stack
    url: "http://100.123.207.64:6767/ping"
    expect: 200
    notes: "Bazarr subtitle management"

  - id: homarr
    host: streaming-stack
    url: "http://100.123.207.64:7575/"
    expect: 307
    notes: "Homarr dashboard (307 redirect to login is healthy)"

  - id: spotisub
    host: streaming-stack
    url: "http://100.123.207.64:8766/"
    expect: 302
    notes: "Spotisub Spotify-to-Subsonic sync (302 redirect to login is healthy)"

  - id: streaming-node-exporter
    host: streaming-stack
    url: "http://100.123.207.64:9100/metrics"
    expect: 200
    notes: "Node exporter on streaming-stack"

  # ─── Finance Stack (VM 211 — LIVE, cutover P4 complete) ─────────────────
  - id: firefly-iii-vm211
    host: finance-stack
    url: "http://100.76.153.100:8080/api/v1/about"
    expect: 302
    enabled: true
    notes: "Firefly III on finance-stack VM 211. Live — cutover P4 (LOOP-FINANCE-VM-SEPARATION-20260211)."

  - id: paperless-ngx-vm211
    host: finance-stack
    url: "http://100.76.153.100:8000/api/"
    expect: 302
    enabled: true
    notes: "Paperless-ngx on finance-stack VM 211. Live — cutover P4 (LOOP-FINANCE-VM-SEPARATION-20260211)."

  - id: ghostfolio-vm211
    host: finance-stack
    url: "http://100.76.153.100:3333/"
    expect: 301
    enabled: true
    notes: "Ghostfolio on finance-stack VM 211. Live — cutover P4 (LOOP-FINANCE-VM-SEPARATION-20260211)."

  - id: mail-archiver-vm211
    host: finance-stack
    url: "http://100.76.153.100:5100/"
    expect: 302
    enabled: true
    notes: "Mail Archiver on finance-stack VM 211. Live — cutover P4 (LOOP-FINANCE-VM-SEPARATION-20260211)."
