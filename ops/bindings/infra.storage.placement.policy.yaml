# Infrastructure Storage Placement Policy (SSOT)
# Non-secret. Spine-native.
# Status: authoritative
# Last verified: 2026-02-26
# Created: LOOP-STORAGE-BOOT-DRIVE-AUDIT-20260226
#
# Authority: This binding declares what storage tier each VM's persistent
# data should use. The VM creation contract references this binding in
# the PROVISION phase to determine data disk requirements.
#
# Storage tiers:
#   boot-only      — No separate data disk needed (stateless or ephemeral workloads)
#   tank-docker    — ZFS dataset on pve:tank/docker (NFS export or zvol)
#   tank-vms       — ZFS zvol on pve:tank/vms (passed through as virtio disk)
#   nfs-media      — NFS mount from pve media pool (read-only or read-write)
#   local-ext4     — /opt/appdata on boot disk for SQLite (NFS-incompatible; intentional)
#
# Boot drive threshold: 80% usage triggers alert. >90% is critical.

version: 1
updated: "2026-02-26"
owner: "@ronny"

# What MUST be on boot drives (acceptable):
boot_drive_acceptable:
  - os_kernel_bootloader
  - docker_engine_binary
  - docker_image_layers        # read-mostly, cached
  - compose_files_and_env      # small config files
  - opt_appdata_sqlite          # NFS-incompatible, intentional
  - ephemeral_temp_data

# What MUST NOT be on boot drives (violations):
boot_drive_violations:
  - postgresql_data_directories
  - redis_persistence_files
  - document_storage            # paperless media/consume/export
  - vector_databases            # qdrant
  - git_repositories            # gitea
  - object_storage              # minio
  - timeseries_databases        # prometheus tsdb
  - log_ingestion_data          # loki
  - mail_server_data            # stalwart, mail-archiver
  - unbounded_growth_paths      # anything that grows without limit

# Boot drive usage thresholds
thresholds:
  boot_usage_warn_pct: 80
  boot_usage_critical_pct: 90

# Per-VM storage placement declarations
# status: current = what IS happening, target = what SHOULD happen
vm_storage:
  docker-host:
    vmid: 200
    boot_disk_gb: 300
    current_storage_tier: tank-docker
    target_storage_tier: tank-docker
    data_mount: /mnt/docker
    data_source: "pve:tank/docker (NFS)"
    status: compliant
    notes: "Legacy VM. Data on NFS /mnt/docker/mint-os-data/. Legacy docker volumes for migrated services."

  automation-stack:
    vmid: 202
    boot_disk_gb: 100
    current_storage_tier: tank-vms
    target_storage_tier: tank-vms
    data_mount: null
    data_source: "pve:tank/vms/vm-202-disk-0 (ZFS zvol)"
    status: partial
    notes: "Boot disk is ZFS-backed zvol (not local-lvm). Docker volumes still on boot filesystem. Consider data disk for n8n/postgres."
    gap: GAP-OP-952

  immich:
    vmid: 203
    boot_disk_gb: 100
    current_storage_tier: tank-docker
    target_storage_tier: tank-docker
    data_mount: null
    data_source: "pve:tank/immich (ZFS, 2.6TB)"
    status: compliant
    notes: "Photo library on tank/immich ZFS dataset. Boot disk on local-lvm but data is properly separated."

  infra-core:
    vmid: 204
    boot_disk_gb: 50
    current_storage_tier: boot-only
    target_storage_tier: boot-only
    data_mount: null
    data_source: "Docker volumes on boot (250MB total)"
    status: accepted-risk
    notes: "22% boot usage (11GB/48GB). Volumes only 250MB. Data on boot but lightweight (Infisical/Authentik/VW/PiHole). Log rotation added. Re-evaluate if usage exceeds 60%."
    gap: GAP-OP-952

  observability:
    vmid: 205
    boot_disk_gb: 50
    current_storage_tier: boot-only
    target_storage_tier: boot-only
    data_mount: null
    data_source: "Docker volumes on boot (1GB total)"
    status: accepted-risk
    notes: "20% boot usage (9.4GB/48GB). Volumes 1GB. Loki/Prometheus data small at current retention. Log rotation added. Re-evaluate if usage exceeds 60%."
    gap: GAP-OP-953

  dev-tools:
    vmid: 206
    boot_disk_gb: 50
    current_storage_tier: boot-only
    target_storage_tier: boot-only
    data_mount: null
    data_source: "Docker volumes on boot (183MB total)"
    status: accepted-risk
    notes: "14% boot usage (6.3GB/48GB). Volumes 183MB. Gitea repos + PostgreSQL small at current scale. Log rotation added. Re-evaluate if usage exceeds 60%."
    gap: GAP-OP-954

  ai-consolidation:
    vmid: 207
    boot_disk_gb: 200
    current_storage_tier: boot-only
    target_storage_tier: boot-only
    data_mount: null
    data_source: "Docker on boot (3.5GB total, 0 volumes)"
    status: accepted-risk
    notes: "5% boot usage (8.1GB/193GB). 200GB boot has massive headroom. Qdrant vectors + AnythingLLM small. Log rotation added. Re-evaluate if usage exceeds 40%."
    gap: GAP-OP-955

  download-stack:
    vmid: 209
    boot_disk_gb: 50
    current_storage_tier: tank-docker
    target_storage_tier: tank-docker
    data_mount: /mnt/docker
    data_source: "pve:tank/docker/download-stack (NFS)"
    nfs_mounts:
      - path: /mnt/docker
        source: "192.168.1.184:/tank/docker/download-stack"
        mode: rw
      - path: /mnt/media
        source: "192.168.1.184:/media"
        mode: rw
    status: compliant
    notes: "Configs on NFS. /opt/appdata for SQLite (intentional). Media on NFS."

  streaming-stack:
    vmid: 210
    boot_disk_gb: 50
    current_storage_tier: tank-docker
    target_storage_tier: tank-docker
    data_mount: /mnt/docker
    data_source: "pve:tank/docker/streaming-stack (NFS)"
    nfs_mounts:
      - path: /mnt/docker
        source: "192.168.1.184:/tank/docker/streaming-stack"
        mode: rw
      - path: /mnt/media
        source: "192.168.1.184:/media"
        mode: ro
    status: compliant
    notes: "Configs on NFS (RW), media on NFS (RO). Pruned images + truncated 2.9GB log, 54%→44%. Log rotation added."
    gap: GAP-OP-957

  finance-stack:
    vmid: 211
    boot_disk_gb: 96
    current_storage_tier: boot-only
    target_storage_tier: boot-only
    data_mount: null
    data_source: "/opt/stacks/finance/data/ on boot (531MB)"
    status: accepted-risk
    notes: "12% boot usage (11GB/92GB) after truncating 59GB firefly-cron crash log. Actual data only 531MB. Fixed cron binary (crond→cron). Log rotation added. Re-evaluate if usage exceeds 60%."
    gap: GAP-OP-941

  mint-data:
    vmid: 212
    boot_disk_gb: 50
    current_storage_tier: tank-vms
    target_storage_tier: tank-vms
    data_mount: /mnt/data
    data_source: "/dev/vda ext4 secondary disk mounted at /mnt/data; DockerRootDir=/mnt/data/docker"
    status: compliant
    notes: "Rebased to non-boot persistence: postgres/minio/redis bind mounts under /mnt/data/mint-data/* with Redis appendonly=yes. Root usage now 8% (48G boot), data disk 61% (118G)."
    gap: GAP-OP-956

  mint-apps:
    vmid: 213
    boot_disk_gb: 50
    current_storage_tier: boot-only
    target_storage_tier: boot-only
    data_mount: null
    data_source: "none (stateless containers)"
    status: compliant
    notes: "Stateless containers. W8D hygiene applied: quote-page upload path bind-mounted to /opt/stacks/mint-apps/runtime/quote-page-uploads, build cache/image prune performed, weekly root-cron prune schedule installed."
    gap: GAP-OP-958

  communications-stack:
    vmid: 214
    boot_disk_gb: 50
    current_storage_tier: tank-vms
    target_storage_tier: tank-vms
    data_mount: null
    data_source: "pve:tank/vms/vm-214-disk-0 (ZFS zvol, 1.06TB)"
    status: partial
    notes: "Boot is ZFS zvol (not local-lvm). Stalwart on named volume. Mail-archiver needs /srv/mail-archiver non-boot path."
    gap: GAP-OP-940

# Remediation priority (by VM, ordered by urgency):
# VMs 204/205/206/207/210/211 resolved 2026-02-26: log rotation added, actual data small, accepted-risk.
remediation_priority:
  - vmid: 212
    hostname: mint-data
    urgency: critical
    action: "Attach ZFS zvol, move PostgreSQL + MinIO + Redis to data disk (81% boot, 9.5G free)"
    owner: mint-terminal
