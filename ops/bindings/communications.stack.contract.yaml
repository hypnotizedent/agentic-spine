# Status: authoritative
# Last verified: 2026-02-26

version: 1
updated_at: "2026-02-26"
owner: "@ronny"
scope: communications-stack-ws1

pilot:
  stage: ws1-live-pilot
  provider: stalwart
  execution_backend: microsoft
  microsoft:
    cap_exec: "ops/plugins/microsoft/bin/microsoft-cap-exec"
    live_probe_query: "*"
    search_default_top: 10
  vm_target:
    hostname: communications-stack
    vm_id: "214"
    profile: spine-ready-v1
    proxmox_host: pve
    tailscale_ip: "100.115.16.37"
    lan_ip: "192.168.1.26"
  ports:
    - container: 25
      host: 25
      protocol: SMTP
      description: "Inbound SMTP relay"
    - container: 465
      host: 465
      protocol: SMTPS
      description: "Implicit TLS submission"
    - container: 587
      host: 587
      protocol: STARTTLS
      description: "STARTTLS submission"
    - container: 993
      host: 993
      protocol: IMAPS
      description: "IMAP over TLS"
    - container: 4190
      host: 4190
      protocol: ManageSieve
      description: "Sieve filter management"
    - container: 443
      host: 8443
      protocol: HTTPS
      description: "Stalwart admin web UI and JMAP endpoint"
    - container: 8080
      host: 8080
      protocol: HTTP
      description: "Stalwart admin HTTP (internal only)"
  send_test:
    mode: live-pilot
    manual_approval_required: true
    default_sender: spine@spine.ronny.works
    default_recipient: spine@spine.ronny.works
    allowed_recipient_domains:
      - spine.ronny.works
      - mintprints.com
      - communications.local
  mailboxes:
    - id: ops
      address: ops@spine.ronny.works
      role: operations
      status: active
      routing_mode: stalwart-direct
    - id: alerts
      address: alerts@spine.ronny.works
      role: alerting
      status: active
      routing_mode: stalwart-direct
    - id: noreply
      address: noreply@spine.ronny.works
      role: system
      status: active
      routing_mode: stalwart-direct

mail_archiver:
  loop_id: LOOP-MAIL-ARCHIVER-COMMS-MIGRATION-20260225
  software_identity:
    image: s1t5/mailarchiver:latest
    runtime_entrypoint: "dotnet MailArchiver.dll"
    source_compose_file: /opt/stacks/finance/docker-compose.yml
    source_import_mount: /opt/stacks/finance/data/mail-archiver/import:/import:ro
    locked_at: "2026-02-25T18:59:00Z"
    verification_method: "ssh finance-stack + docker inspect/logs evidence"
  mbox_takeout_source:
    ssh_target: docker-host
    vm_id: "200"
    absolute_path: /mnt/docker/mail-archive-import/All-mail.mbox
    file_size_bytes: 189440618235
    locked_at: "2026-02-25T18:59:00Z"
    verification_method: "ssh docker-host + filesystem scan evidence"
  storage_invariants:
    nonboot_root: /srv/mail-archiver
    drift_gate: D233
    required_bind_mounts:
      - container: mail-archiver
        destination: /app/uploads
        source_prefix: /srv/mail-archiver/uploads
      - container: mail-archiver
        destination: /tmp
        source_prefix: /srv/mail-archiver/tmp
      - container: mail-archiver-db
        destination: /var/lib/postgresql/data
        source_prefix: /srv/mail-archiver/postgres-data

transactional:
  mode: live
  preview_link_required_for_execute: true
  provider_contract: "ops/bindings/communications.providers.contract.yaml"
  policy_contract: "ops/bindings/communications.policy.contract.yaml"
  templates_contract: "ops/bindings/communications.templates.catalog.yaml"
  delivery_contract: "ops/bindings/communications.delivery.contract.yaml"
