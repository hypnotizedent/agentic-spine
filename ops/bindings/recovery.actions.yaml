version: 1
updated_at: "2026-03-02"
owner: "@ronny"
scope: recovery-actions

defaults:
  max_attempts: 2
  cooldown_seconds: 1800
  escalate_after_failures: 2

actions:
  - id: recover-finance-stack
    trigger:
      gate_ids: [D23]
      failure_class: deterministic
    recovery:
      type: docker_compose_restart
      target: finance-stack
      stack: finance
      services: []
    safety:
      max_attempts: 2
      cooldown_seconds: 1800
      escalate_after_failures: 2

  - id: recover-communications-stack
    trigger:
      gate_ids: [D209]
      failure_class: deterministic
    recovery:
      type: docker_compose_restart
      target: communications-stack
      stack: communications-stack
      services: []
    safety:
      max_attempts: 2
      cooldown_seconds: 1800
      escalate_after_failures: 2

  - id: recover-communications-mail-archiver
    trigger:
      gate_ids: [D233]
      failure_class: deterministic
    recovery:
      type: docker_compose_restart
      target: communications-stack
      stack: communications-stack
      services: [mail-archiver]
    safety:
      max_attempts: 2
      cooldown_seconds: 1800
      escalate_after_failures: 2

  - id: recover-media-download-vpn-routing
    trigger:
      gate_ids: [D223]
      failure_class: deterministic
    recovery:
      type: docker_compose_restart
      target: download-stack
      stack: download-stack
      services: []
    safety:
      max_attempts: 2
      cooldown_seconds: 1800
      escalate_after_failures: 2

  - id: recover-media-streaming-introskipper-config
    trigger:
      gate_ids: [D228]
      failure_class: deterministic
    recovery:
      type: docker_compose_restart
      target: streaming-stack
      stack: streaming-stack
      services: []
    safety:
      max_attempts: 2
      cooldown_seconds: 1800
      escalate_after_failures: 2

  - id: recover-media-download-health-endpoint-parity
    trigger:
      gate_ids: [D108]
      failure_class: deterministic
    recovery:
      type: docker_compose_restart
      target: download-stack
      stack: download-stack
      services: []
    safety:
      max_attempts: 2
      cooldown_seconds: 1200
      escalate_after_failures: 2

  - id: recover-media-streaming-health-endpoint-parity
    trigger:
      gate_ids: [D108]
      failure_class: deterministic
    recovery:
      type: docker_compose_restart
      target: streaming-stack
      stack: streaming-stack
      services: []
    safety:
      max_attempts: 2
      cooldown_seconds: 1200
      escalate_after_failures: 2

  - id: recover-media-lidarr-root-folder
    trigger:
      gate_ids: [D230]
      failure_class: deterministic
    recovery:
      type: docker_compose_restart
      target: download-stack
      stack: download-stack
      services: [lidarr]
    safety:
      max_attempts: 2
      cooldown_seconds: 1800
      escalate_after_failures: 2

  - id: recover-media-docker-network-parity
    trigger:
      gate_ids: [D231]
      failure_class: deterministic
    recovery:
      type: docker_compose_restart
      target: download-stack
      stack: download-stack
      services: []
    safety:
      max_attempts: 2
      cooldown_seconds: 1800
      escalate_after_failures: 2

  - id: alert-media-nfs-mount-failure
    trigger:
      gate_ids: [D107]
      failure_class: deterministic
    recovery:
      type: alert_only
      capability: alerting.dispatch
    safety:
      max_attempts: 0
      cooldown_seconds: 21600
      escalate_after_failures: 1

  - id: alert-media-nfs-io-latency
    trigger:
      gate_ids: [D229]
      failure_class: deterministic
    recovery:
      type: alert_only
      capability: alerting.dispatch
    safety:
      max_attempts: 0
      cooldown_seconds: 21600
      escalate_after_failures: 1

  - id: alert-media-sqlite-storage-placement
    trigger:
      gate_ids: [D232]
      failure_class: deterministic
    recovery:
      type: alert_only
      capability: alerting.dispatch
    safety:
      max_attempts: 0
      cooldown_seconds: 21600
      escalate_after_failures: 1

  - id: alert-media-capacity-guard
    trigger:
      gate_ids: [D257]
      failure_class: deterministic
    recovery:
      type: alert_only
      capability: alerting.dispatch
    safety:
      max_attempts: 0
      cooldown_seconds: 21600
      escalate_after_failures: 1

  - id: recover-mint-data-stack
    trigger:
      gate_ids: [D236]
      failure_class: deterministic
    recovery:
      type: docker_compose_restart
      target: mint-data
      stack: mint-data
      services: []
    safety:
      max_attempts: 2
      cooldown_seconds: 1800
      escalate_after_failures: 2

  - id: recover-mint-apps-stack
    trigger:
      gate_ids: [D238]
      failure_class: deterministic
    recovery:
      type: docker_compose_restart
      target: mint-apps
      stack: mint-apps
      services: []
    safety:
      max_attempts: 2
      cooldown_seconds: 1800
      escalate_after_failures: 2

  - id: recover-uptime-kuma
    trigger:
      gate_ids: [D302]
      failure_class: deterministic
    recovery:
      type: docker_compose_restart
      target: observability
      stack: uptime-kuma
      services: []
      probe_url: http://100.120.163.70:3001
    safety:
      max_attempts: 2
      cooldown_seconds: 1200
      escalate_after_failures: 2

  - id: recover-launchd-scheduler-health
    trigger:
      gate_ids: [D299]
      failure_class: freshness
    recovery:
      type: launchd_restart
      label: com.ronny.launchd-health-check
    safety:
      max_attempts: 2
      cooldown_seconds: 900
      escalate_after_failures: 2

  - id: recover-projection-reconcile-d85
    trigger:
      gate_ids: [D85]
      failure_class: deterministic
    recovery:
      type: capability_commit
      capability: projection.reconcile
      allowlist_file: ops/bindings/projection.reconcile.allowlist.txt
      commit_message: "chore(projection): auto-reconcile gate registry header metadata"
      trailer_capability: projection.reconcile
    safety:
      max_attempts: 2
      cooldown_seconds: 1800
      escalate_after_failures: 2

  - id: recover-projection-reconcile-d285
    trigger:
      gate_ids: [D285]
      failure_class: deterministic
    recovery:
      type: capability_commit
      capability: projection.reconcile
      allowlist_file: ops/bindings/projection.reconcile.allowlist.txt
      commit_message: "chore(projection): auto-reconcile entry-surface metadata"
      trailer_capability: projection.reconcile
    safety:
      max_attempts: 2
      cooldown_seconds: 1800
      escalate_after_failures: 2

  - id: recover-vaultwarden-container
    trigger:
      gate_ids: [D149]
      failure_class: deterministic
    recovery:
      type: docker_compose_restart
      target: infra-core
      stack: vaultwarden
      services: []
      probe_url: http://192.168.1.204:8081/alive
    safety:
      max_attempts: 2
      cooldown_seconds: 1800
      escalate_after_failures: 2

  - id: recover-cloudflare-readpath
    trigger:
      gate_ids: [D315]
      failure_class: deterministic
    recovery:
      type: capability_rerun
      capabilities:
        - cloudflare.zone.list
        - cloudflare.inventory.sync
        - domains.portfolio.status
      detail: "Rerun Cloudflare read surfaces; 429 has bounded retry built in"
    safety:
      max_attempts: 2
      cooldown_seconds: 1800
      escalate_after_failures: 2

  - id: recover-infisical-stack
    trigger:
      gate_ids: [D55]
      failure_class: deterministic
    recovery:
      type: docker_compose_restart
      target: infra-core
      stack: secrets
      services: []
      probe_url: http://192.168.1.204:8088/api/status
    safety:
      max_attempts: 2
      cooldown_seconds: 1800
      escalate_after_failures: 2

  - id: recover-authentik-stack
    trigger:
      gate_ids: []
      failure_class: deterministic
    recovery:
      type: docker_compose_restart
      target: infra-core
      stack: caddy-auth
      services: []
    safety:
      max_attempts: 2
      cooldown_seconds: 1800
      escalate_after_failures: 2

  - id: recover-freshness-reconcile
    trigger:
      gate_ids: []
      failure_class: freshness
    recovery:
      type: capability_retry
      capability: verify.freshness.reconcile
      max_attempts: 2
      backoff_seconds: [60, 300]
    safety:
      max_attempts: 2
      cooldown_seconds: 900
      escalate_after_failures: 2
