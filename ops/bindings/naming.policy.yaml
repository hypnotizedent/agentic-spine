# Naming Policy SSOT
# Canonical identity surface governance for all infrastructure hosts.
# Status: authoritative
# Last verified: 2026-02-17
#
# References: GAP-OP-016, LOOP-NAMING-GOVERNANCE-20260207 (P1)
# Audit basis: ops/staged/identity-surface-audit.yaml (P0)
#
# RULES:
#   - Each host has ONE canonical name. All governed surfaces must match it.
#   - Exceptions must be listed in allowed_exceptions with justification.
#   - This file is the authority for what names SHOULD be.
#   - infra.placement.policy.yaml is the authority for site/kind.
#   - Drift gate D45 enforces cross-file consistency.

version: 1
updated_at: "2026-02-17"
owner: "@ronny"

# Identity surfaces checked, in authority order.
# Top = most authoritative. Bottom = derived / informational.
surface_authority_order:
  - tailscale_name        # MagicDNS registration — primary identity
  - ssh_target_id         # ops/bindings/ssh.targets.yaml
  - device_identity       # docs/governance/DEVICE_IDENTITY_SSOT.md
  - placement_host        # ops/bindings/infra.placement.policy.yaml
  - compose_target        # ops/bindings/docker.compose.targets.yaml
  - system_hostname       # `hostname` on the machine (may differ — see exceptions)
  - pve_node              # /etc/pve/nodes/<name>/ (hypervisors only)

naming_convention:
  rules:
    - "Lowercase only, hyphens for separators"
    - "Max 20 characters (Tailscale limit)"
    - "No underscores (breaks some DNS resolvers)"
    - "Functional names (what it does), not arbitrary names"
  patterns:
    single_purpose: "{function}"
    multi_location: "{function}-{location}"
    stack_role: "{stack}-{role}"

# ─── IoT Device Naming Convention ────────────────────────────────
# Governs naming across Smart Life/Tuya, HA, UniFi, and the device registry.
# Canonical ID in home.device.registry.yaml is the authority.

iot_naming_convention:
  rules:
    - "Canonical ID is kebab-case: {room}-{device-type}[-{n}]"
    - "HA entity ID derives from integration name set to Title Case of canonical ID"
    - "UniFi reservation name matches canonical ID exactly (where manageable)"
    - "Smart Life / Tuya device name: Title Case of canonical ID (e.g. 'Office Desk Bulb')"
    - "Suffix -1, -2 for duplicates in same room"
  derivation:
    canonical_id: "office-desk-bulb"
    ha_entity: "light.office_desk_bulb"
    unifi_name: "office-desk-bulb"
    tuya_name: "Office Desk Bulb"
    ha_friendly_name: "Office Desk Bulb"
  surface_authority_order:
    - device_registry_id    # ops/bindings/home.device.registry.yaml (canonical)
    - ha_entity_id          # HA entity registry (derived)
    - unifi_reservation     # UDR7 DHCP reservation name (must match canonical)
    - tuya_device_name      # Smart Life app (must be Title Case of canonical)

# ─── Canonical Hosts ───────────────────────────────────────────────
#
# surfaces: which binding files MUST contain this host's canonical_name.
#   ssh_target      → ssh.targets.yaml must have matching id
#   placement       → infra.placement.policy.yaml must have matching hosts key
#   compose_target  → docker.compose.targets.yaml must have matching target key
#   device_identity → DEVICE_IDENTITY_SSOT.md must mention `canonical_name`
#
# verification_state:
#   reachable   — SSH verified during P0 audit
#   unreachable — SSH denied or broken (cannot verify system_hostname)
#   offline     — host powered off (cannot verify anything)
#   no_ssh      — no SSH target configured (workstation, or not yet onboarded)

hosts:
  - canonical_name: pve
    kind: proxmox
    site: shop
    surfaces:
      ssh_target: true
      placement: true
      compose_target: false
      device_identity: true
    verification_state: reachable

  - canonical_name: proxmox-home
    kind: proxmox
    site: home
    surfaces:
      ssh_target: true
      placement: true
      compose_target: false
      device_identity: true
    verification_state: reachable
    description: "Home Proxmox host. Canonicalized so system hostname, PVE node, SSH target, and Tailscale all resolve to proxmox-home."

  - canonical_name: docker-host
    kind: vm
    site: shop
    surfaces:
      ssh_target: true
      placement: true
      compose_target: true
      device_identity: true
    verification_state: reachable

  - canonical_name: infra-core
    kind: vm
    site: shop
    surfaces:
      ssh_target: true
      placement: true
      compose_target: true
      device_identity: true
    verification_state: reachable

  - canonical_name: nas
    kind: storage
    site: home
    surfaces:
      ssh_target: true
      placement: true
      compose_target: false
      device_identity: true
    verification_state: reachable

  - canonical_name: vault
    kind: vm
    site: home
    surfaces:
      ssh_target: false  # decommissioned 2026-02-16
      placement: true
      compose_target: false
      device_identity: true
    verification_state: decommissioned
    description: "VMID 102 decommissioned 2026-02-16. Superseded by infra-core."

  - canonical_name: automation-stack
    kind: vm
    site: shop
    surfaces:
      ssh_target: true
      placement: true
      compose_target: true
      device_identity: true
    verification_state: reachable

  - canonical_name: download-stack
    kind: vm
    site: shop
    surfaces:
      ssh_target: true
      placement: true
      compose_target: true
      device_identity: true
    verification_state: reachable
    description: "VM 209. Download automation (*arr stack, sabnzbd, tdarr)."

  - canonical_name: streaming-stack
    kind: vm
    site: shop
    surfaces:
      ssh_target: true
      placement: true
      compose_target: true
      device_identity: true
    verification_state: reachable
    description: "VM 210. Media streaming (Jellyfin, Navidrome, Jellyseerr, Bazarr)."

  - canonical_name: finance-stack
    kind: vm
    site: shop
    surfaces:
      ssh_target: true
      placement: true
      compose_target: true
      device_identity: true
    verification_state: reachable
    description: "VM 211. Finance (Firefly III, Paperless-ngx, Ghostfolio, Mail Archiver). Migrated from docker-host (LOOP-FINANCE-VM-SEPARATION-20260211)."

  - canonical_name: mint-data
    kind: vm
    site: shop
    surfaces:
      ssh_target: true
      placement: true
      compose_target: true
      device_identity: true
    verification_state: reachable
    description: "VM 212. Mint fresh-slate data plane (PostgreSQL 16, MinIO, Redis)."

  - canonical_name: mint-apps
    kind: vm
    site: shop
    surfaces:
      ssh_target: true
      placement: true
      compose_target: true
      device_identity: true
    verification_state: reachable
    description: "VM 213. Mint fresh-slate app plane (files-api, quote-page, order-intake)."

  - canonical_name: ha
    kind: vm
    site: home
    surfaces:
      ssh_target: true
      placement: false
      compose_target: false
      device_identity: true
    verification_state: reachable

  - canonical_name: pihole-home
    kind: lxc
    site: home
    surfaces:
      ssh_target: true
      placement: false
      compose_target: false
      device_identity: true
    verification_state: reachable

  - canonical_name: media-stack
    kind: vm
    site: shop
    status: decommissioned  # VM 201 destroyed 2026-02-10
    surfaces:
      ssh_target: false
      placement: false
      compose_target: false
      device_identity: true
    verification_state: decommissioned

  - canonical_name: download-home
    kind: lxc
    site: home
    surfaces:
      ssh_target: false
      placement: false
      compose_target: false
      device_identity: true
    verification_state: decommissioned
    description: "Destroyed 2026-02-20 (pct destroy 103 --purge). Superseded by download-stack (VM 209)."

  - canonical_name: macbook
    kind: workstation
    site: mobile
    surfaces:
      ssh_target: false
      placement: true
      compose_target: false
      device_identity: true
    verification_state: reachable

  - canonical_name: immich
    kind: vm
    site: shop
    surfaces:
      ssh_target: true
      placement: false
      compose_target: true
      device_identity: true
    verification_state: reachable
    description: "VM 203 (pve). Primary Immich instance. 135K+ assets."

  - canonical_name: immich-home
    kind: vm
    site: home
    status: decommissioned
    surfaces:
      ssh_target: false
      placement: false
      compose_target: false
      device_identity: true
    verification_state: decommissioned
    description: "VM 101 (proxmox-home) destroyed 2026-02-20. Shop immich-1 (VM 203) is sole active instance."

  - canonical_name: observability
    kind: vm
    site: shop
    surfaces:
      ssh_target: true
      placement: true
      compose_target: true
      device_identity: true
    verification_state: verified
    description: "VM 205. Prometheus, Grafana, Loki, Uptime Kuma, node-exporter."

  - canonical_name: ai-consolidation
    kind: vm
    site: shop
    surfaces:
      ssh_target: true
      placement: true
      compose_target: true
      device_identity: true
    verification_state: verified
    description: "VM 207. Qdrant + AnythingLLM. Migrated off MacBook."

# ─── Allowed Exceptions ───────────────────────────────────────────
# These are known, accepted deviations from canonical naming.
# D45 gate will NOT fail on these.

allowed_exceptions:
  - host: nas
    surface: system_hostname
    actual: synology918
    reason: "Synology DSM sets hostname to model name by default. No runtime breakage."
    severity: low

  - host: ha
    surface: system_hostname
    actual: a0d7b954-ssh
    reason: "Home Assistant OS manages its own hostname. Cannot change without reinstall."
    severity: low

  - host: proxmox-home
    surface: tailscale_name
    actual: proxmox-home
    reason: "Canonical hostname and Tailscale identity are both proxmox-home."
    severity: low

  - host: proxmox-home
    surface: ssh_target_id
    actual: proxmox-home
    reason: "SSH target ID matches canonical host identity."
    severity: low

  - host: immich
    surface: tailscale_name
    actual: immich-1
    reason: "Tailscale auto-suffixed VM 203 as immich-1 because stopped VM 101 (immich-home) holds the immich MagicDNS name."
    severity: low

# ─── Rename Procedure ─────────────────────────────────────────────
# When renaming a host, update surfaces in THIS ORDER (top to bottom).
# Failure at any step → stop, do not proceed to next surface.

rename_procedure:
  - step: 1
    surface: "naming.policy.yaml"
    action: "Update canonical_name in this file"
  - step: 2
    surface: "infra.placement.policy.yaml"
    action: "Update hosts key"
  - step: 3
    surface: "ssh.targets.yaml"
    action: "Update target id"
  - step: 4
    surface: "docker.compose.targets.yaml"
    action: "Update target key and ssh_target (if applicable)"
  - step: 5
    surface: "DEVICE_IDENTITY_SSOT.md"
    action: "Update all references to old name"
  - step: 6
    surface: "system_hostname"
    action: "SSH to host and set hostname"
  - step: 7
    surface: "pve_node"
    action: "Migrate PVE node configs (hypervisors only — HIGH RISK)"
  - step: 8
    surface: "tailscale_name"
    action: "Usually auto-follows system_hostname"
  - step: 9
    surface: "D45 gate"
    action: "Run drift-gate.sh and confirm D45 passes"
