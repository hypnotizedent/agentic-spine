# VM Operating Profile Binding (SSOT)
# Non-secret. Spine-native. Defines per-VM operational behavior contracts.
# Status: authoritative
# Last verified: 2026-02-21
#
# Authority: This binding defines HOW agents and operators interact with VMs
#            at runtime. Companion to vm.lifecycle.yaml (which defines WHAT exists).
#            Discovered via GAP-OP-295 during RCA on VM 207 (docker group visibility gap).
#
# ssh_mode:
#   standard       — ubuntu user, key auth, BatchMode=yes
#   non-standard   — custom user (see ssh_user), may need special config
#   haos           — Home Assistant OS (limited shell, hassio user)
#   lxc-root       — LXC container, root user, limited tooling
#   none           — stopped/template, no SSH
#
# runtime_inspection_mode:
#   docker-group   — SSH user is in docker group, can run docker ps/logs/inspect
#   docker-sudo    — SSH user must sudo for docker commands
#   docker-none    — SSH user cannot inspect containers (visibility gap)
#   haos-supervisor — HA OS supervisor API, not docker CLI
#   none           — no runtime inspection available
#
# health_probe_policy:
#   full           — all declared services have HTTP health probes
#   selective      — some services intentionally excluded from probes
#   none           — no health probes (stopped/template)
#
# startup_policy:
#   auto           — VM auto-starts on hypervisor boot (onboot=1)
#   manual         — VM must be manually started
#   template       — never started directly
#
# diagnostic_user_policy:
#   docker-group-member  — SSH user is in docker group (preferred)
#   sudo-only            — docker access requires sudo
#   no-docker-access     — SSH user cannot access docker at all
#   not-applicable       — no docker on this VM (HA OS, stopped, template)
#
# backup_policy:
#   vzdump-scheduled     — included in vzdump cron/manual job
#   vzdump-manual        — backup exists but not scheduled
#   none                 — no backup (template, disposable)

version: 1
updated: "2026-02-21"
owner: "@ronny"

# ─────────────────────────────────────────────────────────────
# Shop Site VMs (pve — Dell R730XD)
# ─────────────────────────────────────────────────────────────

profiles:
  - id: 200
    hostname: docker-host
    ssh_mode: non-standard
    ssh_user: ubuntu
    runtime_inspection_mode: docker-group
    health_probe_policy: selective
    startup_policy: auto
    diagnostic_user_policy: docker-group-member
    backup_policy: vzdump-scheduled
    description: "Legacy VM. Ubuntu user standardized for agent access; runtime remains non-standard Linux Mint."

  - id: 202
    hostname: automation-stack
    ssh_mode: standard
    ssh_user: ubuntu
    runtime_inspection_mode: docker-group
    health_probe_policy: full
    startup_policy: auto
    diagnostic_user_policy: docker-group-member
    backup_policy: vzdump-scheduled
    description: "Standardized ubuntu SSH user. Docker group access confirmed."

  - id: 203
    hostname: immich
    ssh_mode: standard
    ssh_user: ronny
    runtime_inspection_mode: docker-group
    health_probe_policy: full
    startup_policy: auto
    diagnostic_user_policy: docker-group-member
    backup_policy: vzdump-scheduled
    description: "Cloud-init user is ronny (non-standard). Docker group access confirmed."

  - id: 204
    hostname: infra-core
    ssh_mode: standard
    ssh_user: ubuntu
    runtime_inspection_mode: docker-group
    health_probe_policy: full
    startup_policy: auto
    diagnostic_user_policy: docker-group-member
    backup_policy: vzdump-scheduled
    description: "Standard spine-ready-v1 profile. Critical path VM."

  - id: 205
    hostname: observability
    ssh_mode: standard
    ssh_user: ubuntu
    runtime_inspection_mode: docker-group
    health_probe_policy: full
    startup_policy: auto
    diagnostic_user_policy: docker-group-member
    backup_policy: vzdump-scheduled
    description: "Standard spine-ready-v1 profile."

  - id: 206
    hostname: dev-tools
    ssh_mode: standard
    ssh_user: ubuntu
    runtime_inspection_mode: docker-group
    health_probe_policy: full
    startup_policy: auto
    diagnostic_user_policy: docker-group-member
    backup_policy: vzdump-scheduled
    description: "Standard spine-ready-v1 profile."

  - id: 207
    hostname: ai-consolidation
    ssh_mode: standard
    ssh_user: ubuntu
    runtime_inspection_mode: docker-none
    health_probe_policy: full
    startup_policy: auto
    diagnostic_user_policy: no-docker-access
    backup_policy: vzdump-scheduled
    description: >
      RCA 2026-02-13 revealed ubuntu user is NOT in docker group.
      docker ps fails with permission denied. Health probes work
      via HTTP (not docker inspect), so functional impact is limited
      to diagnostic visibility only. Remediation: add ubuntu to docker
      group (requires sudo usermod -aG docker ubuntu + session restart).

  - id: 209
    hostname: download-stack
    ssh_mode: standard
    ssh_user: ubuntu
    runtime_inspection_mode: docker-group
    health_probe_policy: selective
    startup_policy: auto
    diagnostic_user_policy: docker-group-member
    backup_policy: vzdump-scheduled
    description: "Standard profile. Some services intentionally stopped (tdarr/slskd)."

  - id: 210
    hostname: streaming-stack
    ssh_mode: standard
    ssh_user: ubuntu
    runtime_inspection_mode: docker-group
    health_probe_policy: full
    startup_policy: auto
    diagnostic_user_policy: docker-group-member
    backup_policy: vzdump-scheduled
    description: "Standard spine-ready-v1 profile."

  - id: 211
    hostname: finance-stack
    ssh_mode: standard
    ssh_user: ubuntu
    runtime_inspection_mode: docker-group
    health_probe_policy: full
    startup_policy: auto
    diagnostic_user_policy: docker-group-member
    backup_policy: vzdump-scheduled
    description: "Standard spine-ready-v1 profile. Finance-critical data."

  - id: 212
    hostname: mint-data
    ssh_mode: standard
    ssh_user: ubuntu
    runtime_inspection_mode: docker-group
    health_probe_policy: full
    startup_policy: auto
    diagnostic_user_policy: docker-group-member
    backup_policy: vzdump-scheduled
    description: "Standard spine-ready-v1 profile. Data-plane VM."

  - id: 213
    hostname: mint-apps
    ssh_mode: standard
    ssh_user: ubuntu
    runtime_inspection_mode: docker-group
    health_probe_policy: full
    startup_policy: auto
    diagnostic_user_policy: docker-group-member
    backup_policy: vzdump-scheduled
    description: "Standard spine-ready-v1 profile. App-plane VM."

# ─────────────────────────────────────────────────────────────
# Home Site VMs/LXCs (proxmox-home — Beelink SER7)
# ─────────────────────────────────────────────────────────────

  - id: 100
    hostname: homeassistant
    ssh_mode: haos
    ssh_user: hassio
    runtime_inspection_mode: haos-supervisor
    health_probe_policy: full
    startup_policy: auto
    diagnostic_user_policy: not-applicable
    backup_policy: vzdump-scheduled
    description: "HA OS VM. No docker CLI access. Supervisor API for add-on management."

  - id: 105
    hostname: pihole-home
    ssh_mode: lxc-root
    ssh_user: root
    runtime_inspection_mode: none
    health_probe_policy: full
    startup_policy: auto
    diagnostic_user_policy: not-applicable
    backup_policy: vzdump-scheduled
    description: "LXC container. Root SSH via pct exec. No docker — bare-metal Pi-hole v6. Reactivated 2026-02-21."

# ─────────────────────────────────────────────────────────────
# Stopped / Decommissioned / Templates (no operating profile)
# ─────────────────────────────────────────────────────────────
# VM 102 (vaultwarden): decommissioned 2026-02-16. Superseded by infra-core.
# VMs 101, 103 (destroyed 2026-02-20), 201 (decommissioned), 9000 (template)
# are excluded from operating profiles. They have no runtime behavior
# to govern. If reactivated, a profile entry must be added before
# the VM is marked active in vm.lifecycle.yaml.
