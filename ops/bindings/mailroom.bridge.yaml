# Status: authoritative
# Last verified: 2026-02-15

version: 1
updated: "2026-02-15"
owner: "@ronny"

listen:
  host: "127.0.0.1"
  port: 8799

auth:
  # Token auth is required for all non-health endpoints.
  token_env: "MAILROOM_BRIDGE_TOKEN"
  require_token: true
  # Cloudflare Access service-token auth (alternative to token for hosted runtimes).
  # CF validates at the edge and injects a signed JWT; bridge checks aud claim.
  cf_access:
    enabled: true
    aud: "e6082c5fc52cda984e25024daddfcca41a9f69a5a6f993c86aa17a6e61865076"
    jwt_header: "Cf-Access-Jwt-Assertion"

limits:
  # Maximum bytes returned by file-read endpoints (prevents accidental huge responses).
  max_read_bytes: 262144

# Cap-RPC: remote capability execution via /cap/run
cap_rpc:
  # Only these capabilities can be invoked via HTTP RPC.
  # Security: initial allowlist is read-only/audit only. No mutating caps.
  allowlist:
    - spine.verify
    - gaps.status
    - loops.status
    - proposals.status
    - policy.runtime.audit
    - tenant.storage.audit
    - version.compat.verify
    - evidence.export.plan
    - surface.readonly.audit
    - mailroom.bridge.status
    - aof.status
    - aof.version
    - aof.policy.show
    - aof.tenant.show
    - aof.verify
    - media.health.check
    - media.service.status
    - media.nfs.verify
  # Subprocess timeout for cap execution (seconds).
  timeout: 120
  # Token-scoped RBAC: restrict cap-RPC access per token.
  # Each role maps a token env var to a capability subset of the allowlist.
  # If no roles are defined, any authenticated token gets full allowlist access.
  roles:
    operator:
      token_env: "MAILROOM_BRIDGE_TOKEN"
      allow: "*"
    monitor:
      token_env: "MAILROOM_BRIDGE_MONITOR_TOKEN"
      allow:
        - spine.verify
        - gaps.status
        - loops.status
        - proposals.status
        - mailroom.bridge.status
        - aof.status
        - aof.version
    media-consumer:
      token_env: "MAILROOM_BRIDGE_MEDIA_TOKEN"
      allow:
        - media.health.check
        - media.service.status
        - media.nfs.verify

endpoints:
  # GET
  - path: /health
    method: GET
    auth: false
    note: "Liveness probe"
  - path: /loops/open
    method: GET
    auth: true
    note: "Open loops from scope files"
  - path: /outbox/list
    method: GET
    auth: true
    note: "List outbox items"
  - path: /outbox/read
    method: GET
    auth: true
    note: "Read outbox file contents"
  - path: /receipts/read
    method: GET
    auth: true
    note: "Read receipt file contents"
  # POST
  - path: /cap/run
    method: POST
    auth: true
    note: "Execute allowlisted capability via RPC, return receipted result"
  - path: /inbox/enqueue
    method: POST
    auth: true
    note: "Enqueue prompt for watcher processing"
  - path: /rag/ask
    method: POST
    auth: true
    note: "Governed RAG query via rag.anythingllm.ask capability (receipted)"
