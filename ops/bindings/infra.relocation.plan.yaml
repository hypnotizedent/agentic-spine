version: 1
updated: "2026-02-08"
owner: "@ronny"
# ═══════════════════════════════════════════════════════════════════════════
# Infra Relocation Plan - Transactional VM/Service Move Governance
# ═══════════════════════════════════════════════════════════════════════════
#
# This manifest governs infrastructure relocations (VM moves, service migrations).
# All changes to this file must pass D35 parity checks before cutover.
#
# Required workflow:
#   1. preflight receipt (reachability + health baseline)
#   2. manifest parity pass (all SSOTs in sync)
#   3. cutover phase receipt (actual migration)
#   4. parity pass (post-migration validation)
#   5. cleanup phase receipt (old resources decommissioned)
#
# ═══════════════════════════════════════════════════════════════════════════

# Current active relocation (one at a time)
active_relocation:
  change_id: "LOOP-MEDIA-STACK-SPLIT-20260208"
  state: "planning" # planning | preflight | cutover | cleanup | complete
  owner: "@ronny"
  approved_by: '@ronny'
  updated_at: "2026-02-08"

# Previous completed relocation (archived for reference)
completed_relocations:
  - change_id: "LOOP-INFRA-VM-RESTRUCTURE-20260206"
    state: "complete"
    completed_at: "2026-02-08T00:25:08Z"

# VM targets for this relocation
vm_targets:
  # --- Existing VMs (from prior relocation, status=ready) ---
  - vm_id: "204"
    hostname: "infra-core"
    role: "Core infrastructure services (Cloudflared, Pi-hole, Infisical)"
    tailscale_ip: 100.92.91.128
    proxmox_host: "pve"
    status: "ready"
  - vm_id: "205"
    hostname: "observability"
    role: "Monitoring stack (Prometheus, Grafana, Loki, Uptime Kuma)"
    tailscale_ip: 100.120.163.70
    proxmox_host: "pve"
    status: "ready"
  - vm_id: "206"
    hostname: "dev-tools"
    role: "Development toolchain (Gitea, Gitea Actions runner, PostgreSQL)"
    tailscale_ip: 100.90.167.39
    proxmox_host: "pve"
    ci_network_cidr: "192.168.12.206/24,gw=192.168.12.1"
    status: "ready"
  # --- New VMs for media stack split ---
  - vm_id: "209"
    hostname: "download-stack"
    role: "Download services (SABnzbd, *arr, Tdarr, Recyclarr, CrowdSec)"
    tailscale_ip: null # Assigned after provisioning
    proxmox_host: "pve"
    ci_network_cidr: "192.168.12.209/24,gw=192.168.12.1"
    status: "planned"
  - vm_id: "210"
    hostname: "streaming-stack"
    role: "Streaming services (Jellyfin, Navidrome, Jellyseerr, Bazarr)"
    tailscale_ip: null # Assigned after provisioning
    proxmox_host: "pve"
    ci_network_cidr: "192.168.12.210/24,gw=192.168.12.1"
    status: "planned"

# Services to relocate in this plan
services:
  # --- Phase 3: download stack → VM 209 ---
  - service: "prowlarr"
    from_host: "media-stack"
    to_host: "download-stack"
    phase: 3
    health_url: "http://download-stack:9696"
    rollback_to: "media-stack"
    backup_target: null
    status: "planned"
  - service: "flaresolverr"
    from_host: "media-stack"
    to_host: "download-stack"
    phase: 3
    health_url: null
    rollback_to: "media-stack"
    backup_target: null
    status: "planned"
  - service: "recyclarr"
    from_host: "media-stack"
    to_host: "download-stack"
    phase: 3
    health_url: null
    rollback_to: "media-stack"
    backup_target: null
    status: "planned"
  - service: "sabnzbd"
    from_host: "media-stack"
    to_host: "download-stack"
    phase: 3
    health_url: "http://download-stack:8080"
    rollback_to: "media-stack"
    backup_target: null
    status: "planned"
  - service: "qbittorrent"
    from_host: "media-stack"
    to_host: "download-stack"
    phase: 3
    health_url: "http://download-stack:8081"
    rollback_to: "media-stack"
    backup_target: null
    status: "planned"
  - service: "unpackerr"
    from_host: "media-stack"
    to_host: "download-stack"
    phase: 3
    health_url: null
    rollback_to: "media-stack"
    backup_target: null
    status: "planned"
  - service: "radarr"
    from_host: "media-stack"
    to_host: "download-stack"
    phase: 3
    health_url: "http://download-stack:7878"
    rollback_to: "media-stack"
    backup_target: null
    status: "planned"
  - service: "sonarr"
    from_host: "media-stack"
    to_host: "download-stack"
    phase: 3
    health_url: "http://download-stack:8989"
    rollback_to: "media-stack"
    backup_target: null
    status: "planned"
  - service: "lidarr"
    from_host: "media-stack"
    to_host: "download-stack"
    phase: 3
    health_url: "http://download-stack:8686"
    rollback_to: "media-stack"
    backup_target: null
    status: "planned"
  - service: "soularr"
    from_host: "media-stack"
    to_host: "download-stack"
    phase: 3
    health_url: null
    rollback_to: "media-stack"
    backup_target: null
    status: "planned"
  - service: "swaparr-radarr"
    from_host: "media-stack"
    to_host: "download-stack"
    phase: 3
    health_url: null
    rollback_to: "media-stack"
    backup_target: null
    status: "planned"
  - service: "swaparr-sonarr"
    from_host: "media-stack"
    to_host: "download-stack"
    phase: 3
    health_url: null
    rollback_to: "media-stack"
    backup_target: null
    status: "planned"
  - service: "swaparr-lidarr"
    from_host: "media-stack"
    to_host: "download-stack"
    phase: 3
    health_url: null
    rollback_to: "media-stack"
    backup_target: null
    status: "planned"
  - service: "trailarr"
    from_host: "media-stack"
    to_host: "download-stack"
    phase: 3
    health_url: "http://download-stack:7667"
    rollback_to: "media-stack"
    backup_target: null
    status: "planned"
  - service: "posterizarr"
    from_host: "media-stack"
    to_host: "download-stack"
    phase: 3
    health_url: null
    rollback_to: "media-stack"
    backup_target: null
    status: "planned"
  - service: "decypharr"
    from_host: "media-stack"
    to_host: "download-stack"
    phase: 3
    health_url: null
    rollback_to: "media-stack"
    backup_target: null
    status: "planned"
  - service: "huntarr"
    from_host: "media-stack"
    to_host: "download-stack"
    phase: 3
    health_url: null
    rollback_to: "media-stack"
    backup_target: null
    status: "planned"
  - service: "tdarr"
    from_host: "media-stack"
    to_host: "download-stack"
    phase: 3
    health_url: "http://download-stack:8265"
    rollback_to: "media-stack"
    backup_target: null
    status: "planned"
  - service: "autopulse"
    from_host: "media-stack"
    to_host: "download-stack"
    phase: 3
    health_url: null
    rollback_to: "media-stack"
    backup_target: null
    status: "planned"
  - service: "crosswatch"
    from_host: "media-stack"
    to_host: "download-stack"
    phase: 3
    health_url: null
    rollback_to: "media-stack"
    backup_target: null
    status: "planned"
  - service: "crowdsec"
    from_host: "media-stack"
    to_host: "download-stack"
    phase: 3
    health_url: null
    rollback_to: "media-stack"
    backup_target: null
    status: "planned"
  # --- Phase 4: streaming stack → VM 210 ---
  - service: "bazarr"
    from_host: "media-stack"
    to_host: "streaming-stack"
    phase: 4
    health_url: "http://streaming-stack:6767"
    rollback_to: "media-stack"
    backup_target: null
    status: "planned"
  - service: "wizarr"
    from_host: "media-stack"
    to_host: "streaming-stack"
    phase: 4
    health_url: null
    rollback_to: "media-stack"
    backup_target: null
    status: "planned"
  - service: "spotisub"
    from_host: "media-stack"
    to_host: "streaming-stack"
    phase: 4
    health_url: null
    rollback_to: "media-stack"
    backup_target: null
    status: "planned"
  - service: "subgen"
    from_host: "media-stack"
    to_host: "streaming-stack"
    phase: 4
    health_url: null
    rollback_to: "media-stack"
    backup_target: null
    status: "planned"
  - service: "navidrome"
    from_host: "media-stack"
    to_host: "streaming-stack"
    phase: 4
    health_url: "http://streaming-stack:4533"
    rollback_to: "media-stack"
    backup_target: null
    status: "planned"
  - service: "jellyseerr"
    from_host: "media-stack"
    to_host: "streaming-stack"
    phase: 4
    health_url: "http://streaming-stack:5055"
    rollback_to: "media-stack"
    backup_target: null
    status: "planned"
  - service: "jellyfin"
    from_host: "media-stack"
    to_host: "streaming-stack"
    phase: 4
    health_url: "http://streaming-stack:8096"
    rollback_to: "media-stack"
    backup_target: null
    status: "planned"
  - service: "homarr"
    from_host: "media-stack"
    to_host: "streaming-stack"
    phase: 4
    health_url: "http://streaming-stack:7575"
    rollback_to: "media-stack"
    backup_target: null
    status: "planned"

# SSOT files that MUST be updated when services move
required_updates:
  - "docs/governance/SERVICE_REGISTRY.yaml"
  - "docs/governance/STACK_REGISTRY.yaml"
  - "docs/governance/DEVICE_IDENTITY_SSOT.md"
  - "ops/bindings/services.health.yaml"
  - "ops/bindings/ssh.targets.yaml"
  - "ops/bindings/backup.inventory.yaml"
  - "ops/bindings/docker.compose.targets.yaml"

# Temporary exceptions during migration
exceptions:
  - label: "media-stack-vm201-alive-during-split"
    reason: "VM 201 stays running with containers stopped until soak passes"
    expires_at: "2026-03-15T23:59:59Z"
  - label: "cf-tunnel-routes-during-migration"
    reason: "CF tunnel routes may point to old VM during cutover window"
    expires_at: "2026-03-01T23:59:59Z"

# Rollback requirements
rollback:
  max_rollback_window_hours: 24
  requires_backup_verification: true
  requires_health_baseline: true
