version: 1
updated: "2026-02-06"
owner: "@ronny"

# ═══════════════════════════════════════════════════════════════════════════
# Infra Relocation Plan - Transactional VM/Service Move Governance
# ═══════════════════════════════════════════════════════════════════════════
#
# This manifest governs infrastructure relocations (VM moves, service migrations).
# All changes to this file must pass D35 parity checks before cutover.
#
# Required workflow:
#   1. preflight receipt (reachability + health baseline)
#   2. manifest parity pass (all SSOTs in sync)
#   3. cutover phase receipt (actual migration)
#   4. parity pass (post-migration validation)
#   5. cleanup phase receipt (old resources decommissioned)
#
# ═══════════════════════════════════════════════════════════════════════════

# Current active relocation (one at a time)
active_relocation:
  change_id: "LOOP-INFRA-VM-RESTRUCTURE-20260206"
  state: "planning"  # planning | preflight | cutover | cleanup | complete
  owner: "@ronny"
  approved_by: null
  updated_at: "2026-02-06T00:00:00Z"

# VM targets for this relocation
vm_targets:
  - vm_id: "204"
    hostname: "infra-core"
    role: "Core infrastructure services (Cloudflared, Pi-hole, Infisical)"
    tailscale_ip: null  # Assigned after provisioning
    proxmox_host: "pve"
    status: "planned"

  - vm_id: "205"
    hostname: "observability"
    role: "Monitoring stack (Prometheus, Grafana, Loki, Uptime Kuma)"
    tailscale_ip: null
    proxmox_host: "pve"
    status: "planned"

# Services to relocate in this plan
services:
  # Phase 1: infra-core VM
  - service: "cloudflared"
    from_host: "docker-host"
    to_host: "infra-core"
    phase: 1
    health_url: null  # No HTTP health, use tunnel status
    rollback_to: "docker-host"
    backup_target: null
    status: "planned"

  - service: "pihole"
    from_host: "docker-host"
    to_host: "infra-core"
    phase: 1
    health_url: "http://infra-core:80/admin"
    rollback_to: "docker-host"
    backup_target: "nas:/volume1/backups/infra/pihole"
    status: "planned"

  - service: "infisical"
    from_host: "docker-host"
    to_host: "infra-core"
    phase: 1
    health_url: "http://infra-core:8080/api/status"
    rollback_to: "docker-host"
    backup_target: "nas:/volume1/backups/infra/infisical"
    status: "planned"

  # Phase 2: vaultwarden migration
  - service: "vaultwarden"
    from_host: "proxmox-home"
    to_host: "infra-core"
    phase: 2
    health_url: "http://infra-core:8081/alive"
    rollback_to: "proxmox-home"
    backup_target: "nas:/volume1/backups/infra/vaultwarden"
    status: "planned"

  # Phase 4-5: observability VM
  - service: "prometheus"
    from_host: null  # New deployment
    to_host: "observability"
    phase: 4
    health_url: "http://observability:9090/-/healthy"
    rollback_to: null
    backup_target: null
    status: "planned"

  - service: "grafana"
    from_host: null
    to_host: "observability"
    phase: 4
    health_url: "http://observability:3000/api/health"
    rollback_to: null
    backup_target: null
    status: "planned"

  - service: "loki"
    from_host: null
    to_host: "observability"
    phase: 4
    health_url: "http://observability:3100/ready"
    rollback_to: null
    backup_target: null
    status: "planned"

  - service: "uptime-kuma"
    from_host: null
    to_host: "observability"
    phase: 5
    health_url: "http://observability:3001/api/status-page/heartbeat"
    rollback_to: null
    backup_target: null
    status: "planned"

# SSOT files that MUST be updated when services move
required_updates:
  - "docs/governance/SERVICE_REGISTRY.yaml"
  - "docs/governance/STACK_REGISTRY.yaml"
  - "docs/governance/DEVICE_IDENTITY_SSOT.md"
  - "ops/bindings/services.health.yaml"
  - "ops/bindings/ssh.targets.yaml"
  - "ops/bindings/backup.inventory.yaml"

# Temporary exceptions during migration
exceptions:
  - label: "split-dns-during-migration"
    reason: "DNS may resolve to old host during cutover window"
    expires_at: "2026-02-15T23:59:59Z"

# Rollback requirements
rollback:
  max_rollback_window_hours: 24
  requires_backup_verification: true
  requires_health_baseline: true
