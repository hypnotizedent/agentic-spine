---
status: authoritative
owner: "@ronny"
last_verified: 2026-03-02
scope: wave-lifecycle-contract
version: 3

# Wave Lifecycle Contract
# Defines valid state transitions, required artifacts, and close criteria.

states:
  active:
    description: "Wave is open, accepting dispatches"
    allowed_transitions: [closed]
    required_before_transition:
      closed:
        - "All watcher checks must be done or failed (not queued/running)"
        - "Preflight must have been run at least once"
        - "All dispatches must be done or explicitly blocked"
        - "All receipt artifacts in receipts/ must be valid JSON per schema"
  closed:
    description: "Wave is finalized, merge receipt generated"
    allowed_transitions: []
    artifacts:
      - merge_receipt
      - close_receipt_json

# Wave ID format
id_format: "WAVE-YYYYMMDD-NN"
id_pattern: "^WAVE-[0-9]{8}-[0-9]{2}$"

# EXEC_RECEIPT schema
exec_receipt:
  schema: "ops/bindings/orchestration.exec_receipt.schema.json"
  location: "runtime/waves/<WAVE_ID>/receipts/<task_id>.json"
  required_fields:
    - task_id
    - terminal_id
    - lane
    - status
    - files_changed
    - run_keys
    - blockers
    - ready_for_verify
    - timestamp_utc
  optional_fields:
    - wave_id
    - commit_hashes
    - loop_id
    - gap_ids

# Preflight contract
preflight:
  target_duration_s: 120
  clean_mode: scope_clean_required
  ambient_drift: report_only
  checks:
    - name: status_tick
      source: "ops status --brief"
      blocking: true
      timeout_s: 15
    - name: git_state
      source: "scope repo git status + ambient drift ledger"
      blocking: false
      timeout_s: 5
    - name: domain_health
      source: "domain-specific curl"
      blocking: true
      timeout_s: 30
    - name: lane_readiness
      source: "lane state check"
      blocking: false
      timeout_s: 5
  verdicts:
    go: "All blocking checks pass, no critical blockers"
    no-go: "One or more blocking checks failed"

# Watcher queue contract
watcher:
  default_checks:
    - cap: "stability.control.snapshot"
      priority: 1
      timeout_s: 600
    - cap: "verify.core.run"
      priority: 2
      timeout_s: 600
  states: [queued, running, done, failed]
  run_key_pattern: "CAP-[0-9]{8}-[0-9]{6}__[A-Za-z0-9._-]+__R[A-Za-z0-9]+"

# Merge receipt contract (generated on wave.close)
merge_receipt:
  format: markdown
  location: "runtime/waves/<WAVE_ID>/receipt.md"
  required_fields:
    - wave_id
    - objective
    - created_at
    - closed_at
    - dispatches_summary
    - watcher_run_keys
    - preflight_verdict
    - residual_blockers
    - exec_receipts_summary
  optional_fields:
    - roadmap_patch_draft
    - proposal_ids
    - commit_hashes
    - workspace_lifecycle

# JSON close receipt (machine-readable)
close_receipt:
  format: json
  location: "runtime/waves/<WAVE_ID>/close-receipt.json"
  required_fields:
    - wave_id
    - closed_at
    - force_closed
    - dispatches
    - valid_receipts
    - invalid_receipts
    - run_keys
    - residual_blockers
    - READY_FOR_ADOPTION

# Collect summary (written by ops wave collect)
collect_summary:
  format: json
  location: "runtime/waves/<WAVE_ID>/collect-summary.json"
  fields:
    - wave_id
    - collected_at
    - receipts (scanned/valid/invalid)
    - dispatches (total/done/failed/blocked/pending)
    - run_keys
    - ready_for_close

# Runtime state locations
runtime:
  waves_dir: "/Users/ronnyworks/code/.runtime/spine-mailroom/waves"
  lanes_state: "/Users/ronnyworks/code/.runtime/spine-mailroom/lanes/state.json"

# Workspace lifecycle defaults (non-destructive)
workspace:
  default_start_mode: auto
  branch_pattern: "codex/<WAVE_ID>"
  worktree_root: "~/.wt/<repo>/<WAVE_ID>"
  close_lifecycle_state: pending_close
  cleanup_policy: explicit_only

runtime_role_control:
  contract: ops/bindings/role.runtime.control.contract.yaml
  state_field: lifecycle_state
  state_machine: [active, implemented, validated, closed]
  promotion_path: [researcher, worker, qc, close]

wave_packet:
  required_fields:
    - wave_id
    - loop_id
    - owner_terminal
    - current_role
    - next_role
    - deadline_utc
    - horizon
    - execution_readiness
    - claimed_paths
  enforce:
    start: true
    dispatch: true

dod_guard:
  enforce_on_close: true
  required_blocks:
    - verify_results
    - blocker_classification
    - cleanup_proof
    - linkage

evidence_refs:
  required_fields:
    - run_key_refs
    - file_refs
    - commit_refs
    - blocker_class
  blocker_classes: [none, deterministic, freshness, dependency, cleanup, policy, external]

runtime_projections:
  traffic_index: mailroom/state/traffic.index.yaml
  path_claims: mailroom/state/path.claims.yaml
