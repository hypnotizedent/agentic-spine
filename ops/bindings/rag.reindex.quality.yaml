# RAG Reindex Quality Contract
#
# Governs quality thresholds for RAG reindex completion verification.
# Used by: rag.reindex.remote.verify capability, D89 drift gate
# Authority: docs/governance/RAG_REINDEX_RUNBOOK.md
#
# Status: authoritative
# Last verified: 2026-02-14
# Owner: "@ronny"

schema_version: "1.0"
updated: "2026-02-14"

# Completion quality gates - all must pass for clean reindex
completion:
  # No failures allowed for a clean completion
  max_failed_uploads: 0
  
  # Session must be stopped (not running/paused)
  session_must_be_stopped: true
  
  # Checkpoint file must be absent or empty after completion
  checkpoint_must_be_empty: true
  
  # Minimum smoke queries required after reindex
  min_smoke_queries: 2

# Index health thresholds
index_health:
  # docs_indexed should not exceed docs_eligible by more than this ratio
  # Catches stale/inflated counts from previous syncs
  # 1.5 = 50% inflation allowed (some docs may be renamed/duplicated)
  max_index_inflation_ratio: 1.5
  
  # docs_indexed must be at least this % of docs_eligible
  min_parity_ratio: 0.95

# Dependency timing SLOs (milliseconds)
dependency_slos:
  # AnythingLLM API ping from runner host
  anythingllm_ping_ms: 500
  
  # Qdrant healthz from runner host
  qdrant_healthz_ms: 100
  
  # Ollama tags from runner host
  ollama_tags_ms: 1000

# Stall detection
stall_detection:
  # If no progress for this many minutes, consider stalled
  max_stall_minutes: 30

# Smoke query expectations
smoke_queries:
  # Queries that should return sources from canonical paths
  - question: "What is the canonical session entry protocol file?"
    expected_source_pattern: "SESSION_PROTOCOL.md"
  - question: "How do I file a gap?"
    expected_source_pattern: "GAP_LIFECYCLE.md"
