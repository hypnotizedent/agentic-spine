# Status: authoritative
# Last verified: 2026-03-01

version: 3
updated_at: "2026-03-02"
owner: "@ronny"
scope: mail-archiver-account-linkage

mail_archiver:
  host: communications-stack
  vm_id: "214"
  service_id: mail-archiver-vm214
  base_url: "http://100.115.16.37:5100/"
  parent_loop: LOOP-MAIL-ARCHIVER-EWS-CANONICAL-CLOSURE-20260301-20260301

linkage_policy:
  ingestion_mode: read-only
  allow_sendback: false
  require_explicit_enable: true
  default_state: active
  boundary_rules:
    - "Only accounts listed in this contract are allowed as mail-archiver sources."
    - "Connectors are ingest-only (IMAP/OAuth read) and cannot send email."
    - "New sources require explicit contract update plus governed evidence."

freshness_semantics:
  live-sync:
    indicator: last_sync_timestamp
    source: "MailAccounts.LastSync column"
    stale_after_hours: 1
  import-only:
    indicator: latest_import_artifact_timestamp
    source: "mailroom/state/communications/mail-archiver-import-completion-*.yaml"
    stale_after_days: 90

accounts:
  - id: stalwart-ops
    db_account_id: 2
    provider: stalwart
    mailbox: ops@spine.ronny.works
    source_kind: self-hosted
    lane_type: live-sync
    connection:
      protocol: imap
      host: 100.115.16.37
      port: 993
      security: tls
      auth_method: password
      username_ref: infisical://spine/services/mail-archiver/STALWART_OPS_USERNAME
      password_ref: infisical://spine/services/mail-archiver/STALWART_OPS_PASSWORD
    sync:
      state: active
      cadence_cron: "*/15 * * * *"
      backfill_enabled: true
      max_lookback_days: 30

  - id: gmail-primary
    db_account_id: 1
    provider: gmail
    mailbox: hypnotizedent@gmail.com
    source_kind: external
    lane_type: live-sync
    connection:
      protocol: imap
      host: imap.gmail.com
      port: 993
      security: tls
      auth_method: app-password
      username_ref: infisical://spine/services/mail-archiver/GMAIL_PRIMARY_USERNAME
      password_ref: infisical://spine/services/mail-archiver/GMAIL_PRIMARY_APP_PASSWORD
    sync:
      state: active
      cadence_cron: "*/15 * * * *"
      backfill_enabled: true
      import_history:
        takeout_import_date: "2026-02-26"
        takeout_total_imported: 223631
        note: "Gmail Takeout MBOX import completed first, then live IMAP sync activated 2026-03-02."

  - id: icloud-primary
    db_account_id: 4
    provider: icloud
    mailbox: ronny@hantash.com
    source_kind: external
    lane_type: live-sync
    connection:
      protocol: imap
      host: imap.mail.me.com
      port: 993
      security: tls
      auth_method: app-password
      username_ref: infisical://spine/services/mail-archiver/ICLOUD_PRIMARY_USERNAME
      password_ref: infisical://spine/services/mail-archiver/ICLOUD_PRIMARY_APP_PASSWORD
    sync:
      state: active
      cadence_cron: "30 */6 * * *"
      backfill_enabled: true

  - id: microsoft-primary
    db_account_id: 3
    provider: microsoft-m365
    mailbox: ronny@mintprints.com
    source_kind: external
    lane_type: live-sync
    connection:
      protocol: m365-graph-api
      auth_method: client-credentials-oauth2
      client_id_ref: infisical://spine/platform/security/AZURE_CLIENT_ID
      client_secret_ref: infisical://spine/platform/security/AZURE_CLIENT_SECRET
      tenant_id_ref: infisical://spine/platform/security/AZURE_TENANT_ID
    sync:
      state: active
      cadence_cron: "*/15 * * * *"
      backfill_enabled: true
      import_history:
        lanes:
          - lane: graph-api-primary
            completed: "2026-02-26"
            messages: 9087
            note: "Graph API /me/messages MIME export of primary mailbox"
          - lane: ews-archive
            completed: "2026-03-01"
            messages: 68716
            note: "EWS full_access_as_app export of Exchange Online Archive (In-Place Archive)"
        total_imported: 77803
        note: "Both primary mailbox (Graph API) and archive mailbox (EWS) imported first, then M365 Graph live-sync activated 2026-03-02."

onboarding:
  description: "Turnkey checklist for adding a new email account to mail-archiver."
  required_fields:
    - id
    - provider
    - mailbox
    - source_kind
    - lane_type
    - connection
    - sync.state
  steps:
    - "1. Decide lane_type: live-sync (IMAP) or import-only (takeout/export)."
    - "2. Provision credentials in Infisical at /spine/services/mail-archiver/."
    - "3. Add account entry to this contract with all required_fields."
    - "4. Configure account in mail-archiver web UI (http://100.115.16.37:5100/)."
    - "5. For live-sync: set cadence_cron + verify first sync via MailAccounts.LastSync."
    - "6. For import-only: run import, then write completion artifact to mailroom/state/communications/."
    - "7. Commit contract update with governed evidence."
    - "8. Run: ./bin/ops cap run verify.pack.run communications"
  provider_notes:
    gmail:
      auth: "App Password (requires 2FA). Generate at myaccount.google.com/apppasswords."
      imap: "imap.gmail.com:993 TLS"
      live_sync_ready: true
      note: "Enable IMAP in Gmail Settings > Forwarding and POP/IMAP."
    icloud:
      auth: "App-Specific Password (requires 2FA). Generate at appleid.apple.com."
      imap: "imap.mail.me.com:993 TLS"
      live_sync_ready: true
    microsoft:
      auth: "OAuth2 client credentials (basic auth deprecated). Azure AD app registration required."
      imap: "outlook.office365.com:993 TLS (OAuth2 SASL XOAUTH2 only)"
      live_sync_ready: false
      note: "Live-sync blocked by OAuth2 IMAP complexity. Use Graph API delta sync or periodic EWS re-export instead."
    stalwart:
      auth: "Password (self-hosted, Infisical-managed)."
      imap: "100.115.16.37:993 TLS (local Stalwart)"
      live_sync_ready: true

evidence:
  verify_commands:
    - "./bin/ops cap run communications.stack.status"
    - "./bin/ops cap run verify.pack.run communications"
  closes_gaps:
    - GAP-OP-923
    - GAP-OP-973

