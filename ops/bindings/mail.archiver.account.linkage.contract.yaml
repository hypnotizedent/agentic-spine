# Status: authoritative
# Last verified: 2026-03-01

version: 2
updated_at: "2026-03-01"
owner: "@ronny"
scope: mail-archiver-account-linkage

mail_archiver:
  host: communications-stack
  vm_id: "214"
  service_id: mail-archiver-vm214
  base_url: "http://100.115.16.37:5100/"
  parent_loop: LOOP-MAIL-ARCHIVER-EWS-CANONICAL-CLOSURE-20260301-20260301

linkage_policy:
  ingestion_mode: read-only
  allow_sendback: false
  require_explicit_enable: true
  default_state: active
  boundary_rules:
    - "Only accounts listed in this contract are allowed as mail-archiver sources."
    - "Connectors are ingest-only (IMAP/OAuth read) and cannot send email."
    - "New sources require explicit contract update plus governed evidence."

freshness_semantics:
  live-sync:
    indicator: last_sync_timestamp
    source: "MailAccounts.LastSync column"
    stale_after_hours: 1
  import-only:
    indicator: latest_import_artifact_timestamp
    source: "mailroom/state/communications/mail-archiver-import-completion-*.yaml"
    stale_after_days: 90

accounts:
  - id: stalwart-ops
    db_account_id: 2
    provider: stalwart
    mailbox: ops@spine.ronny.works
    source_kind: self-hosted
    lane_type: live-sync
    connection:
      protocol: imap
      host: 100.115.16.37
      port: 993
      security: tls
      auth_method: password
      username_ref: infisical://spine/services/mail-archiver/STALWART_OPS_USERNAME
      password_ref: infisical://spine/services/mail-archiver/STALWART_OPS_PASSWORD
    sync:
      state: active
      cadence_cron: "*/15 * * * *"
      backfill_enabled: true
      max_lookback_days: 30

  - id: gmail-primary
    db_account_id: 1
    provider: gmail
    mailbox: hypnotizedent@gmail.com
    source_kind: external
    lane_type: import-only
    connection:
      protocol: import
      import_method: google-takeout-mbox
    sync:
      state: active
      import_complete: true
      import_completion_date: "2026-02-26"
      total_imported: 223631
      note: "Gmail Takeout MBOX import complete. No live IMAP sync — archive-only lane."

  - id: icloud-primary
    db_account_id: 4
    provider: icloud
    mailbox: ronny@hantash.com
    source_kind: external
    lane_type: live-sync
    connection:
      protocol: imap
      host: imap.mail.me.com
      port: 993
      security: tls
      auth_method: app-password
      username_ref: infisical://spine/services/mail-archiver/ICLOUD_PRIMARY_USERNAME
      password_ref: infisical://spine/services/mail-archiver/ICLOUD_PRIMARY_APP_PASSWORD
    sync:
      state: active
      cadence_cron: "30 */6 * * *"
      backfill_enabled: true

  - id: microsoft-primary
    db_account_id: 3
    provider: microsoft-outlook
    mailbox: ronny@mintprints.com
    source_kind: external
    lane_type: import-only
    connection:
      protocol: import
      import_method: graph-api-mime-export + ews-archive-export
    sync:
      state: active
      import_complete: true
      import_lanes:
        - lane: graph-api-primary
          completed: "2026-02-26"
          messages: 9087
          note: "Graph API /me/messages MIME export of primary mailbox"
        - lane: ews-archive
          completed: "2026-03-01"
          messages: 68716
          note: "EWS full_access_as_app export of Exchange Online Archive (In-Place Archive)"
      total_imported: 77803
      note: "Both primary mailbox (Graph API) and archive mailbox (EWS) imported. No live IMAP sync — archive-only lane."

evidence:
  verify_commands:
    - "./bin/ops cap run communications.stack.status"
    - "./bin/ops cap run verify.pack.run communications"
  closes_gaps:
    - GAP-OP-923
    - GAP-OP-973

