# Policy Runtime Contract
# Status: authoritative
# Last verified: 2026-02-15
# Scope: aof-policy-runtime-enforcement
#
# Declares which policy knobs must be enforced at runtime and how.
# Referenced by: D94 gate, policy.runtime.audit capability
# Referenced by: AOF_POLICY_RUNTIME_ENFORCEMENT.md, policy.presets.yaml

version: 1
updated_at: "2026-02-15"
owner: "@ronny"

# Runtime enforcement rules
# Each knob from policy.presets.yaml must have an enforcement entry here.
# enforcement_point: where the knob is checked (drift-gate, cap-runner, hook)
# enforcement_mode: how violations are handled (fail, warn, log)

knobs:
  drift_gate_mode:
    description: "Controls whether drift gate failures are hard (fail) or soft (warn)"
    enforcement_point: drift-gate.sh
    enforcement_mode: runtime
    wired: true
    wired_in: "surfaces/verify/drift-gate.sh"
    validates_via: "DRIFT_GATE_MODE variable check"

  approval_default:
    description: "Default approval mode for capabilities (auto or manual)"
    enforcement_point: cap.sh
    enforcement_mode: runtime
    wired: true
    wired_in: "ops/commands/cap.sh"
    validates_via: "APPROVAL_DEFAULT override in cap runner"

  session_closeout_sla_hours:
    description: "Maximum hours between session closeouts"
    enforcement_point: drift-gate.sh
    enforcement_mode: runtime
    wired: true
    wired_in: "surfaces/verify/drift-gate.sh (D61)"
    validates_via: "SLA_HOURS variable in closeout check"

  warn_policy:
    description: "Warning escalation policy (strict=fail on warn, advisory=log only)"
    enforcement_point: drift-gate.sh
    enforcement_mode: runtime
    wired: true
    wired_in: "surfaces/verify/drift-gate.sh"
    validates_via: "WARN_POLICY variable at gate summary"

  stale_ssot_max_days:
    description: "Maximum days before SSOT freshness check fails"
    enforcement_point: drift-gate.sh
    enforcement_mode: runtime
    wired: true
    wired_in: "surfaces/verify/drift-gate.sh (D58 SSOT_FRESHNESS_DAYS)"
    validates_via: "SSOT_FRESHNESS_DAYS exported from RESOLVED_STALE_SSOT_MAX_DAYS"

  gap_auto_claim:
    description: "Whether gaps are auto-claimed on file"
    enforcement_point: gaps-file
    enforcement_mode: runtime
    wired: true
    wired_in: "ops/plugins/loops/bin/gaps-file"
    validates_via: "RESOLVED_GAP_AUTO_CLAIM check after gap filed"

  proposal_required:
    description: "Whether multi-agent writes require proposal flow"
    enforcement_point: cap.sh
    enforcement_mode: runtime
    wired: true
    wired_in: "ops/commands/cap.sh"
    validates_via: "RESOLVED_PROPOSAL_REQUIRED blocks mutating caps when true"

  receipt_retention_days:
    description: "Days to retain receipt files before purge eligibility"
    enforcement_point: evidence.export
    enforcement_mode: runtime
    wired: true
    wired_in: "ops/plugins/evidence/bin/evidence-export-plan"
    validates_via: "RESOLVED_RECEIPT_RETENTION_DAYS overrides session_receipts retention"

  commit_sign_required:
    description: "Whether git commits require GPG signatures"
    enforcement_point: pre-commit hook
    enforcement_mode: runtime
    wired: true
    wired_in: ".githooks/pre-commit"
    validates_via: "RESOLVED_COMMIT_SIGN_REQUIRED blocks unsigned commits when true"

  multi_agent_writes:
    description: "Multi-agent write policy (proposal-only or direct)"
    enforcement_point: cap.sh + pre-commit hook
    enforcement_mode: runtime
    wired: true
    wired_in: "ops/commands/cap.sh"
    validates_via: "RESOLVED_MULTI_AGENT_WRITES blocks direct writes when proposal-only"

enforcement:
  gate: D94
  capability: policy.runtime.audit
  checks:
    - "Contract binding exists with all 10 knobs declared"
    - "Each knob declares enforcement_point and wired status"
    - "Wired knobs reference valid source files"
    - "Unwired knobs declare gap reason"
