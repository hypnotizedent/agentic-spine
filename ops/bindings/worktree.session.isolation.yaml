# Worktree Session Isolation Contract
# Status: authoritative
# Last verified: 2026-02-27
# Scope: session-entry hook + ops preflight + D140 drift gate

version: "1.0"
updated: "2026-02-27"
owner: "@ronny"
scope: worktree-session-isolation

policy:
  enabled: true
  main_branch: "main"
  managed_worktree_prefix: "~/.wt/agentic-spine/"
  require_non_main_in_managed_worktree: true
  require_explicit_identity_on_non_main: true
  identity_env_var: "OPS_WORKTREE_IDENTITY"
  bypass_env_var: "OPS_WORKTREE_ISOLATION_BYPASS"
  bypass_allowed_value: "1"
  identity_patterns:
    - "^LOOP-[A-Z0-9-]+$"
    - "^CP-[A-Z0-9-]+$"
  allow_detached_head: false

messages:
  remediation: "Run ./bin/ops wave start <WAVE_ID> --objective \"...\" to auto-provision ~/.wt/<repo>/<lane>, or run worktree.lifecycle.rehydrate for existing branches. Export OPS_WORKTREE_IDENTITY=<LOOP_ID|WAVE_ID> before operating on non-main."
  bypass_warning: "Emergency bypass only: export OPS_WORKTREE_ISOLATION_BYPASS=1"
