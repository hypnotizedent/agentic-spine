status: authoritative
owner: "@ronny"
last_verified: "2026-03-01"
scope: media-capacity-guard-policy
version: "2.0"
updated: "2026-03-01T00:00:00Z"
mode:
  default_policy: report
  enforce_promotion_criteria:
    - contract: docs/CANONICAL/MEDIA_CAPACITY_GUARD_CONTRACT_V1.yaml
      requirement: "READY_FOR_ENFORCE_PROMOTION attested in master receipt"
    - requirement: "verify.pack.run mint passes"
    - requirement: "verify.pack.run communications passes"
thresholds:
  media_warn_pct: 80
  media_fail_pct: 85
  stale_days: 7
runway:
  runway_min_days: 30
  projection_freshness_ttl_hours: 30
  growth_window_days: 14
  top_contributors_limit: 8
  snapshot_path: ops/bindings/media.capacity.snapshot.yaml
  history_path: mailroom/state/capacity/media-capacity-history.ndjson
action_matrix:
  healthy:
    severity: low
    trigger: "runway_status=healthy"
    required_actions:
      - "Keep daily snapshot refresh active."
      - "No reclaim action required."
  warn:
    severity: medium
    trigger: "runway_status=warn or usage>=media_warn_pct"
    required_actions:
      - "Review top contributors and reclaim candidates from regenerable class."
      - "Open/maintain owning loop+gap linkage until runway recovers."
  critical:
    severity: high
    trigger: "runway_status=critical or usage>=media_fail_pct"
    required_actions:
      - "Escalate reclaim execution in primary media lane."
      - "Freeze nonessential ingest until days_to_fail recovers above runway_min_days."
tiered_reclaim_policy:
  regenerable:
    priority: p1
    examples:
      - "cache"
      - "downloads"
      - "transcode"
    action: "Reclaim first; safe to rebuild from source."
  stateful:
    priority: p3
    examples:
      - "app-config"
      - "metadata"
      - "database"
    action: "Do not reclaim without explicit backup + restore plan."
  unknown:
    priority: p2
    action: "Classify before reclaim; default to hold."
policy_links:
  wan_transfer_policy:
    policy_ref: ops/bindings/media.topology.history.yaml
    rule: "No bulk media transfer over WAN â€” tier-3 media remains local to shop media lane."
onboarding_capacity_contract:
  required_fields:
    - capacity_lane
    - capacity_budget_class
    - retention_policy_ref
    - reclaim_policy_ref
  enforced_by_gate: D259
  by_hostname:
    docker-host:
      capacity_lane: infra-shared
      capacity_budget_class: tier2-stateful
      retention_policy_ref: ops/bindings/backup.inventory.yaml
      reclaim_policy_ref: ops/bindings/infra.capacity.guard.policy.yaml#tiered_reclaim_policy.stateful
    automation-stack:
      capacity_lane: infra-shared
      capacity_budget_class: tier2-stateful
      retention_policy_ref: ops/bindings/backup.inventory.yaml
      reclaim_policy_ref: ops/bindings/infra.capacity.guard.policy.yaml#tiered_reclaim_policy.stateful
    immich:
      capacity_lane: stateful-core
      capacity_budget_class: tier2-stateful
      retention_policy_ref: ops/bindings/backup.inventory.yaml
      reclaim_policy_ref: ops/bindings/infra.capacity.guard.policy.yaml#tiered_reclaim_policy.stateful
    infra-core:
      capacity_lane: infra-shared
      capacity_budget_class: tier2-stateful
      retention_policy_ref: ops/bindings/backup.inventory.yaml
      reclaim_policy_ref: ops/bindings/infra.capacity.guard.policy.yaml#tiered_reclaim_policy.stateful
    observability:
      capacity_lane: infra-shared
      capacity_budget_class: tier2-stateful
      retention_policy_ref: ops/bindings/backup.inventory.yaml
      reclaim_policy_ref: ops/bindings/infra.capacity.guard.policy.yaml#tiered_reclaim_policy.stateful
    dev-tools:
      capacity_lane: infra-shared
      capacity_budget_class: tier2-stateful
      retention_policy_ref: ops/bindings/backup.inventory.yaml
      reclaim_policy_ref: ops/bindings/infra.capacity.guard.policy.yaml#tiered_reclaim_policy.stateful
    ai-consolidation:
      capacity_lane: infra-shared
      capacity_budget_class: tier2-stateful
      retention_policy_ref: ops/bindings/backup.inventory.yaml
      reclaim_policy_ref: ops/bindings/infra.capacity.guard.policy.yaml#tiered_reclaim_policy.stateful
    download-stack:
      capacity_lane: media-primary
      capacity_budget_class: tier3-regenerable
      retention_policy_ref: ops/bindings/media.import.policy.yaml
      reclaim_policy_ref: ops/bindings/infra.capacity.guard.policy.yaml#tiered_reclaim_policy.regenerable
    streaming-stack:
      capacity_lane: media-primary
      capacity_budget_class: tier3-regenerable
      retention_policy_ref: ops/bindings/media.import.policy.yaml
      reclaim_policy_ref: ops/bindings/infra.capacity.guard.policy.yaml#tiered_reclaim_policy.regenerable
    finance-stack:
      capacity_lane: stateful-core
      capacity_budget_class: tier2-stateful
      retention_policy_ref: ops/bindings/backup.inventory.yaml
      reclaim_policy_ref: ops/bindings/infra.capacity.guard.policy.yaml#tiered_reclaim_policy.stateful
    mint-data:
      capacity_lane: stateful-core
      capacity_budget_class: tier2-stateful
      retention_policy_ref: ops/bindings/backup.inventory.yaml
      reclaim_policy_ref: ops/bindings/infra.capacity.guard.policy.yaml#tiered_reclaim_policy.stateful
    mint-apps:
      capacity_lane: infra-shared
      capacity_budget_class: tier3-regenerable
      retention_policy_ref: ops/bindings/backup.inventory.yaml
      reclaim_policy_ref: ops/bindings/infra.capacity.guard.policy.yaml#tiered_reclaim_policy.regenerable
    communications-stack:
      capacity_lane: stateful-core
      capacity_budget_class: tier2-stateful
      retention_policy_ref: ops/bindings/backup.inventory.yaml
      reclaim_policy_ref: ops/bindings/infra.capacity.guard.policy.yaml#tiered_reclaim_policy.stateful
target:
  storage_host_id: pve
  pool_name: media
  sibling_pool_name: md1400
ownership:
  owning_loop_id: LOOP-INFRA-MEDIA-CAPACITY-GUARD-20260227
  owning_loop_prefix: LOOP-INFRA-MEDIA-CAPACITY-GUARD-
  owning_terminal: SPINE-EXECUTION-01
  owning_role: SPINE-CONTROL-01
protected:
  no_touch_loop_ids:
    - LOOP-MAIL-ARCHIVER-MICROSOFT-DEEP-IMPORT-20260226
  no_touch_gap_ids:
    - GAP-OP-973
evidence:
  trend_file: docs/planning/W52_MEDIA_CAPACITY_TREND_EVIDENCE.md
  milestone_due_window: "48h"
  required_milestones:
    - "Reduce media below WARN threshold (<80%)"
    - "Attach zpool evidence timestamp"
    - "Link one owning gap and one owning loop"
