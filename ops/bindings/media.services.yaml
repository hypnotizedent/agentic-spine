# Media Services Binding (SSOT)
# Status: authoritative
# Owner: "@ronny"
# Last verified: 2026-02-15
# Scope: media-stack-services
#
# Consolidated service inventory for media-stack tenant.
# Derived from SERVICE_REGISTRY.yaml with media-stack specific metadata.
# Used by: media.health.check, media.service.status capabilities
#          D106-D110 drift gates

version: 1
updated: "2026-02-17"
owner: "@ronny"

defaults:
  health_timeout_sec: 10
  compose_command: "docker compose"

services:
  # ════════════════════════════════════════════════════════════════════════
  # VM 209 — download-stack (192.168.1.209)
  # ════════════════════════════════════════════════════════════════════════

  # Indexing
  prowlarr:
    vm: download-stack
    port: 9696
    health: /ping
    status: active
    category: indexing
    description: "Indexer manager for *arr services"

  # Management (*arr stack)
  radarr:
    vm: download-stack
    port: 7878
    health: /ping
    status: active
    category: management
    description: "Movie management"
    dependencies: [prowlarr, sabnzbd, qbittorrent]

  sonarr:
    vm: download-stack
    port: 8989
    health: /ping
    status: active
    category: management
    description: "TV management"
    dependencies: [prowlarr, sabnzbd, qbittorrent]

  lidarr:
    vm: download-stack
    port: 8686
    health: /ping
    status: active
    category: management
    description: "Music management"
    dependencies: [prowlarr, sabnzbd, slskd]

  # Download clients
  sabnzbd:
    vm: download-stack
    port: 8080
    health: /api?mode=version&output=json
    status: active
    category: download
    description: "Usenet downloader"

  qbittorrent:
    vm: download-stack
    port: 8081
    health: /
    status: active
    category: download
    description: "BitTorrent client"

  # Enhancement services
  bazarr-dl:
    vm: download-stack
    port: 6767
    health: /ping
    status: parked
    category: enhancement
    description: "Subtitle management (download instance, currently inactive)"

  trailarr:
    vm: download-stack
    port: 7667
    health: null  # returns 401 on all paths (auth-gated, no public health route)
    status: active
    category: enhancement
    description: "Trailer management"

  posterizarr:
    vm: download-stack
    port: null
    health: null
    status: active
    category: enhancement
    description: "Poster art management"

  unpackerr:
    vm: download-stack
    port: null
    health: null
    status: active
    category: utility
    description: "Archive extraction for downloads"

  recyclarr:
    vm: download-stack
    port: null
    health: null
    status: active
    category: utility
    description: "TRaSH guide sync"

  flaresolverr:
    vm: download-stack
    port: 8191
    health: /health
    status: active
    category: utility
    description: "Cloudflare challenge solver"

  # Experimental services
  huntarr:
    vm: download-stack
    port: null
    health: null
    status: active
    category: experimental
    description: "Missing media hunter"

  autopulse:
    vm: download-stack
    port: null
    health: null
    status: active
    category: experimental
    description: "Library refresh trigger for Jellyfin (cross-VM)"

  crosswatch:
    vm: download-stack
    port: null
    health: null
    status: active
    category: experimental
    description: "Cross-service watch sync"

  decypharr:
    vm: download-stack
    port: null
    health: null
    status: active
    category: experimental
    description: "Real-Debrid integration"

  # Swaparr instances (stalled download swappers)
  swaparr-radarr:
    vm: download-stack
    port: null
    health: null
    status: active
    category: utility
    description: "Stalled download swapper for Radarr"

  swaparr-sonarr:
    vm: download-stack
    port: null
    health: null
    status: active
    category: utility
    description: "Stalled download swapper for Sonarr"

  swaparr-lidarr:
    vm: download-stack
    port: null
    health: null
    status: active
    category: utility
    description: "Stalled download swapper for Lidarr"

  # Parked services (intentionally stopped)
  tdarr:
    vm: download-stack
    port: 8265
    health: /
    status: parked
    category: parked
    description: "Transcode automation (soak period)"

  slskd:
    vm: download-stack
    port: 5030
    health: /metrics
    status: parked
    category: parked
    description: "Soulseek client (soularr dependency)"

  soularr:
    vm: download-stack
    port: null
    health: null
    status: active
    category: utility
    description: "Soulseek integration for Lidarr"

  # Infrastructure
  crowdsec:
    vm: download-stack
    port: null
    health: null
    status: active
    category: infrastructure
    description: "Security monitoring"

  watchtower-download:
    vm: download-stack
    container: watchtower
    port: null
    health: null
    status: active
    category: infrastructure
    description: "Auto-update utility"

  download-node-exporter:
    vm: download-stack
    container: node-exporter
    port: 9100
    health: /
    status: active
    category: infrastructure
    description: "Host metrics exporter for Prometheus"

  # ════════════════════════════════════════════════════════════════════════
  # VM 210 — streaming-stack (192.168.1.210)
  # ════════════════════════════════════════════════════════════════════════

  # Video streaming
  jellyfin:
    vm: streaming-stack
    port: 8096
    health: /health
    status: active
    category: streaming
    description: "Video streaming server"
    critical: true

  # Music streaming
  navidrome:
    vm: streaming-stack
    port: 4533
    health: /ping
    status: active
    category: streaming
    description: "Music streaming server"

  # Request management
  jellyseerr:
    vm: streaming-stack
    port: 5055
    health: /api/v1/status
    status: active
    category: requests
    description: "Media request management"

  # Subtitles
  bazarr:
    vm: streaming-stack
    port: 6767
    health: /ping
    status: active
    category: enhancement
    description: "Subtitle management"

  # Dashboard
  homarr:
    vm: streaming-stack
    port: 7575
    health: /
    status: active
    category: dashboard
    description: "Media dashboard"

  # User management
  wizarr:
    vm: streaming-stack
    port: 5690
    health: null  # returns 302 redirect (no public health route)
    status: active
    category: user-mgmt
    description: "Media server invitation management"

  # Music sync
  spotisub:
    vm: streaming-stack
    port: 8766
    health: null
    status: active
    category: enhancement
    description: "Spotify-to-Navidrome sync"

  subgen:
    vm: streaming-stack
    port: null
    health: null
    status: active
    category: enhancement
    description: "AI subtitle generation for Jellyfin"

  # Infrastructure
  watchtower-streaming:
    vm: streaming-stack
    container: watchtower
    port: null
    health: null
    status: active
    category: infrastructure
    description: "Auto-update utility"

  streaming-node-exporter:
    vm: streaming-stack
    container: node-exporter
    port: 9100
    health: /
    status: active
    category: infrastructure
    description: "Host metrics exporter for Prometheus"

# Port collision matrix (for D106 verification)
ports:
  download-stack:
    9696: prowlarr
    7878: radarr
    8989: sonarr
    8686: lidarr
    8080: sabnzbd
    8081: qbittorrent
    6767: bazarr-dl
    7667: trailarr
    8191: flaresolverr
    8265: tdarr  # parked
    5030: slskd  # parked
    9100: download-node-exporter

  streaming-stack:
    8096: jellyfin
    4533: navidrome
    5055: jellyseerr
    6767: bazarr
    7575: homarr
    5690: wizarr
    8766: spotisub
    9100: streaming-node-exporter

# HA add-on overlap audit (for D110)
ha_overlaps:
  source_vm: 100  # homeassistant
  source_host: proxmox-home
  
  overlaps:
    - ha_addon: overseerr
      shop_service: jellyseerr
      shop_vm: streaming-stack
      shop_port: 5055
      recommendation: decommission
      reason: "jellyseerr on streaming-stack is the canonical request manager"

    - ha_addon: lidarr
      shop_service: lidarr
      shop_vm: download-stack
      shop_port: 8686
      recommendation: investigate
      reason: "may have different library config or be stale duplicate"

    - ha_addon: sonarr
      shop_service: sonarr
      shop_vm: download-stack
      shop_port: 8989
      recommendation: investigate
      reason: "may have different library config or be stale duplicate"

    - ha_addon: sabnzbd
      shop_service: sabnzbd
      shop_vm: download-stack
      shop_port: 8080
      recommendation: investigate
      reason: "may have different config or be stale duplicate"
