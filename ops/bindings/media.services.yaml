# Media Services Binding (SSOT)
# Status: authoritative
# Owner: "@ronny"
# Last verified: 2026-02-15
# Scope: media-stack-services
#
# Consolidated service inventory for media-stack tenant.
# Derived from SERVICE_REGISTRY.yaml with media-stack specific metadata.
# Used by: media.health.check, media.service.status capabilities
#          D106-D110 drift gates

version: 1
updated_at: "2026-02-25"
owner: "@ronny"

defaults:
  health_timeout_sec: 10
  compose_command: "docker compose"

naming_aliases:
  media-stack:
    status: deprecated
    replaced_by:
      - download-stack
      - streaming-stack
    note: "Legacy media-stack host alias retired after VM split."
  arr-stack:
    status: active
    canonical_vm: download-stack
    note: "ARR services run on download-stack unless explicitly listed under streaming-stack."

services:
  # ════════════════════════════════════════════════════════════════════════
  # VM 209 — download-stack (192.168.1.209)
  # ════════════════════════════════════════════════════════════════════════

  # Indexing
  prowlarr:
    vm: download-stack
    port: 9696
    health: /ping
    status: active
    category: indexing
    description: "Indexer manager for *arr services"

  # Management (*arr stack)
  radarr:
    vm: download-stack
    port: 7878
    health: /ping
    status: active
    category: management
    description: "Movie management"
    dependencies: [prowlarr, sabnzbd, qbittorrent]

  sonarr:
    vm: download-stack
    port: 8989
    health: /ping
    status: active
    category: management
    description: "TV management"
    dependencies: [prowlarr, sabnzbd, qbittorrent]

  lidarr:
    vm: download-stack
    port: 8686
    health: /ping
    status: active
    category: management
    description: "Music management"
    dependencies: [prowlarr, sabnzbd, slskd]

  # Download clients
  sabnzbd:
    vm: download-stack
    port: 8080
    health: /api?mode=version&output=json
    status: active
    category: download
    description: "Usenet downloader"

  qbittorrent:
    vm: download-stack
    port: 8081
    health: /
    status: active
    category: download
    description: "BitTorrent client (route mode: direct; see ops/bindings/vpn.provider.yaml)"

  # Enhancement services
  bazarr-dl:
    vm: download-stack
    port: 6767
    health: /ping
    status: parked
    category: enhancement
    description: "Subtitle management (download instance, currently inactive)"

  trailarr:
    vm: download-stack
    port: 7667
    health: null
    health_reason: auth_gated
    status: active
    category: enhancement
    description: "Trailer management"

  posterizarr:
    vm: download-stack
    port: null
    health: null
    health_reason: no_http_port
    status: active
    category: enhancement
    description: "Poster art management"

  unpackerr:
    vm: download-stack
    port: null
    health: null
    health_reason: no_http_port
    status: active
    category: utility
    description: "Archive extraction for downloads"

  recyclarr:
    vm: download-stack
    port: null
    health: null
    health_reason: no_http_port
    status: active
    category: utility
    description: "TRaSH guide sync (cron-triggered, no daemon)"

  flaresolverr:
    vm: download-stack
    port: 8191
    health: /health
    status: active
    category: utility
    description: "Cloudflare challenge solver"

  # Experimental services
  huntarr:
    vm: download-stack
    port: 9705
    health: /api/health
    status: active
    category: experimental
    description: "Missing media hunter (cycles Lidarr/Radarr/Sonarr searches)"

  autopulse:
    vm: download-stack
    port: 2875
    health: null
    health_reason: localhost_bound
    status: active
    category: experimental
    description: "Library refresh trigger for Jellyfin (cross-VM)"

  crosswatch:
    vm: download-stack
    port: 8787
    health: null
    health_reason: localhost_bound
    status: active
    category: experimental
    description: "Cross-service watch sync"

  decypharr:
    vm: download-stack
    port: null
    health: null
    health_reason: no_http_port
    status: active
    category: experimental
    description: "Real-Debrid integration"

  # Swaparr instances (stalled download swappers)
  swaparr-radarr:
    vm: download-stack
    port: null
    health: null
    health_reason: no_http_port
    status: active
    category: utility
    description: "Stalled download swapper for Radarr"

  swaparr-sonarr:
    vm: download-stack
    port: null
    health: null
    health_reason: no_http_port
    status: active
    category: utility
    description: "Stalled download swapper for Sonarr"

  swaparr-lidarr:
    vm: download-stack
    port: null
    health: null
    health_reason: no_http_port
    status: active
    category: utility
    description: "Stalled download swapper for Lidarr"

  # VPN infrastructure
  gluetun:
    vm: download-stack
    port: null
    health: null
    health_reason: no_http_port
    status: active
    category: infrastructure
    description: "Privado VPN tunnel container for media P2P lane (authoritative policy in ops/bindings/vpn.provider.yaml)"

  # Parked services (intentionally stopped)
  tdarr:
    vm: download-stack
    port: 8265
    health: /
    status: parked
    category: parked
    description: "Transcode automation (soak period)"

  slskd:
    vm: download-stack
    port: 5030
    health: null
    health_reason: vpn_network_mode
    status: active
    category: download
    description: "Soulseek client (route mode: via_tunnel -> gluetun)"
    dependencies: [gluetun]

  soularr:
    vm: download-stack
    port: null
    health: null
    health_reason: no_http_port
    status: active
    category: utility
    description: "Soulseek integration for Lidarr"
    dependencies: [lidarr, slskd]

  # Infrastructure
  crowdsec:
    vm: download-stack
    port: null
    health: null
    health_reason: no_http_port
    status: active
    category: infrastructure
    description: "Security monitoring"

  watchtower-download:
    vm: download-stack
    container: watchtower
    port: null
    health: null
    health_reason: no_http_port
    status: active
    category: infrastructure
    description: "Auto-update utility"

  download-node-exporter:
    vm: download-stack
    container: node-exporter
    port: 9100
    health: /
    status: active
    category: infrastructure
    description: "Host metrics exporter for Prometheus"

  # ════════════════════════════════════════════════════════════════════════
  # VM 210 — streaming-stack (192.168.1.210)
  # ════════════════════════════════════════════════════════════════════════

  # Video streaming
  jellyfin:
    vm: streaming-stack
    port: 8096
    health: /health
    status: active
    category: streaming
    description: "Video streaming server"
    critical: true

  # Music streaming
  navidrome:
    vm: streaming-stack
    port: 4533
    health: /ping
    status: active
    category: streaming
    description: "Music streaming server"

  # Request management
  jellyseerr:
    vm: streaming-stack
    port: 5055
    health: /api/v1/status
    status: active
    category: requests
    description: "Media request management"

  # Subtitles
  bazarr:
    vm: streaming-stack
    port: 6767
    health: /ping
    status: active
    category: enhancement
    description: "Subtitle management"

  # Dashboard
  homarr:
    vm: streaming-stack
    port: 7575
    health: /
    status: active
    category: dashboard
    role: operator-dashboard
    description: "Media dashboard"

  # User management
  wizarr:
    vm: streaming-stack
    port: 5690
    health: /
    status: active
    category: user-mgmt
    description: "Media server invitation management"

  # Music sync
  spotisub:
    vm: streaming-stack
    port: 8766
    health: /api/v1/utils/healthcheck
    status: active
    category: enhancement
    description: "Spotify-to-Navidrome sync"

  subgen:
    vm: streaming-stack
    port: null
    health: null
    health_reason: no_http_port
    status: active
    category: enhancement
    description: "AI subtitle generation for Jellyfin"

  # Infrastructure
  watchtower-streaming:
    vm: streaming-stack
    container: watchtower
    port: null
    health: null
    health_reason: no_http_port
    status: active
    category: infrastructure
    description: "Auto-update utility"

  streaming-node-exporter:
    vm: streaming-stack
    container: node-exporter
    port: 9100
    health: /
    status: active
    category: infrastructure
    description: "Host metrics exporter for Prometheus"

# Jellyfin plugins (installed on streaming-stack VM 210)
jellyfin_plugins:
  repositories:
    - name: "IAmParadox"
      url: "https://www.iamparadox.dev/jellyfin/plugins/manifest.json"
    - name: "Auto Collections (KeksBombe)"
      url: "https://raw.githubusercontent.com/KeksBombe/jellyfin-plugin-auto-collections/refs/heads/main/manifest.json"
    - name: "LizardByte"
      url: "https://app.lizardbyte.dev/jellyfin-plugin-repo/manifest.json"
  installed:
    - name: "Home Screen Sections"
      version: "2.5.2.0"
      status: active
      purpose: "Netflix-style home screen rows"
    - name: "Collection Sections"
      version: "2.3.5.0"
      status: active
      purpose: "Collection-driven library browsing"
    - name: "Auto Collections"
      version: "0.0.4.1"
      status: active
      purpose: "Automatic genre/decade/studio collections"

# Canonical VPN routing policy (see ops/bindings/vpn.provider.yaml)
vpn_policy:
  provider_binding: ops/bindings/vpn.provider.yaml
  tunnel_service: gluetun
  services:
    slskd:
      route_mode: via_tunnel
      tunnel_service: gluetun
    qbittorrent:
      route_mode: direct
      decision_gate: QB-VPN-ROUTE-001
    sabnzbd:
      route_mode: direct

# Port collision matrix (for D106 verification)
ports:
  download-stack:
    9696: prowlarr
    7878: radarr
    8989: sonarr
    8686: lidarr
    8080: sabnzbd
    8081: qbittorrent
    6767: bazarr-dl
    7667: trailarr
    8191: flaresolverr
    8265: tdarr  # parked
    5030: slskd  # via gluetun
    50300: slskd  # P2P listen port via gluetun
    9705: huntarr
    2875: autopulse
    8787: crosswatch
    9100: download-node-exporter

  streaming-stack:
    8096: jellyfin
    4533: navidrome
    5055: jellyseerr
    6767: bazarr
    7575: homarr
    5690: wizarr
    8766: spotisub
    9100: streaming-node-exporter

# HA add-on overlap audit (for D110)
ha_overlaps:
  source_vm: 100  # homeassistant
  source_host: proxmox-home
  
  overlaps:
    - ha_addon: overseerr
      shop_service: jellyseerr
      shop_vm: streaming-stack
      shop_port: 5055
      recommendation: decommission
      reason: "jellyseerr on streaming-stack is the canonical request manager"

    - ha_addon: lidarr
      shop_service: lidarr
      shop_vm: download-stack
      shop_port: 8686
      recommendation: investigate
      reason: "may have different library config or be stale duplicate"

    - ha_addon: sonarr
      shop_service: sonarr
      shop_vm: download-stack
      shop_port: 8989
      recommendation: investigate
      reason: "may have different library config or be stale duplicate"

    - ha_addon: sabnzbd
      shop_service: sabnzbd
      shop_vm: download-stack
      shop_port: 8080
      recommendation: investigate
      reason: "may have different config or be stale duplicate"
