# RAG Workspace Contract
# Canonical binding for RAG workspace configuration.
# Authority: docs/governance/RAG_INDEXING_RULES.md, docs/governance/RAG_QUERY_PATTERNS.md
# Consumed by: ops/plugins/rag/bin/rag, surfaces/verify/d87-rag-workspace-contract-lock.sh

schema_version: '1.0'
updated_at: '2026-02-13'

workspace:
  slug: "agentic-spine"
  description: "Spine-native RAG workspace for governed agent knowledge"
  provider: "anythingllm"
  provider_version: ">=1.0.0"

embedding:
  model: "mxbai-embed-large:latest"
  provider: "ollama"
  vector_store: "qdrant"

index_policy:
  eligible_roots:
    - "docs/"
    - "ops/"
    - "surfaces/"
  exclusion_prefixes:
    - "docs/legacy/"
    - "docs/governance/_audits/"
    - "docs/governance/_archived/"
    - "docs/governance/_imported/"
    - "receipts/"
    - "mailroom/state/"
    - "fixtures/"
    - ".git/"
    - "node_modules/"
  frontmatter_required:
    - "status:"
    - "owner:"
    - "last_verified:"
  secrets_filter: true

sync_policy:
  upload_timeout_sec: 180
  retry_count: 1
  retry_delay_sec: 5
  checkpoint_dir: "mailroom/state/rag-sync"
  dry_run_first: recommended
  # Load-shaping knobs â€” govern sync pacing to prevent embedding overload
  load_shaping:
    # Inter-document pause between uploads (seconds). 0 = no pause.
    inter_doc_pace_sec: 1
    # Per-request timeout for individual embedding/upload (seconds)
    per_request_timeout_sec: 600
    # Maximum retry attempts per failed upload
    max_retries: 2
    # Backoff strategy: "fixed" or "exponential"
    backoff_strategy: "exponential"
    # Base delay between retries (seconds). Exponential: delay * 2^attempt
    retry_base_delay_sec: 5
    # Maximum backoff cap (seconds) to prevent runaway delays
    retry_max_delay_sec: 60

cutover_policy:
  verify_workspace_exists: true
  verify_parity_after_sync: true
  smoke_test_queries:
    - "What is the canonical session entry protocol file?"
    - "How do I file a gap?"
  acceptance_criteria: "docs_indexed >= docs_eligible AND smoke queries return sources"
