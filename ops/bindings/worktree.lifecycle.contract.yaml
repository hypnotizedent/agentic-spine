# Worktree Lifecycle Contract
# Status: authoritative
# Last verified: 2026-02-27
# Scope: D48 lifecycle-aware worktree hygiene for multi-terminal wave/loop runtime

version: "1.1"
updated: "2026-02-27"
owner: "@ronny"
scope: worktree-lifecycle

policy:
  main_branch: "main"
  canonical_worktree_root: "~/.wt"
  canonical_worktree_layout: "<root>/<repo>/<lane>"
  lease_filename: ".spine-lane-lease.yaml"
  lease_ttl_hours_default: 24
  local_branch_prefixes_allow_no_remote:
    - "codex/"
    - "orchestration/"
  merged_branch_grace_hours: 24
  closed_owner_grace_hours: 6
  unowned_local_branch_grace_hours: 168
  fail_on_detached_head: true
  fail_on_dirty_when_owner_closed: true
  warn_on_dirty_when_owner_active: true

cleanup:
  phases:
    - report-only
    - archive-only
    - delete
  delete_token_env_var: "OPS_WORKTREE_DELETE_TOKEN"
  delete_token_value: "RELEASE_MAIN_CLEANUP_WINDOW"
  require_archive_before_delete: true
  require_branch_merged_or_explicit_token: true
  block_if_active_lease: true

runtime:
  archive_root: "~/code/_closeout_backups/worktree-lifecycle"
  waves_state_dir: "~/code/.runtime/spine-mailroom/waves"
  loops_scope_dir: "mailroom/state/loop-scopes"

messages:
  remediation: "Use wave/loop lifecycle closeout before git cleanup. Prefer `./bin/ops cap run worktree.lifecycle.reconcile -- --json` to classify stale branches, then perform explicit close actions."
  gate_summary: "D48 enforces lifecycle violations only (closed-owner zombies, detached heads, non-local orphan branches, stale merged branches, stale unowned locals)."
